Computers and network equipment inventory.

* Linus
** Yubikeys
*** YubiKey 4 (CCID) -- PGP and SSH
Serial 0x3f6d8b (04156811)

Bus 001 Device 037: ID 1050:0404 Yubico.com Yubikey 4/5 CCID
  idVendor           0x1050 Yubico.com
  idProduct          0x0404 Yubikey 4/5 CCID
  bcdDevice            4.28
  iManufacturer           1 Yubico
  iProduct                2 Yubikey 4 CCID

$ gpg --card-status
Reader ...........: Yubico YubiKey CCID 01 00
Application ID ...: D2760001240102010006041568110000
Application type .: OpenPGP
Version ..........: 2.1
Manufacturer .....: Yubico
Serial number ....: 04156811
...
Signature key ....: 8C4C D511 095E 982E B0EF  BFA2 1E8B F349 2329 1265
      created ....: 2010-05-07 15:05:41
Encryption key....: BDF0 F8A7 4B86 7E14 3D5F  F6E5 BFBF 3660 110E B862
      created ....: 2019-05-30 21:04:21
Authentication key: FE08 8B34 43E1 3C60 6C7C  3C36 C178 8C2B 0B31 20D3
      created ....: 2018-02-17 22:07:53
General key info..: pub  rsa4096/1E8BF34923291265 2010-05-07 Linus Nordberg <linus@nordberg.se>

*** Yubikey 5C Nano
Purchase date: 2021-12-09
Serial 16 383 131

$ lsusb -v
Bus 001 Device 050: ID 1050:0407 Yubico.com Yubikey 4/5 OTP+U2F+CCID
  idVendor           0x1050 Yubico.com
  idProduct          0x0407 Yubikey 4/5 OTP+U2F+CCID
  bcdDevice            5.43

*** Yubikey 5C Nano
Purchase date: ?
Serial 10 124 574

Bus 001 Device 051: ID 1050:0407 Yubico.com Yubikey 4/5 OTP+U2F+CCID
  idVendor           0x1050 Yubico.com
  idProduct          0x0407 Yubikey 4/5 OTP+U2F+CCID
  bcdDevice            5.12

*** Yubikey NEO
Serial 3037390

Bus 001 Device 048: ID 1050:0116 Yubico.com Yubikey NEO(-N) OTP+U2F+CCID
  idVendor           0x1050 Yubico.com
  idProduct          0x0116 Yubikey NEO(-N) OTP+U2F+CCID
  bcdDevice            3.35
  iManufacturer           1 Yubico
  iProduct                2 Yubikey NEO OTP+U2F+CCID

*** Yubikey II "H1"
Serial 0107 7263

Bus 001 Device 056: ID 1050:0010 Yubico.com Yubikey (v1 or v2)
  idVendor           0x1050 Yubico.com
  idProduct          0x0010 Yubikey (v1 or v2)
  bcdDevice            2.23
  iManufacturer           1 Yubico
  iProduct                2 Yubico Yubikey II

** apu2d -- apu for home WiFi, running openwrt 2020-03
Purchased 2020-03 from Teklager
Model apu2d
RAM 2G
SSD 16G

Hostname OpenWrt
Architecture AMD GX-412TC SOC

http://192.168.1.1/

Dropbear used to work but offers only ssh-rsa which I suppose modern ssh client's don't do.
Tried installing openssh-server and succeeded but didn't manage to configure it in the web UI.
Tried to go back to dropbear but still no config options (under System -> Administration where it used to reside).

*** OS -- OpenWrt
https://downloads.openwrt.org/releases/19.07.2/targets/x86/64/openwrt-19.07.2-x86-64-combined-ext4.img.gz
87156fcc2f4f3c19829eae954885806472f7bed7ba8f094c1275279954fecb08
Linux OpenWrt 4.14.171 #0 SMP Thu Feb 27 21:05:12 2020 x86_64 GNU/Linux

- https://openwrt.org/docs/guide-developer/security
- https://oldwiki.archive.openwrt.org/doc/devel/security

*** root@OpenWrt:/# dmesg
[    0.000000] Linux version 4.14.171 (builder@buildhost) (gcc version 7.5.0 (OpenWrt GCC 7.5.0 r10947-65030d81f3)) #0 SMP Thu Feb 27 21:05:12 2020
[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz root=PARTUUID=57113300-02 rootfstype=ext4 rootwait console=tty0 console=ttyS0,115200n8 noinitrd
[    0.000000] x86/fpu: Supporting XSAVE feature 0x001: 'x87 floating point registers'
[    0.000000] x86/fpu: Supporting XSAVE feature 0x002: 'SSE registers'
[    0.000000] x86/fpu: Supporting XSAVE feature 0x004: 'AVX registers'
[    0.000000] x86/fpu: xstate_offset[2]:  576, xstate_sizes[2]:  256
[    0.000000] x86/fpu: Enabled xstate features 0x7, context size is 832 bytes, using 'standard' format.
[    0.000000] e820: BIOS-provided physical RAM map:
[    0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable
[    0.000000] BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved
[    0.000000] BIOS-e820: [mem 0x0000000000100000-0x0000000077ffefff] usable
[    0.000000] BIOS-e820: [mem 0x0000000077fff000-0x0000000077ffffff] reserved
[    0.000000] BIOS-e820: [mem 0x000000007ee8d000-0x000000007effffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000f8000000-0x00000000fbffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000fed40000-0x00000000fed44fff] reserved
[    0.000000] NX (Execute Disable) protection: active
[    0.000000] SMBIOS 2.8 present.
[    0.000000] DMI: PC Engines apu2/apu2, BIOS v4.11.0.4 02/26/2020
[    0.000000] tsc: Fast TSC calibration using PIT
[    0.000000] e820: update [mem 0x00000000-0x00000fff] usable ==> reserved
[    0.000000] e820: remove [mem 0x000a0000-0x000fffff] usable
[    0.000000] e820: last_pfn = 0x77fff max_arch_pfn = 0x400000000
[    0.000000] MTRR default type: uncachable
[    0.000000] MTRR fixed ranges enabled:
[    0.000000]   00000-9FFFF write-back
[    0.000000]   A0000-BFFFF uncachable
[    0.000000]   C0000-FFFFF write-back
[    0.000000] MTRR variable ranges enabled:
[    0.000000]   0 base 00FF800000 mask FFFF800000 write-protect
[    0.000000]   1 base 0000000000 mask FF80000000 write-back
[    0.000000]   2 disabled
[    0.000000]   3 disabled
[    0.000000]   4 disabled
[    0.000000]   5 disabled
[    0.000000]   6 disabled
[    0.000000]   7 disabled
[    0.000000] x86/PAT: Configuration [0-7]: WB  WC  UC- UC  WB  WP  UC- WT  
[    0.000000] found SMP MP-table at [mem 0x000f38e0-0x000f38ef]
[    0.000000] Base memory trampoline at [ffff888000099000] 99000 size 24576
[    0.000000] Using GB pages for direct mapping
[    0.000000] BRK [0x02019000, 0x02019fff] PGTABLE
[    0.000000] BRK [0x0201a000, 0x0201afff] PGTABLE
[    0.000000] BRK [0x0201b000, 0x0201bfff] PGTABLE
[    0.000000] BRK [0x0201c000, 0x0201cfff] PGTABLE
[    0.000000] BRK [0x0201d000, 0x0201dfff] PGTABLE
[    0.000000] ACPI: Early table checksum verification disabled
[    0.000000] ACPI: RSDP 0x00000000000F3AF0 000024 (v02 COREv4)
[    0.000000] ACPI: XSDT 0x000000007EE9E0E0 00006C (v01 COREv4 COREBOOT 00000000 CORE 20180531)
[    0.000000] ACPI: FACP 0x000000007EE9FD80 0000F4 (v04 COREv4 COREBOOT 00000000 CORE 20180531)
[    0.000000] ACPI: DSDT 0x000000007EE9E280 001AF6 (v02 COREv4 COREBOOT 00010001 INTL 20180531)
[    0.000000] ACPI: FACS 0x000000007EE9E240 000040
[    0.000000] ACPI: SSDT 0x000000007EE9FE80 0001EE (v02 COREv4 COREBOOT 0000002A CORE 20180531)
[    0.000000] ACPI: MCFG 0x000000007EEA0070 00003C (v01 COREv4 COREBOOT 00000000 CORE 20180531)
[    0.000000] ACPI: TPM2 0x000000007EEA00B0 00004C (v04 COREv4 COREBOOT 00000000 CORE 20180531)
[    0.000000] ACPI: APIC 0x000000007EEA0100 00007E (v02 COREv4 COREBOOT 00000000 CORE 20180531)
[    0.000000] ACPI: HEST 0x000000007EEA0180 0001D0 (v01 COREv4 COREBOOT 00000000 CORE 20180531)
[    0.000000] ACPI: SSDT 0x000000007EEA0350 0048A6 (v02 AMD    AGESA    00000002 MSFT 04000000)
[    0.000000] ACPI: SSDT 0x000000007EEA4C00 0007C8 (v01 AMD    AGESA    00000001 AMD  00000001)
[    0.000000] ACPI: HPET 0x000000007EEA53D0 000038 (v01 COREv4 COREBOOT 00000000 CORE 20180531)
[    0.000000] ACPI: Local APIC address 0xfee00000
[    0.000000] Zone ranges:
[    0.000000]   DMA      [mem 0x0000000000001000-0x0000000000ffffff]
[    0.000000]   DMA32    [mem 0x0000000001000000-0x0000000077ffefff]
[    0.000000]   Normal   empty
[    0.000000] Movable zone start for each node
[    0.000000] Early memory node ranges
[    0.000000]   node   0: [mem 0x0000000000001000-0x000000000009efff]
[    0.000000]   node   0: [mem 0x0000000000100000-0x0000000077ffefff]
[    0.000000] Initmem setup node 0 [mem 0x0000000000001000-0x0000000077ffefff]
[    0.000000] On node 0 totalpages: 491421
[    0.000000]   DMA zone: 64 pages used for memmap
[    0.000000]   DMA zone: 21 pages reserved
[    0.000000]   DMA zone: 3998 pages, LIFO batch:0
[    0.000000]   DMA32 zone: 7616 pages used for memmap
[    0.000000]   DMA32 zone: 487423 pages, LIFO batch:31
[    0.000000] ACPI: PM-Timer IO Port: 0x818
[    0.000000] ACPI: Local APIC address 0xfee00000
[    0.000000] ACPI: LAPIC_NMI (acpi_id[0xff] high edge lint[0x1])
[    0.000000] IOAPIC[0]: apic_id 4, version 33, address 0xfec00000, GSI 0-23
[    0.000000] IOAPIC[1]: apic_id 5, version 33, address 0xfec20000, GSI 24-55
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 0 global_irq 2 dfl dfl)
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 9 global_irq 9 low level)
[    0.000000] ACPI: IRQ0 used by override.
[    0.000000] ACPI: IRQ9 used by override.
[    0.000000] Using ACPI (MADT) for SMP configuration information
[    0.000000] ACPI: HPET id: 0x10228201 base: 0xfed00000
[    0.000000] smpboot: Allowing 4 CPUs, 0 hotplug CPUs
[    0.000000] e820: [mem 0x7f000000-0xf7ffffff] available for PCI devices
[    0.000000] Booting paravirtualized kernel on bare hardware
[    0.000000] clocksource: refined-jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
[    0.000000] random: get_random_bytes called from 0xffffffff81ebaaad with crng_init=0
[    0.000000] setup_percpu: NR_CPUS:8 nr_cpumask_bits:8 nr_cpu_ids:4 nr_node_ids:1
[    0.000000] percpu: Embedded 41 pages/cpu s127896 r8192 d31848 u524288
[    0.000000] pcpu-alloc: s127896 r8192 d31848 u524288 alloc=1*2097152
[    0.000000] pcpu-alloc: [0] 0 1 2 3 
[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 483720
[    0.000000] Kernel command line: BOOT_IMAGE=/boot/vmlinuz root=PARTUUID=57113300-02 rootfstype=ext4 rootwait console=tty0 console=ttyS0,115200n8 noinitrd
[    0.000000] PID hash table entries: 4096 (order: 3, 32768 bytes)
[    0.000000] Dentry cache hash table entries: 262144 (order: 9, 2097152 bytes)
[    0.000000] Inode-cache hash table entries: 131072 (order: 8, 1048576 bytes)
[    0.000000] Calgary: detecting Calgary via BIOS EBDA area
[    0.000000] Calgary: Unable to locate Rio Grande table in EBDA - bailing!
[    0.000000] Memory: 1914564K/1965684K available (10248K kernel code, 560K rwdata, 1652K rodata, 1084K init, 412K bss, 51120K reserved, 0K cma-reserved)
[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=4, Nodes=1
[    0.000000] Hierarchical RCU implementation.
[    0.000000] 	CONFIG_RCU_FANOUT set to non-default value of 32
[    0.000000] 	RCU restricting CPUs from NR_CPUS=8 to nr_cpu_ids=4.
[    0.000000] RCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=4
[    0.000000] NR_IRQS: 4352, nr_irqs: 1000, preallocated irqs: 16
[    0.000000] spurious 8259A interrupt: IRQ7.
[    0.000000] Console: colour dummy device 80x25
[    0.000000] console [tty0] enabled
[    0.000000] console [ttyS0] enabled
[    0.000000] clocksource: hpet: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 133484873504 ns
[    0.000000] hpet clockevent registered
[    0.000000] tsc: Fast TSC calibration using PIT
[    0.010000] tsc: Detected 998.006 MHz processor
[    0.010000] Calibrating delay loop (skipped), value calculated using timer frequency.. 1996.01 BogoMIPS (lpj=9980060)
[    0.020008] pid_max: default: 32768 minimum: 301
[    0.030015] ACPI: Core revision 20170728
[    0.051526] ACPI: 4 ACPI AML tables successfully acquired and loaded
[    0.057975] Mount-cache hash table entries: 4096 (order: 3, 32768 bytes)
[    0.060028] Mountpoint-cache hash table entries: 4096 (order: 3, 32768 bytes)
[    0.070400] mce: CPU supports 6 MCE banks
[    0.074446] LVT offset 1 assigned for vector 0xf9
[    0.080018] Last level iTLB entries: 4KB 512, 2MB 8, 4MB 4
[    0.085515] Last level dTLB entries: 4KB 512, 2MB 256, 4MB 128, 1GB 0
[    0.090009] Spectre V1 : Mitigation: usercopy/swapgs barriers and __user pointer sanitization
[    0.100009] Spectre V2 : Mitigation: Full AMD retpoline
[    0.105245] Spectre V2 : Spectre v2 / SpectreRSB mitigation: Filling RSB on context switch
[    0.110008] Speculative Store Bypass: Mitigation: Speculative Store Bypass disabled via prctl
[    0.120338] Freeing SMP alternatives memory: 32K
[    0.131423] smpboot: Max logical packages: 1
[    0.136188] ..TIMER: vector=0x30 apic1=0 pin1=2 apic2=0 pin2=0
[    0.352046] smpboot: CPU0: AMD GX-412TC SOC (family: 0x16, model: 0x30, stepping: 0x1)
[    0.360000] Performance Events: AMD PMU driver.
[    0.360008] ... version:                0
[    0.364024] ... bit width:              48
[    0.370005] ... generic registers:      4
[    0.374021] ... value mask:             0000ffffffffffff
[    0.380005] ... max period:             00007fffffffffff
[    0.385322] ... fixed-purpose events:   0
[    0.389343] ... event mask:             000000000000000f
[    0.390128] Hierarchical SRCU implementation.
[    0.394881] smp: Bringing up secondary CPUs ...
[    0.400314] x86: Booting SMP configuration:
[    0.404513] .... node  #0, CPUs:      #1 #2 #3
[    0.415945] smp: Brought up 1 node, 4 CPUs
[    0.424129] smpboot: Total of 4 processors activated (7984.04 BogoMIPS)
[    0.433023] reboot: PC Engines apu2 series board detected. Selecting PCI-method for reboots.
[    0.440141] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns
[    0.450025] futex hash table entries: 1024 (order: 4, 65536 bytes)
[    0.460078] pinctrl core: initialized pinctrl subsystem
[    0.465727] NET: Registered protocol family 16
[    0.470989] cpuidle: using governor ladder
[    0.475506] ACPI: bus type PCI registered
[    0.480009] acpiphp: ACPI Hot Plug PCI Controller Driver version: 0.5
[    0.486614] PCI: Using configuration type 1 for base access
[    0.490005] PCI: Using configuration type 1 for extended access
[    0.496869] mtrr: your CPUs had inconsistent variable MTRR settings
[    0.500013] mtrr: probably your BIOS does not setup all CPUs.
[    0.510006] mtrr: corrected configuration.
[    0.527676] ACPI: Added _OSI(Module Device)
[    0.530011] ACPI: Added _OSI(Processor Device)
[    0.530026] ACPI: Added _OSI(3.0 _SCP Extensions)
[    0.540006] ACPI: Added _OSI(Processor Aggregator Device)
[    0.540400] ACPI: Executed 3 blocks of module-level executable AML code
[    0.560596] ACPI: Interpreter enabled
[    0.564286] ACPI: (supports S0 S5)
[    0.570025] ACPI: Using IOAPIC for interrupt routing
[    0.570062] PCI: Using host bridge windows from ACPI; if necessary, use "pci=nocrs" and report a bug
[    0.580559] ACPI: Enabled 7 GPEs in block 00 to 1F
[    0.603939] ACPI: PCI Root Bridge [PCI0] (domain 0000 [bus 00-ff])
[    0.610027] acpi PNP0A08:00: _OSC: OS supports [ExtendedConfig Segments MSI]
[    0.610070] acpi PNP0A08:00: _OSC: not requesting OS control; OS requires [ExtendedConfig ASPM ClockPM MSI]
[    0.620138] acpi PNP0A08:00: host bridge window expanded to [io  0x0000-0x0cf7 window]; [io  0x03b0-0x03df window] ignored
[    0.638880] PCI host bridge to bus 0000:00
[    0.640006] pci_bus 0000:00: root bus resource [io  0x0000-0x0cf7 window]
[    0.640009] pci_bus 0000:00: root bus resource [io  0x0d00-0xffff window]
[    0.650023] pci_bus 0000:00: root bus resource [mem 0x000a0000-0x000bffff]
[    0.660006] pci_bus 0000:00: root bus resource [mem 0x000c0000-0x000dffff]
[    0.670023] pci_bus 0000:00: root bus resource [mem 0x7f000000-0xffffffff]
[    0.670023] pci_bus 0000:00: root bus resource [bus 00-ff]
[    0.680006] pci 0000:00:00.0: [1022:1566] type 00 class 0x060000
[    0.680006] pci 0000:00:00.2: [1022:1567] type 00 class 0x080600
[    0.683314] pci 0000:00:02.0: [1022:156b] type 00 class 0x060000
[    0.683634] pci 0000:00:02.1: [1022:1439] type 01 class 0x060400
[    0.683972] pci 0000:00:02.1: enabling Extended Tags
[    0.683972] pci 0000:00:02.1: PME# supported from D0 D3hot D3cold
[    0.683973] pci 0000:00:02.2: [1022:1439] type 01 class 0x060400
[    0.689369] pci 0000:00:02.2: enabling Extended Tags
[    0.690050] pci 0000:00:02.2: PME# supported from D0 D3hot D3cold
[    0.690298] pci 0000:00:02.4: [1022:1439] type 01 class 0x060400
[    0.694742] pci 0000:00:02.4: enabling Extended Tags
[    0.695417] pci 0000:00:02.4: PME# supported from D0 D3hot D3cold
[    0.700006] pci 0000:00:02.5: [1022:1439] type 01 class 0x060400
[    0.700089] pci 0000:00:02.5: enabling Extended Tags
[    0.700089] pci 0000:00:02.5: PME# supported from D0 D3hot D3cold
[    0.700333] pci 0000:00:08.0: [1022:1537] type 00 class 0x108000
[    0.700364] pci 0000:00:08.0: reg 0x10: [mem 0xf7f00000-0xf7f1ffff 64bit pref]
[    0.700377] pci 0000:00:08.0: reg 0x18: [mem 0xf7d00000-0xf7dfffff]
[    0.705508] pci 0000:00:08.0: reg 0x1c: [mem 0xf7f24000-0xf7f24fff]
[    0.705508] pci 0000:00:08.0: reg 0x20: [mem 0xf7e00000-0xf7efffff]
[    0.705508] pci 0000:00:08.0: reg 0x24: [mem 0xf7f20000-0xf7f21fff]
[    0.705800] pci 0000:00:10.0: [1022:7814] type 00 class 0x0c0330
[    0.705800] pci 0000:00:10.0: reg 0x10: [mem 0xf7f22000-0xf7f23fff 64bit]
[    0.705800] pci 0000:00:10.0: PME# supported from D0 D3hot D3cold
[    0.705801] pci 0000:00:11.0: [1022:7801] type 00 class 0x010601
[    0.705801] pci 0000:00:11.0: reg 0x10: [io  0x3010-0x3017]
[    0.705801] pci 0000:00:11.0: reg 0x14: [io  0x3020-0x3023]
[    0.706271] pci 0000:00:11.0: reg 0x18: [io  0x3018-0x301f]
[    0.706271] pci 0000:00:11.0: reg 0x1c: [io  0x3024-0x3027]
[    0.706271] pci 0000:00:11.0: reg 0x20: [io  0x3000-0x300f]
[    0.706271] pci 0000:00:11.0: reg 0x24: [mem 0xf7f25000-0xf7f253ff]
[    0.706271] pci 0000:00:11.0: PME# supported from D3hot
[    0.706272] pci 0000:00:13.0: [1022:7808] type 00 class 0x0c0320
[    0.706617] pci 0000:00:13.0: reg 0x10: [mem 0xf7f26000-0xf7f260ff]
[    0.706617] pci 0000:00:13.0: supports D1 D2
[    0.706617] pci 0000:00:13.0: PME# supported from D0 D1 D2 D3hot D3cold
[    0.706618] pci 0000:00:14.0: [1022:780b] type 00 class 0x0c0500
[    0.707068] pci 0000:00:14.3: [1022:780e] type 00 class 0x060100
[    0.707317] pci 0000:00:14.7: [1022:7813] type 00 class 0x080501
[    0.707317] pci 0000:00:14.7: reg 0x10: [mem 0xf7f27000-0xf7f270ff 64bit]
[    0.707694] pci 0000:00:18.0: [1022:1580] type 00 class 0x060000
[    0.707992] pci 0000:00:18.1: [1022:1581] type 00 class 0x060000
[    0.708288] pci 0000:00:18.2: [1022:1582] type 00 class 0x060000
[    0.708556] pci 0000:00:18.3: [1022:1583] type 00 class 0x060000
[    0.708824] pci 0000:00:18.4: [1022:1584] type 00 class 0x060000
[    0.709084] pci 0000:00:18.5: [1022:1585] type 00 class 0x060000
[    0.709581] pci 0000:01:00.0: [168c:003c] type 00 class 0x028000
[    0.709581] pci 0000:01:00.0: reg 0x10: [mem 0xf7400000-0xf75fffff 64bit]
[    0.709581] pci 0000:01:00.0: reg 0x30: [mem 0xf7600000-0xf760ffff pref]
[    0.709581] pci 0000:01:00.0: supports D1
[    0.709581] pci 0000:01:00.0: PME# supported from D0 D1 D3hot
[    0.710019] pci 0000:00:02.1: PCI bridge to [bus 01]
[    0.710019] pci 0000:00:02.1:   bridge window [mem 0xf7400000-0xf76fffff]
[    0.710186] pci 0000:02:00.0: [8086:1539] type 00 class 0x020000
[    0.710209] pci 0000:02:00.0: reg 0x10: [mem 0xf7b00000-0xf7b1ffff]
[    0.710244] pci 0000:02:00.0: reg 0x18: [io  0x1000-0x101f]
[    0.710265] pci 0000:02:00.0: reg 0x1c: [mem 0xf7b20000-0xf7b23fff]
[    0.710439] pci 0000:02:00.0: PME# supported from D0 D3hot D3cold
[    0.715269] pci 0000:00:02.2: PCI bridge to [bus 02]
[    0.720006] pci 0000:00:02.2:   bridge window [io  0x1000-0x1fff]
[    0.720006] pci 0000:00:02.2:   bridge window [mem 0xf7b00000-0xf7bfffff]
[    0.720006] pci 0000:03:00.0: [8086:1539] type 00 class 0x020000
[    0.720804] pci 0000:03:00.0: reg 0x10: [mem 0xf7c00000-0xf7c1ffff]
[    0.720804] pci 0000:03:00.0: reg 0x18: [io  0x2000-0x201f]
[    0.720804] pci 0000:03:00.0: reg 0x1c: [mem 0xf7c20000-0xf7c23fff]
[    0.720804] pci 0000:03:00.0: PME# supported from D0 D3hot D3cold
[    0.720805] pci 0000:00:02.4: PCI bridge to [bus 03]
[    0.721250] pci 0000:00:02.4:   bridge window [io  0x2000-0x2fff]
[    0.721250] pci 0000:00:02.4:   bridge window [mem 0xf7c00000-0xf7cfffff]
[    0.721251] pci 0000:04:00.0: [168c:003c] type 00 class 0x028000
[    0.721251] pci 0000:04:00.0: reg 0x10: [mem 0xf7800000-0xf79fffff 64bit]
[    0.721251] pci 0000:04:00.0: reg 0x30: [mem 0xf7a00000-0xf7a0ffff pref]
[    0.721251] pci 0000:04:00.0: supports D1
[    0.721251] pci 0000:04:00.0: PME# supported from D0 D1 D3hot
[    0.726383] pci 0000:00:02.5: PCI bridge to [bus 04]
[    0.730023] pci 0000:00:02.5:   bridge window [mem 0xf7800000-0xf7afffff]
[    0.730023] pci_bus 0000:00: on NUMA node 0
[    0.732451] ACPI: PCI Interrupt Link [INTA] (IRQs *3 4 5 7 10 11 12 15)
[    0.732528] ACPI: PCI Interrupt Link [INTB] (IRQs *3 4 5 7 10 11 12 15)
[    0.740151] ACPI: PCI Interrupt Link [INTC] (IRQs 3 4 *5 7 10 11 12 15)
[    0.750024] ACPI: PCI Interrupt Link [INTD] (IRQs 3 4 5 *7 10 11 12 15)
[    0.750152] ACPI: PCI Interrupt Link [INTE] (IRQs 3 4 5 7 10 *11 12 15)
[    0.760150] ACPI: PCI Interrupt Link [INTF] (IRQs 9) *10
[    0.770023] ACPI: PCI Interrupt Link [INTG] (IRQs 3 4 5 7 10 11 12 15) *0
[    0.770150] ACPI: PCI Interrupt Link [INTH] (IRQs 3 4 5 7 10 11 12 15) *0
[    0.786750] SCSI subsystem initialized
[    0.790921] libata version 3.00 loaded.
[    0.790921] ACPI: bus type USB registered
[    0.791095] usbcore: registered new interface driver usbfs
[    0.800147] usbcore: registered new interface driver hub
[    0.805515] usbcore: registered new device driver usb
[    0.811366] PCI: Using ACPI for IRQ routing
[    0.814438] PCI: pci_cache_line_size set to 64 bytes
[    0.814540] e820: reserve RAM buffer [mem 0x0009fc00-0x0009ffff]
[    0.814545] e820: reserve RAM buffer [mem 0x77fff000-0x77ffffff]
[    0.816619] hpet0: at MMIO 0xfed00000, IRQs 2, 8, 0
[    0.820012] hpet0: 3 comparators, 32-bit 14.318180 MHz counter
[    0.827997] clocksource: Switched to clocksource hpet
[    0.827997] pnp: PnP ACPI init
[    0.828806] system 00:00: [mem 0xfec10002-0xfec11001] has been reserved
[    0.835554] system 00:00: Plug and Play ACPI device, IDs PNP0c02 (active)
[    0.835688] pnp 00:01: Plug and Play ACPI device, IDs PNP0b00 (active)
[    0.835818] pnp 00:02: Plug and Play ACPI device, IDs PNP0501 (active)
[    0.835983] pnp 00:03: Plug and Play ACPI device, IDs PNP0501 (active)
[    0.836513] pnp: PnP ACPI: found 4 devices
[    0.849583] clocksource: acpi_pm: mask: 0xffffff max_cycles: 0xffffff, max_idle_ns: 2085701024 ns
[    0.858559] pci 0000:00:02.1: PCI bridge to [bus 01]
[    0.863554] pci 0000:00:02.1:   bridge window [mem 0xf7400000-0xf76fffff]
[    0.870377] pci 0000:00:02.2: PCI bridge to [bus 02]
[    0.875356] pci 0000:00:02.2:   bridge window [io  0x1000-0x1fff]
[    0.881471] pci 0000:00:02.2:   bridge window [mem 0xf7b00000-0xf7bfffff]
[    0.888277] pci 0000:00:02.4: PCI bridge to [bus 03]
[    0.893264] pci 0000:00:02.4:   bridge window [io  0x2000-0x2fff]
[    0.899374] pci 0000:00:02.4:   bridge window [mem 0xf7c00000-0xf7cfffff]
[    0.906194] pci 0000:00:02.5: PCI bridge to [bus 04]
[    0.911188] pci 0000:00:02.5:   bridge window [mem 0xf7800000-0xf7afffff]
[    0.918000] pci_bus 0000:00: resource 4 [io  0x0000-0x0cf7 window]
[    0.918006] pci_bus 0000:00: resource 5 [io  0x0d00-0xffff window]
[    0.918011] pci_bus 0000:00: resource 6 [mem 0x000a0000-0x000bffff]
[    0.918016] pci_bus 0000:00: resource 7 [mem 0x000c0000-0x000dffff]
[    0.918022] pci_bus 0000:00: resource 8 [mem 0x7f000000-0xffffffff]
[    0.918027] pci_bus 0000:01: resource 1 [mem 0xf7400000-0xf76fffff]
[    0.918033] pci_bus 0000:02: resource 0 [io  0x1000-0x1fff]
[    0.918038] pci_bus 0000:02: resource 1 [mem 0xf7b00000-0xf7bfffff]
[    0.918044] pci_bus 0000:03: resource 0 [io  0x2000-0x2fff]
[    0.918049] pci_bus 0000:03: resource 1 [mem 0xf7c00000-0xf7cfffff]
[    0.918054] pci_bus 0000:04: resource 1 [mem 0xf7800000-0xf7afffff]
[    0.918208] NET: Registered protocol family 2
[    0.923014] TCP established hash table entries: 16384 (order: 5, 131072 bytes)
[    0.930338] TCP bind hash table entries: 16384 (order: 6, 262144 bytes)
[    0.937116] TCP: Hash tables configured (established 16384 bind 16384)
[    0.943764] UDP hash table entries: 1024 (order: 3, 32768 bytes)
[    0.949804] UDP-Lite hash table entries: 1024 (order: 3, 32768 bytes)
[    0.956373] NET: Registered protocol family 1
[    0.961585] pci 0000:00:13.0: PME# does not work under D3, disabling it
[    0.968276] PCI: CLS 64 bytes, default 64
[    0.968709] amd_uncore: AMD NB counters detected
[    0.973413] amd_uncore: AMD LLC counters detected
[    0.978513] LVT offset 0 assigned for vector 0x400
[    0.983571] perf: AMD IBS detected (0x000000ff)
[    0.990974] workingset: timestamp_bits=62 max_order=19 bucket_order=0
[    1.002058] squashfs: version 4.0 (2009/01/31) Phillip Lougher
[    1.009726] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 249)
[    1.017243] io scheduler noop registered
[    1.021186] io scheduler deadline registered (default)
[    1.026688] gpio_it87: no device
[    1.031656] hv_vmbus: registering driver hv_pci
[    1.036228] hv_vmbus: registering driver hyperv_fb
[    1.041461] input: Power Button as /devices/LNXSYSTM:00/LNXSYBUS:00/PNP0C0C:00/input/input0
[    1.049941] ACPI: Power Button [PWRB]
[    1.053830] input: Power Button as /devices/LNXSYSTM:00/LNXPWRBN:00/input/input1
[    1.061387] ACPI: Power Button [PWRF]
[    1.067326] Serial: 8250/16550 driver, 16 ports, IRQ sharing enabled
[    1.094355] 00:02: ttyS0 at I/O 0x3f8 (irq = 4, base_baud = 115200) is a 16550A
[    1.122391] 00:03: ttyS1 at I/O 0x2f8 (irq = 3, base_baud = 115200) is a 16550A
[    1.150511] serial8250: ttyS2 at I/O 0x3e8 (irq = 4, base_baud = 115200) is a 16550A
[    1.178907] serial8250: ttyS3 at I/O 0x2e8 (irq = 3, base_baud = 115200) is a 16550A
[    1.188564] Non-volatile memory driver v1.3
[    1.193025] Linux agpgart interface v0.103
[    1.201035] loop: module loaded
[    1.204382] Guest personality initialized and is inactive
[    1.209842] VMCI host device registered (name=vmci, major=10, minor=63)
[    1.216489] Initialized host personality
[    1.220654] VMware PVSCSI driver - version 1.0.7.0-k
[    1.225674] hv_vmbus: registering driver hv_storvsc
[    1.230738] ahci 0000:00:11.0: version 3.0
[    1.231177] ahci 0000:00:11.0: AHCI 0001.0300 32 slots 2 ports 6 Gbps 0x3 impl SATA mode
[    1.239284] ahci 0000:00:11.0: flags: 64bit ncq sntf ilck pm led clo pmp fbs pio slum part 
[    1.248558] scsi host0: ahci
[    1.251826] scsi host1: ahci
[    1.254875] ata1: SATA max UDMA/133 abar m1024@0xf7f25000 port 0xf7f25100 irq 19
[    1.262296] ata2: SATA max UDMA/133 abar m1024@0xf7f25000 port 0xf7f25180 irq 19
[    1.270289] VMware vmxnet3 virtual NIC driver - version 1.4.a.0-k-NAPI
[    1.276867] hv_vmbus: registering driver hv_netvsc
[    1.281763] Fusion MPT base driver 3.04.20
[    1.285874] Copyright (c) 1999-2008 LSI Corporation
[    1.290782] Fusion MPT SPI Host driver 3.04.20
[    1.295278] ehci_hcd: USB 2.0 'Enhanced' Host Controller (EHCI) Driver
[    1.301822] ehci-pci: EHCI PCI platform driver
[    1.306583] ehci-pci 0000:00:13.0: EHCI Host Controller
[    1.311843] ehci-pci 0000:00:13.0: new USB bus registered, assigned bus number 1
[    1.319255] ehci-pci 0000:00:13.0: applying AMD SB700/SB800/Hudson-2/3 EHCI dummy qh workaround
[    1.327978] ehci-pci 0000:00:13.0: debug port 2
[    1.332590] ehci-pci 0000:00:13.0: irq 18, io mem 0xf7f26000
[    1.360320] ehci-pci 0000:00:13.0: USB 2.0 started, EHCI 1.00
[    1.366996] hub 1-0:1.0: USB hub found
[    1.370876] hub 1-0:1.0: 2 ports detected
[    1.375495] ohci_hcd: USB 1.1 'Open' Host Controller (OHCI) Driver
[    1.381716] ohci-pci: OHCI PCI platform driver
[    1.386222] ohci-platform: OHCI generic platform driver
[    1.391516] uhci_hcd: USB Universal Host Controller Interface driver
[    1.398229] xhci_hcd 0000:00:10.0: xHCI Host Controller
[    1.403495] xhci_hcd 0000:00:10.0: new USB bus registered, assigned bus number 2
[    1.411141] xhci_hcd 0000:00:10.0: hcc params 0x014040c3 hci version 0x100 quirks 0x0000000000000410
[    1.421366] hub 2-0:1.0: USB hub found
[    1.425204] hub 2-0:1.0: 2 ports detected
[    1.429745] xhci_hcd 0000:00:10.0: xHCI Host Controller
[    1.435013] xhci_hcd 0000:00:10.0: new USB bus registered, assigned bus number 3
[    1.442436] xhci_hcd 0000:00:10.0: Host supports USB 3.0  SuperSpeed
[    1.449035] usb usb3: We don't know the algorithms for LPM for this host, disabling LPM.
[    1.457936] hub 3-0:1.0: USB hub found
[    1.461773] hub 3-0:1.0: 2 ports detected
[    1.466522] usbcore: registered new interface driver usb-storage
[    1.472640] i8042: PNP: No PS/2 controller found.
[    1.477356] i8042: Probing ports directly.
[    1.602259] ata2: SATA link down (SStatus 0 SControl 300)
[    1.740066] usb 1-1: new high-speed USB device number 2 using ehci-pci
[    1.940935] hub 1-1:1.0: USB hub found
[    1.945143] hub 1-1:1.0: 4 ports detected
[    1.990120] tsc: Refined TSC clocksource calibration: 998.129 MHz
[    1.996243] clocksource: tsc: mask: 0xffffffffffffffff max_cycles: 0x1cc65f36a68, max_idle_ns: 881590538042 ns
[    2.100178] ata1: SATA link up 6.0 Gbps (SStatus 133 SControl 300)
[    2.106531] ata1.00: ATA-11: SATA SSD, SBFM01.3, max UDMA/133
[    2.112301] ata1.00: 31277232 sectors, multi 16: LBA48 NCQ (depth 31/32), AA
[    2.119542] ata1.00: configured for UDMA/133
[    2.124207] scsi 0:0:0:0: Direct-Access     ATA      SATA SSD         01.3 PQ: 0 ANSI: 5
[    2.133398] sd 0:0:0:0: [sda] 31277232 512-byte logical blocks: (16.0 GB/14.9 GiB)
[    2.141096] sd 0:0:0:0: [sda] Write Protect is off
[    2.145933] sd 0:0:0:0: [sda] Mode Sense: 00 3a 00 00
[    2.146173] sd 0:0:0:0: [sda] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA
[    2.156792]  sda: sda1 sda2
[    2.160839] sd 0:0:0:0: [sda] Attached SCSI disk
[    2.516070] i8042: No controller found
[    2.519837] hv_vmbus: registering driver hyperv_keyboard
[    2.525263] rtc_cmos 00:01: RTC can wake from S4
[    2.530087] rtc_cmos 00:01: rtc core: registered rtc_cmos as rtc0
[    2.536231] rtc_cmos 00:01: alarms up to one day, 114 bytes nvram, hpet irqs
[    2.544064] sdhci: Secure Digital Host Controller Interface driver
[    2.550268] sdhci: Copyright(c) Pierre Ossman
[    2.554680] sdhci-pci 0000:00:14.7: SDHCI controller found [1022:7813] (rev 1)
[    2.562494] mmc0: SDHCI controller on PCI [0000:00:14.7] using ADMA 64-bit
[    2.570124] hidraw: raw HID events driver (C) Jiri Kosina
[    2.575577] hv_vmbus: registering driver hid_hyperv
[    2.580590] usbcore: registered new interface driver usbhid
[    2.586168] usbhid: USB HID core driver
[    2.590048] hv_utils: Registering HyperV Utility Driver
[    2.595278] hv_vmbus: registering driver hv_util
[    2.599905] hv_vmbus: registering driver hv_balloon
[    2.604827] x86/pm: family 0x16 cpu detected, MSR saving is needed during suspending.
[    2.613218] NET: Registered protocol family 10
[    2.618288] Segment Routing with IPv6
[    2.622042] NET: Registered protocol family 17
[    2.626517] bridge: filtering via arp/ip/ip6tables is no longer available by default. Update your scripts to load br_netfilter if you need this.
[    2.639480] 8021q: 802.1Q VLAN Support v1.8
[    2.643765] NET: Registered protocol family 40
[    2.649115] microcode: CPU0: patch_level=0x07030105
[    2.654040] microcode: CPU1: patch_level=0x07030105
[    2.658968] microcode: CPU2: patch_level=0x07030105
[    2.663900] microcode: CPU3: patch_level=0x07030105
[    2.668845] microcode: Microcode Update Driver: v2.2.
[    2.668865] AVX version of gcm_enc/dec engaged.
[    2.678486] AES CTR mode by8 optimization enabled
[    2.684823] sched_clock: Marking stable (2684808935, 0)->(2687263853, -2454918)
[    2.692438] registered taskstats version 1
[    2.697405] rtc_cmos 00:01: setting system clock to 2020-03-23 16:24:05 UTC (1584980645)
[    2.705938] acpi_cpufreq: overriding BIOS provided _PSD data
[    2.715529] EXT4-fs (sda2): mounted filesystem without journal. Opts: (null)
[    2.722657] VFS: Mounted root (ext4 filesystem) readonly on device 8:2.
[    2.733843] Freeing unused kernel memory: 1084K
[    2.840308] Write protecting the kernel read-only data: 14336k
[    2.848692] Freeing unused kernel memory: 2016K
[    2.859306] Freeing unused kernel memory: 396K
[    2.878011] init: Console is alive
[    2.903271] kmodloader: loading kernel modules from /etc/modules-boot.d/*
[    2.914732] pps_core: LinuxPPS API ver. 1 registered
[    2.919726] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti <giometti@linux.it>
[    2.929794] PTP clock support registered
[    2.934237] Button Hotplug driver version 0.4.1
[    2.938913] kmodloader: done loading kernel modules from /etc/modules-boot.d/*
[    2.953207] init: - preinit -
[    3.010310] clocksource: Switched to clocksource tsc
[    3.036650] random: jshn: uninitialized urandom read (4 bytes read)
[    3.062250] random: jshn: uninitialized urandom read (4 bytes read)
[    3.087882] random: jshn: uninitialized urandom read (4 bytes read)
[    6.202973] mount_root: mounting /dev/root
[    6.207426] EXT4-fs (sda2): warning: mounting unchecked fs, running e2fsck is recommended
[    6.233492] EXT4-fs (sda2): re-mounted. Opts: (null)
[    6.267545] EXT4-fs (sda1): warning: mounting unchecked fs, running e2fsck is recommended
[    6.277006] EXT4-fs (sda1): mounted filesystem without journal. Opts: (null)
[    6.287687] urandom-seed: Seeding with /etc/urandom.seed
[    6.301400] procd: - early -
[    6.977603] procd: - ubus -
[    6.984112] urandom_read: 2 callbacks suppressed
[    6.984116] random: ubusd: uninitialized urandom read (4 bytes read)
[    7.032660] random: ubusd: uninitialized urandom read (4 bytes read)
[    7.039289] random: ubusd: uninitialized urandom read (4 bytes read)
[    7.046451] procd: - init -
[    7.133888] kmodloader: loading kernel modules from /etc/modules.d/*
[    7.142602] e1000: Intel(R) PRO/1000 Network Driver - version 7.3.21-k8-NAPI
[    7.149867] e1000: Copyright (c) 1999-2006 Intel Corporation.
[    7.157614] igb: Intel(R) Gigabit Ethernet Network Driver - version 5.4.0-k
[    7.162194] urngd: v1.0.2 started.
[    7.164680] igb: Copyright (c) 2007-2014 Intel Corporation.
[    7.197904] random: crng init done
[    7.201349] random: 2 urandom warning(s) missed due to ratelimiting
[    7.405198] pps pps0: new PPS source ptp0
[    7.409396] igb 0000:02:00.0: added PHC on eth0
[    7.414032] igb 0000:02:00.0: Intel(R) Gigabit Ethernet Network Connection
[    7.421527] igb 0000:02:00.0: eth0: (PCIe:2.5Gb/s:Width x1) 00:0d:b9:53:99:c8
[    7.428776] igb 0000:02:00.0: eth0: PBA No: FFFFFF-0FF
[    7.433998] igb 0000:02:00.0: Using MSI-X interrupts. 2 rx queue(s), 2 tx queue(s)
[    7.681193] pps pps1: new PPS source ptp1
[    7.685415] igb 0000:03:00.0: added PHC on eth1
[    7.689976] igb 0000:03:00.0: Intel(R) Gigabit Ethernet Network Connection
[    7.697336] igb 0000:03:00.0: eth1: (PCIe:2.5Gb/s:Width x1) 00:0d:b9:53:99:c9
[    7.704584] igb 0000:03:00.0: eth1: PBA No: FFFFFF-0FF
[    7.709871] igb 0000:03:00.0: Using MSI-X interrupts. 2 rx queue(s), 2 tx queue(s)
[    7.721566] ip6_tables: (C) 2000-2006 Netfilter Core Team
[    7.730349] i2c /dev entries driver
[    7.741314] e1000e: Intel(R) PRO/1000 Network Driver - 3.2.6-k
[    7.747460] e1000e: Copyright(c) 1999 - 2015 Intel Corporation.
[    7.755014] ip_tables: (C) 2000-2006 Netfilter Core Team
[    7.764693] nf_conntrack version 0.5.0 (16384 buckets, 65536 max)
[    7.790228] xt_time: kernel timezone is -0000
[    7.797915] PPP generic driver version 2.4.2
[    7.803046] NET: Registered protocol family 24
[    7.808635] kmodloader: done loading kernel modules from /etc/modules.d/*
[    9.881632] 8021q: adding VLAN 0 to HW filter on device eth1
[    9.888408] br-lan: port 1(eth1) entered blocking state
[    9.894102] br-lan: port 1(eth1) entered disabled state
[    9.899886] device eth1 entered promiscuous mode
[    9.906073] IPv6: ADDRCONF(NETDEV_UP): br-lan: link is not ready
[    9.959372] IPv6: ADDRCONF(NETDEV_UP): eth0: link is not ready
[    9.965648] 8021q: adding VLAN 0 to HW filter on device eth0
[   12.920815] igb 0000:03:00.0 eth1: igb: eth1 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX/TX
[   12.980810] igb 0000:02:00.0 eth0: igb: eth0 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX/TX
[   12.990542] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready
[   13.060463] br-lan: port 1(eth1) entered blocking state
[   13.065737] br-lan: port 1(eth1) entered forwarding state
[   13.071703] IPv6: ADDRCONF(NETDEV_CHANGE): br-lan: link becomes ready

*** network config
root@OpenWrt:~# ip ad
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq master br-wan state UP qlen 1000
    link/ether 00:0d:b9:53:99:c8 brd ff:ff:ff:ff:ff:ff
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq master br-lan state UP qlen 1000
    link/ether 00:0d:b9:53:99:c9 brd ff:ff:ff:ff:ff:ff
6: br-lan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 00:0d:b9:53:99:c9 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.1/24 brd 192.168.1.255 scope global br-lan
       valid_lft forever preferred_lft forever
    inet6 fdc5:5028:9959::1/60 scope global 
       valid_lft forever preferred_lft forever
    inet6 fe80::20d:b9ff:fe53:99c9/64 scope link 
       valid_lft forever preferred_lft forever
7: br-wan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 00:0d:b9:53:99:c8 brd ff:ff:ff:ff:ff:ff
    inet 192.168.6.39/24 brd 192.168.6.255 scope global br-wan
       valid_lft forever preferred_lft forever
    inet6 fe80::20d:b9ff:fe53:99c8/64 scope link 
       valid_lft forever preferred_lft forever
8: wlan1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master br-wan state UP qlen 1000
    link/ether 04:f0:21:54:37:cc brd ff:ff:ff:ff:ff:ff
    inet6 fe80::6f0:21ff:fe54:37cc/64 scope link 
       valid_lft forever preferred_lft forever
9: wlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master br-wan state UP qlen 1000
    link/ether 04:f0:21:56:00:39 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::6f0:21ff:fe56:39/64 scope link 
       valid_lft forever preferred_lft forever
root@OpenWrt:~# brctl show
bridge name     bridge id               STP enabled     interfaces
br-lan          7fff.000db95399c9       no              eth1
br-wan          7fff.000db95399c8       no              eth0
                                                        wlan1
                                                        wlan0

*** upgrading software packages
opkg update && opkg list-upgradable| awk '{print $1}'| tr '\n' ' '| xargs -r opkg upgrade

** rpi2 B v1.1 2014, transparent case
** rpi2 B+ v1.2 2014, black case
v1.2 has a 4x64-bit ARM
** recv -- rpi3 B+, heatsink case FLIRC
- hostname: recv
- debian buster
- 192.168.7.94
- eth MAC b8:27:eb:68:41:49
- uuid(1): c2fd46a8-1a77-11ea-ad3d-63f17a633433
- blkid: /dev/mmcblk0p2: LABEL="RASPIROOT" UUID="b8f2865e-b461-4e9b-b09e-c82747a07acf" TYPE="ext4" PARTUUID="7b658673-02"

** netgear prosafe gigabit 8 port VPN Firewall FVS318G
http://192.168.1.1 admin / ska11eper
mac e0:46:9a:b7:b0:03

** beaglebone black rev-c ("element14"), black case
** fcntl.4711.se -- SuperMicro 1U; quad intel; 2011
day-of-purchase 2011-?-?
motherboard:
RAM:
CPU: Intel(R) Xeon(R) CPU           X3440  @ 2.53GHz (2533.35-MHz K8-class CPU)
NIC: 2 x Intel 82574L Gigabit Ethernet Controller (82574L)

[root@fcntl ~]# sysctl hw | head -5
hw.machine: amd64
hw.model: Intel(R) Xeon(R) CPU           X3440  @ 2.53GHz
hw.ncpu: 8
hw.byteorder: 1234
hw.physmem: 8553656320
*** installing hbsd 10.3
10.3-STABLE-HBSD
switch port: dfri-sw:23 (stolen from slartibartfast <2016-11-11 Fri>)
inet 171.25.193.12 netmask 0xffffffc0 broadcast 171.25.193.63 
inet6 2001:67c:289c::12 prefixlen 64 

.ssh/config:
Host fcntl
     proxycommand ssh fcntlsshhs -W mothership:22
     CheckHostIP no
     VerifyHostKeyDNS no
     user root
     identityfile ~/ostick/keys/ssh/fcntl
Host fcntlsshhs
     hostname gylsy74pvxttlywo.onion
     CheckHostIP no
     VerifyHostKeyDNS no
     user root
     identityfile ~/ostick/keys/ssh/fcntl

torrc:
HidServAuth gylsy74pvxttlywo.onion 35Nqlr0HLUxmVTlu/4Ptoh       # sshhs@fcntl:22
**** todo when booted off of alternative media [3/3]
- [X] create mirrors
  for part in $(seq 6); do gmirror label p$part /dev/ada0p$part; done;
  for part in $(seq 6); do gmirror insert p$part /dev/ada1p$part; done;
- [X] update fstab
  mount /dev/mirror/p3 /mnt
  sed -i.bak -e 's|^/dev/ada0\(.*\) +|/dev/mirror/\1/g' /mnt/etc/fstab
  umount /mnt
- [X] copy boot stuff
  gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 ada1
**** todo when at console [1/1]
- [X] uncomment tmpfs in /etc/fstab and reboot
**** [0/2] secadm in jail 'maatuska'
- [ ] integriforce { path: "/usr/local/bin/tor", hash: FIXME, type: "sha256", mode: "hard" }
- [ ] maaaaaybe whitelist_mode: true    
**** geom, gmirror, gpart info
***** gpart(8)
****** BOOTSTRAPPING
     FreeBSD supports several partitioning schemes and each scheme uses dif‐
     ferent bootstrap code.  The bootstrap code is located in a specific disk
     area for each partitioning scheme, and may vary in size for different
     schemes.

     Bootstrap code can be separated into two types.  The first type is embed‐
     ded in the partitioning scheme's metadata, while the second type is
     located on a specific partition.  Embedding bootstrap code should only be
     done with the gpart bootcode command with the -b bootcode option.  The
     GEOM PART class knows how to safely embed bootstrap code into specific
     partitioning scheme metadata without causing any damage.

     The Master Boot Record (MBR) uses a 512-byte bootstrap code image, embed‐
     ded into the partition table's metadata area.  There are two variants of
     this bootstrap code: /boot/mbr and /boot/boot0.  /boot/mbr searches for a
     partition with the active attribute (see the ATTRIBUTES section) in the
     partition table.  Then it runs next bootstrap stage.  The /boot/boot0
     image contains a boot manager with some additional interactive functions
     for multi-booting from a user-selected partition.

     A BSD disklabel is usually created inside an MBR partition (slice) with
     type freebsd (see the PARTITION TYPES section).  It uses 8 KB size boot‐
     strap code image /boot/boot, embedded into the partition table's metadata
     area.

     Both types of bootstrap code are used to boot from the GUID Partition Ta‐
     ble.  First, a protective MBR is embedded into the first disk sector from
     the /boot/pmbr image.  It searches through the GPT for a freebsd-boot
     partition (see the PARTITION TYPES section) and runs the next bootstrap
     stage from it.  The freebsd-boot partition should be smaller than 545 KB.
     It can be located either before or after other FreeBSD partitions on the
     disk.  There are two variants of bootstrap code to write to this parti‐
     tion: /boot/gptboot and /boot/gptzfsboot.

     /boot/gptboot is used to boot from UFS partitions.  gptboot searches
     through freebsd-ufs partitions in the GPT and selects one to boot based
     on the bootonce and bootme attributes.  If neither attribute is found,
     /boot/gptboot boots from the first freebsd-ufs partition.  /boot/loader
     (the third bootstrap stage) is loaded from the first partition that
     matches these conditions.  See gptboot(8) for more information.

     /boot/gptzfsboot is used to boot from ZFS.  It searches through the GPT
     for freebsd-zfs partitions, trying to detect ZFS pools.  After all pools
     are detected, /boot/zfsloader is started from the first one found.

     The VTOC8 scheme does not support embedding bootstrap code.  Instead, the
     8 KBytes bootstrap code image /boot/boot1 should be written with the
     gpart bootcode command with the -p bootcode option to all sufficiently
     large VTOC8 partitions.  To do this the -i index option could be omitted.

     The APM scheme also does not support embedding bootstrap code.  Instead,
     the 800 KBytes bootstrap code image /boot/boot1.hfs should be written
     with the gpart bootcode command to a partition of type apple-boot, which
     should also be 800 KB in size.

****** EXAMPLES
     Create a GPT scheme on ada0:

           /sbin/gpart create -s GPT ada0

     Embed GPT bootstrap code into a protective MBR:

           /sbin/gpart bootcode -b /boot/pmbr ada0

     Create a dedicated freebsd-boot partition that can boot FreeBSD from a
     freebsd-ufs partition, and install bootstrap code into it.  This parti‐
     tion must be larger than the bootstrap code (usually either /boot/gptboot
     or /boot/gptzfsboot), but smaller than 545 kB since the first-stage
     loader will load the entire partition into memory during boot, regardless
     of how much data it actually contains.  This example uses 88 blocks (44
     kB) so the next partition will be aligned on a 64 kB boundary without the
     need to specify an explicit offset or alignment.  The boot partition
     itself is aligned on a 4 kB boundary.

           /sbin/gpart add -b 40 -s 88 -t freebsd-boot ada0
           /sbin/gpart bootcode -p /boot/gptboot -i 1 ada0

     Create a 512MB-sized freebsd-ufs partition to contain a UFS filesystem
     from which the system can boot.

           /sbin/gpart add -s 512M -t freebsd-ufs ada0

     Create an MBR scheme on ada0, then create a 30GB-sized FreeBSD slice,
     mark it active and install the boot0 boot manager:

           /sbin/gpart create -s MBR ada0
           /sbin/gpart add -t freebsd -s 30G ada0
           /sbin/gpart set -a active -i 1 ada0
           /sbin/gpart bootcode -b /boot/boot0 ada0

     Now create a BSD scheme (BSD label) with space for up to 20 partitions:

           /sbin/gpart create -s BSD -n 20 ada0s1

     Create a 1GB-sized UFS partition and a 4GB-sized swap partition:

           /sbin/gpart add -t freebsd-ufs -s 1G ada0s1
           /sbin/gpart add -t freebsd-swap -s 4G ada0s1

     Install bootstrap code for the BSD label:

           /sbin/gpart bootcode -b /boot/boot ada0s1

     Create a VTOC8 scheme on da0:

           /sbin/gpart create -s VTOC8 da0

     Create a 512MB-sized freebsd-ufs partition to contain a UFS filesystem
     from which the system can boot.

           /sbin/gpart add -s 512M -t freebsd-ufs da0

     Create a 15GB-sized freebsd-ufs partition to contain a UFS filesystem and
     aligned on 4KB boundaries:

           /sbin/gpart add -s 15G -t freebsd-ufs -a 4k da0

     After creating all required partitions, embed bootstrap code into them:

           /sbin/gpart bootcode -p /boot/boot1 da0

     Create a backup of the partition table from da0:

           /sbin/gpart backup da0 > da0.backup

     Restore the partition table from the backup to da0:

           /sbin/gpart restore -l da0 < /mnt/da0.backup

     Clone the partition table from ada0 to ada1 and ada2:

           /sbin/gpart backup ada0 | /sbin/gpart restore -F ada1 ada2
*** upgrading to hbsd 11-stable
**** failed hbsd-udpate from 10 to 11
[root@fcntl ~]# date
Wed Nov 14 15:52:32 CET 2018
[root@fcntl ~]# uname -a
FreeBSD fcntl.4711.se 10.4-STABLE-HBSD FreeBSD 10.4-STABLE-HBSD #0: Fri Mar 30 22:23:15 UTC 2018     root@updater-01:/usr/obj/usr/src/sys/HARDENEDBSD  amd64
[root@fcntl ~]# hbsd-update -C
[+] Local version: hbsd-v1000050-efbca994b402af6832a22a0130a007944bbdc465
[+] Remote version: hbsd-v1000050-efbca994b402af6832a22a0130a007944bbdc465 sha256 6b3ede25edeadcefec9f11cacf62e564c5f984b31a3fc683afe5631848fbc7d5
[root@fcntl ~]# cat /etc/hbsd-update-11-stable.conf | egrep -v ^#\|^\ *$
dnsrec="$(uname -m).master.11-stable.hardened.hardenedbsd.updates.hardenedbsd.org"
capath="/usr/share/keys/hbsd-update/trusted"
branch="hardened/11-stable/master"
baseurl="http://updates.hardenedbsd.org/pub/HardenedBSD/updates/${branch}/$(uname -m)"
[root@fcntl ~]# hbsd-update -c /etc/hbsd-update-11-stable.conf
/tmp/tmp.hsqmelDT/update.tar                  100% of  305 MB 2792 kBps 01m51s
[-] Warning: Could not find extra file script.sh.  Skipping validity checks for that file.

reboot

[root@fcntl ~]# screen
Shared object "libelf.so.1" not found, required by "screen"

[root@fcntl ~]# hbsd-update -C
hbsd-v1100056-c37a9e39ed1ad511bbe51c46c4228f33587d2d00
[+] Local version: hbsd-v1100056-c37a9e39ed1ad511bbe51c46c4228f33587d2d00
[+] Remote version: hbsd-v1100056-c37a9e39ed1ad511bbe51c46c4228f33587d2d00 sha256 11a993965536e39692a7297272cfee8080523097f8276b4adee25946bb0662ad
[root@fcntl ~]# uname -a
FreeBSD fcntl.4711.se 11.2-STABLE-HBSD FreeBSD 11.2-STABLE-HBSD #0 : Wed Nov  7 03:00:42 UTC 2018     root@updater-01:/usr/obj/usr/src/sys/HARDENEDBSD  amd64

[root@fcntl ~]# secadm list
sysctlbyname: No such file or directory
unable to get rules. error code: -1

[root@fcntl ~]# pkg-static install -f pkg
[root@fcntl ~]# pkg clean -y
[root@fcntl ~]# pkg upgrade -f

Here, kernel started panic and some 6h later, and a clean reinstall, I
suspect mac_biba to be the culprit. All the mac_* modules are disabled
and multilabel disabled for /. The system seems stable after
that. Re-adding modules one at a time, with days between, starting
with gmirror on <2018-11-20 Tue>.
**** base install
when booted from usb stick
  tunefs -l enable /dev/ada0p2
**** jail maatuska
pkg install bash git-lite
pkg install autoconf automake libtool libevent pkgconf lzma zstd gmake

**** disk mirroring
# in single user mode, booted from a stick
gpart backup ada0 | gpart restore -F ada1
gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 ada1
for part in 2 3; do gmirror label p$part /dev/ada0p$part; done 
mount /dev/ada0p2 /mnt
sed -i.bak -e 's|^/dev/ada0\(.*\) +|/dev/mirror/\1/g' /mnt/etc/fstab
umount /mnt
shutdown -r now
for part in 2 3; do gmirror insert p$part /dev/ada1p$part; done 
*** modermodemet.adb-centralen.se
**** IP addresses
193.10.5.101
2001:6b0:8::101
**** Disk layout
Base setup was done like described in http://wiki.freebsd.org/RootOnZFS/GPTZFSBoot/Mirror.

[root@modermodemet /etc]# egrep ad[0-9] /var/run/dmesg.boot 
ad5: 286168MB <WDC WD3000HLFS-01G6U1 04.04V02> at ata2-slave UDMA100 SATA 3Gb/s
ad6: 286168MB <WDC WD3000HLFS-01G6U1 04.04V02> at ata3-master UDMA100 SATA 3Gb/s

[root@modermodemet /etc]# gpart show
=>       34  586072301  ad5  GPT  (279G)
         34        128    1  freebsd-boot  (64K)
        162    8388608    2  freebsd-swap  (4.0G)
    8388770  577683565    3  freebsd-zfs  (275G)

=>       34  586072301  ad6  GPT  (279G)
         34        128    1  freebsd-boot  (64K)
        162    8388608    2  freebsd-swap  (4.0G)
    8388770  577683565    3  freebsd-zfs  (275G)

[root@modermodemet /etc]# zpool list
NAME    SIZE   USED  AVAIL    CAP  HEALTH  ALTROOT
zroot   274G  32.5G   241G    11%  ONLINE  -

[root@modermodemet /etc]# zpool status
  pool: zroot
 state: ONLINE
 scrub: none requested
config:

        NAME           STATE     READ WRITE CKSUM
        zroot          ONLINE       0     0     0
          mirror       ONLINE       0     0     0
            gpt/disk0  ONLINE       0     0     0
            gpt/disk1  ONLINE       0     0     0

errors: No known data errors

[root@modermodemet /etc]# cat /etc/fstab 
/dev/gpt/swap0 none swap sw 0 0
/dev/gpt/swap1 none swap sw 0 0

[root@modermodemet /etc]# pstat -s
Device          1K-blocks     Used    Avail Capacity
/dev/gpt/swap0    4194304        0  4194304     0%
/dev/gpt/swap1    4194304        0  4194304     0%
Total             8388608        0  8388608     0%

[root@modermodemet /etc]# zfs list
NAME                        USED  AVAIL  REFER  MOUNTPOINT
zroot                      32.5G   237G   290M  legacy
zroot/tmp                    32K   237G    32K  /tmp
zroot/usr                  32.2G   237G   575M  /usr
zroot/usr/home             31.0G   237G  31.0G  /usr/home
zroot/usr/ports             368M   237G   231M  /usr/ports
zroot/usr/ports/distfiles   121M   237G   121M  /usr/ports/distfiles
zroot/usr/ports/packages   16.4M   237G  16.4M  /usr/ports/packages
zroot/usr/src               308M   237G   308M  /usr/src
zroot/var                  11.3M   237G   230K  /var
zroot/var/crash            22.5K   237G  22.5K  /var/crash
zroot/var/db               7.27M   237G  4.59M  /var/db
zroot/var/db/pkg           2.68M   237G  2.68M  /var/db/pkg
zroot/var/empty              21K   237G    21K  /var/empty
zroot/var/log              1.45M   237G  1.45M  /var/log
zroot/var/mail             2.20M   237G  2.20M  /var/mail
zroot/var/run                54K   237G    54K  /var/run
zroot/var/tmp                23K   237G    23K  /var/tmp

**** Jail setup
***** How the base jail was set up
There is a base jail in /jail/base, installed like this:

  export JAILBASE=/jail/base
  cd /usr/src; make buildworld
  make installworld DESTDIR=$JAILBASE
  make distribution DESTDIR=$JAILBASE
  mkdir $JAILBASE/usr/ports
  portsnap -p $JAILBASE/usr/ports extract
  mkdir $JAILBASE/usr/local
  mkdir $JAILBASE/home

And with the following in /etc/rc.conf:

jail_enable=YES
jail_list="lntest lnproj lndfri jnj0"
jail_interface="em0"
jail_flags="-l -U root -s 3"
jail_sysvipc_allow=NO
jail_set_hostname_allow=NO
jail_socket_unixiproute_only=YES
jail_devfs_enable=YES
jail_devfs_ruleset="devfsrules_jail"

***** How to create a new jail
Create a new jail using the mkjail.sh script (in /root):

  /root/mkjail.sh ln test	# creates /jail/ln/test

Follow the instructions on what to add to /etc/fstab in the
mothership. Mount the new filesystems, mount -a.

Add config in rc.conf:

<add new jail to jail_list>

[root@modermodemet /jail/ln]# egrep ^jail_lntest /etc/rc.conf 
jail_lntest_rootdir=/jail/ln/test
jail_lntest_hostname=lntest.adb-centralen.se
jail_lntest_ip="10.0.0.1"       #"<v4>,<v6>"

Start the jail:

  /etc/rc.d/jail start <jail-name>

Get a shell:

  jexec <number, see jls> sh -

Set up the basics:
echo "nameserver 193.10.5.87" > /etc/resolv.conf
ln -s /usr/share/zoneinfo/Europe/Stockholm /etc/localtime
cat >> /etc/make.conf <<EOF
WRKDIRPREFIX=           /usr/local/ports
DISTDIR=                /usr/local/ports/distfiles
PACKAGES=               /usr/local/ports/packages
EOF
cd /usr/ports/ports-mgmt/portmaster && make install clean
portmaster -y ports-mgmt/portaudit && /usr/local/sbin/portaudit -Fda
echo daily_status_security_portaudit_enable=NO >> /etc/periodic.conf
portmaster -y shells/bash
chsh -s /usr/local/bin/bash root
bash -

cat >> /etc/rc.conf <<EOF
sendmail_enable=NONE
syslogd_flags="-C -4 -ss -vv"
EOF
/etc/rc.d/syslogd restart

**** Existing jails [4/11]
- [X] accept (IM)
      - [X] ejabberd
- [X] brk
      - [X] external MTA (postfix)
      - [X] postgrey
      - [X] dovecot SASL
- [ ] creat (webmail)
      - [ ] apache or lighttpd
      - [ ] horde or roundcube
- [ ] dup2
      - [ ] heimdal
- [ ] execve
      - [ ] imapd (cyrus or dovecot?)
- [X] jn0 193.10.5.107 2001:6b0:8::107
- [X] lnproj proj.adbcentralen.se (koseuhaeB3so)
      - [X] ikiwiki
- [ ] NAME
      - [ ] tor relay
      - [ ] tor bridge
- [ ] NAME
      - [ ] postfix MTA
- [ ] NAME
      - [ ] named or nsd and unbound (?)
- [ ] NAME -- proxy
      - [ ] tcp-over-dns
**** Strange things to look into
***** no buffer space available 2013-05-09
around 13:00 on 2013-05-09, mm stopped responding.
ping at console showed "no buffer space available".
see /root/*20130509* for details.
increased nmbclusters to 64' and rebooted.

at 11:36 on 2013-05-10, it happened again. i think that the kernel is
out of RAM. update: wait, that machine has 8GB. seems unlikely.

why is this happening now? 1) i started a few more jails on may which
could possibly consume some RAM, mostly bc of zfs i think, 2) do we
use lots of icmp or udp packets? that's (was?) supposedly a common
reason for "no buffer space available". what if we are being SYN
flooded or get lots of udp for some reason? do we see the "max RST"
log entries?

action friday 2013-05-10, before leaving town until monday night: 1)
run netstat -m, netstat -an, vmstat -z, pfctl -s a and record
results, 2) disable all unused jails, 3) disable all unused zfs
partitions/zones(?) from being mounted (/etc/fstab), 4) reboot and
record the stuff from above again

things done 2013-05-10:
- ifconfig down+up at 12:26 got things going again
- stopped and disabled a couple of jails, unmounted stuff
- keeping nmbclusters at 64000
- set up an hourly cron job that brings down+up em0 if we can't ping
  default gw. it also collects system data before and after doing
  that.
***** misc
Aug 31 09:48:17 modermodemet kernel: pid 78027 (try), uid 0: exited on signal 10 (core dumped)
**** Upgrading 8.2-RELEASE-p3 --> 8-STABLE
***** Upgrading the boot ZFS pool
in new world:
gpart bootcode -p /boot/gptzfsboot -i 1 ad5
gpart bootcode -p /boot/gptzfsboot -i 1 ad6

**** ejabberd <2012-11-24 Sat>
Upgrading beam, backup is somewhere where portmaster put it.
===>>> Upgrade of erlang-r14b04_2,1 to erlang-15.b.02_1,2 succeeded

Not restarting right now. This note is for the future when things just
break at restart.
**** out of buffer space, may 2013
<back story, see somewhere else>

Trouble since then:
<2013-05-14 Tue> CEST, xmpp-client
 * (5:38PM) read tcp 193.10.5.85:5222: connection reset by peer
<2013-05-15 Wed>
Wed May 15 13:53:55 2013 Client Disconnect: [0:ln5@193.10.5.108] Connection closed
<2013-05-31 Fri> the ifdownup script fired
<2013-06-05 Wed> 
Wed Jun  5 07:01:05 2013 IRC Connection Failed: 0:ln5@193.10.5.108 to oxygen.oftc.net port 0: DNS lookup failure or bad address
*** fcntl reachability from sunet
[linus@kcmp ~]$ while true; do ping -c 1 -t 1 fcntl.4711.se >/dev/null 2>&1 || date | tee -a fcntl-downtime; sleep 10 ; done
Thu Nov 15 04:41:20 CET 2018
Thu Nov 15 07:25:21 CET 2018
Thu Nov 15 12:16:53 CET 2018
Thu Nov 15 12:39:07 CET 2018
Thu Nov 15 13:03:13 CET 2018
Thu Nov 15 16:43:15 CET 2018
Thu Nov 15 17:15:42 CET 2018
Thu Nov 15 17:36:17 CET 2018
Thu Nov 15 17:36:28 CET 2018
Thu Nov 15 17:36:39 CET 2018
Thu Nov 15 17:37:00 CET 2018
Thu Nov 15 17:51:03 CET 2018
Thu Nov 15 17:51:14 CET 2018
Thu Nov 15 17:52:25 CET 2018
Thu Nov 15 17:52:37 CET 2018
Thu Nov 15 17:52:48 CET 2018
Thu Nov 15 17:54:39 CET 2018
Thu Nov 15 17:54:50 CET 2018
Thu Nov 15 17:55:01 CET 2018
Thu Nov 15 19:00:25 CET 2018
Thu Nov 15 19:47:13 CET 2018
Thu Nov 15 20:09:38 CET 2018
Thu Nov 15 21:46:26 CET 2018
Thu Nov 15 22:10:12 CET 2018
Fri Nov 16 06:27:39 CET 2018
Fri Nov 16 06:42:23 CET 2018
Fri Nov 16 07:01:58 CET 2018
Fri Nov 16 09:53:18 CET 2018
Fri Nov 16 10:15:24 CET 2018

** flogsta -- x60 32bit
** Dell 1425, 32-bit (temp loan from leif); office @ TUG
** apuapu -- apu1d firewall @home
Router and firewall at home.

*** updating base and packages
- reboot to securelevel -1
- hbsd-update
  /tmp/tmp.DU6hAxiz/update.tar                  100% of  287 MB   24 MBps 00m12s
- reboot into new kernel (securelevel=2)
- pkg upgrade -y

*** hardware
http://www.pcengines.ch/apu.htm
2G RAM
8G SD card
64G mSATA (not found)

SD card:
da0 15G GPT
da0p1 512k freebsd-boot
da0p2 6G freebsd-ufs /
da0p3 ~9G freebsd-ufs /usr

*** console access
minicom -D /dev/ttyUSB0

*** os
- hardenedbsd 10-STABLE (v40.1) installed in october 2016
- http://installer.hardenedbsd.org/releases/hardened_10_stable_master-LAST/

*** dmesg
[1] Copyright (c) 1992-2015 The FreeBSD Project.
[1] Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994
[1]     The Regents of the University of California. All rights reserved.
[1] FreeBSD is a registered trademark of The FreeBSD Foundation.
[1] FreeBSD 10.2-STABLE-HBSD #19 b7c236c(HEAD): Wed Oct  7 17:54:08 EDT 2015
[1]     root@nyi-01.build.hardenedbsd.org:/usr/obj/jenkins/workspace/HardenedBSD-stable-10-STABLE-amd64/sys/HARDENEDBSD amd64
[1] FreeBSD clang version 3.4.1 (tags/RELEASE_34/dot1-final 208032) 20140512
[1] PAX: initialize and check PaX and HardenedBSD features.
[1] [PAX LOG] logging to system: enabled
[1] [PAX LOG] logging to user: disabled
[1] [PAX ASLR] status: opt-out
[1] [PAX ASLR] mmap: 30 bit
[1] [PAX ASLR] exec base: 30 bit
[1] [PAX ASLR] stack: 42 bit
[1] [PAX ASLR] vdso: 28 bit
[1] [PAX ASLR] disallow MAP_32BIT mode mmap: opt-out
[1] [PAX PAGEEXEC] status: opt-out
[1] [PAX MPROTECT] status: opt-out
[1] [PAX HARDENING] procfs hardening: enabled
[1] [PAX HARDENING] randomize pids: enabled
[1] [PAX HARDENING] unset insecure init variables: enabled
[1] [PAX SEGVGUARD] status: opt-in
[1] [PAX SEGVGUARD] expiry: 120 sec
[1] [PAX SEGVGUARD] suspension: 600 sec
[1] [PAX SEGVGUARD] maxcrahes: 5
[1] CPU: AMD G-T40E Processor (1000.02-MHz K8-class CPU)
[1]   Origin="AuthenticAMD"  Id=0x500f20  Family=0x14  Model=0x2  Stepping=0
[1]   Features=0x178bfbff<FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CLFLUSH,MMX,FXSR,SSE,SSE2,HTT>
[1]   Features2=0x802209<SSE3,MON,SSSE3,CX16,POPCNT>
[1]   AMD Features=0x2e500800<SYSCALL,NX,MMX+,FFXSR,Page1GB,RDTSCP,LM>
[1]   AMD Features2=0x35ff<LAHF,CMP,SVM,ExtAPIC,CR8,ABM,SSE4A,MAS,Prefetch,IBS,SKINIT,WDT>
[1]   SVM: NP,NRIP,NAsids=8
[1]   TSC: P-state invariant, performance statistics
[1] real memory  = 2115420160 (2017 MB)
[1] avail memory = 2019016704 (1925 MB)
[1] Event timer "LAPIC" quality 400
[1] ACPI APIC Table: <CORE   COREBOOT>
[1] FreeBSD/SMP: Multiprocessor System Detected: 2 CPUs
[1] FreeBSD/SMP: 1 package(s) x 2 core(s)
[1]  cpu0 (BSP): APIC ID:  0
[1]  cpu1 (AP): APIC ID:  1
[1] random device not loaded; using insecure entropy
[1] ioapic0 <Version 2.1> irqs 0-23 on motherboard
[1] random: <Software, Yarrow> initialized
[1] kbd0 at kbdmux0
[1] module_register_init: MOD_LOAD (vesa, 0xffffffff80dc3a50, 0) error 19
[1] cryptosoft0: <software crypto> on motherboard
[1] aesni0: No AESNI support.
[1] acpi0: <CORE COREBOOT> on motherboard
[1] acpi0: Power Button (fixed)
[1] cpu0: <ACPI CPU> on acpi0
[1] cpu1: <ACPI CPU> on acpi0
[1] atrtc0: <AT realtime clock> port 0x70-0x71 irq 8 on acpi0
[1] Event timer "RTC" frequency 32768 Hz quality 0
[1] attimer0: <AT timer> port 0x40-0x43 irq 0 on acpi0
[1] Timecounter "i8254" frequency 1193182 Hz quality 0
[1] Event timer "i8254" frequency 1193182 Hz quality 100
[1] Timecounter "ACPI-fast" frequency 3579545 Hz quality 900
[1] acpi_timer0: <32-bit timer at 3.579545MHz> port 0x808-0x80b on acpi0
[1] hpet0: <High Precision Event Timer> iomem 0xfed00000-0xfed003ff on acpi0
[1] Timecounter "HPET" frequency 14318180 Hz quality 950
[1] Event timer "HPET" frequency 14318180 Hz quality 550
[1] Event timer "HPET1" frequency 14318180 Hz quality 450
[1] pcib0: <ACPI Host-PCI bridge> port 0xcf8-0xcff on acpi0
[1] pci0: <ACPI PCI bus> on pcib0
[1] pcib1: <ACPI PCI-PCI bridge> at device 4.0 on pci0
[1] pci1: <ACPI PCI bus> on pcib1
[1] re0: <RealTek 8168/8111 B/C/CP/D/DP/E/F/G PCIe Gigabit Ethernet> port 0x1000-0x10ff mem 0xfe600000-0xfe600fff,0xfe500000-0xfe503fff at device 0.0 on pci1
[1] re0: Using 1 MSI-X message
[1] re0: ASPM disabled
[1] re0: Chip rev. 0x2c000000
[1] re0: MAC rev. 0x00200000
[1] miibus0: <MII bus> on re0
[1] rgephy0: <RTL8169S/8110S/8211 1000BASE-T media interface> PHY 1 on miibus0
[1] rgephy0:  none, 10baseT, 10baseT-FDX, 10baseT-FDX-flow, 100baseTX, 100baseTX-FDX, 100baseTX-FDX-flow, 1000baseT, 1000baseT-master, 1000baseT-FDX, 1000baseT-FDX-mastw
[1] re0: Using defaults for TSO: 65518/35/2048
[1] re0: Ethernet address: 00:0d:b9:33:14:70
[1] pcib2: <ACPI PCI-PCI bridge> at device 5.0 on pci0
[1] pci2: <ACPI PCI bus> on pcib2
[1] re1: <RealTek 8168/8111 B/C/CP/D/DP/E/F/G PCIe Gigabit Ethernet> port 0x2000-0x20ff mem 0xfe800000-0xfe800fff,0xfe700000-0xfe703fff at device 0.0 on pci2
[1] re1: Using 1 MSI-X message
[1] re1: ASPM disabled
[1] re1: Chip rev. 0x2c000000
[1] re1: MAC rev. 0x00200000
[1] miibus1: <MII bus> on re1
[1] rgephy1: <RTL8169S/8110S/8211 1000BASE-T media interface> PHY 1 on miibus1
[1] rgephy1:  none, 10baseT, 10baseT-FDX, 10baseT-FDX-flow, 100baseTX, 100baseTX-FDX, 100baseTX-FDX-flow, 1000baseT, 1000baseT-master, 1000baseT-FDX, 1000baseT-FDX-mastw
[1] re1: Using defaults for TSO: 65518/35/2048
[1] re1: Ethernet address: 00:0d:b9:33:14:71
[1] pcib3: <ACPI PCI-PCI bridge> at device 6.0 on pci0
[1] pci3: <ACPI PCI bus> on pcib3
[1] re2: <RealTek 8168/8111 B/C/CP/D/DP/E/F/G PCIe Gigabit Ethernet> port 0x3000-0x30ff mem 0xfea00000-0xfea00fff,0xfe900000-0xfe903fff at device 0.0 on pci3
[1] re2: Using 1 MSI-X message
[1] re2: ASPM disabled
[1] re2: Chip rev. 0x2c000000
[1] re2: MAC rev. 0x00200000
[1] miibus2: <MII bus> on re2
[1] rgephy2: <RTL8169S/8110S/8211 1000BASE-T media interface> PHY 1 on miibus2
[1] rgephy2:  none, 10baseT, 10baseT-FDX, 10baseT-FDX-flow, 100baseTX, 100baseTX-FDX, 100baseTX-FDX-flow, 1000baseT, 1000baseT-master, 1000baseT-FDX, 1000baseT-FDX-mastw
[1] re2: Using defaults for TSO: 65518/35/2048
[1] re2: Ethernet address: 00:0d:b9:33:14:72
[1] ahci0: <AMD SB7x0/SB8x0/SB9x0 AHCI SATA controller> port 0x4020-0x4027,0x4040-0x4043,0x4028-0x402f,0x4044-0x4047,0x4000-0x400f mem 0xfeb08000-0xfeb083ff at device 10
[1] ahci0: AHCI v1.20 with 4 6Gbps ports, Port Multiplier supported
[1] ahci0: quirks=0x22000<ATI_PMP_BUG,1MSI>
[1] ahcich0: <AHCI channel> at channel 0 on ahci0
[1] ahcich1: <AHCI channel> at channel 1 on ahci0
[1] ahcich2: <AHCI channel> at channel 2 on ahci0
[1] ahcich3: <AHCI channel> at channel 3 on ahci0
[1] ohci0: <AMD SB7x0/SB8x0/SB9x0 USB controller> mem 0xfeb04000-0xfeb04fff at device 18.0 on pci0
[1] usbus0 on ohci0
[1] ehci0: <AMD SB7x0/SB8x0/SB9x0 USB 2.0 controller> mem 0xfeb08400-0xfeb084ff at device 18.2 on pci0
[1] usbus1: EHCI version 1.0
[1] usbus1 on ehci0
[1] ohci1: <AMD SB7x0/SB8x0/SB9x0 USB controller> mem 0xfeb05000-0xfeb05fff at device 19.0 on pci0
[1] usbus2 on ohci1
[1] ehci1: <AMD SB7x0/SB8x0/SB9x0 USB 2.0 controller> mem 0xfeb08500-0xfeb085ff at device 19.2 on pci0
[1] usbus3: EHCI version 1.0
[1] usbus3 on ehci1
[1] atapci0: <ATI IXP700/800 UDMA133 controller> port 0x1f0-0x1f7,0x3f6,0x170-0x177,0x376,0x4010-0x401f at device 20.1 on pci0
[1] ata0: <ATA channel> at channel 0 on atapci0
[1] ata1: <ATA channel> at channel 1 on atapci0
[1] isab0: <PCI-ISA bridge> at device 20.3 on pci0
[1] isa0: <ISA bus> on isab0
[1] pcib4: <ACPI PCI-PCI bridge> at device 20.4 on pci0
[1] pcib4: failed to allocate initial memory window: 0-0xfffff
[1] pcib4: failed to allocate initial prefetch window: 0-0xfffff
[1] pci5: <ACPI PCI bus> on pcib4
[1] ohci2: <AMD SB7x0/SB8x0/SB9x0 USB controller> mem 0xfeb06000-0xfeb06fff at device 20.5 on pci0
[1] usbus4 on ohci2
[1] pcib5: <ACPI PCI-PCI bridge> at device 21.0 on pci0
[1] pci4: <ACPI PCI bus> on pcib5
[1] ohci3: <AMD SB7x0/SB8x0/SB9x0 USB controller> mem 0xfeb07000-0xfeb07fff at device 22.0 on pci0
[1] usbus5 on ohci3
[1] ehci2: <AMD SB7x0/SB8x0/SB9x0 USB 2.0 controller> mem 0xfeb08600-0xfeb086ff at device 22.2 on pci0
[1] usbus6: EHCI version 1.0
[1] usbus6 on ehci2
[1] acpi_button0: <Power Button> on acpi0
[1] orm0: <ISA Option ROM> at iomem 0xee800-0xeffff on isa0
[1] ppc0: cannot reserve I/O port range
[1] uart0: <16550 or compatible> at port 0x3f8-0x3ff irq 4 flags 0x10 on isa0
[1] uart0: console (115200,n,8,1)
[1] uart1: <16550 or compatible> at port 0x2f8-0x2ff irq 3 on isa0
[1] Timecounters tick every 1.000 msec
[1] random: unblocking device.
[1] usbus0: 12Mbps Full Speed USB v1.0
[1] usbus1: 480Mbps High Speed USB v2.0
[1] usbus2: 12Mbps Full Speed USB v1.0
[1] usbus3: 480Mbps High Speed USB v2.0
[1] ugen0.1: <ATI> at usbus0
[1] uhub0: <ATI OHCI root HUB, class 9/0, rev 1.00/1.00, addr 1> on usbus0
[1] ugen1.1: <ATI> at usbus1
[1] uhub1: <ATI EHCI root HUB, class 9/0, rev 2.00/1.00, addr 1> on usbus1
[1] ugen2.1: <ATI> at usbus2
[1] uhub2: <ATI OHCI root HUB, class 9/0, rev 1.00/1.00, addr 1> on usbus2
[1] ugen3.1: <ATI> at usbus3
[1] uhub3: <ATI EHCI root HUB, class 9/0, rev 2.00/1.00, addr 1> on usbus3
[1] usbus4: 12Mbps Full Speed USB v1.0
[1] usbus5: 12Mbps Full Speed USB v1.0
[1] usbus6: 480Mbps High Speed USB v2.0
[1] ugen4.1: <ATI> at usbus4
[1] uhub4: <ATI OHCI root HUB, class 9/0, rev 1.00/1.00, addr 1> on usbus4
[1] ugen5.1: <ATI> at usbus5
[1] uhub5: <ATI OHCI root HUB, class 9/0, rev 1.00/1.00, addr 1> on usbus5
[1] ugen6.1: <ATI> at usbus6
[1] uhub6: <ATI EHCI root HUB, class 9/0, rev 2.00/1.00, addr 1> on usbus6
[1] uhub4: 2 ports with 2 removable, self powered
[1] uhub0: 5 ports with 5 removable, self powered
[1] uhub2: 5 ports with 5 removable, self powered
[1] uhub5: 4 ports with 4 removable, self powered
[2] uhub6: 4 ports with 4 removable, self powered
[3] uhub1: 5 ports with 5 removable, self powered
[3] uhub3: 5 ports with 5 removable, self powered
[3] ugen6.2: <Generic> at usbus6
[3] umass0: <Generic Flash Card ReaderWriter, class 0/0, rev 2.01/1.00, addr 2> on usbus6
[3] umass0:  SCSI over Bulk-Only; quirks = 0x4001
[3] umass0:6:0:-1: Attached to scbus6
[4] ugen1.2: <USB 2.0> at usbus1
[4] umass1: <USB 2.0 USB 2.0, class 0/0, rev 2.00/1.07, addr 2> on usbus1
[4] umass1:  SCSI over Bulk-Only; quirks = 0x4101
[4] umass1:7:1:-1: Attached to scbus7
[5] da1 at umass-sim1 bus 1 scbus7 target 0 lun 0
[5] da1: <Generic Flash Disk 8.07> Removable Direct Access SCSI-2 device
[5] da1: Serial Number CC06F232
[5] da1: 40.000MB/s transfers
[5] da1: 8045MB (16476160 512 byte sectors: 255H 63S/T 1025C)
[5] da1: quirks=0x2<NO_6_BYTE>
[5] da0 at umass-sim0 bus 0 scbus6 target 0 lun 0
[5] da0: <Multiple Card  Reader 1.00> Removable Direct Access SPC-2 SCSI device
[5] da0: Serial Number 058F63666485
[5] da0: 40.000MB/s transfers
[5] da0: Attempt to query device size failed: NOT READY, Medium not present
[5] da0: quirks=0x2<NO_6_BYTE>
[5] SMP: AP CPU #1 Launched!
[5] Timecounter "TSC" frequency 1000022692 Hz quality 800
[6] Trying to mount root from ufs:/dev/ufs/HardenedBSD_Install [ro,noatime]...
[11] re0: link state changed to DOWN
[11] re1: link state changed to DOWN
[11] re2: link state changed to DOWN
*** pciconf -lvbc
hostb0@pci0:0:0:0:      class=0x060000 card=0x15101022 chip=0x15101022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 14h Processor Root Complex'
    class      = bridge
    subclass   = HOST-PCI
pcib1@pci0:0:4:0:       class=0x060400 card=0x12341022 chip=0x15121022 rev=0x00 hdr=0x01
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 14h Processor Root Port'
    class      = bridge
    subclass   = PCI-PCI
    cap 01[50] = powerspec 3  supports D0 D3  current D0
    cap 10[58] = PCI-Express 2 root port slot max data 128(128) link x1(x1)
                 speed 2.5(5.0) ASPM L0s/L1(L0s/L1)
    cap 05[a0] = MSI supports 1 message, 64 bit
    cap 0d[b0] = PCI Bridge card=0x12341022
    cap 08[b8] = HT MSI fixed address window enabled at 0xfee00000
pcib2@pci0:0:5:0:       class=0x060400 card=0x12341022 chip=0x15131022 rev=0x00 hdr=0x01
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 14h Processor Root Port'
    class      = bridge
    subclass   = PCI-PCI
    cap 01[50] = powerspec 3  supports D0 D3  current D0
    cap 10[58] = PCI-Express 2 root port slot max data 128(128) link x1(x1)
                 speed 2.5(5.0) ASPM L0s/L1(L0s/L1)
    cap 05[a0] = MSI supports 1 message, 64 bit
    cap 0d[b0] = PCI Bridge card=0x12341022
    cap 08[b8] = HT MSI fixed address window enabled at 0xfee00000
pcib3@pci0:0:6:0:       class=0x060400 card=0x12341022 chip=0x15141022 rev=0x00 hdr=0x01
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 14h Processor Root Port'
    class      = bridge
    subclass   = PCI-PCI
    cap 01[50] = powerspec 3  supports D0 D3  current D0
    cap 10[58] = PCI-Express 2 root port slot max data 128(128) link x1(x1)
                 speed 2.5(5.0) ASPM L0s/L1(L0s/L1)
    cap 05[a0] = MSI supports 1 message, 64 bit
    cap 0d[b0] = PCI Bridge card=0x12341022
    cap 08[b8] = HT MSI fixed address window enabled at 0xfee00000
ahci0@pci0:0:17:0:      class=0x010601 card=0x43911002 chip=0x43911002 rev=0x40 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 SATA Controller [AHCI mode]'
    class      = mass storage
    subclass   = SATA
    bar   [10] = type I/O Port, range 32, base 0x4020, size 8, enabled
    bar   [14] = type I/O Port, range 32, base 0x4040, size 4, enabled
    bar   [18] = type I/O Port, range 32, base 0x4028, size 8, enabled
    bar   [1c] = type I/O Port, range 32, base 0x4044, size 4, enabled
    bar   [20] = type I/O Port, range 32, base 0x4000, size 16, enabled
    bar   [24] = type Memory, range 32, base 0xfeb08000, size 1024, enabled
    cap 12[70] = SATA Index-Data Pair
    cap 13[a4] = PCI Advanced Features: FLR TP
ohci0@pci0:0:18:0:      class=0x0c0310 card=0x43971002 chip=0x43971002 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 USB OHCI0 Controller'
    class      = serial bus
    subclass   = USB
    bar   [10] = type Memory, range 32, base 0xfeb04000, size 4096, enabled
ehci0@pci0:0:18:2:      class=0x0c0320 card=0x43961002 chip=0x43961002 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 USB EHCI Controller'
    class      = serial bus
    subclass   = USB
    bar   [10] = type Memory, range 32, base 0xfeb08400, size 256, enabled
    cap 01[c0] = powerspec 2  supports D0 D1 D2 D3  current D0
    cap 0a[e4] = EHCI Debug Port at offset 0xe0 in map 0x14
ohci1@pci0:0:19:0:      class=0x0c0310 card=0x43971002 chip=0x43971002 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 USB OHCI0 Controller'
    class      = serial bus
    subclass   = USB
    bar   [10] = type Memory, range 32, base 0xfeb05000, size 4096, enabled
ehci1@pci0:0:19:2:      class=0x0c0320 card=0x43961002 chip=0x43961002 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 USB EHCI Controller'
    class      = serial bus
    subclass   = USB
    bar   [10] = type Memory, range 32, base 0xfeb08500, size 256, enabled
    cap 01[c0] = powerspec 2  supports D0 D1 D2 D3  current D0
    cap 0a[e4] = EHCI Debug Port at offset 0xe0 in map 0x14
none0@pci0:0:20:0:      class=0x0c0500 card=0x15101022 chip=0x43851002 rev=0x42 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SBx00 SMBus Controller'
    class      = serial bus
    subclass   = SMBus
atapci0@pci0:0:20:1:    class=0x01018a card=0x439c1002 chip=0x439c1002 rev=0x40 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 IDE Controller'
    class      = mass storage
    subclass   = ATA
    bar   [20] = type I/O Port, range 32, base 0x4010, size 16, enabled
isab0@pci0:0:20:3:      class=0x060100 card=0x439d1002 chip=0x439d1002 rev=0x40 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 LPC host controller'
    class      = bridge
    subclass   = PCI-ISA
pcib4@pci0:0:20:4:      class=0x060401 card=0x00000000 chip=0x43841002 rev=0x40 hdr=0x01
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SBx00 PCI to PCI Bridge'
    class      = bridge
    subclass   = PCI-PCI
ohci2@pci0:0:20:5:      class=0x0c0310 card=0x43991002 chip=0x43991002 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 USB OHCI2 Controller'
    class      = serial bus
    subclass   = USB
    bar   [10] = type Memory, range 32, base 0xfeb06000, size 4096, enabled
pcib5@pci0:0:21:0:      class=0x060400 card=0x00001002 chip=0x43a01002 rev=0x00 hdr=0x01
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB700/SB800/SB900 PCI to PCI bridge (PCIE port 0)'
    class      = bridge
    subclass   = PCI-PCI
    cap 01[50] = powerspec 3  supports D0 D1 D2 D3  current D0
    cap 10[58] = PCI-Express 2 root port max data 128(128) link x16(x4)
                 speed undef(2.5) ASPM disabled(L0s/L1)
    cap 05[a0] = MSI supports 1 message, 64 bit
    cap 0d[b0] = PCI Bridge card=0x00001002
    cap 08[b8] = HT MSI fixed address window enabled at 0xfee00000
ohci3@pci0:0:22:0:      class=0x0c0310 card=0x43971002 chip=0x43971002 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 USB OHCI0 Controller'
    class      = serial bus
    subclass   = USB
    bar   [10] = type Memory, range 32, base 0xfeb07000, size 4096, enabled
ehci2@pci0:0:22:2:      class=0x0c0320 card=0x43961002 chip=0x43961002 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD/ATI]'
    device     = 'SB7x0/SB8x0/SB9x0 USB EHCI Controller'
    class      = serial bus
    subclass   = USB
    bar   [10] = type Memory, range 32, base 0xfeb08600, size 256, enabled
    cap 01[c0] = powerspec 2  supports D0 D1 D2 D3  current D0
    cap 0a[e4] = EHCI Debug Port at offset 0xe0 in map 0x14
hostb1@pci0:0:24:0:     class=0x060000 card=0x00000000 chip=0x17001022 rev=0x43 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 0'
    class      = bridge
    subclass   = HOST-PCI
hostb2@pci0:0:24:1:     class=0x060000 card=0x00000000 chip=0x17011022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 1'
    class      = bridge
    subclass   = HOST-PCI
hostb3@pci0:0:24:2:     class=0x060000 card=0x00000000 chip=0x17021022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 2'
    class      = bridge
    subclass   = HOST-PCI
hostb4@pci0:0:24:3:     class=0x060000 card=0x00000000 chip=0x17031022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 3'
    class      = bridge
    subclass   = HOST-PCI
    cap 0f[f0] = unknown
hostb5@pci0:0:24:4:     class=0x060000 card=0x00000000 chip=0x17041022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 4'
    class      = bridge
    subclass   = HOST-PCI
hostb6@pci0:0:24:5:     class=0x060000 card=0x00000000 chip=0x17181022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 6'
    class      = bridge
    subclass   = HOST-PCI
hostb7@pci0:0:24:6:     class=0x060000 card=0x00000000 chip=0x17161022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 5'
    class      = bridge
    subclass   = HOST-PCI
hostb8@pci0:0:24:7:     class=0x060000 card=0x00000000 chip=0x17191022 rev=0x00 hdr=0x00
    vendor     = 'Advanced Micro Devices, Inc. [AMD]'
    device     = 'Family 12h/14h Processor Function 7'
    class      = bridge
    subclass   = HOST-PCI
re0@pci0:1:0:0: class=0x020000 card=0x012310ec chip=0x816810ec rev=0x06 hdr=0x00
    vendor     = 'Realtek Semiconductor Co., Ltd.'
    device     = 'RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller'
    class      = network
    subclass   = ethernet
    bar   [10] = type I/O Port, range 32, base 0x1000, size 256, enabled
    bar   [18] = type Memory, range 64, base 0xfe600000, size 4096, enabled
    bar   [20] = type Prefetchable Memory, range 64, base 0xfe500000, size 16384, enabled
    cap 01[40] = powerspec 3  supports D0 D1 D2 D3  current D0
    cap 05[50] = MSI supports 1 message, 64 bit
    cap 10[70] = PCI-Express 2 endpoint IRQ 1 max data 128(128) link x1(x1)
                 speed 2.5(2.5) ASPM disabled(L0s/L1)
    cap 11[b0] = MSI-X supports 4 messages, enabled
                 Table in map 0x20[0x0], PBA in map 0x20[0x800]
    cap 03[d0] = VPD
re1@pci0:2:0:0: class=0x020000 card=0x012310ec chip=0x816810ec rev=0x06 hdr=0x00
    vendor     = 'Realtek Semiconductor Co., Ltd.'
    device     = 'RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller'
    class      = network
    subclass   = ethernet
    bar   [10] = type I/O Port, range 32, base 0x2000, size 256, enabled
    bar   [18] = type Memory, range 64, base 0xfe800000, size 4096, enabled
    bar   [20] = type Prefetchable Memory, range 64, base 0xfe700000, size 16384, enabled
    cap 01[40] = powerspec 3  supports D0 D1 D2 D3  current D0
    cap 05[50] = MSI supports 1 message, 64 bit
    cap 10[70] = PCI-Express 2 endpoint IRQ 1 max data 128(128) link x1(x1)
                 speed 2.5(2.5) ASPM disabled(L0s/L1)
    cap 11[b0] = MSI-X supports 4 messages, enabled
                 Table in map 0x20[0x0], PBA in map 0x20[0x800]
    cap 03[d0] = VPD
re2@pci0:3:0:0: class=0x020000 card=0x012310ec chip=0x816810ec rev=0x06 hdr=0x00
    vendor     = 'Realtek Semiconductor Co., Ltd.'
    device     = 'RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller'
    class      = network
    subclass   = ethernet
    bar   [10] = type I/O Port, range 32, base 0x3000, size 256, enabled
    bar   [18] = type Memory, range 64, base 0xfea00000, size 4096, enabled
    bar   [20] = type Prefetchable Memory, range 64, base 0xfe900000, size 16384, enabled
    cap 01[40] = powerspec 3  supports D0 D1 D2 D3  current D0
    cap 05[50] = MSI supports 1 message, 64 bit
    cap 10[70] = PCI-Express 2 endpoint IRQ 1 max data 128(128) link x1(x1)
                 speed 2.5(2.5) ASPM disabled(L0s/L1)
    cap 11[b0] = MSI-X supports 4 messages, enabled
                 Table in map 0x20[0x0], PBA in map 0x20[0x800]
    cap 03[d0] = VPD
*** config
**** system
sed -i.bak -e 's|\(/dev/da.*rw\)\(.*\)|\1,noatime\2|g' /etc/fstab

cat >> /etc/rc.conf <<EOF
kern_securelevel_enable=YES
kern_securelevel=2
ifconfig_re0="DHCP"
ifconfig_re1="inet 192.168.6.1"
ifconfig_re2="inet 192.168.7.1"
gateway_enable=YES
sshd_enable="YES"
dumpdev=NO
sendmail_enable=NONE
syslogd_flags="-C -4 -ss -vv"
EOF
**** pf
cat >> /etc/rc.conf <<EOF
pf_enable=YES
pflog_enable=YES
EOF

cat > /etc/pf.conf <<EOF
ext_if = "re0"
wlan_if = "re1"
wlan = "192.168.6.1"
lan_if = "re2"
lan = "192.168.7.1"
icmp_types  = "{echoreq, unreach}"
icmp6_types = "{echoreq, unreach, toobig, neighbradv, neighbrsol, routeradv}"
set skip on lo
scrub in
nat on $ext_if from ! ($ext_if) to any -> ($ext_if)
block in log
pass out
antispoof quick log for {lo $wlan_if $lan_if}
pass in from any to ! 192.168.7.0/24
pass in from any to ! 192.168.6.0/24
block in log from any to {192.168.6.1 192.168.7.1} label "protect firewall"
pass in on ! $ext_if inet proto {tcp udp} from any port bootpc to {$lan $wlan } port bootps label "dhcp"
pass in on $lan_if inet proto {tcp udp} from any to $lan port domain label "local resolver on lan"
pass in on $wlan_if inet proto {tcp udp} from any to $wlan port domain label "local resolver on wlan"
pass in on $lan_if inet proto tcp from any to 192.168.7.1 port 4722 label "local sshd"
pass inet  proto icmp  all icmp-type  $icmp_types
pass inet6 proto icmp6 all icmp6-type $icmp6_types
EOF
**** unbound
local_unbound_enable="YES"

FIXME: need to edit /etc/unbound/unbound.conf?

cat > /etc/unbound/conf.d/interface.conf <<EOF
server:
        interface: 127.0.0.1
        #interface: ::1
        interface: 192.168.7.1
        interface: 192.168.6.1

        access-control: 192.168.7.0/24 allow
        access-control: 192.168.6.0/24 allow
EOF
**** dhcpd
pkg install dhcpd

cat >> /etc/rc.conf <<EOF
dhcpd_enable=YES
dhcpd_flags="-c /usr/local/etc/dhcpd.conf re1 re2"
EOF

cat > /usr/local/etc/dhcpd.conf <<EOF
option subnet-mask 255.255.255.0;
default-lease-time 600;
max-lease-time 7200;
subnet 192.168.6.0 netmask 255.255.255.0 {
  range 192.168.6.10 192.168.6.100;
  option broadcast-address 192.168.6.255;
  option routers 192.168.6.1;
  option domain-name-servers 192.168.6.1;
}
subnet 192.168.7.0 netmask 255.255.255.0 {
  range 192.168.7.10 192.168.7.100;
  option broadcast-address 192.168.7.255;
  option routers 192.168.7.1;
  option domain-name-servers 192.168.7.1;
}
EOF

** lilleputt -- rpi2
fbsd 11.0-CURRENT
192.168.1.53
ssh on ziyxvw3j2a3sqhli.onion port 22
tor on 7000, nickname DFRIpi2001
** nuckie -- NUC @ home
- model NUC5i7RYH
- 19V / 3.43A
- manufactured 07/2015
- Intel Core i7-5557U 3.1Ghz "Broadwell-U", fifth generation
- https://en.wikipedia.org/wiki/Next_Unit_of_Computing
- mini HDMI, mini DP
- 1 x Gbps Ethernet
- 4 x USB3 + 2 x USB2 internal
- 2 x 1.35V DDR3L: 1x8G installed
- 1 x M.2: 120GB installed
*** hardened gentoo
[[file:~/p/hgd/hgd.org::*fourth try, on the NUC (i7)][fourth try, on the NUC (i7)]]
*** previos hbsd installation
os: hbsd 11-CURRENT installed <2016-04-04 Mon>
hostname: nuckie
CPU: Intel(R) Core(TM) i7-5557U CPU @ 3.10GHz (3092.94-MHz K8-class CPU)
CPU: 2 cores x 2 threads
RAM: 8G
SSD: ada0: <Samsung SSD 850 EVO M.2 120GB EMT21B6Q> ACS-2 ATA SATA 3.x device
HDD: da0: <WD Elements 10B8 1012> Fixed Direct Access SPC-4 SCSI device
HDD: da0: 1907697MB (3906963456 512 byte sectors)
*** updating base and packages
- hbsd-update
- pkg upgrade -y
- <2016-08-04 Thu> FreeBSD nuckie 12.0-CURRENT-HBSD FreeBSD 12.0-CURRENT-HBSD #0: Thu Aug  4 02:00:21 UTC 2016     root@laptop-dev-02:/usr/obj/usr/src/sys/HARDENEDBSD  amd64
*** fbsd bugs
**** LOR #261, ignore
Seeing LOR #261, see http://sources.zabbadoz.net/freebsd/lor.html
Reported first 2008-09-30
svn.freebsd.org/changeset/base/187474
https://lists.debian.org/debian-bsd/2013/05/msg00135.html

Example:
[967]  1st 0xfffffe01e9721990 bufwait (bufwait) @ /usr/src/sys/kern/vfs_bio.c:3488
[967]  2nd 0xfffff800045a0600 dirhash (dirhash) @ /usr/src/sys/ufs/ufs/ufs_dirhash.c:281

** x60 64bit
hardened gentoo

*** TODO [/]
- [ ] store a backup of the luks header on the backup hdd
- [ ] ?enable swap
- [ ] can grub pass the passphrase to initramfs somehow?
- [ ] is lvmetad running?
- [ ] is there a hardened profile with systemd?

** Lenovo G50-80 laptop "Musses dator"
CPU: i5-5200U (?)
Graphics: ?
RAM: 6G
SSD: ?
*** preinstalled windows
Windows 10 key, maybe: 00325-80233-16294-AAOEM
Serial number: PFOC86V8
When running on another computer, Windows reports *-JQKQQ
registry -> DigitalProductId: <cruft> <key above> 0x0 <cruft> [TH]X19-99523 <cruft>
registry -> DigitalProductId4: <cruft> 03612-03258-023-316294-02-1033-10240 <cruft>
phone call on <2016-01-01 Fri>, confirmation id for one computer:
  546866 555112 171921 194750 151833 703634 756360 419931 
** glinet -- GL-AR150 wifi @ VKG
https://wiki.openwrt.org/toh/gl-inet/gl-ar150
Firmware: 2.13 <2016-04-06 Wed>
LAN/WLAN IP: 192.168.10.1
DHCP client hostname: GL-AR150-a55
MAC wifi: E4:95:6E:40:6A:55
*** web interface
- http://192.168.10.1/
*** remote access over ssh
- connect to LAN/WLAN ethernet port
- killall dhclient; ifconfig eth0 192.168.10.2
- ssh config
Host glinet
     ProxyCommand /bin/nc %h %p
     user root
- ssh glinet
*** updating software
Configured for auto-update, see "Firmware" tab in web interface.
Currently, <2016-08-04 Thu>, at version 2.20.
*** cat /proc/cpuinfo
system type             : Atheros AR9330 rev 1
machine                 : GL_ar150 board
processor               : 0
cpu model               : MIPS 24Kc V7.4
BogoMIPS                : 265.42
wait instruction        : yes
microsecond timers      : yes
tlb_entries             : 16
extra interrupt vector  : yes
hardware watchpoint     : yes, count: 4, address/irw mask: [0x0ffc, 0x0ffc, 0x0ffb, 0x0ffb]
isa                     : mips1 mips2 mips32r1 mips32r2
ASEs implemented        : mips16
shadow register sets    : 1
kscratch registers      : 0
package                 : 0
core                    : 0
VCED exceptions         : not available
VCEI exceptions         : not available
** wifi extender 2 -- TP-LINK AC750 WiFi Range Extender RE210
LAN MAC: C0-25-E9-A6-91-64

This is mullvad property, i suppose.

Firmware Version: 	
3.14.2 Build 160623 Rel.43391n
Hardware Version: 	
RE210 v1 00000000

** wifi extender 1 -- TP-LINK AC750 WiFi Range Extender RE210
LAN MAC 18-D6-C7-9C-39-20

https://www.tp-link.com/en/home-networking/range-extender/re210/

*** 2018 -- in Junis room
Saw this on 'datan' <2018-03-08 Thu> when we had network trouble bc
the extender started offering DHCP:
? (192.168.0.254) at 18:d6:c7:9c:39:21 [ether] on wlp4s0

DHCPREQUEST of 192.168.0.101 on wlp4s0 to 255.255.255.255 port 67
DHCPOFFER of 192.168.0.101 from 192.168.0.254
DHCPACK of 192.168.0.101 from 192.168.0.254
bound to 192.168.0.101 -- renewal in 25 seconds.

What was fixed on <2018-03-08 Thu>
- change dhcp auto -> off
- change ssid for 2.4Ghz from "blahonga" to "blahonga_EXT"
- new pw for admin

*** 2020-10 -- to be at Kajsas

http://192.168.0.254/
admin/admin

TODO: New pw for admin, see passdb misc/tplink-wifi_extender:admin.

** Printer Canon Pixma TS6050 Series
Kopieringsapparat, skrivare, scanner.
Bläckstråle, färg (5-färgs).
WiFi och USB.

*** Info från [[https://new.webhallen.com/se/product/264720-Canon-Pixma-TS6050-Series-Farg-WiFi][webhallen]]
Release 	2017-03-14 
Tillverkarens artikelnr 	1368C006
Max. utskriftshastighet i färg: 	10 ipm (bilder per minut)
Max. utskriftshastighet i svartvitt: 	15 ipm (bilder per minut)
Automatisk duplex: 	Ja
Max upplösning färg: 	4800 x 1200 dpi
Scannerupplösning (optisk): 1200 x 2400 dpi 
Scanningsdjup (indata/utdata): Färg: 48 bitar/24 bitar, Gråskala: 16 bitar/8 bitar 
Skrivarupplösning: Upp till 4800 x 1200 dpi
Utskriftshastighet (svartvitt): Cirka 15 sidor per minut
Utskriftshastighet (färg): Cirka 10,0 sidor per minut
Fotoutskriftshastighet: 10 x 15 cm utan kant: cirka 39 sekunder
Kantfri utskrift: Ja (A4, Letter, 20 x 25 cm, 13 x 18 cm, 10 x 15 cm, 13 x 13 cm)
Dubbelsidig utskrift: Automatisk dubbelsidig utskrift (A4, A5, B5, Letter – vanligt papper) 
** junis speldator
NOTE: Windows license/product key taken from Lenovo G50-80 laptop
CPU:
RAM:
Device ID:
Windows Product ID:
*** uppgradering 2019
priser webhallen 2019-01-18
- amd ryzen 5 2600 1800:- kampanj -18%
  - https://www.webhallen.com/se/product/284732-AMD-Ryzen-5-2600
- asus rog strix b450-f gaming 1500:-
  - https://www.webhallen.com/se/product/288870-ASUS-ROG-STRIX-B450-F-Gaming-ATX-B450
- (asus rog strix b450-f gaming + ovan 3400:-, så 1600:- för plankan)
- corsair vengance DDR4 SDRAM 8GB 800:-
S:A 4100:-

att kolla upp
- vilken sorts RAM sitter i?
- klarar bef. kragg en AMD RS 2600?

** <noaname> speldator 2019
Bought from Gustav @ OBE on 2019-01-22, 3000 SEK
Windows 7
pw: hej123
** HISTORICAL
*** tbd0.nordberg.se -- SuperMicro 1U; former banksy.nordberg.se
 Intel(R) Core(TM)2 CPU          6400  @ 2.13GHz
 RT8139 (A/B/C/810x/813x/C+) Fast Ethernet Adapter

 day-of-purchase ???

 lnkrb	kerberos
 lndns	DNS
 lnweb	http, webmail
 lntest	xmpp
 lnmail	MTA, imap
 lnspam	SA, clamav
**** banksy domU freeze and raid failure <2011-09-24 Sat>
 Did a hard reboot around 11:30 into single user (root pw forgotten),
 mounted / and /usr and ran passwd.  Did exit and came up without the
 xen kernel.  Rebooted with reboot(8).

***** Conclusion
 /dev/wd1h doesn't feel well.  We're running the raid on /dev/wd0h only.

 Can't find any signs of physical disk failure in log files.

 <2011-09-25 Sun 01:02> Parity rebuilt. 
***** Notes from after last reboot
 -bash-4.0# hostname
 tbd0.nordberg.se
 -bash-4.0# date
 Sat Sep 24 11:45:31 CEST 2011
 -bash-4.0# tail /var/log/messages
 Sep 24 11:42:02 tbd0 ntpd[395]: Listening on interface #6 lo0, fe80::1#123 Enabled
 Sep 24 11:42:02 tbd0 ntpd[395]: Listening on interface #7 xvif1.0, fe80::216:3eff:fe01:87#123 Enabled
 Sep 24 11:42:02 tbd0 ntpd[395]: bind() fd 28, family 24, port 123, scope 5, addr fe80::f00b:a4ff:fef8:f70c, in6_is_addr_multicast=0 flags=0x11 fails: Can't assign requested address
 Sep 24 11:42:02 tbd0 ntpd[395]: unable to create socket on tap0 (8) for fe80::f00b:a4ff:fef8:f70c#123
 Sep 24 11:42:02 tbd0 ntpd[395]: failed to initialize interface for address fe80::f00b:a4ff:fef8:f70c
 Sep 24 11:42:02 tbd0 ntpd[395]: Listening on routing socket on fd #28 for interface updates
 Sep 24 11:42:02 tbd0 ntpd[395]: kernel time sync status 0x2040<UNSYNC,NANO,MODE=0x0=PLL,CLK=0x0=A>
 Sep 24 11:42:02 tbd0 ntpd[395]: frequency initialized 186.225 PPM from /var/db/ntp.drift
 Sep 24 11:42:02 tbd0 /netbsd: raid1: Error re-writing parity!
 Sep 24 11:42:03 tbd0 ntpd[395]: Listening on interface #9 tap0, fe80::f00b:a4ff:fef8:f70c#123 Enabled
 -bash-4.0# 

 -bash-4.0# egrep raid /var/log/messages
 Sep 24 11:39:45 tbd0 /netbsd: raid1: RAID Level 1
 Sep 24 11:39:45 tbd0 /netbsd: raid1: Components: /dev/wd0h /dev/wd1h[**FAILED**]
 Sep 24 11:39:45 tbd0 /netbsd: raid1: Total Sectors: 263377152 (128602 MB)
 Sep 24 11:39:45 tbd0 /netbsd: raid1: Error re-writing parity!
 Sep 24 11:41:58 tbd0 /netbsd: raidattach: Asked for 8 units
 Sep 24 11:41:58 tbd0 /netbsd: Last configured as: raid1
 Sep 24 11:41:58 tbd0 /netbsd: Last configured as: raid1
 Sep 24 11:41:58 tbd0 /netbsd: Configuring raid1:
 Sep 24 11:41:58 tbd0 /netbsd: raid1: allocating 20 buffers of 65536 bytes.
 Sep 24 11:41:58 tbd0 /netbsd: raid1: RAID Level 1
 Sep 24 11:41:58 tbd0 /netbsd: raid1: Components: /dev/wd0h /dev/wd1h[**FAILED**]
 Sep 24 11:41:58 tbd0 /netbsd: raid1: Total Sectors: 263377152 (128602 MB)
 Sep 24 11:41:58 tbd0 /netbsd: raid1: configured ok
 Sep 24 11:42:02 tbd0 /netbsd: raid1: Error re-writing parity!
 -bash-4.0# 

 -bash-4.0# raidctl -s raid1
 Components:
            /dev/wd0h: optimal
            /dev/wd1h: failed
 No spares.
 Component label for /dev/wd0h:
    Row: 0, Column: 0, Num Rows: 1, Num Columns: 2
    Version: 2, Serial Number: 123456, Mod Counter: 150
    Clean: No, Status: 0
    sectPerSU: 128, SUsPerPU: 1, SUsPerRU: 1
    Queue size: 100, blocksize: 512, numBlocks: 263377152
    RAID Level: 1
    Autoconfig: Yes
    Root partition: No
    Last configured as: raid1
 /dev/wd1h status is: failed.  Skipping label.
 Parity status: DIRTY
 Reconstruction is 100% complete.
 Parity Re-write is 100% complete.
 Copyback is 100% complete.
 -bash-4.0# 
***** Things from logs
 messages:
 Dec 14 22:13:32 tbd0 /netbsd: raid1: Error re-writing parity!
 Jul  4 08:30:56 tbd0 /netbsd: pid 370 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)
 Sep 24 08:28:45 tbd0 /netbsd: pid 1663 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)
 Sep 24 11:39:45 tbd0 syslogd: restart

 xen/xend.log:
 [2011-09-24 08:28:45 237] WARNING (image:470) domain banksy: device model failure: pid 1663: malfunctioning or died ?; see /var/log/xen/qemu-dm-banksy.log 

***** Rebuilding parity
 bash-4.0# raidctl -v -R /dev/wd1h raid1
 Reconstruction status:
  99% |***************************************| ETA:    00:01 |

 bash-4.0# raidctl -vs raid1
 Components:
            /dev/wd0h: optimal
            /dev/wd1h: optimal
 No spares.
 Component label for /dev/wd0h:
    Row: 0, Column: 0, Num Rows: 1, Num Columns: 2
    Version: 2, Serial Number: 123456, Mod Counter: 151
    Clean: No, Status: 0
    sectPerSU: 128, SUsPerPU: 1, SUsPerRU: 1
    Queue size: 100, blocksize: 512, numBlocks: 263377152
    RAID Level: 1
    Autoconfig: Yes
    Root partition: No
    Last configured as: raid1
 Component label for /dev/wd1h:
    Row: 0, Column: 1, Num Rows: 1, Num Columns: 2
    Version: 2, Serial Number: 123456, Mod Counter: 151
    Clean: No, Status: 0
    sectPerSU: 128, SUsPerPU: 1, SUsPerRU: 1
    Queue size: 100, blocksize: 512, numBlocks: 263377152
    RAID Level: 1
    Autoconfig: Yes
    Root partition: No
    Last configured as: raid1
 Parity status: clean
 Reconstruction is 100% complete.
 Parity Re-write is 100% complete.
 Copyback is 100% complete.
***** Plan
 - [ ] remove /dev/wd1h from the raid set and do smartctl -a /dev/wd1h

**** Issues
***** Crashing domu <2011-07-04 Mon>
 Jul  4 08:30:56 tbd0 /netbsd: pid 370 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)
 Jul  4 08:30:57 tbd0 /netbsd: tap0: detached

 -bash-4.0# xm list
 Name                                        ID   Mem VCPUs      State   Time(s)
 Domain-0                                     0   256     1     r----- 296016.7
 banksy                                       1  2048     1     ------ 1837426.4
**** TODO Fixa adressboken i webmailen
     SCHEDULED: <2008-08-24 Sun>
**** TODO Upgrade Lisp environment @ lntest [2/6]
     - [X] sbcl port
     - [X] slime/swank
     - [ ] pgsql
     - [ ] elephant
     - [ ] hunchentoot
     - [ ] weblocks
**** TODO Rotate logs on lnweb
 See http://httpd.apache.org/docs/2.2/logs.html#piped
**** DONE Upgrade to 6.3 or 7.1
***** 6.3
 Should be manageable to do with make world.
 Update: It was.
**** TODO Upgrade banksy to 7.x [0/9]
 - [ ] Buy a new disk and put it in mgv.
 - [ ] Install 7.x on it.
 - [ ] portupgrade all vital services on banksy.
 - [ ] portinstall the same servies on mgv.
 - [ ] Copy configuration banksy -> mgv and test.
 - [ ] Install the disk in banksy.
 - [ ] Boot up banksy w/o starting any services.
 - [ ] Copy mail (and configuration again) banksy -> mgv.
 - [ ] Bring it all up and verify functionality.
**** TODO Fix broken disk
***** Current status
 Aug  2 15:28:04 banksy kernel: ad0: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=23257439
 Aug 12 19:23:34 banksy su: linus to root on /dev/ttyp2
 Aug 12 19:31:57 banksy kernel: ichsmb0: <SMBus controller> port 0x1100-0x111f irq 19 at device 31.3 on pci0
 Aug 12 19:31:57 banksy kernel: ichsmb0: [GIANT-LOCKED]
 Aug 12 19:31:57 banksy kernel: smbus0: <System Management Bus> on ichsmb0
 Aug 12 19:31:57 banksy kernel: smb0: <SMBus generic I/O> on smbus0
 Aug 18 15:32:49 banksy su: linus to root on /dev/ttyp0
 Aug 29 09:00:24 banksy su: BAD SU linus to root on /dev/ttyp5
 Aug 29 09:00:27 banksy su: linus to root on /dev/ttyp5
 Aug 30 12:08:41 banksy kernel: ad0: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=72814123
 Aug 30 13:07:33 banksy kernel: ad0: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=72796523
 Aug 30 13:28:18 banksy kernel: ad2: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=37547035
 Aug 30 13:48:43 banksy kernel: ad0: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=156296384
 Aug 30 14:01:28 banksy kernel: ad0: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=114350669
 Aug 30 14:48:45 banksy kernel: ad0: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=72796523
 Aug 30 15:02:14 banksy kernel: ad0: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=72867883
 Aug 30 15:27:11 banksy kernel: ad0: FAILURE - READ_DMA status=51<READY,DSC,ERROR> error=40<UNCORRECTABLE> LBA=74046427
 Aug 30 15:27:11 banksy kernel: GEOM_MIRROR: Request failed (error=5). ad0s2[READ(offset=840433664, length=8192)]
 Aug 30 15:27:11 banksy kernel: GEOM_MIRROR: Device lnjail: provider ad0s2 disconnected.

 [root@banksy ~]# date
 Mon Sep  1 16:00:11 CEST 2008
 [root@banksy ~]# gmirror status
          Name    Status  Components
 mirror/lnjail  DEGRADED  ad2s2
 mirror/mrjail  COMPLETE  ad0s3
                          ad2s3

 [root@banksy ~]# gmirror list lnjail
 Geom name: lnjail
 State: DEGRADED
 Components: 2
 Balance: split
 Slice: 4096
 Flags: NONE
 GenID: 1
 SyncID: 1
 ID: 1092856437
 Providers:
 1. Name: mirror/lnjail
    Mediasize: 21467980288 (20G)
    Sectorsize: 512
    Mode: r2w2e3
 Consumers:
 1. Name: ad2s2
    Mediasize: 21467980800 (20G)
    Sectorsize: 512
    Mode: r1w1e1
    State: ACTIVE
    Priority: 1
    Flags: DIRTY
    GenID: 1
    SyncID: 1
    ID: 3671990636
****** smartctl -a /dev/ad0
******* Tue 2008-09-02
 smartctl version 5.38 [amd64-portbld-freebsd6.2] Copyright (C) 2002-8 Bruce Allen
 Home page is http://smartmontools.sourceforge.net/

 === START OF INFORMATION SECTION ===
 Model Family:     Seagate Barracuda 7200.9 family
 Device Model:     ST380811AS
 Serial Number:    9PS03T9Q
 Firmware Version: 3.AAE
 User Capacity:    80,026,361,856 bytes
 Device is:        In smartctl database [for details use: -P show]
 ATA Version is:   7
 ATA Standard is:  Exact ATA specification draft version not indicated
 Local Time is:    Mon Sep  1 19:47:14 2008 CEST
 SMART support is: Available - device has SMART capability.
 SMART support is: Enabled

 === START OF READ SMART DATA SECTION ===
 SMART overall-health self-assessment test result: PASSED

 General SMART Values:
 Offline data collection status:  (0x82) Offline data collection activity
                                         was completed without error.
                                         Auto Offline Data Collection: Enabled.
 Self-test execution status:      (   0) The previous self-test routine completed
                                         without error or no self-test has ever 
                                         been run.
 Total time to complete Offline 
 data collection:                 ( 430) seconds.
 Offline data collection
 capabilities:                    (0x5b) SMART execute Offline immediate.
                                         Auto Offline data collection on/off support.
                                         Suspend Offline collection upon new
                                         command.
                                         Offline surface scan supported.
                                         Self-test supported.
                                         No Conveyance Self-test supported.
                                         Selective Self-test supported.
 SMART capabilities:            (0x0003) Saves SMART data before entering
                                         power-saving mode.
                                         Supports SMART auto save timer.
 Error logging capability:        (0x01) Error logging supported.
                                         General Purpose Logging supported.
 Short self-test routine 
 recommended polling time:        (   1) minutes.
 Extended self-test routine
 recommended polling time:        (  27) minutes.

 SMART Attributes Data Structure revision number: 10
 Vendor Specific SMART Attributes with Thresholds:
 ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
   1 Raw_Read_Error_Rate     0x000f   119   100   006    Pre-fail  Always       -       0
   3 Spin_Up_Time            0x0003   095   095   000    Pre-fail  Always       -       0
   4 Start_Stop_Count        0x0032   100   100   020    Old_age   Always       -       21
   5 Reallocated_Sector_Ct   0x0033   100   100   036    Pre-fail  Always       -       6
   7 Seek_Error_Rate         0x000f   081   062   030    Pre-fail  Always       -       157008113
   9 Power_On_Hours          0x0032   099   099   000    Old_age   Always       -       1207
  10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always       -       0
  12 Power_Cycle_Count       0x0032   100   100   020    Old_age   Always       -       24
 187 Reported_Uncorrect      0x0032   099   099   000    Old_age   Always       -       1
 189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always       -       0
 190 Airflow_Temperature_Cel 0x0022   067   060   045    Old_age   Always       -       33 (Lifetime Min/Max 25/40)
 194 Temperature_Celsius     0x0022   033   040   000    Old_age   Always       -       33 (0 21 0 0)
 195 Hardware_ECC_Recovered  0x001a   066   050   000    Old_age   Always       -       146918911
 197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       11
 198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       11
 199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0
 200 Multi_Zone_Error_Rate   0x0000   100   253   000    Old_age   Offline      -       0
 202 TA_Increase_Count       0x0032   100   253   000    Old_age   Always       -       0

 SMART Error Log Version: 1
 ATA Error Count: 1
         CR = Command Register [HEX]
         FR = Features Register [HEX]
         SC = Sector Count Register [HEX]
         SN = Sector Number Register [HEX]
         CL = Cylinder Low Register [HEX]
         CH = Cylinder High Register [HEX]
         DH = Device/Head Register [HEX]
         DC = Device Command Register [HEX]
         ER = Error register [HEX]
         ST = Status register [HEX]
 Powered_Up_Time is measured from power on, and printed as
 DDd+hh:mm:SS.sss where DD=days, hh=hours, mm=minutes,
 SS=sec, and sss=millisec. It "wraps" after 49.710 days.

 Error 1 occurred at disk power-on lifetime: 1161 hours (48 days + 9 hours)
   When the command that caused the error occurred, the device was active or idle.

   After command completion occurred, registers were:
   ER ST SC SN CL CH DH
   -- -- -- -- -- -- --
   40 51 00 e7 db 69 e4  Error: UNC at LBA = 0x0469dbe7 = 74046439

   Commands leading to the command that caused the error were:
   CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name
   -- -- -- -- -- -- -- --  ----------------  --------------------
   c8 00 10 db db 69 e4 00      08:45:11.951  READ DMA
   c8 00 10 db 8d 6b e4 00      08:45:16.279  READ DMA
   c8 00 10 5b 92 6a e4 00      08:45:16.267  READ DMA
   ca 00 04 47 42 5e e4 00      08:45:16.248  WRITE DMA
   ca 00 20 cb 4c 5c e4 00      08:45:15.669  WRITE DMA

 SMART Self-test log structure revision number 1

 SMART Selective self-test log data structure revision number 1
  SPAN  MIN_LBA  MAX_LBA  CURRENT_TEST_STATUS
     1        0        0  Not_testing
     2        0        0  Not_testing
     3        0        0  Not_testing
     4        0        0  Not_testing
     5        0        0  Not_testing
 Selective self-test flags (0x0):
   After scanning selected spans, do NOT read-scan remainder of disk.
 If Selective self-test is pending on power-up, resume after 0 minute delay.

******* <2008-09-04 Thu 00:20> short self-test shows no errors
 smartctl version 5.38 [amd64-portbld-freebsd6.2] Copyright (C) 2002-8 Bruce Allen
 Home page is http://smartmontools.sourceforge.net/

 === START OF INFORMATION SECTION ===
 Model Family:     Seagate Barracuda 7200.9 family
 Device Model:     ST380811AS
 Serial Number:    9PS03T9Q
 Firmware Version: 3.AAE
 User Capacity:    80,026,361,856 bytes
 Device is:        In smartctl database [for details use: -P show]
 ATA Version is:   7
 ATA Standard is:  Exact ATA specification draft version not indicated
 Local Time is:    Thu Sep  4 00:18:47 2008 CEST
 SMART support is: Available - device has SMART capability.
 SMART support is: Enabled

 === START OF READ SMART DATA SECTION ===
 SMART overall-health self-assessment test result: PASSED

 General SMART Values:
 Offline data collection status:  (0x82) Offline data collection activity
                                         was completed without error.
                                         Auto Offline Data Collection: Enabled.
 Self-test execution status:      (   0) The previous self-test routine completed
                                         without error or no self-test has ever
                                         been run.
 Total time to complete Offline
 data collection:                 ( 430) seconds.
 Offline data collection
 capabilities:                    (0x5b) SMART execute Offline immediate.
                                         Auto Offline data collection on/off support.
                                         Suspend Offline collection upon new
                                         command.
                                         Offline surface scan supported.
                                         Self-test supported.
                                         No Conveyance Self-test supported.
                                         Selective Self-test supported.
 SMART capabilities:            (0x0003) Saves SMART data before entering
                                         power-saving mode.
                                         Supports SMART auto save timer.
 Error logging capability:        (0x01) Error logging supported.
                                         General Purpose Logging supported.
 Short self-test routine
 recommended polling time:        (   1) minutes.
 Extended self-test routine
 recommended polling time:        (  27) minutes.

 SMART Attributes Data Structure revision number: 10
 Vendor Specific SMART Attributes with Thresholds:
 ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
   1 Raw_Read_Error_Rate     0x000f   100   091   006    Pre-fail  Always       -       234743479
   3 Spin_Up_Time            0x0003   095   095   000    Pre-fail  Always       -       0
   4 Start_Stop_Count        0x0032   100   100   020    Old_age   Always       -       21
   5 Reallocated_Sector_Ct   0x0033   100   100   036    Pre-fail  Always       -       6
   7 Seek_Error_Rate         0x000f   081   062   030    Pre-fail  Always       -       159414997
   9 Power_On_Hours          0x0032   099   099   000    Old_age   Always       -       1253
  10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always       -       0
  12 Power_Cycle_Count       0x0032   100   100   020    Old_age   Always       -       24
 187 Reported_Uncorrect      0x0032   099   099   000    Old_age   Always       -       1
 189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always       -       0
 190 Airflow_Temperature_Cel 0x0022   067   060   045    Old_age   Always       -       33 (Lifetime Min/Max 25/40)
 194 Temperature_Celsius     0x0022   033   040   000    Old_age   Always       -       33 (0 21 0 0)
 195 Hardware_ECC_Recovered  0x001a   058   048   000    Old_age   Always       -       45953407
 197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       0
 198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       0
 199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0
 200 Multi_Zone_Error_Rate   0x0000   100   253   000    Old_age   Offline      -       0
 202 TA_Increase_Count       0x0032   100   253   000    Old_age   Always       -       0

 SMART Error Log Version: 1
 ATA Error Count: 1
         CR = Command Register [HEX]
         FR = Features Register [HEX]
         SC = Sector Count Register [HEX]
         SN = Sector Number Register [HEX]
         CL = Cylinder Low Register [HEX]
         CH = Cylinder High Register [HEX]
         DH = Device/Head Register [HEX]
         DC = Device Command Register [HEX]
         ER = Error register [HEX]
         ST = Status register [HEX]
 Powered_Up_Time is measured from power on, and printed as
 DDd+hh:mm:SS.sss where DD=days, hh=hours, mm=minutes,
 SS=sec, and sss=millisec. It "wraps" after 49.710 days.

 Error 1 occurred at disk power-on lifetime: 1161 hours (48 days + 9 hours)
   When the command that caused the error occurred, the device was active or idle.

   After command completion occurred, registers were:
   ER ST SC SN CL CH DH
   -- -- -- -- -- -- --
   40 51 00 e7 db 69 e4  Error: UNC at LBA = 0x0469dbe7 = 74046439

   Commands leading to the command that caused the error were:
   CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name
   -- -- -- -- -- -- -- --  ----------------  --------------------
   c8 00 10 db db 69 e4 00      08:45:11.951  READ DMA
   c8 00 10 db 8d 6b e4 00      08:45:16.279  READ DMA
   c8 00 10 5b 92 6a e4 00      08:45:16.267  READ DMA
   ca 00 04 47 42 5e e4 00      08:45:16.248  WRITE DMA
   ca 00 20 cb 4c 5c e4 00      08:45:15.669  WRITE DMA

 SMART Self-test log structure revision number 1
 Num  Test_Description    Status                  Remaining  LifeTime(hours)  LBA_of_first_error
 # 1  Short offline       Completed without error       00%      1253         -

 SMART Selective self-test log data structure revision number 1
  SPAN  MIN_LBA  MAX_LBA  CURRENT_TEST_STATUS
     1        0        0  Not_testing
     2        0        0  Not_testing
     3        0        0  Not_testing
     4        0        0  Not_testing
     5        0        0  Not_testing
 Selective self-test flags (0x0):
   After scanning selected spans, do NOT read-scan remainder of disk.
 If Selective self-test is pending on power-up, resume after 0 minute delay.

***** Breaking up the mirror
 [root@banksy ~]# gmirror remove -v ad0s2 lnjail
 No such device: ad0s2.

 [root@banksy ~]# gmirror forget -v lnjail
 Done.

 [root@banksy ~]# gmirror status lnjail
          Name    Status  Components
 mirror/lnjail  COMPLETE  ad2s2

 [root@banksy ~]# gmirror list lnjail
 Geom name: lnjail
 State: COMPLETE
 Components: 1
 Balance: split
 Slice: 4096
 Flags: NONE
 GenID: 1
 SyncID: 1
 ID: 1092856437
 Providers:
 1. Name: mirror/lnjail
    Mediasize: 21467980288 (20G)
    Sectorsize: 512
    Mode: r2w2e3
 Consumers:
 1. Name: ad2s2
    Mediasize: 21467980800 (20G)
    Sectorsize: 512
    Mode: r1w1e1
    State: ACTIVE
    Priority: 1
    Flags: NONE
    GenID: 1
    SyncID: 1
    ID: 3671990636
***** Adding the potentially broken disk again
 [root@banksy ~]# gmirror insert -v lnjail ad0s2
 Done.
 [root@banksy ~]# gmirror status  lnjail
          Name    Status  Components
 mirror/lnjail  DEGRADED  ad2s2
                          ad0s2 (1%)

 This didn't work out well:

 Sep  1 22:32:04 banksy kernel: GEOM_MIRROR: Device lnjail: provider ad0s2 detected.
 Sep  1 22:32:04 banksy kernel: GEOM_MIRROR: Device lnjail: rebuilding provider ad0s2.
 Sep  1 22:35:04 banksy kernel: ad2: FAILURE - READ_DMA status=51<READY,DSC,ERROR> error=40<UNCORRECTABLE> LBA=52421995
 Sep  1 22:35:04 banksy kernel: GEOM_MIRROR: Request failed (error=5). ad2s2[READ(offset=8588099584, length=131072)]
 Sep  1 22:35:04 banksy kernel: GEOM_MIRROR: Synchronization request failed (error=5). mirror/lnjail[READ(offset=8588099584, length=131072)]

****** smartctl -a /dev/ad2
******* Tue 2008-09-02
 smartctl version 5.38 [amd64-portbld-freebsd6.2] Copyright (C) 2002-8 Bruce Allen
 Home page is http://smartmontools.sourceforge.net/

 === START OF INFORMATION SECTION ===
 Model Family:     Seagate Barracuda 7200.9 family
 Device Model:     ST380811AS
 Serial Number:    9PS03F66
 Firmware Version: 3.AAE
 User Capacity:    80,026,361,856 bytes
 Device is:        In smartctl database [for details use: -P show]
 ATA Version is:   7
 ATA Standard is:  Exact ATA specification draft version not indicated
 Local Time is:    Mon Sep  1 23:08:14 2008 CEST
 SMART support is: Available - device has SMART capability.
 SMART support is: Enabled

 === START OF READ SMART DATA SECTION ===
 SMART overall-health self-assessment test result: PASSED

 General SMART Values:
 Offline data collection status:  (0x82) Offline data collection activity
                                         was completed without error.
                                         Auto Offline Data Collection: Enabled.
 Self-test execution status:      (   0) The previous self-test routine completed
                                         without error or no self-test has ever
                                         been run.
 Total time to complete Offline
 data collection:                 ( 430) seconds.
 Offline data collection
 capabilities:                    (0x5b) SMART execute Offline immediate.
                                         Auto Offline data collection on/off support.
                                         Suspend Offline collection upon new
                                         command.
                                         Offline surface scan supported.
                                         Self-test supported.
                                         No Conveyance Self-test supported.
                                         Selective Self-test supported.
 SMART capabilities:            (0x0003) Saves SMART data before entering
                                         power-saving mode.
                                         Supports SMART auto save timer.
 Error logging capability:        (0x01) Error logging supported.
                                         General Purpose Logging supported.
 Short self-test routine
 recommended polling time:        (   1) minutes.
 Extended self-test routine
 recommended polling time:        (  27) minutes.

 SMART Attributes Data Structure revision number: 10
 Vendor Specific SMART Attributes with Thresholds:
 ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
   1 Raw_Read_Error_Rate     0x000f   105   099   006    Pre-fail  Always       -       0
   3 Spin_Up_Time            0x0003   095   095   000    Pre-fail  Always       -       0
   4 Start_Stop_Count        0x0032   100   100   020    Old_age   Always       -       22
   5 Reallocated_Sector_Ct   0x0033   100   100   036    Pre-fail  Always       -       12
   7 Seek_Error_Rate         0x000f   081   060   030    Pre-fail  Always       -       129667895
   9 Power_On_Hours          0x0032   099   099   000    Old_age   Always       -       1285
  10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always       -       0
  12 Power_Cycle_Count       0x0032   100   100   020    Old_age   Always       -       25
 187 Reported_Uncorrect      0x0032   001   001   000    Old_age   Always       -       377
 189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always       -       0
 190 Airflow_Temperature_Cel 0x0022   068   060   045    Old_age   Always       -       32 (0 4 40 25)
 194 Temperature_Celsius     0x0022   032   040   000    Old_age   Always       -       32 (0 22 0 0)
 195 Hardware_ECC_Recovered  0x001a   069   046   000    Old_age   Always       -       133307865
 197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       2
 198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       2
 199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0
 200 Multi_Zone_Error_Rate   0x0000   100   253   000    Old_age   Offline      -       0
 202 TA_Increase_Count       0x0032   100   253   000    Old_age   Always       -       0

 SMART Error Log Version: 1
 ATA Error Count: 1
         CR = Command Register [HEX]
         FR = Features Register [HEX]
         SC = Sector Count Register [HEX]
         SN = Sector Number Register [HEX]
         CL = Cylinder Low Register [HEX]
         CH = Cylinder High Register [HEX]
         DH = Device/Head Register [HEX]
         DC = Device Command Register [HEX]
         ER = Error register [HEX]
         ST = Status register [HEX]
 Powered_Up_Time is measured from power on, and printed as
 DDd+hh:mm:SS.sss where DD=days, hh=hours, mm=minutes,
 SS=sec, and sss=millisec. It "wraps" after 49.710 days.

 Error 1 occurred at disk power-on lifetime: 1284 hours (53 days + 12 hours)
   When the command that caused the error occurred, the device was active or idle.

   After command completion occurred, registers were:
   ER ST SC SN CL CH DH
   -- -- -- -- -- -- --
   40 51 00 c1 e5 1f e3  Error: UNC at LBA = 0x031fe5c1 = 52422081

   Commands leading to the command that caused the error were:
   CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name
   -- -- -- -- -- -- -- --  ----------------  --------------------
   c8 00 80 6b e5 1f e3 00      08:56:46.220  READ DMA
   c8 00 80 eb e4 1f e3 00      08:56:46.217  READ DMA
   c8 00 80 6b e4 1f e3 00      08:56:46.233  READ DMA
   c8 00 80 eb e3 1f e3 00      08:56:46.232  READ DMA
   c8 00 80 6b e3 1f e3 00      08:56:46.231  READ DMA

 SMART Self-test log structure revision number 1

 SMART Selective self-test log data structure revision number 1
  SPAN  MIN_LBA  MAX_LBA  CURRENT_TEST_STATUS
     1        0        0  Not_testing
     2        0        0  Not_testing
     3        0        0  Not_testing
     4        0        0  Not_testing
     5        0        0  Not_testing
 Selective self-test flags (0x0):
   After scanning selected spans, do NOT read-scan remainder of disk.
 If Selective self-test is pending on power-up, resume after 0 minute delay.
******* <2008-09-04 Thu 00:15> Short self-test shows read error at same LBA as in error 1
 smartctl version 5.38 [amd64-portbld-freebsd6.2] Copyright (C) 2002-8 Bruce Allen
 Home page is http://smartmontools.sourceforge.net/

 === START OF INFORMATION SECTION ===
 Model Family:     Seagate Barracuda 7200.9 family
 Device Model:     ST380811AS
 Serial Number:    9PS03F66
 Firmware Version: 3.AAE
 User Capacity:    80,026,361,856 bytes
 Device is:        In smartctl database [for details use: -P show]
 ATA Version is:   7
 ATA Standard is:  Exact ATA specification draft version not indicated
 Local Time is:    Thu Sep  4 00:13:17 2008 CEST
 SMART support is: Available - device has SMART capability.
 SMART support is: Enabled

 === START OF READ SMART DATA SECTION ===
 SMART overall-health self-assessment test result: PASSED

 General SMART Values:
 Offline data collection status:  (0x82) Offline data collection activity
                                         was completed without error.
                                         Auto Offline Data Collection: Enabled.
 Self-test execution status:      ( 121) The previous self-test completed having
                                         the read element of the test failed.
 Total time to complete Offline
 data collection:                 ( 430) seconds.
 Offline data collection
 capabilities:                    (0x5b) SMART execute Offline immediate.
                                         Auto Offline data collection on/off support.
                                         Suspend Offline collection upon new
                                         command.
                                         Offline surface scan supported.
                                         Self-test supported.
                                         No Conveyance Self-test supported.
                                         Selective Self-test supported.
 SMART capabilities:            (0x0003) Saves SMART data before entering
                                         power-saving mode.
                                         Supports SMART auto save timer.
 Error logging capability:        (0x01) Error logging supported.
                                         General Purpose Logging supported.
 Short self-test routine
 recommended polling time:        (   1) minutes.
 Extended self-test routine
 recommended polling time:        (  27) minutes.

 SMART Attributes Data Structure revision number: 10
 Vendor Specific SMART Attributes with Thresholds:
 ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
   1 Raw_Read_Error_Rate     0x000f   103   093   006    Pre-fail  Always       -       46203848
   3 Spin_Up_Time            0x0003   095   095   000    Pre-fail  Always       -       0
   4 Start_Stop_Count        0x0032   100   100   020    Old_age   Always       -       22
   5 Reallocated_Sector_Ct   0x0033   100   100   036    Pre-fail  Always       -       12
   7 Seek_Error_Rate         0x000f   081   060   030    Pre-fail  Always       -       131594425
   9 Power_On_Hours          0x0032   099   099   000    Old_age   Always       -       1328
  10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always       -       0
  12 Power_Cycle_Count       0x0032   100   100   020    Old_age   Always       -       25
 187 Reported_Uncorrect      0x0032   001   001   000    Old_age   Always       -       378
 189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always       -       0
 190 Airflow_Temperature_Cel 0x0022   067   060   045    Old_age   Always       -       33 (0 4 40 25)
 194 Temperature_Celsius     0x0022   033   040   000    Old_age   Always       -       33 (0 22 0 0)
 195 Hardware_ECC_Recovered  0x001a   060   046   000    Old_age   Always       -       17935512
 197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       1
 198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       1
 199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0
 200 Multi_Zone_Error_Rate   0x0000   100   253   000    Old_age   Offline      -       0
 202 TA_Increase_Count       0x0032   100   253   000    Old_age   Always       -       0

 SMART Error Log Version: 1
 ATA Error Count: 2
         CR = Command Register [HEX]
         FR = Features Register [HEX]
         SC = Sector Count Register [HEX]
         SN = Sector Number Register [HEX]
         CL = Cylinder Low Register [HEX]
         CH = Cylinder High Register [HEX]
         DH = Device/Head Register [HEX]
         DC = Device Command Register [HEX]
         ER = Error register [HEX]
         ST = Status register [HEX]
 Powered_Up_Time is measured from power on, and printed as
 DDd+hh:mm:SS.sss where DD=days, hh=hours, mm=minutes,
 SS=sec, and sss=millisec. It "wraps" after 49.710 days.

 Error 2 occurred at disk power-on lifetime: 1285 hours (53 days + 13 hours)
   When the command that caused the error occurred, the device was active or idle.

   After command completion occurred, registers were:
   ER ST SC SN CL CH DH
   -- -- -- -- -- -- --
   40 51 00 a4 c8 c0 e0  Error: UNC at LBA = 0x00c0c8a4 = 12634276

   Commands leading to the command that caused the error were:
   CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name
   -- -- -- -- -- -- -- --  ----------------  --------------------
   c8 00 80 2f c8 c0 e0 00      00:29:47.339  READ DMA
   c8 00 80 1d c9 a2 e4 00      00:29:47.338  READ DMA
   c8 00 80 9d c8 a2 e4 00      00:29:47.338  READ DMA
   c8 00 80 1d c8 a2 e4 00      00:29:47.335  READ DMA
   c8 00 80 9d c7 a2 e4 00      00:29:47.335  READ DMA

 Error 1 occurred at disk power-on lifetime: 1284 hours (53 days + 12 hours)
   When the command that caused the error occurred, the device was active or idle.

   After command completion occurred, registers were:
   ER ST SC SN CL CH DH
   -- -- -- -- -- -- --
   40 51 00 c1 e5 1f e3  Error: UNC at LBA = 0x031fe5c1 = 52422081

   Commands leading to the command that caused the error were:
   CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name
   -- -- -- -- -- -- -- --  ----------------  --------------------
   c8 00 80 6b e5 1f e3 00      08:56:46.220  READ DMA
   c8 00 80 eb e4 1f e3 00      08:56:46.217  READ DMA
   c8 00 80 6b e4 1f e3 00      08:56:46.233  READ DMA
   c8 00 80 eb e3 1f e3 00      08:56:46.232  READ DMA
   c8 00 80 6b e3 1f e3 00      08:56:46.231  READ DMA

 SMART Self-test log structure revision number 1
 Num  Test_Description    Status                  Remaining  LifeTime(hours)  LBA_of_first_error
 # 1  Short offline       Completed: read failure       90%      1328         52422081

 SMART Selective self-test log data structure revision number 1
  SPAN  MIN_LBA  MAX_LBA  CURRENT_TEST_STATUS
     1        0        0  Not_testing
     2        0        0  Not_testing
     3        0        0  Not_testing
     4        0        0  Not_testing
     5        0        0  Not_testing
 Selective self-test flags (0x0):
   After scanning selected spans, do NOT read-scan remainder of disk.
 If Selective self-test is pending on power-up, resume after 0 minute delay.

***** Stoping the mirror
 [root@banksy ~]# gmirror stop -f lnjail
 Sep  1 23:15:42 banksy kernel: GEOM_MIRROR: Device lnjail: provider mirror/lnjail destroyed.
 Sep  1 23:15:42 banksy kernel: GEOM_MIRROR: Device lnjail: rebuilding provider ad0s2 stopped.
 Sep  1 23:15:42 banksy kernel: GEOM_MIRROR: Device lnjail destroyed.

 [root@banksy ~]# Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=131072, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=507904, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=385433600, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=385449984, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=385744896, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=385761280, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=385859584, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=770719744, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=770736128, length=16384)]error = 6
 Sep  1 23:16:04 banksy kernel: g_vfs_done():mirror/lnjaild[WRITE(offset=963346432, length=16384)]error = 6

***** Planning for replacing both disks
****** Partitioning one new disk.
 ad6s1 209G "banksy" (replacing ad0s1)
 ad6s2 29G "ln" (replacing mirrored ad0s2 and ad2s2)
 ad6s3 29G "mr" (replacing mirrored ad0s3 and ad2s3)
 ad6s4 28G "mk" (replacing ad2s1)
****** /stand/sysinstall
 Disk name:      ad6                                    FDISK Partition Editor
 DISK Geometry:  38913 cyls/255 heads/63 sectors = 625137345 sectors (305242MB)

 Offset       Size(ST)        End     Name  PType       Desc  Subtype    Flags

          0         63         62        -     12     unused        0
         63  440389782  440389844    ad6s1      8    freebsd      165
  440389845   62910540  503300384    ad6s2      8    freebsd      165
  503300385   62910540  566210924    ad6s3      8    freebsd      165
  566210925   58926420  625137344    ad6s4      8    freebsd      165
  625137345       5103  625142447        -     12     unused        0          
****** fdisk /dev/ad6
 \******* Working on device /dev/ad6 *******
 parameters extracted from in-core disklabel are:
 cylinders=620181 heads=16 sectors/track=63 (1008 blks/cyl)

 Figures below won't work with BIOS for partitions not in cyl 1
 parameters to be used for BIOS calculations are:
 cylinders=620181 heads=16 sectors/track=63 (1008 blks/cyl)

 Media sector size is 512
 Warning: BIOS sector numbering starts with sector 1
 Information from DOS bootblock is:
 The data for partition 1 is:
 sysid 165 (0xa5),(FreeBSD/NetBSD/386BSD)
     start 63, size 440389782 (215034 Meg), flag 80 (active)
         beg: cyl 0/ head 1/ sector 1;
         end: cyl 1023/ head 254/ sector 63
 The data for partition 2 is:
 sysid 165 (0xa5),(FreeBSD/NetBSD/386BSD)
     start 440389845, size 62910540 (30718 Meg), flag 80 (active)
         beg: cyl 1023/ head 255/ sector 63;
         end: cyl 1023/ head 254/ sector 63
 The data for partition 3 is:
 sysid 165 (0xa5),(FreeBSD/NetBSD/386BSD)
     start 503300385, size 62910540 (30718 Meg), flag 80 (active)
         beg: cyl 1023/ head 255/ sector 63;
         end: cyl 1023/ head 254/ sector 63
 The data for partition 4 is:
 sysid 165 (0xa5),(FreeBSD/NetBSD/386BSD)
     start 566210925, size 58926420 (28772 Meg), flag 80 (active)
         beg: cyl 1023/ head 255/ sector 63;
         end: cyl 1023/ head 254/ sector 63
****** Labeling the slices
******* banksy ad6s1
 # /dev/ad6s1:
 8 partitions:
 #        size   offset    fstype   
   b:  8388608   409600      swap                    
   c: 440389782        0    unused    
   d:   409600        0    4.2BSD    200M / 
   e:  4194304  8798208    4.2BSD    2G   /var
   f: 41943040 12992512    4.2BSD    20G  /usr
   g: 385454230 54935552    4.2BSD   183G /spare
******* lnjail ad6s2
 # /dev/ad6s2:
 8 partitions:
 #        size   offset    fstype
   c: 62910540        0    unused
   d:  2097152        0    4.2BSD    2G  /usr/jaildisk/ln/var
   e: 60813388  2097152    4.2BSD    28G /usr/jaildisk/ln
******* mrjail ad6s3
******* mkjail ad6s4
***** Fixing the problem
 <2008-09-02 Tue> When I came to U88 I could see that Banksy had
 rebooted and magically restored the mirrors.  It was unhappy about one
 single thing -- one of ad2s1d or ad2s1e didn't come up clean but
 needed manual fsck.  No trouble fixing it though.
***** DONE Make a proper backup
***** DONE Run self tests on the disks
 Short tests show no error on ad0 and same error on ad0 several times.
 Long test on ad0 shows no errors.
***** TODO Configure smartd to run
***** DONE Replace ad2 with the new disk
 Mirror everything.

 Partitioning
 slice size   size block  mirror	name
 adXs1        72404892    ad0s1	banksy
 adXs2 20481M 41945715    ad0s2	lnjail
 adXs3 20481M 41945715    ad0s3	mrjail
 adXs4 *	     *		 -	therest

 gmirror stop lnjail
 gmirror remove lnjail ad2s2
 gmirror remove lnjail ad0s2
 gmirror insert -p 1 lnjail ad0s2
 gmirror insert -i -p 0 lnjail adXs2
****** Geom name: lnjail
 State: COMPLETE
 Components: 2
 Balance: split
 Slice: 4096
 Flags: NONE
 GenID: 1
 SyncID: 1
 ID: 1092856437
 Providers:
 1. Name: mirror/lnjail
    Mediasize: 21467980288 (20G)
    Sectorsize: 512
    Mode: r2w2e3
 Consumers:
 1. Name: ad0s2
    Mediasize: 21476206080 (20G)
    Sectorsize: 512
    Mode: r1w1e1
    State: ACTIVE
    Priority: 0
    Flags: NONE
    GenID: 1
    SyncID: 1
    ID: 1786144702
 2. Name: ad2s2
    Mediasize: 21467980800 (20G)
    Sectorsize: 512
    Mode: r1w1e1
    State: ACTIVE
    Priority: 1
    Flags: NONE
    GenID: 1
    SyncID: 1
    ID: 3671990636
****** Geom name: mrjail
 State: COMPLETE
 Components: 2
 Balance: split
 Slice: 4096
 Flags: NONE
 GenID: 0
 SyncID: 1
 ID: 3586666150
 Providers:
 1. Name: mirror/mrjail
    Mediasize: 21467980288 (20G)
    Sectorsize: 512
    Mode: r2w2e3
 Consumers:
 1. Name: ad0s3
    Mediasize: 21476206080 (20G)
    Sectorsize: 512
    Mode: r1w1e1
    State: ACTIVE
    Priority: 0
    Flags: NONE
    GenID: 0
    SyncID: 1
    ID: 3346070460
 2. Name: ad2s3
    Mediasize: 21467980800 (20G)
    Sectorsize: 512
    Mode: r1w1e1
    State: ACTIVE
    Priority: 1
    Flags: NONE
    GenID: 0
    SyncID: 1
    ID: 685415508

****** ad0
 [root@banksy ~]# fdisk -s ad0
 /dev/ad0: 155061 cyl 16 hd 63 sec
 Part        Start        Size Type Flags
    1:          63    72404892 0xa5 0x80
    2:    72404955    41945715 0xa5 0x00
    3:   114350670    41945715 0xa5 0x00
 [root@banksy ~]# fdisk ad0
 \******* Working on device /dev/ad0 *******
 parameters extracted from in-core disklabel are:
 cylinders=155061 heads=16 sectors/track=63 (1008 blks/cyl)

 Figures below won't work with BIOS for partitions not in cyl 1
 parameters to be used for BIOS calculations are:
 cylinders=155061 heads=16 sectors/track=63 (1008 blks/cyl)

 Media sector size is 512
 Warning: BIOS sector numbering starts with sector 1
 Information from DOS bootblock is:
 The data for partition 1 is:
 sysid 165 (0xa5),(FreeBSD/NetBSD/386BSD)
     start 63, size 72404892 (35353 Meg), flag 80 (active)
         beg: cyl 0/ head 1/ sector 1;
         end: cyl 1023/ head 254/ sector 63
 The data for partition 2 is:
 sysid 165 (0xa5),(FreeBSD/NetBSD/386BSD)
     start 72404955, size 41945715 (20481 Meg), flag 0
         beg: cyl 1023/ head 255/ sector 63;
         end: cyl 1023/ head 254/ sector 63
 The data for partition 3 is:
 sysid 165 (0xa5),(FreeBSD/NetBSD/386BSD)
     start 114350670, size 41945715 (20481 Meg), flag 0
         beg: cyl 1023/ head 255/ sector 63;
         end: cyl 1023/ head 254/ sector 63
 The data for partition 4 is:
 <UNUSED>
***** TODO Mirror ad0s1
 Q: Can a slice with mounted file systems be a mirror provider?
***** TODO Mail mullet and inform them about the failing disks
**** DONE files has moved
 Apr 11 09:54:10 lnmail postfix/tlsmgr[98392]: warning: request to update file /usr/local/etc/postfix/prng_exch in non-postfix directory /usr/local/etc/postfix
 Apr 11 09:54:10 lnmail postfix/tlsmgr[98392]: warning: redirecting the request to postfix-owned data_directory /var/db/postfix
 Apr 11 09:54:10 lnmail postfix/tlsmgr[98392]: warning: request to update table btree:/usr/local/etc/postfix/smtpd_scache in non-postfix directory /usr/local/etc/postfix
 Apr 11 09:54:10 lnmail postfix/tlsmgr[98392]: warning: redirecting the request to postfix-owned data_directory /var/db/postfix

 Update <2008-09-04 Thu>: Change config, see main.cf:1.8.
**** TODO backup regularly [1/2]
 - [X] At least lnmail:/usr/local/cyrus/spool
 - [ ] Investigate misc/amanda-server misc/amanda-client or script dump
   with mechanism for increasing dump level (per file system) when
   a certain size of the backup is reached.
**** TODO make sure razor-agent isn't logging extensively to /
 Update: Well, it does. :-(  Fix it.  
**** TODO jails [2/3]
     - [ ] ntpd listens to all addresses, make it stop doing that
     - [X] populate jails/newjail and possibly create a flavour or two with
       - files in /etc
       - users? nah
       - packages -- put them in /pkg in new jail and flavours/XXX/ezjail.flavour
		     will install them
       - bash needs libintl.so.6, which is overwritten by libintl.so.8 from
         the gettext port.  We copy .6 from banksy (/usr/local/lib/compat/pkg).
     - [X] more packages in jail flavours:
       - all: postfix (w/o SASL)
****** DONE lnkrb: heimdal kdc
     export jname=lnkrb; export ushname=ln; export jipaddr=10.0.1.1
     ezjail-admin create -f default -r /usr/jaildisks/$ushname/$jname $jname $jipaddr
     [ -d /usr/jaildisks/$ushname/var/$jname ] && rmdir /usr/jaildisks/$ushname/var/$jname
     mv /usr/jaildisks/$ushname/$jname/var /usr/jaildisks/$ushname/var/$jname
     mkdir /usr/jaildisks/$ushname/$jname/var /usr/jaildisks/$ushname/$jname/u
     cat >> /etc/fstab.$jname <<EOF
 /usr/jaildisks/$ushname/var/$jname /usr/jaildisks/$ushname/$jname/var   nullfs rw 0 0
 /u                          /usr/jaildisks/$ushname/$jname/u     nullfs ro 0 0
 EOF
     /usr/local/etc/rc.d/ezjail.sh start $jname
	 
	  - migrate db from tage
	    tage# kadmin -l dump dumpfile
	    cp /var/heimdal/m-key and dumpfile tage -> lnkrb
	    lnkrb# kadmin -l init NORDBERG.SE
	    lnkrb# kadmin -l load dumpfile
****** DONE lnmail: postfix, imapd, sasl2
 - gmirror /usr/jaildisk/ln/imap-spool?  No, we'll keep the mail
	     on the same (mirrored) partition as all the rest -- the
	     18G /dev/mirror/lnjaile (ad0s2 + ad2s2).  We will need to move
	     this some day (we use 2.3G for /var/spool/imap on tage today) but
	     let's do first things first.
 - install postfix, cyrus imapd, sasl2
   - security/cyrus-sasl2-saslauthd		[done]
   - mail/cyrus-imapd23				[done]
 - configure
   - postfix to send incoming mail via lnspam	[done]
****** DONE lnspam: SA, clamav, mysql
 - mysql setup
 mysql -p < sa.dump
 mysql -p < horde_userpref.dump
 mysql -p
  use mysql;
  update user set password=password('PASSWORD') where user='root';
  replace into user (host, user, password) values ('lnspam', 'sa', password('PASSWORD'));
  replace into db (host, db, user, select_priv) values ('lnspam', 'sa', 'sa',  'Y');
  replace into db (host, db, user, select_priv) values ('lnspam', 'horde', 'sa',  'Y');
  flush privileges;
****** DONE lndns: bind
 - use named in base
 - rndc-confgen -a -t /var/named -u bind
****** DONE lnweb
 apache, php, horde, imp
****** DONE iommi.mobrules.nu:
     ezjail-admin create -f default -r /usr/jaildisks/mr/iommi iommi 10.0.2.1
     [ -d /usr/jaildisks/mr/var/iommi ] && rmdir /usr/jaildisks/mr/var/iommi
     mv /usr/jaildisks/mr/iommi/var /usr/jaildisks/mr/var/iommi
     mkdir /usr/jaildisks/mr/iommi/var /usr/jaildisks/mr/iommi/u
     cat >> /etc/fstab.iommi <<EOF
 /usr/jaildisks/mr/var/iommi /usr/jaildisks/mr/iommi/var   nullfs rw 0 0
 /u                          /usr/jaildisks/mr/iommi/u     nullfs ro 0 0
 EOF
     /usr/local/etc/rc.d/ezjail.sh start iommi
     jls
     jexec N bash -
**** TODO Verify
****** mail [2/4]
 - [X] incoming mail
   - from the net (fatburen?)
   - spam filtering
     - working at all
     - settings from mysql
   - virus filtering
   - mgv relaying with client cert (mgv)
   - sieve
   - mailing lists
     - tuben12
 - [X] outgoing mail
 - [ ] TLS w/ swox
   - incoming
   - outgoing
 - [ ] dns
   - dig @ns.nordberg.se smtp.nordberg.se
   - nordberg.se axfr @ swox
   - pull axfr from swox and other slaving for
**** Ports updates
 heimdal-0.7.2_2 --> 1.0.1
   had to readd /usr/ports/security/heimdal/files/kpasswdd-cracklib.c.in
   which disappeared, see http://www.freebsd.org/cgi/query-pr.cgi?pr=ports/115589

 [root@lnkrb ~]# /usr/local/etc/rc.d/kadmind.sh start kadmind[root@lnkrb ~]# /libexec/ld-elf.so.1: /usr/local/libexec/kadmind: Undefined symbol "kadm5_add_passwd_quality_verifier"

 Rebuilt w/o cracklib, still same problem.

 Seems like kadm5_add_passwd_quality_verifier disappeared from
 libkadm5srv.so between so.7 and so.8:

 [root@lnkrb ~]# for f in  /usr/local/lib/*.so; do nm -g $f | egrep kadm5_add && echo $f; done
 000000000000ab00 T kadm5_add_passwd_quality_verifier
 /usr/local/lib/libkadm5srv.so
 [root@lnkrb ~]# ls -l /usr/local/lib/libkadm5srv.so
 lrwxr-xr-x  1 root  wheel  16 Oct 15 23:25 /usr/local/lib/libkadm5srv.so -> libkadm5srv.so.8

 [root@lnkrb ~]# ldconfig -r |egrep libkadm5srv
         72:-lkadm5srv.8 => /usr/lib/libkadm5srv.so.8
         99:-lkadm5srv.8 => /usr/local/lib/libkadm5srv.so.8
         110:-lkadm5srv.7 => /usr/local/lib/compat/pkg/libkadm5srv.so.7
**** DONE SSL/TLS from a cell phone
****** submission (587) + SSL
 Hanging.
****** submission (587) + TLS
 Works!

 But it's hard to get it right in the phone.  Things change under your
 feet, at least on the k550i.
****** smtps (465) + SSL


****** smtps (465) + TLS
 Sep 10 20:03:25 lnmail postfix/smtpd[96063]: connect from m83-178-20-219.cust.tele2.se[83.178.20.219]
 Sep 10 20:03:29 lnmail postfix/smtpd[96063]: SSL_accept error from m83-178-20-219.cust.tele2.se[83.178.20.219]: 0
 Sep 10 20:03:29 lnmail postfix/smtpd[96063]: warning: TLS library problem: 96063:error:14094438:SSL routines:SSL3_READ_BYTES:tlsv1 alert internal error:/u/FreeBSD/RELENG_6_2/src/secure/lib/libssl/../../../crypto/openssl/ssl/s3_pkt.c:1052:SSL alert number 80:
 Sep 10 20:03:29 lnmail postfix/smtpd[96063]: SSL_accept error from m83-178-20-219.cust.tele2.se[83.178.20.219]: 0
 Sep 10 20:03:29 lnmail postfix/smtpd[96063]: warning: TLS library problem: 96063:error:14094438:SSL routines:SSL3_READ_BYTES:tlsv1 alert internal error:/u/FreeBSD/RELENG_6_2/src/secure/lib/libssl/../../../crypto/openssl/ssl/s3_pkt.c:1052:SSL alert number 80:
 Sep 10 20:03:29 lnmail postfix/smtpd[96063]: lost connection after STARTTLS from m83-178-20-219.cust.tele2.se[83.178.20.219]
 Sep 10 20:03:29 lnmail postfix/smtpd[96063]: disconnect from m83-178-20-219.cust.tele2.se[83.178.20.219]
**** DONE Synchronize and fix names
****** sync tage:/home/mail-arch --> lnmail:/var/mail-archive
     -rw-rw-r--  1 root  nobody      7346 Jun 11 19:22 test
     -rw-rw-r--  1 root  nobody   1423994 Jun 11 19:22 tuben12-styrelsen
     -rw-rw-r--  1 root  nobody  21817220 Jun 11 19:23 tunnelgruppen

****** remove 'x' from names
     - /usr/local/etc/imapd.conf: servername imapx -> imap
     - /usr/local/etc/postfix/main.cf: smtp_helo_name smtpx -> smtp

****** move imap users and mail spool (2.4G)
     tage# SSH_AUTH_SOCK=/tmp/ssh-XXX/agent.YYY rsync -az --bwlimit=100 --delete-after -e "ssh -p 60222" /var/spool/imap/comp /var/spool/imap/local /var/spool/imap/user cyrus@banksy:/usr/local/cyrus/spool/
     tage# rsync -avz -e "ssh -p 60222" /var/imap/user cyrus@banksy:/var/imap/
     move /var/imap/mailboxes.db, and more?
     lnmail# su - cyrus
     lnmail% bin/reconstruct  # might need -r and/or -f; should list all mboxes

****** copy mysql data from svc0 -> lnspam
     - bayes data: mysqldump -p --opt sa
     - SA config: mysqldump -p --opt horde userpref
**** DONE The swap
 - pull ethernet cable from tage switch to banksy, don't connect
 - configure tage to not start any of postfix, imapd, bind (more?)
 - change IP addresses in config files on both hosts
   /etc/rc.conf
   /etc/pf.conf
   /etc/resolv.conf
   .zone files
 - stop postfix and imapd on tage, take care of postfix spool somehow
 - sync imapd mail spool one last time, including /var/imap/user (.seen files)
 - bring tage off the net by disconnecting ethernet, connect banksy to tages
   switch port
 - reboot banksy and check IP address (.22)
 - verify DNS, incoming mail
 - reboot tage, check IP address (.24), verify that no services are running
 - connect tage to the net

**** jails
***** jail setup
    # example from setting up 'lnmail'
     export jname=lnmail; export ushname=ln; export jipaddr=10.0.1.2
     ezjail-admin create -f ln -r /usr/jaildisks/$ushname/$jname $jname $jipaddr
     [ -d /usr/jaildisks/$ushname/var/$jname ] && rmdir /usr/jaildisks/$ushname/var/$jname
     mv /usr/jaildisks/$ushname/$jname/var /usr/jaildisks/$ushname/var/$jname
     mkdir /usr/jaildisks/$ushname/$jname/var /usr/jaildisks/$ushname/$jname/u
     cat >> /etc/fstab.$jname <<EOF
 /usr/jaildisks/$ushname/var/$jname /usr/jaildisks/$ushname/$jname/var   nullfs rw 0 0
 /u                          /usr/jaildisks/$ushname/$jname/u     nullfs ro 0 0
 EOF
     /usr/local/etc/rc.d/ezjail.sh start $jname
***** unionfs
****** crashing kernel by playing with unionfs
 banksy# mount_unionfs -b /u/distfiles /usr/jaildisks/ln/lnmail/var/ports/distfiles
 banksy# touch /u/distfiles/ON-BANKSY
 lnmail# echo foo >> /var/ports/distfiles/ON-BANKSY
 <system rebooting>
**** backup
***** shaping
 # pfctl -sq
 queue root_em0 bandwidth 2Mb priority 0 cbq( wrr root ) {bup}
 queue  bup bandwidth 200Kb cbq( default ) 
 # dd if=/dev/zero bs=1k count=200 | nc tage 30001
 204800 bytes transferred in 6.766418 secs (30267 bytes/sec)
 307200 bytes transferred in 10.385779 secs (29579 bytes/sec)
 512000 bytes transferred in 21.796291 secs (23490 bytes/sec)
 1048576 bytes transferred in 54.066851 secs (19394 bytes/sec)

 # pfctl -sq
 queue root_em0 bandwidth 2Mb priority 0 cbq( wrr root ) {bup}
 queue  bup bandwidth 100Kb cbq( default ) 
 # dd if=/dev/zero bs=1k count=200 | nc tage 30001
 204800 bytes transferred in 13.644918 secs (15009 bytes/sec)
 307200 bytes transferred in 22.305276 secs (13773 bytes/sec)
 512000 bytes transferred in 44.920969 secs (11398 bytes/sec)
 1048576 bytes transferred in 99.905841 secs (10496 bytes/sec)

**** kerberos
***** get keytabs for hosts
 kadmin> ank --random-key host/lnmail.nordberg.se@NORDBERG.SE
 kadmin> ext host/lnmail.nordberg.se@NORDBERG.SE
***** DONE setup ssh with kerberos authentication
**** Installation of various ports
***** www/horde-meta
 options for meta: nothing changed, we'll get imp, ingo, turba, nag
 horde-3.1.5
 pear-1.6.2
 php-5.2.5

 Stop!  We really don't want all this X11 stuff.  Getting glibc and gtk
 feels just wrong just now.  Let's try to tweak horde-base to start
 with:

 lang/php5*, horde-meta, horde-base: WITHOUT_X11
 horde-ingo: WITH_SIEVE

 Argh, we need WITH_APACHE for lang/php5.  Strange that we didn't get
 that curses dialog when building php5 by means of www/horde-meta.
 Wonder if BATCH was defined somehow?
**** Disk geometry (original disks)
 sysinstall suggests 9729 cylinders / 255 heads / 63 sectors (76316 MB)
 and we let it be that way.
**** Disk layout
 2x74G: ad0 and ad2.
 2008-09: ad2 was replaced with a 320G Samsung.
***** ad0
 One 34G (35353M) slice for the host (ad0s1).
 Two 20G (20481M) slices for linus (ad0s2) and jonasg (ad0s3).
****** ad0s1 34G banksy
 ad0s1a 193M /
 ad0s1b 2G   swap
 ad0s1d 989M /var
 ad0s1e 9.7G /usr
 ad0s1f 9.7G unused
 ad0s1g 11G  /u
******* bsdlabel
 # /dev/ad0s1:
 8 partitions:
 #        size   offset    fstype   [fsize bsize bps/cpg]
   a:   409600        0    4.2BSD     2048 16384 25608 
   b:  4194304   409600      swap                    
   c: 72404892        0    unused        0     0         # "raw" part, don't edit
   d:  2097152  4603904    4.2BSD     2048 16384 28528 
   e: 20971520  6701056    4.2BSD     2048 16384 28528 
   f: 20971520 27672576    4.2BSD     2048 16384 28528 
   g: 23760796 48644096    4.2BSD     2048 16384 28528 
****** ad0s2 20G linus (ln) mirror w/ ad2s2
 v-------- fixme: why this?
 bsdlabel -e ad0s2
 bsdlabel -e ad2s2
   d: 1G * 4.2BSD
   e: *  * 4.2BSD
 ^--------
 geom mirror load
 gmirror label -v lnjail ad0s2 ad2s2
 bsdlabel -e /dev/mirror/lnjail
   d: 1G * 4.2BSD
   e: *  * 4.2BSD

 newfs -U /dev/mirror/lnjaild
 newfs -U /dev/mirror/lnjaile
******* bsdlabel
 # /dev/mirror/lnjail:
 8 partitions:
 #        size   offset    fstype   [fsize bsize bps/cpg]
   c: 41929649        0    unused        0     0         # "raw" part, don't edit
   d:  2097152       16    4.2BSD     2048 16384 28528 
   e: 39832481  2097168    4.2BSD     2048 16384 28528 
****** ad0s3 20G mobrules (mr) mirror w/ ad2s3
 # ad2s3 is slightly smaller, label that one first then use the same
 # number of sectors for ad0s3
 bsdlabel -e ad2s3
   d: 1G * 4.2BSD
   e: * * 4.2BSD
 bsdlabel -e ad2s3
   d: 2097152 * 4.2BSD
   e: 39832482 * 4.2BSD

 gmirror label -v mrjail ad0s3 ad2s3
 bsdlabel -e /dev/mirror/mrjail
   d: 1G * 4.2BSD
   e: * * 4.2BSD

 newfs -U /dev/mirror /dev/mirror/mrjaild
 newfs -U /dev/mirror /dev/mirror/mrjaile
***** ad2
****** ad2s1 34G (35353M) unused
****** ad2s2 20G linus (ln) mirror w/ ad0s2
****** ad2s3 20G mobrules (mr) mirror w/ ad0s3
****** ad2s4 223G (228926M) unused
 ad2s4d 19G  old backup
 ad2s4e 197G unused
**** kernel config
**** pf
 if="em0"
 scrub in all
 block log all
 antispoof for $if
 #pass quick on lo0 all
 pass out all
 pass out proto {udp,icmp} all keep state
 pass out proto tcp all modulate state
 pass in proto tcp from any to $banksy port 22 flags S/SA modulate state
**** speed
 make buildworld: ~50 min
 make -j 4 buildworld: 29 min
   2786.408u 524.904s 28:53.99 190.9%      4766+3399k 3983+229141io 1548pf+0w
 make -j 3 buildworld: 29 min
   2775.259u 515.509s 29:11.66 187.8%      4767+3404k 8075+228866io 2054pf+0w
**** delay problem
 With banksy in Cybris and an ssh client on sploit, using a WLAN to
 connect to mgv which is routing to puff and Internet, we see long
 delays in the interactive traffic (ssh, TCP) when "the pipe is cold".

 We don't see this when running the client on mgv.

 At Tue Apr 17 06:33:30 CEST 2007, it took about five seconds to get a
 newline echoed back over ssh.  This was after five minutes without any
 trafic.  Captured in banksy:/root/d.

 Another test later looked like this on the client side (sploit):
 07:27:44.302027 IP 10.3.0.11.58352 > 194.52.231.24.22: P 285446163:285446211(48) ack 792100641 win 65535
 07:28:20.340201 IP 10.3.0.11.58352 > 194.52.231.24.22: P 0:48(48) ack 1 win 65535
 07:28:20.364518 IP 194.52.231.24.22 > 10.3.0.11.58352: P 1:49(48) ack 48 win 65535
 07:28:20.365622 IP 194.52.231.24.22 > 10.3.0.11.58352: P 49:113(64) ack 48 win 65535
 07:28:20.365724 IP 10.3.0.11.58352 > 194.52.231.24.22: . ack 113 win 65535
**** Hardware
 http://www.mullet.se/sortiment/product.htm?product_id==227661&show=3
 Motherboard: PDSML-LN1+
**** Creating a new jail for a new user
 # example from setting up
 cat >> /etc/rc.conf <<EOF
 ifconfig_re0_alias9="inet 193.10.5.85 netmask 0xffffff00"  # gmp
 EOF

 [root@banksy ~]# ifconfig re0 alias 193.10.5.85
 # update /etc/pf.conf and reload

 export jname=gmp; export ushname=tg; export jipaddr=193.10.5.85
 mkdir -p /usr/jaildisks/$ushname/var
 ezjail-admin create -f ln -r /usr/jaildisks/$ushname/$jname $jname $jipaddr
 [ -d /usr/jaildisks/$ushname/var/$jname ] && rmdir /usr/jaildisks/$ushname/var/$jname
 mv /usr/jaildisks/$ushname/$jname/var /usr/jaildisks/$ushname/var/$jname
 mkdir /usr/jaildisks/$ushname/$jname/var /usr/jaildisks/$ushname/$jname/u
 cat >> /etc/fstab.$jname <<EOF
 /usr/jaildisks/$ushname/var/$jname /usr/jaildisks/$ushname/$jname/var   nullfs rw 0 0
 /u                          /usr/jaildisks/$ushname/$jname/u     nullfs ro 0 0
 EOF
 time /usr/local/etc/rc.d/ezjail.sh start $jname
 real    2m39.037s

**** qmeu-dm crash <2012-05-16 Wed>
 May 16 06:37:28 banksy kernel: ad1: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=20321775

 May 16 06:38:18 tbd0 /netbsd: pid 358 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)
 May 16 06:38:18 tbd0 /netbsd: tap0: detached

 May 16 07:13:34 banksy syslogd: kernel boot file is /boot/kernel/kernel

 Had to bring up a console (ssh -NfL 5900:127.0.0.1:5900
 tbd0.nordberg.se; vncviewer localhost) and fsck /var to get it up.
**** qemu-dm crash <2012-05-18 Fri>
 May 18 04:56:40 banksy kernel: ad1: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=19728999

 May 18 04:57:20 tbd0 /netbsd: pid 11207 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)

 May 18 08:59:34 banksy syslogd: kernel boot file is /boot/kernel/kernel

 Rebooted tbd0 this time.
**** more disk trouble <2012-05-19>
 May 19 05:01:20 banksy kernel: ad1: TIMEOUT - READ_DMA retrying (1 retry left) LBA=22879151

 No crash here (note that this was a read).
**** qemu-dm crash <2012-06-01 Fri>
 Jun  1 16:22:10 tbd0 /netbsd: pid 366 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)
**** disk trouble? <2012-11-20 Tue>
 Nov 18 18:27:30 banksy kernel: ad1: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=1586131
 Nov 18 18:28:57 banksy kernel: ad1: TIMEOUT - WRITE_DMA retrying (1 retry left) LBA=2279247
**** SMTP break-in attempt 2013-01-28
 167 authentication SASL attempts as linus on submission, two seconds
 interval, from 1.171.220.205 (1-171-220-205.dynamic.hinet.net), HINET
 Taipei Taiwan.

 Jan 28 23:40:58 lnmail postfix/smtpd[60439]: warning: 1-171-220-205.dynamic.hinet.net[1.171.220.205]: SASL LOGIN authentication failed: authentication failure

 Jan 28 23:35:40 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:42 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:44 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:46 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:48 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:50 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:52 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:54 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:56 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:35:58 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:00 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:03 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:05 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:07 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:09 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:11 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:13 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:15 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:17 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:19 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:21 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:23 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:25 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:27 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:29 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:32 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:34 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:36 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:38 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:40 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:42 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:44 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:46 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:48 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:50 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:52 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:55 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:57 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:36:59 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:01 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:03 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:05 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:07 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:09 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:11 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:13 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:15 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:18 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:20 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:22 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:24 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:26 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:28 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:30 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:33 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:35 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:37 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:39 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:41 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:43 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:45 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:47 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:49 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:51 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:53 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:55 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:57 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:37:59 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:01 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:04 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:06 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:08 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:10 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:12 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:14 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:16 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:18 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:20 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:22 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:24 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:26 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:29 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:31 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:33 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:35 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:37 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:39 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:41 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:43 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:45 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:47 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:49 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:51 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:54 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:56 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:38:58 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:00 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:02 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:04 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:06 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:08 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:11 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:13 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:15 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:17 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:19 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:21 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:23 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:25 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:27 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:29 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:31 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:33 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:35 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:37 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:40 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:42 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:44 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:46 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:48 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:50 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:52 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:54 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:56 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:39:58 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:00 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:02 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:04 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:07 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:09 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:11 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:13 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:15 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:17 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:19 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:21 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:23 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:25 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:27 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:30 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:32 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:34 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:36 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:38 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:40 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:42 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:44 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:46 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:48 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:50 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:52 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:54 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:56 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:40:58 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:01 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:03 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:05 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:07 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:09 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:11 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:13 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:15 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:17 lnmail saslauthd[1857]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:19 lnmail saslauthd[1856]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:21 lnmail saslauthd[1854]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:23 lnmail saslauthd[1855]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]
 Jan 28 23:41:25 lnmail saslauthd[1853]: do_auth         : auth failure: [user=linus] [service=smtp] [realm=] [mech=kerberos5] [reason=krb5_verify_user_opt failed]

**** qemu-dm crash <2013-09-22 Sun>
 Sep 21 15:04:01 tbd0 /netbsd: pid 6166 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)
 Sep 21 15:04:01 tbd0 /netbsd: tap0: detached
 Sep 21 15:04:02 tbd0 ntpd[381]: Deleting interface #22 tap0, fe80::f00b:a4ff:fe2c:f811#123, interface stats: received=0
 , sent=0, dropped=0, active_time=41176223 secs

 -bash-4.0# xm list
 Name                                        ID   Mem VCPUs      State   Time(s)
 Domain-0                                     0   256     1     r----- 1386472.4
 banksy                                       6  2048     1     ------ 5709572.5
 -bash-4.0# xm destroy 6
 -bash-4.0# xm list
 Name                                        ID   Mem VCPUs      State   Time(s)
 Domain-0                                     0   256     1     r----- 1386473.3
 -bash-4.0# xm create banksy
 Using config file "/usr/pkg/etc/xen/banksy".
 Started domain banksy
 -bash-4.0# date
 Sun Sep 22 12:28:53 CEST 2013
 -bash-4.0# xm list
 Name                                        ID   Mem VCPUs      State   Time(s)
 Domain-0                                     0   256     1     r----- 1386476.8
 banksy                                       7  2048     1     r-----     12.6

 tool% ssh -NfL 5988:127.0.0.1:5900 -p 22 tbd0.nordberg.se
 vncviewer localhost::5988

 <console shows fsck in action (ad1s1d INCORRECT BLOCK COUNT...)>

 -bash-4.0# ping -c 1 banksy
 PING banksy.nordberg.se (193.10.5.87): 56 data bytes
 64 bytes from 193.10.5.87: icmp_seq=0 ttl=64 time=0.457 ms

 ----banksy.nordberg.se PING Statistics----
 1 packets transmitted, 1 packets received, 0.0% packet loss
 round-trip min/avg/max/stddev = 0.457/0.457/0.457/0.000 ms
 -bash-4.0# date
 Sun Sep 22 12:33:54 CEST 2013

**** qemu-dm crash <2013-09-23 Mon>
 Sep 22 12:33:40 banksy syslogd: kernel boot file is /boot/kernel/kernel
 Sep 23 05:35:16 tbd0 /netbsd: pid 19019 (qemu-dm), uid 0: exited on signal 11 (core not dumped, err = 14)
 Sep 23 05:35:16 tbd0 /netbsd: tap0: detached
 Sep 23 05:35:17 tbd0 ntpd[381]: Deleting interface #25 tap0, fe80::f00b:a4ff:feae:648e#123, interface stats: received=0, sent=0, dropped=0, active_time=61589 secs

 Rebooted tbd0 this time.
**** another crash, dec 31 i think
*** tamias-012 -- Shuttle @home
 torify ssh root@ylb6566u3sdka25m.onion
 ssh root@fe80::82ee:73ff:fe28:6d4b%wlan0

 <2013-03-25 Mon>
 inet addr:192.36.125.239  Bcast:192.36.125.255  Mask:255.255.255.0
 inet6 addr: 2001:6b0:7:0:82ee:73ff:fe28:6d4b/64 Scope:Global
*** Dell PowerEdge 750 1U, former ehlo.4711.se
 Tor DA 'maatuska'
 Hosted by Bolero in Kista until 2012-02-28.

 IPv4: 171.25.193.9

 Old IP addresses:
 IPv4: 213.115.239.118/25
 IPv4 gateway: 213.115.239.1
 IPv6: 2001:470:dd3d:239::118/64
 IPv6 gateway: 2001:470:dd3d:239::1

 Dell PowerEdge 750
 www.dell.com/downloads/global/products/pedge/en/750_specs.pdf
 Intel(R) Pentium(R) 4 CPU 2.80GHz
 RAM DDR-400MHz SDRAM, max 4GB, current 1GB installed (prob. 2x512MB)
* ADB-Centralen
** ioctl.adb-centralen.se (2017-09-29) -- VM @ kcmp
fbsd-10.4 installed 2018-04-24
*** storage
[root@ioctl /var/jail]# gpart show
=>       34  587202493  vtbd0  GPT  (280G)
         34        222         - free -  (111K)
        256       1024      1  freebsd-boot  (512K)
       1280  578812672      2  freebsd-ufs  (276G)
  578813952    8388574      3  freebsd-swap  (4.0G)
  587202526          1         - free -  (512B)
[root@ioctl /var/jail]# gpart status
   Name  Status  Components
vtbd0p1      OK  vtbd0
vtbd0p2      OK  vtbd0
vtbd0p3      OK  vtbd0
**** pre migration 2018-04-24
[root@ioctl ~]# date
Tue Apr 24 11:28:56 CEST 2018
[root@ioctl ~]# dmesg|egrep ada[01]
ada0 at ahcich0 bus 0 scbus0 target 0 lun 0
ada0: <WDC WD1000DHTZ-04N21V0 04.06A00> ATA8-ACS SATA 3.x device
ada0: Serial Number WD-WX11E83NW836
ada0: 600.000MB/s transfers (SATA 3.x, UDMA6, PIO 8192bytes)
ada0: Command Queueing enabled
ada0: 953869MB (1953525168 512 byte sectors)
ada0: Previously was known as ad4
ada1 at ahcich1 bus 0 scbus1 target 0 lun 0
ada1: <WDC WD1000DHTZ-04N21V0 04.06A00> ATA8-ACS SATA 3.x device
ada1: Serial Number WD-WXK1E63ARNTM
ada1: 600.000MB/s transfers (SATA 3.x, UDMA6, PIO 8192bytes)
ada1: Command Queueing enabled
ada1: 953869MB (1953525168 512 byte sectors)
ada1: Previously was known as ad6
GEOM: ada0: the secondary GPT table is corrupt or invalid.
GEOM: ada0: using the primary only -- recovery suggested.
GEOM: ada1: the secondary GPT table is corrupt or invalid.
GEOM: ada1: using the primary only -- recovery suggested.
[root@ioctl ~]# gmirror list
Geom name: gm0
State: COMPLETE
Components: 2
Balance: load
Slice: 4096
Flags: NONE
GenID: 0
SyncID: 2
ID: 2061159505
Providers:
1. Name: mirror/gm0
   Mediasize: 1000204885504 (932G)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r2w2e3
Consumers:
1. Name: ada0
   Mediasize: 1000204886016 (932G)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r1w1e1
   State: ACTIVE
   Priority: 0
   Flags: DIRTY
   GenID: 0
   SyncID: 2
   ID: 1873935879
2. Name: ada1
   Mediasize: 1000204886016 (932G)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r1w1e1
   State: ACTIVE
   Priority: 0
   Flags: DIRTY
   GenID: 0
   SyncID: 2
   ID: 294104974
[root@ioctl ~]# gpart list
Geom name: mirror/gm0
modified: false
state: CORRUPT
fwheads: 255
fwsectors: 63
last: 1953525133
first: 34
entries: 128
scheme: GPT
Providers:
1. Name: mirror/gm0p1
   Mediasize: 65536 (64K)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r0w0e0
   rawuuid: 9d833eb0-ed7c-11e3-a679-00259071e325
   rawtype: 83bd6b9d-7f41-11dc-be0b-001560b84f0f
   label: (null)
   length: 65536
   offset: 20480
   type: freebsd-boot
   index: 1
   end: 167
   start: 40
2. Name: mirror/gm0p2
   Mediasize: 996432343040 (928G)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r1w1e1
   rawuuid: 9d841299-ed7c-11e3-a679-00259071e325
   rawtype: 516e7cb6-6ecf-11d6-8ff8-00022d09712b
   attrib: bootme
   label: (null)
   length: 996432343040
   offset: 86016
   type: freebsd-ufs
   index: 2
   end: 1946157087
   start: 168
3. Name: mirror/gm0p3
   Mediasize: 3772439040 (3.5G)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r1w1e0
   rawuuid: 9d849d08-ed7c-11e3-a679-00259071e325
   rawtype: 516e7cb5-6ecf-11d6-8ff8-00022d09712b
   label: (null)
   length: 3772439040
   offset: 996432429056
   type: freebsd-swap
   index: 3
   end: 1953525132
   start: 1946157088
Consumers:
1. Name: mirror/gm0
   Mediasize: 1000204885504 (932G)
   Sectorsize: 512
   Stripesize: 4096
   Stripeoffset: 0
   Mode: r2w2e3
[root@ioctl ~]# gpart status mirror/gm0
        Name   Status  Components
mirror/gm0p1  CORRUPT  mirror/gm0
mirror/gm0p2  CORRUPT  mirror/gm0
mirror/gm0p3  CORRUPT  mirror/gm0
[root@ioctl ~]# gpart show mirror/gm0
=>        34  1953525100  mirror/gm0  GPT  (932G) [CORRUPT]
          34           6              - free -  (3.0K)
          40         128           1  freebsd-boot  (64K)
         168  1946156920           2  freebsd-ufs  [bootme]  (928G)
  1946157088     7368045           3  freebsd-swap  (3.5G)
  1953525133           1              - free -  (512B)
[root@ioctl ~]# cat /etc/fstab
# Device        Mountpoint      FStype  Options Dump    Pass#
/dev/mirror/gm0p2       /               ufs     rw      1       1
/dev/mirror/gm0p3       none            swap    sw      0       0
fdesc /dev/fd fdescfs rw 0 0

*** jail hints
- upgrading one jail, base and packages:
  /root/upgrade-jail.sh [-a] [-r RELEASE] JAILNAME
- upgrading all jails, base and packages:
  /root/upgrade-all-jails.sh
- missing libucl when running pkg?
mv /usr/sbin/pkg /usr/sbin/pkg.OFF
- creating new jail (rough guide, missing chflags schg)
cd /jails
fetch https://ftp.lysator.liu.se/pub/FreeBSD/releases/amd64/amd64/10.3-RELEASE/MANIFEST
fetch https://ftp.lysator.liu.se/pub/FreeBSD/releases/amd64/amd64/10.3-RELEASE/base.txz
egrep base MANIFEST 
sha256 -c e7c4c961694e34b2b60598d9668a185b5de1c6241bedfc4891cd9ea8fbff2dc4 base.txz 
mkdir pics
tar xf base.txz -C pics
touch pics/boot/loader.conf
cat >> pics/etc/rc.conf <<EOF
dumpdev="NO"
syslogd_flags="-C -4 -ss -vv"
sendmail_enable=NONE
EOF
for f in resolv.conf localtime host.conf ; do cp /etc/$f pics/etc/; done
dd if=/dev/random of=pics/entropy bs=4k count=1
sysrc jail_list+=pics
cat >> /etc/jail.conf <<EOF
pics {
        host.hostname = "pics.nordberg.se";
        ip4.addr = "10.0.8.10";
}
EOF
service jail start pics
jexec pics newaliases
pkg -j pics install -y bash
pkg -j pics upgrade -y
jexec pics pw user mod root -d /root -s /usr/local/bin/bash
*** jails running on new ioctl, after migration 2018-04-24 [12/13]
- [X] ns
- [X] resolver
- [X] kdc
- [X] jabber
- [X] proj
- [X] webmail
- [X] imap
- [X] spam
- [X] smtp
- [X] web
- [X] git
- [X] le
- [ ] btc [copied, not started]
*** jails, details
**** webmail (creat)
 - after upgrading IMP (TODO: automate this!)
   cat /usr/local/www/horde/imp/lib/Compose.php | egrep -A 5 'Add a Received header'
   vi /usr/local/www/horde/imp/lib/Compose.php
   # Comment out the block that starts with
   # /* Add a Received header for the hop from browser to server. */
**** spam
 - <2015-08-26 Wed> installing spamassassin from pkg
   pkg install spamassassin p5-DBD-mysql # needs p5-DBI

 - HISTORICAL upgrading packages: mail/spamassassin needs to be built with myslq
   support and cannot be installed as a package
   portmaster -d mail/spamassassin
***** configuration
 - /usr/local/share/doc/spamassassin/sql/README
 SpamAssassin will check the global configuration file (ie. any file matching
 /etc/mail/spamassassin/*.cf) for the following settings:
   user_scores_dsn               DBI:driver:connection
   user_scores_sql_username      dbusername
   user_scores_sql_password      dbpassword
 - rc.conf
 spamd_flags="-u spamd -H /var/spool/spamd --allow-tell --sql-config --nouser-config --allowed-ips=smtp.adb-centralen.se,fixme"
***** notes from moving from banksy
****** adb-centralen.se, zone
 accept          A       193.10.5.85
                 AAAA    2001:6b0:8::85
 banksy  1h      A       193.10.5.87
 brk             CNAME   mail
 cadar           A       193.10.5.90
 conference      CNAME   jabber
 creat           A       193.10.5.100
                 AAAA    2001:6b0:8::100
 dup2            A       193.10.5.98
                 AAAA    2001:6b0:8::98
 execve          A       193.10.5.89
                 AAAA    2001:6b0:8::89
 fcntl           A       193.10.5.90
                 AAAA    2001:6b0:8::90
 getpid          A       193.10.5.77
                 AAAA    2001:6b0:8::77
 imap            A       193.10.5.124
                 AAAA    2001:6b0:8::124
 ioctl           A       193.10.5.109
                 AAAA    2001:6b0:8::109
 jabber  1h      A       193.10.5.85
                 AAAA    2001:6b0:8::85
 kdc             A       193.10.5.128
                 AAAA    2001:6b0:8::128
 lnln            A       193.10.5.84
 mail            A       193.10.5.111
                 AAAA    2001:6b0:8::111
 mm              CNAME   modermodemet
 modermodemet    A       193.10.5.101
                 AAAA    2001:6b0:8::101
 proj            A       193.10.5.108
                 AAAA    2001:6b0:8::108
 pwd             CNAME   getpid
 smtp            A       193.10.5.129
                 AAAA    2001:6b0:8::129
 ;webmail        1h      CNAME   banksy.nordberg.se.
 ;www            CNAME   193.10.5.106
 www     1h      A       193.10.5.127
 ;               AAAA    2001:6b0:8::127

 _jabber._tcp            SRV 0 0 5269 jabber
 _xmpp-server._tcp       SRV 0 0 5269 jabber
 _jabber-client._tcp     SRV 0 0 5222 jabber
 _xmpp-client._tcp       SRV 0 0 5222 jabber
 _jabber-ssl-client._tcp SRV 0 0 5223 jabber
 _xmpp-ssl-client._tcp   SRV 0 0 5223 jabber

 lndns CNAME banksy.nordberg.se.
 _ssh._tcp.lndns SRV 0 5 60224 banksy.nordberg.se.

 lntest CNAME banksy.nordberg.se.
 _ssh._tcp.lntest        SRV 0 5 60226 banksy.nordberg.se.


 lists                   NS  ns.nordberg.se.
 lists                   NS  ns.gmplib.org.
 lists                   NS  ns.fatburen.org.
****** [root@lnspam /usr/local/etc/mail/spamassassin]# cat sql.cf
 user_scores_dsn                 DBI:mysql:horde:127.0.0.1
 user_scores_sql_username        sa
 user_scores_sql_password        thblPW

 bayes_store_module Mail::SpamAssassin::BayesStore::MySQL
 bayes_sql_dsn                      DBI:mysql:sa:127.0.0.1
 bayes_sql_username                 sa
 bayes_sql_password                 thblPW
 [root@lnspam /usr/local/etc/mail/spamassassin]# cat local.cf
 # This is the right place to customize your installation of SpamAssassin.
 # See 'perldoc Mail::SpamAssassin::Conf' for details of what can be
 # tweaked.

 # Note that user prefs and bayes data are in SQL,  see sql.cf.

 report_safe 0
 lock_method flock
 required_score 4.5
 use_bayes 1
 bayes_auto_learn 1

 # We trust ourself.  127/8 seems to be implied.
 internal_networks       10.0.1/24 193.10.5.87
 trusted_networks        10.0.1/24 193.10.5.87

 trusted_networks 85.17.20.242 2001:1af8:40e0:a007:1:85c5:606b:2c25 # jn
 trusted_networks 171.25.193.17                                     # mail.dfri.se

 # MX:es are both internal and trusted
 #internal_networks       212.247.27.200                # server.fatburen.org
 #internal_networks       195.17.28.218                 # smtp.swox.se
 #trusted_networks        212.247.27.200                # server.fatburen.org
 #trusted_networks        195.17.28.51 195.17.28.218    # king & bang
 #trusted_networks        194.52.231.20                 # smtp.romab.com

 bayes_ignore_header X-Bogosity
 bayes_ignore_header X-Spam-Flag
 bayes_ignore_header X-Spam-Status

 score FH_DATE_PAST_20XX 0.0
 score RCVD_IN_DNSWL_MED 0.0
 score RCVD_ILLEGAL_IP 0.0
****** [root@lnspam /usr/local/etc/mail/spamassassin]# ps axuwww|egrep spam
 root     1889  0.0  2.7 91868 55708  ??  SsJ   4:58PM   0:10.38 /usr/local/bin/spamd -u spamd -H /var/spool/spamd --allow-tell --sql-config --nouser-config --allowed-ips=10.0.1.2,10.0.1.3 -d -r /var/run/spamd/spamd.pid (perl5.8.9)
 spamd   21161  0.0  3.1 101628 65168  ??  IJ    8:33AM   0:23.84 spamd child (perl5.8.9)
 spamd   23795  0.0  3.0 97952 62056  ??  IJ    1:46PM   0:03.25 spamd child (perl5.8.9)
 mysql    1973  0.0  0.1  5192  1440  p1  IJ    4:58PM   0:00.06 /bin/sh /usr/local/bin/mysqld_safe --defaults-extra-file=/usr/local/mysql/my.cnf --user=mysql --datadir=/usr/local/mysql --pid-file=/usr/local/mysql/lnspam.nordberg.se.pid
 mysql    2027  0.0  1.8 59908 38656  p1  SJ    4:58PM   1:04.27 /usr/local/libexec/mysqld --defaults-extra-file=/usr/local/mysql/my.cnf --basedir=/usr/local --datadir=/usr/local/mysql --user=mysql --log-error=/usr/local/mysql/lnspam.nordberg.se.err --pid-file=/usr/local/mysql/lnspam.nordberg.se.pid
 root    25118  0.0  0.1  5924  1244  p1  S+J   4:21PM   0:00.06 egrep spam
****** jn@9999.se> jag hittar det här i SA-konf:
 jn@9999.se> trusted_networks 85.17.20.242 2001:1af8:40e0:a007:1:85c5:606b:2c25 # jn
 jn@9999.se> fortf. aktuellt?
 (Oct 11 16:22:02) jn@9999.se: De är inaktuella. Byt de där två adresserna i SA till 91.109.21.198 och 2a00:c98:2040:a008:1::198 dvs less.junkmail.se.
****** [root@lnspam /usr/local/etc/mail/spamassassin]# cat /etc/rc.conf
 hostname="lnspam.nordberg.se"
 network_interfaces=""
 rpcbind_enable="NO"
 cron_flags="$cron_flags -J 15"
 syslogd_flags="-ss"

 postfix_enable="YES"
 sendmail_enable="NO"
 sendmail_submit_enable="NO"
 sendmail_outbound_enable="NO"
 sendmail_msp_queue_enable="NO"

 sshd_enable="YES"
 mysql_enable=YES
 mysql_dbdir="/usr/local/mysql"

 clamav_clamd_enable="YES"
 clamav_freshclam_enable="YES"
 spamd_enable="YES"
 # Note: `--daemonize' is given in sa-spamd startup script (as -d).
 # Add `-D bayes,learn' for more debuggin.
 # Note that we're using global auto-whitelisting here, in ~spamd/.spamassassin/.
 # See /usr/local/share/doc/p5-Mail-SpamAssassin/sql/README.awl for a possible cure.
 spamd_flags="-u spamd -H /var/spool/spamd --allow-tell --sql-config --nouser-config --allowed-ips=10.0.1.2,10.0.1.3"

 # This setuid-with-sql thing is fine as long as there's a local UNIX user matching.  When there's no user, we see
 #   Sep 20 23:47:34 lnspam spamd[68472]: spamd: handle_user unable to find user: micke 
 #   Sep 20 23:47:34 lnspam spamd[68472]: spamd: service unavailable: Error fetching user preferences via SQL at /usr/local/bin/spamd line 2017, <GEN19> line 2. 
 #spamd_flags="-D bayes,learn --allow-tell --setuid-with-sql --nouser-config --allowed-ips=10.0.1.2"
****** resources
 https://svn.apache.org/repos/asf/spamassassin/tags/spamassassin_current_release_3.4.x/sql/README
 https://wiki.apache.org/spamassassin/UsingSQL
 /usr/local/share/doc/spamassassin/sql/README
**** smtp
- nc.verkligendata.se can relay thanks to being included in
  mynetworks, which is not what we really want
  - tried using client-certs but failed with relay reject no matter
    what
  - TODO consider cleaning up:
    - client-certs
    - ca-certs/nc.verkligendata.se.pem
    - postconf smtpd_tls_ask_ccert

- FIXED upgrading packages: mail/postfix-tls needs to be built with SASL
   support and cannot be installed as a package:
     portmaster -d mail/postfix-tls
   indications of failure of doing this is that MUA:s are not allowed
   to send email via smtp.adbc and this is logged:
     smtp postfix/submission/smtpd.*: warning: smtpd_sasl_auth_enable is true, but SASL support is not compiled in
   UPDATE <2015-04-02 Thu> postfix-tls no longer exists
- FIXED starting services: seen "smtp postfix/master[52983]: fatal: bind
   2001:6b0:8::129 port 25: Can't assign requested address" when
   restarting the 'smtp' jail, which i think might be a race with
   setting the alias on the interface in the host. Conclusion: Always
   double check that postfix master was started and if not start it
   manually. If annoying anough, add 'sleep 1' to the startup script or
   fix the real problem.
   UPDATE <2015-01-17 Sat>: Fixed through net.inet6.ip6.dad_count=0
- FIXED no SASL authentication mechanisms <2022-01-02 Sun> 
  [root@smtp /]# egrep fatal /var/log/maillog | head -1
  Jan  2 21:01:28 smtp postfix/submission/smtpd[18439]: fatal: no SASL authentication mechanisms
  UPDATE: It was the imap server not responding due to a failed upgrade
- FIXED rate limiting smtpd, to avoid SASL password cracking
  smtpd_client_connection_rate_limit = 10
  smtpd_client_auth_rate_limit = 6
***** setting up milter, dkim and dmarc [1/3]
 - [X] where should dkim signing happen?
   - smtp.adbc
   - opendkim
     - pkg install milter-opendkim; mkdir /var/run/opendkim; chmod 750 /var/run/opendkim; chgrp postfix /var/run/opendkim
     - vi /usr/local/etc/mail/opendkim.conf
     - see [[file:~/p/adb-centralen/doc/HOWTO.dkim][file:~/p/adb-centralen/doc/HOWTO.dkim]] for how to add a domain

 - [ ] where should dkim verification happen?
   - smtp.adbc?
   - imap.adbc? will milter coexist with our filtering using
     /usr/local/bin/mail-filter.sh (implementing one filter by invoking
     spamc)? can we move away from our own shell script and towards a
     milter based solution invoking spamc? package spamss-milter
     http://savannah.nongnu.org/projects/spamass-milt perhaps
 - [ ] opendmarc
**** git
***** git config
- hooks kept in repo
--- .gitolite.rc        2018-11-19 06:45:51.727350000 +0100
+++ .gitolite.rc.ORIG   2018-11-19 06:45:07.354559000 +0100
@@ -79,7 +79,7 @@
         # or you can use this, which lets you put everything in a subdirectory
         # called "local" in your gitolite-admin repo.  For a SECURITY WARNING
         # on this, see http://gitolite.com/gitolite/non-core.html#pushcode
-        LOCAL_CODE                =>  "$rc{GL_ADMIN_BASE}/local",
+        # LOCAL_CODE                =>  "$rc{GL_ADMIN_BASE}/local",
 
     # ------------------------------------------------------------------
**** MOVED: imap
 NOTE: imap moved to kcmp spring 2018
 - dovecot user is uid=10143,gid=10143 in order to be higher than
   $(doveconf first_valid_uid) which is 500 by default
 - /etc/krb5.conf
 [realms]
         ADB-CENTRALEN.SE = {
                 kdc = kdc.adb-centralen.se
                 admin_server = kdc.adb-centralen.se
         }

 [libdefaults]
         default_realm = ADB-CENTRALEN.SE
         kdc_timeout = 10

 [logging]
         entity = SYSLOG
 - getting a keytab, on kdc.adbc
 kadmin> ank --random-key host/imap.adb-centralen.se@ADB-CENTRALEN.SE
 kadmin> ext host/imap.adb-centralen.se@ADB-CENTRALEN.SE
 the keytab file ends up in /etc/krb5.keytab (welp!)
 - authentication is done through pam
   - conf.d/10-auth.conf
     !include auth-static.conf.ext
   - conf.d/auth-static.conf.ext
     passdb {
       driver = pam
       args = %s
     }
     userdb {
       driver = static
       args = uid=dovecot gid=dovecot home=/var/db/imap/%u/imap allow_all_users=yes
     }
   - /etc/pam.d/imap
     auth            required        pam_krb5.so             no_warn try_first_pass no_user_check
     account         required        pam_permit.so
   - /etc/pam.d/smtp
     auth            required        pam_krb5.so             no_warn try_first_pass no_user_check
     account         required        pam_permit.so
   - /etc/pam.d/sieve
     auth            required        pam_krb5.so             no_warn try_first_pass no_user_check
     account         required        pam_permit.so
   - See PAM_KRB5(8) for no_user_check and possibly more.
 - spam
   - 
 - /usr/local/bin/mail-filter.sh
 - backup
   - restic backup /root /etc /usr/local/etc /var/db/dovecot /var/db/imap
     - restic has one problem and another potential problem
       - resource heavy -- 40+ threads iirc, not good for our
         constrained environment
       - might be sending _all_ the data for every backup, which in the
         case of the mail store is a bit too big
   - borg, see [[*borgbackup%20to%20lnbup@flow.nordu.net][borgbackup to lnbup@flow.nordu.net]] for setup
 export BORG_REPO=bup@bup_flow:borg/$(hostname)
 borg create --remote-ratelimit 1024 \
     -e /var/cache \
     ::{utcnow:%Y-%m-%d} \
     /etc /usr/local/etc /root /var
 borg prune --keep-daily=7 --keep-weekly=4 --keep-monthly=-1 --keep-year=-1
 borg check

**** NOT-IN-USE: pics
 pkg install lighttpd letsencrypt.sh piwigo mariadb100-server # php56
 [configure lighttpd with mod_alias for .well-known/acme-challenge]
 [configure letsencrypt.sh, see [[file:~/hints.org::*dehydrated%20/%20letsencrypt.sh][dehydrated / letsencrypt.sh]]]
 [reconfigure lighttpd with tls using new cert]

 service mysql-server start
 /usr/local/bin/mysql_secure_installation
 mysql --user=root -p
   create database db_piwigo;
   create user 'piwigo'@'localhost' identified by '*REDACTED*';
   grant all on db_piwigo.* to 'piwigo'@'localhost';
   flush privileges;

 after upgrading piwigo, set date.timezone="Europe/Stockholm" in /usr/local/etc/php.ini
*** upgrading to 10.3-RELEASE [14/14]
- [X] base
- [X] ns.adb-centralen.se
- [X] resolver.adb-centralen.se
- [X] kdc.adb-centralen.se
- [X] creat.adb-centralen.se (webmail)
- [X] spam.adb-centralen.se
- [X] imap.adb-centralen.se
- [X] smtp.adb-centralen.se
- [X] jabber.adb-centralen.se
- [X] www.adb-centralen.se
- [X] ct.adb-centralen.se
- [X] btc.adb-centralen.se
- [X] git.adb-centralen.se
- [X] proj.adb-centralen.se
*** setting up bhyve and creating a vm
sysrc -f /boot/loader.conf vmm_load=yes nmdm_load=yes if_bridge_load=yes
reboot
pkg install vm-bhyve
mkdir /var/vm
sysrc vm_enable=yes vm_dir=/var/vm
vm init

# Create a virtual switch for internet access
vm switch create public
vm switch nat public on
vi /etc/pf.conf	# remove the 'include' statement for pf-nat.conf and insert corresponding nat rule(s) directly in pf.conf
service pf reload

# Set up a DHCP server serving VM's
pkg install -y dnsmasq
cat /usr/local/etc/dnsmasq.conf.bhyve >> /usr/local/etc/dnsmasq.conf
sysrc dnsmasq_enable=yes
service dnsmasq start
cat >> /etc/pf.conf <<EOF
pass in on {tap0 bridge0} proto udp from {0.0.0.0/32 172.16.0.0/24} port bootpc to 255.255.255.255/32 port bootps label "DHCP from VM's"
pass in on bridge0 from 172.16.0.0/24 to any label "outgoing from bhyve vm's"
EOF
service pf reload
# Missing here is pf rules for NAT:ing publicly reachable addresses into vm's.
# Here's an example from kallocain.dfri.se:/var/jail/_vm/.config/pf-nat.conf:
# # NOTE: Translation rules are first-match-wins.
#
# # Nat for specific vm's with external addresses first.
# binat pass on $ext_if from 172.16.1.186 to any -> 171.25.193.138
# binat pass on $ext_if from 172.16.1.172 to any -> 171.25.193.137 
#
# # General NAT for vm's without an external address second.
# nat on $ext_if from {172.16.1.0/24} to any -> ($ext_if) 

# Download an ISO and set up a default VM template
vm iso http://ftp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/11.1/FreeBSD-11.1-RELEASE-amd64-disc1.iso
cp /usr/local/share/examples/vm-bhyve/default.conf /var/vm/.templates/

# Create a VM running FreeBSD
name=testvm
vm create $name
vm -f install $name FreeBSD-11.1-RELEASE-amd64-disc1.iso
vm console $name # install, reboot
sysrc vm_list+=$name

# Createa VM running Debian
pkg install grub2-bhyve
# TODO
*** installing HardeneDBSD 11.x-STABLE [0/7]
- [ ] services upgraded [0/1]
  - [ ] knot 2.x
- [ ] full backup, 255G (USB HDD or DFRI host?)
- [ ] base install
- [ ] disks mirrored
  for part in $(seq N); do gmirror label p$part /dev/ada0p$part; done;
  for part in $(seq N); do gmirror insert p$part /dev/ada1p$part; done;
  sed -i.bak -e 's|^/dev/ada0\(.*\) +|/dev/mirror/\1/g' fstab
  gpart bootcode -b /boot/pmbr /dev/ada1
- [ ] /tmp is tmpfs
- [ ] jails [0/14]
  - [ ] ns
  - [ ] resolver
  - [ ] kdc
  - [ ] imap
  - [ ] spam
  - [ ] smtp
  - [ ] proj
  - [ ] www
  - [ ] webmail
  - [ ] jabber
  - [ ] btc
  - [ ] git
  - [ ] le
  - [ ] ct
- [ ] secadm
  example: integriforce { path: "/usr/local/bin/tor", hash: FIXME, type: "sha256", mode: "hard" }
*** backups
**** borgbackup to lnbup@flow.nordu.net
pkg install -y py36-borgbackup
ssh-keygen -t ed25519 -f ~/.ssh/bup-flow # install public key in lnbup@flow
cat >> /etc/ssh/ssh_config <<EOF
Host bup_flow
        hostname flow.sunet.se
        port 4722
        user bup
        identityfile /root/.ssh/bup-flow
        verifyhostkeydns no
echo 'BORG_REPO=bup@bup_flow:borg/$(hostname); export BORG_REPO' >> /root/.profile
. /root/.profile
BORG_PASSPHRASE= borg init --encryption keyfile
# NOTE: copy key file to laptop!
#       datan$ scp root@host:.config/borg/keys/* ~/p/adb-centralen/bup/keys/

See [[file:~/p/adb-centralen/src/bup.sh]] for how to do a backup.
**** restic backup on lnbup@flow.nordu.net
cat >> /etc/ssh/ssh_config <<EOF
Host bup_flow                                                                                                
        hostname flow.nordu.net                                                                              
        port 4722                                                                                            
        user bup                                                                                             
        identityfile /root/.ssh/bup-flow                                                                     
EOF

touch restic.pw.bup_flow; chmod 600 restic.pw.bup_flow
dd if=/dev/random of=restic.pw.bup_flow bs=32 count=1
restic -p restic.pw.bup_flow -r sftp:bup_flow:$(hostname) init
restic -p restic.pw.bup_flow -r sftp:bup_flow:$(hostname) backup \
    /root /etc /usr/local/etc \
    /var -e /var/vm -e /var/cache \
    /jails -e /jails/\*.OFF -e /jails/\*/dev

*** upgrading jails to 10.4 <2018-06-05 Tue> [11/11]
- [X] 193.10.5.87     ns.adb-centralen.se
- [X] 193.10.5.125    resolver.adb-centralen.se
- [X] 193.10.5.128    kdc.adb-centralen.se
- [X] 193.10.5.85     jabber.adb-centralen.se
- [X] 193.10.5.108    proj.adb-centralen.se
- [X] 193.10.5.100    creat.adb-centralen.se webmail
- [X] 10.0.8.30       spam.adb-centralen.se
- [X] 193.10.5.129    smtp.adb-centralen.se
- [X] 193.10.5.127    www.adb-centralen.se web
- [X] 193.10.5.86     git.adb-centralen.se
- [X] 10.0.8.15       le

** kcmp.adb-centralen.se (2018-04-02) -- SuperMicro 1U @ TUG
CPU?; year?
HardenedBSD 11.2-STABLE installed on 2018-04-24.
Upgraded to 12 around 2019-08.

*** hw and bios
motherboard: [[https://www.supermicro.com/products/motherboard/xeon/c202_c204/x9scm-f.cfm][X9SCM-F]]
RAM: 4 x 240-pin DDR3 DIMM slots, max 8GB/slot, 1333/1600MHz ECC DDR3 SDRAM Unbuffered (UDIMM), 1.5V, 1.35V
CPU: Intel(R) Xeon(R) CPU E31230 @ 3.20GHz

[root@ioctl ~]# sysctl hw | head -5
hw.machine: amd64
hw.model: Intel(R) Xeon(R) CPU E31230 @ 3.20GHz
hw.ncpu: 8
hw.byteorder: 1234
hw.physmem: 12834246656 # 24G

bios: R 2.2 http://www.supermicro.com/support/resources/getfile.php?SoftwareItemID=3126

- [[https://www.dustin.se/product/5010820849/valueram][3x8GB RAM]] ordered from Dustin on <2018-09-04 Tue>
*** os installation
zfs, stripe, 12g swap
*** basic setup
sysrc -f /etc/sysctl.conf net.inet6.ip6.dad_count=0
sysctl net.inet6.ip6.dad_count=0
sysrc -f /etc/periodic.conf daily_scrub_zfs_enable=yes

pkg install -y postfix
postconf inet_interfaces=localhost
postconf mydomain=adb-centralen.se
sysrc postfix_enable=yes
echo root: linus@nordberg.se >> /etc/aliases
newaliases
service postfix start
*** storage
[root@kcmp ~]# gpart show ada0
=>        40  1953525088  ada0  GPT  (932G)
          40      409600     1  efi  (200M)
      409640        1024     2  freebsd-boot  (512K)
      410664         984        - free -  (492K)
      411648    25165824     3  freebsd-swap  (12G)
    25577472  1927946240     4  freebsd-zfs  (919G)
  1953523712        1416        - free -  (708K)
gpart backup ada0 | gpart restore -F ada1
zpool attach zroot ada0p4 ada1p4
gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 2 ada1

[root@kcmp ~]# date
Sun Sep  1 23:40:02 CEST 2019
[root@kcmp ~]# zpool upgrade
This system supports ZFS pool feature flags.

Enabled the following features on 'zroot':
  large_dnode
  spacemap_v2

If you boot from pool 'zroot', don't forget to update boot code.
Assuming you use GPT partitioning and da0 is your boot disk
the following command will do it:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0

[root@kcmp ~]# gpart show ada0
=>        40  1953525088  ada0  GPT  (932G)
          40      409600     1  efi  (200M)
      409640        1024     2  freebsd-boot  (512K)
      410664         984        - free -  (492K)
      411648    25165824     3  freebsd-swap  (12G)
    25577472  1927946240     4  freebsd-zfs  (919G)
  1953523712        1416        - free -  (708K)
[root@kcmp ~]# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 2 ada0
gpart: /dev/ada0p2: Operation not permitted
[root@kcmp ~]# gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 2 ada1
gpart: /dev/ada1p2: Operation not permitted
*** bhyve setup and creation of a fbsd vm (ioctl)
sysrc -f /boot/loader.conf vmm_load=yes nmdm_load=yes if_bridge_load=yes
reboot
pkg install -y vm-bhyve
zfs create zroot/var/vm
sysrc vm_enable=yes vm_dir=/var/vm
vm init
vm switch create public # NOTE: no NAT
vm switch add public em0
# downloading a fbsd10 image:
vm iso http://ftp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.4/FreeBSD-10.4-RELEASE-amd64-disc1.iso
# check this too: http://ftp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.4/CHECKSUM.SHA512-FreeBSD-10.4-RELEASE-amd64
cp /usr/local/share/examples/vm-bhyve/default.conf /var/vm/.templates/
# creating a vm for ioctl.adbc:
export vm=ioctl
vm create -s 280g $vm # TODO: bug report vm(8) manual saying the default unit for `-s' is gig (it's bytes)
sysrc -f /var/vm/$vm/$vm.conf utctime=yes cpu=4 memory=8G
vm install $vm FreeBSD-10.4-RELEASE-amd64-disc1.iso
vm console $vm 
sysrc vm_list+=$vm

# copying to a vnode shows to be slower than copying over ssh into the vm, so skip this:
mdconfig /var/vm/ioctl/disk0.img
mount /dev/md0p2 /mnt

for f in ns resolver kdc jabber proj webmail imap smtp spam web le btc git; do echo -n "$f "; time tar cf - -C /ioctl/jails $f | ssh 193.10.5.109 "tar xf - -C /var/jail"; done

*** VM woes
- VM ioctl is unable to reach jails on host kcmp over ipv6 until it
  has some help getting an entry into its NDP table, f.ex. by the host
  pinging the vm over ipv6. Correction: pinging does not solve this,
  while manual insertion in the table does:
  [root@ioctl ~]# ndp -s 2001:6b0:8::100 00:25:90:71:e3:25 tempfix
  - real world case: jail netxcloud on kcmp cannot reach jail smtp on
    VM ioctl over ipv6 
    - nextcloud$ gnutls-cli -s -p 587 2001:6b0:8::129 # hangs
    - ioctl$ ndp -n 2001:6b0:8::100 # shows nothing
  - should the host act as a proxy on behalf of its jails for NDP requests?
*** backup
See [[*borgbackup to lnbup@flow.nordu.net][borgbackup to lnbup@flow.nordu.net]] for how to do backup.
**** restic, but borg is probably better for us
cat >> /etc/ssh/ssh_config <<EOF
Host bup_flow                                                                                                
        hostname flow.nordu.net                                                                              
        port 4722                                                                                            
        user bup                                                                                             
        identityfile /root/.ssh/bup-flow                                                                     
EOF

export RESTIC_REPOSITORY=sftp:bup_flow:$(hostname)
export RESTIC_PASSWORD_FILE=restic-pw.$(hostname).bup_flow
cd /root; touch ${RESTIC_PASSWORD_FILE}; chmod 600 ${RESTIC_PASSWORD_FILE}
dd if=/dev/random bs=32 count=1 | base64 > ${RESTIC_PASSWORD_FILE}
restic init
restic backup /root /etc /usr/local/etc \
    /var -e /var/vm

*** what jails have moved out of ioctl onto kcmp [4/12]
- [X] 193.10.5.124    imap.adb-centralen.se         /jails/imap
- [X] 193.10.5.125    resolver.adb-centralen.se     /jails/resolver
- [X] 193.10.5.87     ns.adb-centralen.se           /jails/ns
- [ ] 10.0.8.30       spam.adb-centralen.se         /jails/spam
- [ ] 193.10.5.128    kdc.adb-centralen.se          /jails/kdc
- [ ] 193.10.5.85     jabber.adb-centralen.se       /jails/jabber
- [X] 193.10.5.108    proj.adb-centralen.se         /jails/proj
- [ ] 193.10.5.129    smtp.adb-centralen.se         /jails/smtp
- [ ] 193.10.5.127    www.adb-centralen.se          /jails/web
- [ ] 193.10.5.86     git.adb-centralen.se          /jails/git
- [ ] 10.0.8.15       le                            /jails/le
- [ ] 10.0.8.11       btc.adb-centralen.se          /jails/btc
-     193.10.5.100    creat.adb-centralen.se        /jails/webmail
*** creating a new jail, how to
**** plain jail style
mkjail.sh install FQDN
**** iocage style
WARNING: Adding and removing IP addresses to (iocage) jails may leave
the host interface configured with addresses that shouldn't be there
(and seem hard to get rid of using ifconfig delete).
***** iocage setup
 sysrc -f /etc/sysctl.conf net.inet6.ip6.dad_count=0; sysctl net.inet6.ip6.dad_count=0
 pkg install -y py36-iocage
 sysrc iocage_enable=yes

 # add to /usr/local/etc/secadm.rules:
 secadm {
   pax {
     path: "/usr/local/bin/python3.6",
     mprotect: false,
     pageexec: false,
   },
 }
 service secadm restart

 mount -t fdescfs null /dev/fd
 cat >> /etc/fstab <<EOF
 fdescfs /dev/fd  fdescfs  rw  0  0
 EOF

 # add to /etc/pf.conf
     # NAT for jails with private addresses
     nat on $ext_if from 192.168.0.0/24 to any -> $kcmp_v4
     nat on $ext_if from fd00::0:0/48 to any -> $kcmp_v6
 service pf reload

 cat > /root/.login_conf <<EOF
 me:\
         :charset=UTF-8:\
         :lang=en_US.UTF-8:\
         :setenv=LC_COLLATE=C:
 EOF

 [see [[file:~/p/adb-centralen/src/mkjailtempl.sh][file:~/p/adb-centralen/src/mkjailtempl.sh]]]
***** creating a new jail
 [see [[file:~/p/adb-centralen/src/mkjail-iocage.sh][file:~/p/adb-centralen/src/mkjail-iocage.sh]]]
***** iocage upgrade a jail RELEASE, 
 # we should be able to simply
 #   iocage fetch --update --verify -r 11-STABLE
 # but as of 2018-05-12, using iocage Version 0.9.10 2017/12/22, that fails with
 #   11-STABLE was not found!

 export FILES="base.txz doc.txz src.txz"
 export TOPDIR=11-STABLE.$(date -u +%s)
 export DIR=${TOPDIR}/11-STABLE
 mkdir -p ${DIR}
 (cd ${DIR}; for f in MANIFEST ${FILES}; do curl -sO https://installer.hardenedbsd.org/pub/HardenedBSD/releases/amd64/amd64/hardenedbsd-11-stable-LAST/${f}; done;)
 (cd ${DIR}; for f in ${FILES}; do sha256 -qc $(egrep ^${f} MANIFEST | cut -f 2) $f || echo "$f: checksum mismatch"; done;)
 [ -d lib32 ] || mkdir lib32; tar cf - lib32 | xz - > ${DIR}/lib32.txz
 iocage fetch -fh False -d ${DIR} -r 11-STABLE

 # this should work but is buggy:
 for JNAME in $JAILS; do
   iocage upgrade ${JNAME} -r 11-STABLE
 done
 # resulting in a python backtrace and
 #   FileNotFoundError: [Errno 2] No such file or directory: 'hbsd-upgrade': 'hbsd-upgrade'

# for hbsd-12, using the .dk mirror:
export FILES="base.txz src.txz"
export TOPDIR=12-STABLE.$(date -u +%s)
export DIR=${TOPDIR}/12-STABLE
mkdir -p ${DIR}
(cd ${DIR}; for f in MANIFEST ${FILES}; do curl -sO http://dk-01.installer.hardenedbsd.org/pub/HardenedBSD/releases/amd64/amd64/hardenedbsd-12-stable-LAST/${f}; done;)
(cd ${DIR}; for f in ${FILES}; do sha256 -qc $(egrep ^${f} MANIFEST | cut -f 2) $f || echo "$f: checksum mismatch"; done;)
[ -d lib32 ] || mkdir lib32; tar cf - lib32 | xz - > ${DIR}/lib32.txz
iocage fetch -fh False -d ${TOPDIR} -r 12-STABLE

***** idea: cloning the template jail, upgrading it and moving all/some jails to use the new template
 bzzt, can't clone template jails
***** trying to iocage update a jail doesn't seem to work
 <2018-06-24 Sun>
 ./usr/libexec/dwatch/proc-status: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-exec: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-signal: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-signal-send: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-signal-clear: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-signal-discard: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-exec-failure: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-exit: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-create: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 ./usr/libexec/dwatch/proc-exec-success: Hard-link target './usr/libexec/dwatch/proc' does not exist.
 tar: Error exit delayed from previous errors.

*** active jails
**** bdflush -- backup server
**** bounce -- irc shells
**** getgid -- gitolite <2019-09-04 Wed>
pkg install gitolite
# /usr/local/share/doc/gitolite/README.txt
adduser # git; 700
su - git
cat > ssh.linus.pub <<EOF
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDPh8Iyh0LfVqR82e5vOk/SjA5JF8b7TTvOOaDEGu0m+fsaJD5AeUBg1XlZSA/ZQ8iCSzLTPY6WPIfYcHdFj/lYm8xVj6rsTjfAa947r5wKjNxxrp/yocliGYRVJ0IKQXWRMBU9zQ08uVX1490tYfeKTPS0/qo52XF3p9QuSGX4CismvFqBkgoEjuSHpmsh6X+yQUGsjaZ+J0feQxd8E9HyYvhH5XFOpwtiJt5hhU2uEYYLR36mgByhWiTNIC1cUNJRpuyyuip9l60xjXEqFDuhoCUXAiNCQPyD9zHtadXG2tSi40cmHlzBT3Lop0QQ1yS9LrFjlBBb6GuL0MtxWLh+2mcq4HN/GeoUAe6PbomnOlyxSV95fdKbXI3QegblI5U6ew3ffqsP8VtPP+kCwaYqb1r9tBCY5zgsdwNhR6IoEZJMJs1FerEfKipPWZ4G1wVAprRgbcjfMqh40rcuYxopMDPKyMaeRQ6GjOAiGcf32pCcyReq2yRD+NXo9r70HIBNQzENiC6nYlDVObmUB11h4aUZuyMpgBud2GmuyNbp2wjfT9Rm1aUBStUzfTnzC9LfryYaUNdYw3ZLHZSeB2hcFByZHfpT+/d7rTJTAnOtl3kayZvcNzzLDEMCjqIOSe/k8gw/YzJUSSX3sQrwmXEz76n3u2IlkHELxDHTB3RJow== cardno:000604156811
EOF
/usr/local/bin/gitolite setup -pk ssh.linus.pub
rm ssh.linus.pub

Here's where we realise we've already got gitolite running on git @
ioctl! So we postpone this jail for now.

**** imap
***** spam filtering
  adduser # mail-filter
  /usr/local/bin/mail-filter.sh
  reaching spam.adbc
  route add 10.0.8.30 ioctl
  sysrc route_spam="10.0.8.30 ioctl"
  sysrc static_routes=spam
  pkg install -y spamassassin
***** work order for 2018-04-27
  kcmp# rsync --rsh="ssh -i /root/.ssh/id_ed25519" -a --bwlimit=1m root@ioctl:/var/jail/imap/var/db/imap /iocage/jails/imap/root/var/db/
  ioctl# jexec imap service dovecot stop
  kcmp# rsync --rsh="ssh -i /root/.ssh/id_ed25519" -a root@ioctl:/var/jail/imap/var/db/imap /iocage/jails/imap/root/var/db/
  kcmp# rsync --rsh="ssh -i /root/.ssh/id_ed25519" -a root@ioctl:/var/jail/imap/var/db/dovecot/sieve /iocage/jails/imap/root/var/db/dovecot/
  kcmp# iocage start imap
  kcmp# vi /etc/pf.conf # uncomment four rdr lines and remove imap= and $imap

  2018-04-30 that didn't work at all

  first, using 192.168.0.13 as the only ip address for the jail,
  traffic didn't come into the jail; possibly because imap @ ioctl was
  still running and all traffic for 193.10.5.124 went to ioctl

  then, using 193.10.5.124 as the only ip address for the jail,
  traffic didn't get out of the jail; tried iocage set ip4=inherit to
  no avail

  setting _both_ addresses on the jail made things work from a networking pov

  but then dovecot was all stressed out about things and my inbox
  looked super weird, like several days of mail was gone

  many of all of these:
  Apr 30 11:48:44 imap dovecot: imap(fredrik/imap)<5336><V1QQwQ1rFCNN2vOz>: Warning: Fixed a duplicate: /var/db/imap/fredrik/imap/cur/1524732391.M972440P44214.imap.adb-centralen.se,S=43854,W=44743:2, -> 1525081724.M180206P5336.imap,S=43854,W=44743
  Apr 30 11:49:10 imap dovecot: imap(linus/imap)<20890><q9I9wg1r3OZU2CHZ>: Warning: Fixed a duplicate: /var/db/imap/linus/imap/cur/1524677996.M978183P88941.imap.adb-centralen.se,S=21129,W=21469:2,S -> 1525081750.M202317P20890.imap,S=21129,W=21469
  Apr 30 11:49:10 imap dovecot: imap(linus/imap)<20890><q9I9wg1r3OZU2CHZ>: Warning: Maildir /var/db/imap/linus/imap: Expunged message reappeared, giving a new UID (old uid=131329, file=1511786144.M144306P51187.imap.adb-centralen.se,S=20567,W=20817:2,S)
  and with 'old uid' changing, seemingly a sequence

  on old imap: 
  [root@imap /]# ls -l /var/db/imap/linus/imap/cur/1524677996.M978183P88941.imap.adb-centralen.se\,S\=21129\,W\=21469\:2\,S 
  -rw-r--r--  1 dovecot  dovecot  21129 Apr 25 19:39 /var/db/imap/linus/imap/cur/1524677996.M978183P88941.imap.adb-centralen.se,S=21129,W=21469:2,S
  on new imap:
  [root@kcmp ~]# ls -l /iocage/jails/imap/root/var/db/imap/linus/imap/cur/1524677996.M978183P88941.imap.adb-centralen.se\,S\=21129\,W\=21469\:2\,FS 
  -rw-r--r--  1 10143  10143  21129 Apr 25 19:39 /iocage/jails/imap/root/var/db/imap/linus/imap/cur/1524677996.M978183P88941.imap.adb-centralen.se,S=21129,W=21469:2,FS

  UPDATE: Can this be because we rsync:ed for multiple days and didn't
  --delete?

  Let's try 

    rsync --rsh="ssh -i /root/.ssh/id_ed25519" -a --delete root@ioctl:/var/jail/imap/var/db/imap /iocage/jails/imap/root/var/db/

  Better!
***** setting up mlmmj
 - pkg install mlmmj
 - adduser -s nologin -w no	# mlmmj, /var/mlmmj
 - add the following to master.cf
 mlmmj     unix  -       n       n       -       1       pipe
   flags=ORhu user=mlmmj:mlmmj
   argv=/usr/local/bin/mlmmj-recieve -L /var/mlmmj/${domain}/${user} -s ${sender} -e ${extension}

   FIXME: What about flags=BFXhu, as used by DFRI?
 - main.cf
   postconf mlmmj_destination_recipient_limit=1
   postconf transport_maps=hash:/usr/local/etc/postfix/transport
****** adding domain lists.adb-centralen.se
  - cat >> /etc/crontab <<EOF
  0 */2 * * * mlmmj /usr/local/bin/mlmmj-maintd -F -d /var/mlmmj/lists.adb-centralen.se
  EOF
  - spool dir for lists.adbc
    mkdir /var/mlmmj/lists.adb-centralen.se; chown mlmmj:mlmmj /var/mlmmj/lists.adb-centralen.se
  - make sure that postfix on smtp.adbc has lists.adbc both in $relay_domains and in transport
  - let postfix know @lists.adbc is local
  postconf mydestination | egrep -q lists.adbc-centralen.se || echo "add it!"
****** adding a list
  mlmmj-make-ml -s /var/mlmmj/lists.adb-centralen.se -L testing
  chown -R mlmmj:mlmmj /var/mlmmj/lists.adb-centralen.se/testing
  echo 'testing@lists.adb-centralen.se mlmmj:' >> /usr/local/etc/postfix/transport
  postmap /usr/local/etc/postfix/transport

  echo @lists.adb-centralen.se @lists.adb-centralen.se >> /usr/local/etc/postfix/virtual
  postmap /usr/local/etc/postfix/virtual
  postfix reload


  postfix reload
  # configure the list
  cd /var/mlmmj/lists.adb-centralen.se/testing/control || echo BZZZT
  touch modnonsubposts notifysub subonlyget subonlypost tocc
  echo linus@nordberg.se > moderators
  echo '[Testing]' > prefix
  echo "List-Id: testing@lists.adb-centralen.se" > customheaders
  # subscribing ln+testing@4711.se
  /usr/local/bin/mlmmj-sub -L /var/mlmmj/lists.adb-centralen.se/testing -a ln+testing@4711.se

***** building dovecot <2019-05-08 Wed>
https://vuxml.freebsd.org/freebsd/3f98ccb3-6b8a-11e9-9b5c-a4badb296695.html
https://dovecot.org/list/dovecot-news/2019-April/000409.html
https://dovecot.org/list/dovecot-news/2019-April/000410.html

pkgs not updated in repo so we built from ports
portmaster mail/dovecot mail/dovecot-pigeonhole

May  8 16:12:03 imap pkg-static: pkgconf-1.6.0,1 deinstalled
May  8 16:12:03 imap pkg-static: pkgconf-1.6.1,1 installed
May  8 16:15:46 imap pkg-static: dovecot-2.3.5.1 deinstalled
May  8 16:15:47 imap pkg-static: dovecot-2.3.6 installed
May  8 16:23:11 imap pkg-static: dovecot-pigeonhole-0.5.5 deinstalled
May  8 16:23:11 imap pkg-static: dovecot-pigeonhole-0.5.6 installed

**** llseek -- LDAP server
***** openldap installation and configuration
    pkg install -y openldap-server
    sysrc slapd_enable=yes slapd_sockets="/var/run/openldap/ldapi"
    echo slapd_flags=\'-h \"ldapi://%2Fvar%2Frun%2Fopenldap%2Fldapi/ ldap://0.0.0.0/\"\' >> /etc/rc.conf
    vi /usr/local/etc/openldap/slapd.conf # set schema, suffix, rootdn and rootpw; enable back_mdb; optionally add more index lines

    # This is what we did, but I'm more and more confident that setting up slapd.conf properly and issuing
    #   slaptest -f /usr/local/etc/openldap/slapd.conf -F /usr/local/etc/slapd.d
    # is the better option. Do this with slapd _not_ running and after each change to slapd.conf.
    vi /usr/local/etc/openldap/slapd.ldif # see [[*slapd.ldif][slapd.ldif]]
    mkdir /usr/local/etc/slapd.d
    slapadd -n 0 -F /usr/local/etc/slapd.d -l /usr/local/etc/openldap/slapd.ldif

    service slapd start
***** slapd.ldif
[root@lseek /usr/local/etc]# cat /usr/local/etc/openldap/slapd.ldif | egrep -v ^#
dn: cn=config
objectClass: olcGlobal
cn: config
olcArgsFile: /var/db/run/slapd.args
olcPidFile: /var/db/run/slapd.pid


dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulepath:  /usr/local/libexec/openldap
olcModuleload:  back_mdb.la


dn: cn=schema,cn=config
objectClass: olcSchemaConfig
cn: schema

include: file:///usr/local/etc/openldap/schema/core.ldif

dn: olcDatabase=frontend,cn=config
objectClass: olcDatabaseConfig
objectClass: olcFrontendConfig
olcDatabase: frontend


dn: olcDatabase=mdb,cn=config
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
olcDatabase: mdb
olcSuffix: dc=adb-centralen,dc=se
olcRootDN: cn=admin,dc=adb-centralen,dc=se
olcRootPW: {SSHA}REDACTED
olcDbDirectory: /var/db/openldap-data
olcDbIndex: cn,sn,uid       pres,eq,approx,sub
olcDbIndex: objectClass eq
***** verifying functionality
ldapsearch -H "ldapi://%2Fvar%2Frun%2Fopenldap%2Fldapi/"  -x -b '' -s base '(objectclass=*)' namingContexts
# extended LDIF
#
# LDAPv3
# base <> with scope baseObject
# filter: (objectclass=*)
# requesting: namingContexts 
#

#
dn:
namingContexts: dc=adb-centralen,dc=se

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1

***** LDAP db set up
    pkg install ldapvi
    cat << EOF | ldapadd -x -H "ldapi://%2Fvar%2Frun%2Fopenldap%2Fldapi/" -D "cn=admin,dc=adb-centralen,dc=se" -W
    dn: dc=adb-centralen,dc=se
    objectclass: dcObject
    objectclass: organization
    o: ADB-Centralen
    dc: adb-centralen

    dn: cn=admin,dc=adb-centralen,dc=se
    objectclass: organizationalRole
    cn: admin
    EOF
    # => Enter LDAP Password: 
    # => adding new entry "dc=adb-centralen,dc=se"
    # => adding new entry "cn=admin,dc=adb-centralen,dc=se"
******* verify that it worked
[root@lseek /usr/local/etc/openldap]# ldapsearch -H "ldapi://%2Fvar%2Frun%2Fopenldap%2Fldapi/"  -x -b 'dc=adb-centralen,dc=se' '(objectclass=*)' 
# extended LDIF
#
# LDAPv3
# base <dc=adb-centralen,dc=se> with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# adb-centralen.se
dn: dc=adb-centralen,dc=se
objectClass: dcObject
objectClass: organization
o: ADB-Centralen
dc: adb-centralen

# admin, adb-centralen.se
dn: cn=admin,dc=adb-centralen,dc=se
objectClass: organizationalRole
cn: admin

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2

***** libldap configuration
    ldapvi --encoding=ASCII -h "ldapi://%2Fvar%2Frun%2Fopenldap%2Fldapi/" --discover --config > /usr/local/etc/openldap/ldap.conf

ldapvi --encoding=ASCII should now Just Work.

**** mincore -- minecraft server
See [[file:~/hints.org::*syadmin with paper in new VM, using tmux instead of screen][syadmin with paper in new VM, using tmux instead of screen]]

**** mount2 -- monitoring
**** murmur -- mumble.adbc
**** nextcloud -- clown.adbc
***** installing packages
NOTE: default www/nextcloud uses mysql while we'd prefer pgsql, but
perhaps the sane thing is to test the default packages first and
switch to a non-standard setup only later (but before real use, to
avoid having to migrate any data)
****** pkg install nextcloud-calendar nextcloud-twofactor_totp
...
Message from openldap-client-2.4.46:

************************************************************

The OpenLDAP client package has been successfully installed.

Edit
  /usr/local/etc/openldap/ldap.conf
to change the system-wide client defaults.

Try `man ldap.conf' and visit the OpenLDAP FAQ-O-Matic at
  http://www.OpenLDAP.org/faq/index.cgi?file=3
for more information.

************************************************************
Message from libinotify-20180201:

============================================================================

Libinotify functionality on FreeBSD is missing support for

  - detecting a file being moved into or out of a directory within the
    same filesystem
  - certain modifications to a symbolic link (rather than the
    file it points to.)

in addition to the known limitations on all platforms using kqueue(2)
where various open and close notifications are unimplemented.

This means the following regression tests will fail:

Directory notifications:
   IN_MOVED_FROM
   IN_MOVED_TO

Open/close notifications:
   IN_OPEN
   IN_CLOSE_NOWRITE
   IN_CLOSE_WRITE

Symbolic Link notifications:
   IN_DONT_FOLLOW
   IN_ATTRIB
   IN_MOVE_SELF
   IN_DELETE_SELF

Kernel patches to address the missing directory and symbolic link
notifications are available from:

https://github.com/libinotify-kqueue/libinotify-kqueue/tree/master/patches

=============================================================================
You might want to consider increasing the kern.maxfiles tunable if you plan
to use this library for applications that need to monitor activity of a lot
of files.

If the default on your system is too low, add the following line to
/boot/loader.conf, then reboot the system:

    kern.maxfiles="25000"
=============================================================================
Message from gamin-0.1.10_9:

===============================================================================

Gamin will only provide realtime notification of changes for at most n files,
where n is the minimum value between (kern.maxfiles * 0.7) and
(kern.maxfilesperproc - 200). Beyond that limit, files will be polled.

If you often open several large folders with Nautilus, you might want to
increase the kern.maxfiles tunable (you do not need to set
kern.maxfilesperproc, since it is computed at boot time from kern.maxfiles).

For a typical desktop, add the following line to /boot/loader.conf, then
reboot the system:  

    kern.maxfiles="25000"

The behavior of gamin can be controlled via the various gaminrc files.
See http://www.gnome.org/~veillard/gamin/config.html on how to create
these files.  In particular, if you find gam_server is taking up too much
CPU time polling for changes, something like the following may help
in one of the gaminrc files:

# reduce polling frequency to once per 10 seconds
# for UFS file systems in order to lower CPU load
fsset ufs poll 10   

===============================================================================

===>   NOTICE:

The gamin port currently does not have a maintainer. As a result, it is
more likely to have unresolved issues, not be up-to-date, or even be removed in
the future. To volunteer to maintain this port, please create an issue at:

https://bugs.freebsd.org/bugzilla

More information about port maintainership is available at:

https://www.freebsd.org/doc/en/articles/contributing/ports-contributing.html#maintain-port
Message from samba46-4.6.14:

===============================================================================

How to start: http://wiki.samba.org/index.php/Samba4/HOWTO

 * Your configuration is: /usr/local/etc/smb4.conf

 * All the relevant databases are under: /var/db/samba4

 * All the logs are under: /var/log/samba4

 * Provisioning script is: /usr/local/bin/samba-tool

For additional documentation check: http://wiki.samba.org/index.php/Samba4

Bug reports should go to the: https://bugzilla.samba.org/

===============================================================================
Message from mysql56-client-5.6.40:

 * * * * * * * * * * * * * * * * * * * * * * * *

Please be aware the database client is vulnerable
to CVE-2015-3152 - SSL Downgrade aka "BACKRONYM".
You may find more information at the following URL:

http://www.vuxml.org/freebsd/36bd352d-299b-11e5-86ff-14dae9d210b8.html

Although this database client is not listed as
"affected", it is vulnerable and will not be
receiving a patch. Please take note of this when
deploying this software.

 * * * * * * * * * * * * * * * * * * * * * * * *
Message from nextcloud-13.0.1:

***********************************************************************
 *                         POST INSTALL CONFIGURATION                  *
***********************************************************************

Please note that everything has been installed in /usr/local/www/nextcloud.

You will probably want to add an alias to your httpd.conf file, something
like this:

        Alias /nextcloud /usr/local/www/nextcloud
        AcceptPathInfo On
        <Directory /usr/local/www/nextcloud>
            AllowOverride All
            Require all granted
        </Directory>

And restart Apache.

***********************************************************************
 *                       NEXTCLOUD VERSION UPGRADE                     *
***********************************************************************

After a version migration you should upgrade your nextcloud instance
using command line:

  cd /usr/local/www/nextcloud
  su -m www -c "php ./occ upgrade"

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

                    /!\ NEXTCLOUD 13.0.1 UPDATE /!\

The nextcloud 13.0.1 package changes the location of the bundled apps.
After updating to 13.0.1 you MUST adapt your configuration. You MUST
add an additional entry to the "apps-paths" array in config/config.php

    1 =>
    array (
      'path' => '/usr/local/www/nextcloud/apps-pkg',
      'url' => '/apps-pkg',
      'writable' => false,
    ),

For the default installation, the fix can be applied with:

  cd /usr/local/www/nextcloud
  su -m www -c "php ./occ config:import < /usr/local/share/nextcloud/fix-apps_paths.json"

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

****** php-cgi crashing
- configuring lighttpd with php using fastcgi over a unix socket
  /usr/local/etc/lighttpd/conf.d/fastcgi.conf:
    fastcgi.server = ( ".php" =>
                   ( 
                     "php-local" =>
                     (
                       "socket" => socket_dir + "/php-fastcgi.socket",
                       "bin-path" => server_root + "/cgi-bin/php5",
                       "max-procs" => 1,
                       "broken-scriptfilename" => "enable",
                     )))
- php-cgi kept crashing immediately
  (mod_fastcgi.c.372) unexpected end-of-file (perhaps the fastcgi process died): pid: 6126 socket: unix:/var/run/lighttpd/sockets/php-fastcgi.socket-0 
- disabled all hardening settings for php-cgi, nothing changed
- made user www allowed to write to /usr/local/www/nextcloud and got core file, couldn't make anytying out of it
- rebuilt lang/php56 with debug symbols and no optimisation
  CFLAGS="-g -pipe -DDEBUG_FASTCGI" make clean deinstall reinstall
- configured lighttpd to connect over tcp instead
  /usr/local/etc/lighttpd/conf.d/fastcgi.conf:
    fastcgi.server = ( ".php" =>
                   ( 
                       "php-tcp" =>
                     (
                       "host" => "127.0.0.1",
                       "port" => 9000,
                       "check-local" => "disable",
                       "broken-scriptfilename" => "enable",
                     )))
- ran php-cgi under gdb
  gdb --args ./php-cgi -b 127.0.0.1:9000
- caught crash in zend_accel_script_optimize()
  (gdb) bt
  #0  0x0000025fb8a1a9c5 in zend_accel_script_optimize () from /usr/local/lib/php/20131226/opcache.so
  #1  0x0000025fb8a182f4 in zend_accel_script_optimize () from /usr/local/lib/php/20131226/opcache.so
  #2  0x0000025fb8a1527c in zend_accel_script_optimize () from /usr/local/lib/php/20131226/opcache.so
  #3  0x0000025fb8a1503a in zend_accel_script_optimize () from /usr/local/lib/php/20131226/opcache.so
  #4  0x0000025fb8a08b7c in persistent_compile_file () from /usr/local/lib/php/20131226/opcache.so
  #5  0x0000025fb8a083d7 in persistent_compile_file () from /usr/local/lib/php/20131226/opcache.so
  #6  0x00000000005a0c1e in zend_execute_scripts ()
  #7  0x0000000000538baa in php_execute_script ()
  #8  0x000000000063e715 in main ()
  #9  0x000000000041e6b5 in _start ()
  #10 0x0000025fb6a4f000 in ?? ()
  #11 0x0000000000000000 in ?? ()
- found https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=227723 and patched accordingly
- rebuilt and reinstalled lang/php56 and www/php56-opcache
- now, let's use pgsql after all, since we're building some from ports anyway
Stop. That doesn't make sense -- it's nextcloud that is requiring mysql:
[root@nextcloud ~]# pkg required-depends php56-mysql
php56-pdo_mysql-5.6.37
[root@nextcloud ~]# pkg required-depends php56-pdo_mysql
nextcloud-13.0.1

Besides, we won't be building php-cgi forever.
****** php configuration
- php.ini opcache settings set as specified in https://ramsdenj.com/2017/06/05/nextcloud-in-a-jail-on-freebsd.html#opcache
***** installing packages, take two <2018-08-29 Wed>
pkg install nextcloud-calendar-php56 mysql56-server apache24
***** installing packages^Wports, take three <2018-09-03 Mon>
The problem with take two was that when allowing nextcloud to upgrade
itself, which we want, the packages doesn't match anymore. The real
problem starts when you upgrade (or reinstall) them.

Installing the nextcloud ports instead and avoiding upgrades using the
"Updater App".
- pkg install nextcloud-php56 # tried php72 but "things didn't work"
  (php-fpm kept returning nothing, like it'd crashed, despite secadm
  rules)
- <do initial nextcloud configuration, using occ, see below>
- service lighttpd stop
- portmaster www/nextcloud # bringing it up to 13.0.6
- su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
- service lighttpd start

More apps
portmaster www/nextcloud-calendar www/nextcloud-contacts www/nextcloud-notes www/nextcloud-tasks mail/nextcloud-mail security/nextcloud-passman security/nextcloud-twofactor_totp

***** configuring apache24
****** httpd.conf
ServerAdmin hostmaster@adb-centralen.se
ServerName clown.adb-centralen.se
DocumentRoot "/usr/local/www/nextcloud"

LoadModule socache_shmcb_module libexec/apache24/mod_socache_shmcb.so
LoadModule ssl_module libexec/apache24/mod_ssl.so
LoadModule rewrite_module libexec/apache24/mod_rewrite.so
LoadModule php5_module        libexec/apache24/libphp5.so

<IfModule mod_headers.c>
  Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
</IfModule>

Include etc/apache24/extra/httpd-default.conf
Include etc/apache24/extra/httpd-ssl.conf

<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch "\.phps$">
    SetHandler application/x-httpd-php-source
</FilesMatch>

<Directory "/usr/local/www/nextcloud">
    AllowOverride All
    SetEnv HOME /usr/local/www/nextcloud
    SetEnv HTTP_HOME /usr/local/www/nextcloud
 </Directory>

<VirtualHost _default_:80>                       
  DocumentRoot /var/www/nextcloud                
  <IfModule mod_rewrite.c>                       
    RewriteEngine On    
    RewriteCond %{HTTPS} !=on                    
    RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]                                           
  </IfModule>           
</VirtualHost>
****** extra/httpd-ssl.conf
SSLRandomSeed startup file:/dev/urandom 1024
SSLRandomSeed connect file:/dev/urandom 512

Listen 192.168.0.14:443
Listen [fd00::14]:443

<VirtualHost _default_:443>
  DocumentRoot "/usr/local/www/nextcloud"
  ServerName clown.adb-centralen.se
  ServerAdmin hostmaster@adb-centralen.se

  <IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
  </IfModule>

  SSLCertificateFile "/usr/local/etc/apache24/server.pem"
  SSLCertificateKeyFile "/usr/local/etc/apache24/privkey.pem"
  SSLCertificateChainFile "/usr/local/etc/apache24/le.pem"

  Alias /nextcloud "/usr/local/www/nextcloud/"

  <Directory /usr/local/www/nextcloud/>
    Options +FollowSymlinks
    AllowOverride All
    <IfModule mod_dav.c>
      Dav off
    </IfModule>
    SetEnv HOME /usr/local/www/nextcloud
    SetEnv HTTP_HOME /usr/local/www/nextcloud
  </Directory>
</VirtualHost>

***** configuring mysql 
sysrc mysql_enable=yes
service mysql-server start
mysql_secure_installation # root pw <sikrit>; Y on all questions
mysql> create user 'admin'@'localhost' identified by '<sikrit>y';
mysql> grant all privileges on *.* to 'admin'@'localhost' with grant option;
- update 2018-09-09: there's no good reason for not just handing over
  root's pw to nextcloud and skip that admin part
***** configuring nextcloud
chpass -s /bin/sh www
HISTFILE= su www
php /usr/local/www/nextcloud/occ maintenance:install --database mysql --database-name nextcloud --database-user admin --database-pass <sikrit> --admin-user admin12 --admin-pass <sikrit>
> Nextcloud is not installed - only a limited number of commands are available
> Nextcloud was successfully installed
exit
chpass -s /usr/sbin/nologin www

Enabling IMAP authn:
  'user_backends' =>
  array (
    0 =>
    array (
      'class' => 'OC_User_IMAP',
      'arguments' =>
      array (
        0 => '{imap.adb-centralen.se:993/imap/ssl/readonly/novalidate-cert}',
      ),
    ),
  ),
***** configuring php
- using php56 since anything newer (70, 71, 72) reults in a crashing php-fpm (as of sept 2018)
  - update 2018-09-09: secadm policy mps helps with that, as verified on nc3 using php71
- not using pecl-APCu; seems to be crashing php-fpm
- using php56-pecl-memcached, with a 'd', which is using libmemcached
  pkg install memcached php56-pecl-memcached
  sysrc memcached_enable=yes
  TODO: configure memcached the daemon
    - bind to localhost:11211 (default)
    - -m 512 # MB, default=64
  FIXME: configure nextcloud (config.php)
    'memcache.local' => '\OC\Memcache\Memcached',
    'memcache.distributed' => '\OC\Memcache\Memcached',
    'memcached_servers' => array(
       array('localhost', 11211),
       ),
***** changelog
- /etc/hosts
  192.168.0.14    clown.adb-centralen.se
  fd00::14        clown.adb-centralen.se
- new IP address, .100
***** letsencrypt
****** dehydrated <2018-11-23 Fri>
pkg install dehydrated
export CONTACT=hostmaster@adb-centralen.se
cat /usr/local/etc/dehydrated/config.sample | sed -e 's|#HOOK=|HOOK=${BASEDIR}/hook.sh|1' -e "s/#CONTACT_EMAIL=/CONTACT_EMAIL=${CONTACT}/1" > /usr/local/etc/dehydrated/config
cp /usr/local/etc/dehydrated/hook.sh.sample /usr/local/etc/dehydrated/hook.sh
cat > /usr/local/etc/dehydrated/deploy_cert_apache.sh << EOF
#! /bin/sh
set -eu

main() {
  local DOMAIN="\${1}" KEYFILE="\${2}" CERTFILE="\${3}" FULLCHAINFILE="\${4}" CHAINFILE="\${5}" TIMESTAMP="\${6}"

  DEST=/usr/local/etc/apache24/\${DOMAIN}.crt.pem
  [ -e \$DEST ] && cp -a \$DEST \$DEST.\$(date +%s)
  cat \$CERTFILE \$CHAINFILE > \$DEST
  chmod 644 \$DEST
  chown root:www \$DEST

  DEST=/usr/local/etc/apache24/\${DOMAIN}.key.pem
  [ -e \$DEST ] && cp -a \$DEST \$DEST.\$(date +%s)
  cp -a \$DEST \$DEST.\$(date +%s)
  cp \$KEYFILE \$DEST
  chmod 640 \$DEST
  chown root:www \$DEST

  service apache24 restart
}

main \$@
EOF
chmod +x /usr/local/etc/dehydrated/deploy_cert_apache.sh
$EDITOR /usr/local/etc/dehydrated/hook.sh  # make deploy_cert() invoke /usr/local/etc/dehydrated/deploy_cert_apache.sh $@
chmod +x /usr/local/etc/dehydrated/hook.sh
echo clown.adb-centralen.se > /usr/local/etc/dehydrated/domains.txt
****** apache24 config
<VirtualHost _default_:80>
  <Directory "/usr/local/www/dehydrated">
    Options None
    AllowOverride None
    Require all granted
    ForceType text/plain
    #RedirectMatch 404 "^(?!/\.well-known/acme-challenge/[\w-]{43}$)"
  </Directory>
  Alias /.well-known/acme-challenge/ /usr/local/www/dehydrated/
  <IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge [NC]
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
  </IfModule>
</VirtualHost>
****** finish
service apache24 restart
dehydrated -c
sysrc -f /etc/periodic.conf weekly_dehydrated_enable=yes
***** upgrading 13.0.6 to 14.0.4 <2018-12-09 Sun>
- We skipped using ports since packages were up-to-date.
- nc14 did not want to run with php56 so we upgraded to php70.
- php70 is unable to load opcache
  (/usr/local/lib/php/20151012/opcache.so: Undefined symbol
  "zend_file_cache_script_store")
- php70 needs secadm rules, and so does apache when running php7
- we should try php73 at some point
****** step by step [15/15]
- [X] cd /usr/ports; git pull
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] : on kcmp ; sleep 300; iocage snapshot nextcloud
Snapshot: zroot/iocage/jails/nextcloud@2018-12-08_23:11:39 created.
- #pkg lock -g nextcloud*
- [X] pkg upgrade
Message from php56-*
Security Support ends on 31 Dec 2018.
- #portmaster -b nextcloud
- [X] su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
This version of Nextcloud requires at least PHP 7.0<br/>You are currently running 5.6.38. Please update your PHP version.
- [X] pkg delete nextcloud-php56
Installed packages to be REMOVED:
        nextcloud-php56-14.0.4
        nextcloud-passman-php56-2.1.4_1
        nextcloud-tasks-php56-0.9.8
        nextcloud-notes-php56-2.5.0
        nextcloud-mail-php56-0.11.0
        nextcloud-contacts-php56-2.1.7
        nextcloud-calendar-php56-1.6.4
- [X] pkg install nextcloud-php70
- [X] pkg install nextcloud-calendar-php70 nextcloud-contacts-php70 nextcloud-mail-php70 nextcloud-notes-php70 nextcloud-tasks-php70
- [X] su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
Failed loading /usr/local/lib/php/20151012/opcache.so:  /usr/local/lib/php/20151012/opcache.so: Undefined symbol "zend_file_cache_script_store"
: Note that this is a warning and not a fatal error. Ignore for now.
- [X] pkg delete mod_php56; pkg install mod_php70; $EDITOR /usr/local/etc/apache24/httpd.conf # LoadModule php7_module libexec/apache24/libphp7.so
- [X] add secadm rules php and apache24+php71
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
The current PHP memory limit is below the recommended value of 512MB.
Disabled incompatible app: announcementcenter
Disabled incompatible app: circles
Disabled incompatible app: spreed
Disabled incompatible app: twofactor_yubikey
Update successful
Maintenance mode is kept active
: apache keeps exiting on signal 11, needs a secadm rule, restarting the jail does the trick
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
- [X] su -m www -c "php console.php files:scan --all"
- [X] $EDITOR /usr/local/etc/php.ini # memory_limit=512M

***** upgrading php70 -> php73 and nextcloud-php70-14.0.4 -> nextcloud-php73-15.0.4
- https://security-tracker.debian.org/tracker/php7.0
- CVE ID         : CVE-2018-14851 CVE-2018-14883 CVE-2018-17082
                 CVE-2018-19518 CVE-2018-19935
****** steps [14/14]
- [X] pkg info nextcloud-\*
nextcloud-calendar-php70-1.6.4
nextcloud-contacts-php70-2.1.7
nextcloud-mail-php70-0.11.0
nextcloud-notes-php70-2.5.0
nextcloud-php70-14.0.4
nextcloud-tasks-php70-0.9.8
- [X] $EDITOR /etc/crontab # disable backups
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] : on kcmp && sleep 300; iocage snapshot nextcloud
- [X] sysrc secadm_enable=no
- [X] : on kcmp && iocage restart nextcloud
- [X] pkg delete nextcloud-\* mod_php70 php70-\*
- [X] pkg install nextcloud-php73 mod_php73
- [X] pkg install nextcloud-calendar-php73 nextcloud-contacts-php73 nextcloud-mail-php73 nextcloud-notes-php73 nextcloud-tasks-php73
- [X] sysrc secadm_enable=yes; service secadm start
- [X] service apache24 restart
- [X] : if any nextcloud-* packages changed version && cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
- [X] $EDITOR /etc/crontab # enable backups
***** upgrading nextcloud-php73-15.0.7 -> nextcloud-php73-16.0.0 <2019-08-28 Wed>
upgrading hbsd base 11.2 -> 12.0

- [X] pkg info nextcloud-\*
nextcloud-calendar-php73-1.6.4
nextcloud-contacts-php73-3.1.0
nextcloud-mail-php73-0.11.0
nextcloud-notes-php73-2.5.1
nextcloud-php73-15.0.7
nextcloud-tasks-php73-0.9.8
- [X] $EDITOR /etc/crontab # disable backups
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] : on kcmp && sleep 300; iocage snapshot nextcloud
Snapshot: zroot/iocage/jails/nextcloud@2019-08-28_06:42:32 created.
- [X] : on kcmp && ./hbsd-upgrade.sh hupd 3
- [X] pkg-static install -fy pkg
- [X] pkg update && pkg upgrade
        nextcloud-tasks-php73: 0.9.8 -> 0.11.0
        nextcloud-php73: 15.0.7 -> 16.0.2
        nextcloud-notes-php73: 2.5.1 -> 3.0.0
        nextcloud-mail-php73: 0.11.0 -> 0.15.1
        nextcloud-contacts-php73: 3.1.0 -> 3.1.3
        nextcloud-calendar-php73: 1.6.4 -> 1.7.0
- [X] : on kcmp && iocage restart nextcloud
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
httpd      83480 6  tcp6   2001:6b0:8::100:443   *:*
root     httpd      65119 3  tcp4   193.10.5.100:80       *:*
root     httpd      65119 4  tcp6   2001:6b0:8::100:80    *:*
root     httpd      65119 5  tcp4   193.10.5.100:443      *:*
root     httpd      65119 6  tcp6   2001:6b0:8::100:443   *:*
mysql    mysqld     62492 19 tcp46  *:3306                *:*
root     master     98560 13 tcp4   193.10.5.100:25       *:*
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
- [X] : in a browser, visit https://clown.adb-centralen.se/ and click "upgrade". Twice (no idea why).
- [X] $EDITOR /etc/crontab # enable backups
***** upgrading nextcloud-php73-16.0.2 -> nextcloud-php73-17.0.0 <2019-10-23 Wed>
- [X] pkg info nextcloud-\*
nextcloud-calendar-php73-1.7.0
nextcloud-contacts-php73-3.1.3
nextcloud-mail-php73-0.15.1
nextcloud-notes-php73-3.0.0
nextcloud-php73-16.0.2
nextcloud-tasks-php73-0.11.0
- [X] $EDITOR /etc/crontab # disable backups
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] /root/dump-nextcloud-db.sh
- [X] env BORG_REPO=bup@bup_flow:borg/nextcloud borg create -e /var/cache ::{utcnow:%Y-%m-%dT%H:%M:%SZ} /etc /usr/local/etc /root /var
- [X] : on kcmp && sleep 120; iocage snapshot nextcloud
- [X] pkg update && pkg upgrade -r adbc
nextcloud-php73 upgraded: 16.0.2 -> 17.0.0 
nextcloud-tasks-php73 upgraded: 0.11.0 -> 0.11.3 
nextcloud-notes-php73 upgraded: 3.0.0 -> 3.0.3 
nextcloud-mail-php73 upgraded: 0.15.1 -> 0.17.0 
nextcloud-contacts-php73 upgraded: 3.1.3 -> 3.1.4 
nextcloud-calendar-php73 upgraded: 1.7.0 -> 1.7.1 
- [X] : on kcmp && iocage restart nextcloud
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade" # yes, again
- [X] $EDITOR /etc/crontab # enable backups
***** nextcloud-php73: 17.0.1 -> 17.0.2
- [X] pkg info nextcloud-\*
nextcloud-calendar-php73-1.7.1
nextcloud-contacts-php73-3.1.6
nextcloud-mail-php73-0.18.1
nextcloud-notes-php73-3.0.3
nextcloud-php73-17.0.1
nextcloud-tasks-php73-0.11.3
- none of the usual steps were performed, bc mass upgrade of jails and
  this procedure was forgotten
- so at the next visit, i was prompted to upgrade to 17.0.2, twice
- things look good anyway, afaict
***** nextcloud VERn -> VERm template
- [ ] pkg info nextcloud-\*
- [ ] $EDITOR /etc/crontab # disable backups or at least make sure they ain't gonna run right now
- [ ] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [ ] sleep 60   # to let all clients finish their stuff, maybe
- [ ] /root/dump-nextcloud-db.sh
- [ ] env BUP_RATE_LIMIT= my_bup.sh
- [ ] : on kcmp && iocage snapshot nextcloud
- [ ] pkg update && pkg upgrade -r adbc
- [ ] : on kcmp && iocage restart nextcloud
- [ ] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
- [ ] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
- [ ] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade" # yes, again
- [ ] $EDITOR /etc/crontab # enable backups, if they were disabled
***** nextcloud-php73-17.0.2 -> 18.0.0 <2020-02-10 Mon>
- [X] pkg info nextcloud-\*
nextcloud-calendar-php73-1.7.1
nextcloud-contacts-php73-3.1.6
nextcloud-mail-php73-0.21.0
nextcloud-notes-php73-3.1.1
nextcloud-php73-17.0.2
nextcloud-tasks-php73-0.11.3
- [X] $EDITOR /etc/crontab # disable backups or at least make sure they ain't gonna run right now
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] sleep 60   # to let all clients finish their stuff, maybe
- [X] /root/dump-nextcloud-db.sh
- [X] env BUP_RATE_LIMIT= my_bup.sh
- [X] : on kcmp && iocage snapshot nextcloud
- [X] pkg update && pkg upgrade -r adbc
nextcloud-php73 upgraded: 17.0.2 -> 18.0.0 
nextcloud-mail-php73 upgraded: 0.21.0 -> 1.0.0 
nextcloud-contacts-php73 upgraded: 3.1.6 -> 3.1.7 
nextcloud-calendar-php73 upgraded: 1.7.1 -> 2.0.0 
- [X] : on kcmp && iocage restart nextcloud
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
fixme: The current PHP memory limit is below the recommended value of 512MB.
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade" # yes, again
- [X] $EDITOR /etc/crontab # enable backups, if they were disabled

This upgrade took 22 minutes, out of which ~6 were slow backup (bc
rate limiting).

***** nextcloud-php73-18.0.0 -> 18.0.1 <2020-03-13 Fri>
- [X] [root@clown ~]# pkg info nextcloud\*
nextcloud-calendar-php73-2.0.0
nextcloud-contacts-php73-3.1.7
nextcloud-mail-php73-1.0.0
nextcloud-notes-php73-3.1.1
nextcloud-php73-18.0.0
nextcloud-tasks-php73-0.11.3
- [X] $EDITOR /etc/crontab # disable backups or at least make sure they ain't gonna run right now
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] sleep 60   # to let all clients finish their stuff, maybe
- [X] /root/dump-nextcloud-db.sh
- [X] env BUP_RATE_LIMIT=- my_bup.sh
- [X] : on kcmp && iocage snapshot nextcloud
- [X] pkg update && pkg upgrade -r adbc
nextcloud-php73 upgraded: 18.0.0 -> 18.0.1
nextcloud-notes-php73 upgraded: 3.1.1 -> 3.1.5
nextcloud-mail-php73 upgraded: 1.0.0 -> 1.1.2
nextcloud-contacts-php73 upgraded: 3.1.7 -> 3.2.0
nextcloud-calendar-php73 upgraded: 2.0.0 -> 2.0.1
- [X] : on kcmp && iocage restart nextcloud
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
The current PHP memory limit is below the recommended value of 512MB.
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade" # yes, again
Had no effect this time, maybe because not major upgrade?
- [X] $EDITOR /etc/crontab # enable backups, if they were disabled

This upgrade took 18 minutes, out of which many were spent on the slow
backup (bc rate limiting wasn't disabled after all).

***** nextcloud-php73-18.0.1 -> 18.0.2 <2020-03-16 Mon>
- [X] pkg info nextcloud\*
nextcloud-calendar-php73-2.0.1
nextcloud-contacts-php73-3.2.0
nextcloud-mail-php73-1.1.2
nextcloud-notes-php73-3.1.5
nextcloud-php73-18.0.1
nextcloud-tasks-php73-0.11.3
- [X] $EDITOR /etc/crontab # disable backups or at least make sure they ain't gonna run right now
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] sleep 60   # to let all clients finish their stuff, maybe
- [X] /root/dump-nextcloud-db.sh
- [X] env BUP_RATE_LIMIT=- time my_bup.sh
- [X] : on kcmp && iocage snapshot nextcloud
- [X] pkg update && pkg upgrade -r adbc
- [X] : on kcmp && iocage restart nextcloud
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
The current PHP memory limit is below the recommended value of 512MB.
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade" # yes, again
Had no effect this time, maybe because not major upgrade?
- [X] $EDITOR /etc/crontab # enable backups, if they were disabled

This upgrade took 19 minutes, out of which 6 were spent on the backup,
without rate limiting. And a few of the minutes were fiddling with pkg
repo upgrades.

***** php73 -> php74 and nextcloud-php73-18.0.2 -> nextcloud-php74-18.0.4 2020-05-08
- [X] pkg info nextcloud\*
nextcloud-calendar-php73-2.0.2
nextcloud-contacts-php73-3.2.0
nextcloud-mail-php73-1.1.3
nextcloud-notes-php73-3.2.0
nextcloud-php73-18.0.2
nextcloud-tasks-php73-0.12.1
- [X] $EDITOR /etc/crontab # disable mysql dump or at least make sure it ain't gonna run right now
- [X] crontab -e # disable backups
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --on"
- [X] sleep 60   # to let all clients finish their stuff, maybe
- [X] /root/dump-nextcloud-db.sh
- [X] env BUP_RATE_LIMIT=- time my_bup.sh
- [X] : on kcmp && iocage snapshot nextcloud
- [X] sysrc secadm_enable=no
- [X] : on kcmp && iocage restart nextcloud # to disable secadm
- [X] pkg delete nextcloud-\* mod_php73 php73-\*
- [X] pkg update && pkg upgrade -r adbc
- [X] pkg install nextcloud-php74 nextcloud-calendar-php74 nextcloud-contacts-php74 nextcloud-mail-php74 nextcloud-notes-php74 nextcloud-tasks-php74 mod_php74
- [X] sysrc secadm_enable=yes
- [X] : on kcmp && iocage restart nextcloud
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
Updating <mail> ...
Purify and migrate collected mail addresses

 Done
 103/103 [============================] 100%
Insert sync background job for all accounts
 Done
 13/13 [============================] 100%
Repair warning: Can't make itinerary extractor executable: chmod returned false
- [X] su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
- [X] cd /usr/local/www/nextcloud; su -m www -c "php /usr/local/www/nextcloud/occ upgrade" # yes, again
- [X] $EDITOR /etc/crontab # enable mysql dump, if it was disabled
- [X] crontab -e # enable backups
- [X] pkg info nextcloud\*
nextcloud-calendar-php74-2.0.3
nextcloud-contacts-php74-3.3.0
nextcloud-mail-php74-1.3.4
nextcloud-notes-php74-3.2.0
nextcloud-php74-18.0.4
nextcloud-tasks-php74-0.12.1

This upgrade took 25 minutes, out of which 6 were spent on the backup.

***** Nextcloud 18.0.4 -> 18.0.14 <2021-03-15 Mon>
In order to get to 20.x, we need to upgrade in steps. At least
according to [0]. The HBSD ports don't do major versions in separate
ports so it seems tricky to find latest 18 and latest 19. Therefore,
we use the builtin upgrade thing, aka the Updater, instead.

One immediate crux is that 'www' cannot write to certain parts of the
file system:

    drwxr-xr-x  2 root  www  3 May  8  2020 /usr/local/www/nextcloud/updater/

So let's change that. It seems like we have a mix in
/usr/local/www/nextcloud/ when it comes to ownershiop -- a few files
and directories are owned by 'www' and the rest by 'root'. It seems
like we can not be conservative and change as little as possible --
the update procedure needs to change a lot, so let 'www' own it all:

    [root@clown /usr/local/www/nextcloud]# chown -R www .

[0] https://docs.nextcloud.com/server/21/admin_manual/maintenance/upgrade.html
***** 18.0.14 -> 19.0.9 <2021-03-15 Mon>
This is a step towards 21. The Updater button for 19 was found under
Settings -> Administration -> Overview. Update channel was 'stable'.

A backup was taken before starting the upgrade:

    /root/dump-nextcloud-db.sh
    BUP_RATE_LIMIT=- /usr/local/bin/my_bup.sh

After the upgrade, database stuff was done:

    occ db:add-missing-indices
    occ db:add-missing-columns
    occ db:convert-filecache-bigint

***** 19.0.9 -> 20.0.8 <2021-03-15 Mon>
Same general comments as for 18 -> 19 apply.

In the web based update thingie, the following occured:
Checking for update of app "mail" in appstore
Update app "mail" from appstore
An error occurred.

Running the upgrade once more fixed the issue:

    cd /usr/local/www/nextcloud
    su -m www -c "php /usr/local/www/nextcloud/occ upgrade"
    su -m www -c "php /usr/local/www/nextcloud/occ maintenance:mode --off"
    su -m www -c "php /usr/local/www/nextcloud/occ upgrade"

After the upgrade, database stuff was done:

    occ db:add-missing-indices
    occ db:add-missing-primary-keys
    occ db:convert-filecache-bigint

***** TODO upgrade (most of) packages
The PHP packages need point release upgrades, and a bunch of other
packages need smaller upgrades too.

MySQL is at 5.6.48 and needs to go to 8 or higher for Nextcloud 21 to
be happy. So databases/mysql80-server or databases/mariadb105-server.


***** TODO Enabling MySQL 4-byte support
- https://docs.nextcloud.com/server/18/admin_manual/configuration_database/mysql_4byte_support.html
- don't forget `--default-character-set=utf8mb4' to mysqldump
***** missing 6 days of backups <2022-03-16 Wed>
bpf.vdse was down since march 10, fixed now <2022-03-16 Wed>

[root@clown /usr/local/nextcloud/data]# time my_bup.sh 

real    42m29.966s
user    4m28.178s
sys     0m36.656s
[root@clown /usr/local/nextcloud/data]# borg list | tail
2022-02-27T22:39:32Z                 Sun, 2022-02-27 23:39:34 [17ec554c6275cb039578a847a22310bfcecf00cac68bbadce20467fbd7c42ca9]
2022-02-28T22:43:40Z                 Mon, 2022-02-28 23:43:42 [adf12ba1c91bc063ca537dc163479a0f735594ed25c45d014122883cbc3c1948]
2022-03-04T22:41:40Z                 Fri, 2022-03-04 23:41:42 [7c02d86bd38926dd1483bcf8e5d1eab9b6fb3fbe8b8a34de7392e5189ff15e31]
2022-03-05T22:43:35Z                 Sat, 2022-03-05 23:43:37 [a3167bf50b4b2ba4aec695c7faefa353cb7d9dd8836b38efd65bb92250731d8d]
2022-03-06T22:43:01Z                 Sun, 2022-03-06 23:43:02 [7dbac0eca992076688d2892650bde77952829c6ae2592a66e6ce65bbc893e16f]
2022-03-07T22:44:45Z                 Mon, 2022-03-07 23:44:47 [a4575aba7010e11ab904022be2b678960bb17cd7b115b33060f8b3c99ded109f]
2022-03-08T22:36:11Z                 Tue, 2022-03-08 23:36:13 [4a476f3a956627bebd6e55add0049a85ea5a9d9de494d451367cff1ad38010a2]
2022-03-09T22:37:21Z                 Wed, 2022-03-09 23:37:23 [f3d03ca8dbcc38c90120b3daca331a1ba02850010e56f88456a52abe7d9165a1]
2022-03-10T04:43:06Z                 Thu, 2022-03-10 05:43:07 [a2bfa344974a4e8a621a17f2a743cba733363cda5f599d107b90b01aa277a451]
2022-03-16T10:11:19Z                 Wed, 2022-03-16 11:11:20 [d383c24cbe076eeb4c75a93d719dc7e1fbea7013c097d05f472a4c1e7ce1fcba]

**** ns -- authoritative name server
pkg install knot2

https://knot.readthedocs.io/en/stable/index.html -- authoritative name server

***** _nsupdate
****** setup
- on le as root
ssh-keygen -t ed25519 -f ~_dehydrated/.ssh/challenge
cat > /usr/local/etc/dehydrated/hook.sh <<EOF
deploy_challenge() {
    local DOMAIN="${1}" TOKEN_FILENAME="${2}" TOKEN_VALUE="${3}"
    RR="_acme-challenge.${DOMAIN}. IN TXT ${TOKEN_VALUE}"
    printf "Adding TXT record for %s:\n" ${DOMAIN}
    echo "add ${DOMAIN} ${TOKEN_VALUE}" | ssh -T -l _nsupdate -i /home/_dehydrated/.ssh/challenge -o "UserKnownHostsFile /home/_dehydrated/.ssh/known_hosts" -p 4722 ns.adb-centralen.se
}
clean_challenge() {
    printf "Removing TXT record for ${DOMAIN}\n"
    echo "del ${DOMAIN}" | ssh -T -l _nsupdate -i /home/_dehydrated/.ssh/challenge -o "UserKnownHostsFile /home/_dehydrated/.ssh/known_hosts" -p 4722 ns.adb-centralen.se
}
EOF

- on ns as root
install adb-centralen/src/nsupdate-le.sh /usr/local/sbin/
cat > ~_nsupdate/.ssh/authorized_keys <<EOF
restrict,command="/usr/local/sbin/nsupdate-le.sh" ssh-ed25519 ${PUBKEY_FROM_LE} _dehydrated@le
EOF
****** generating new certs
- on le as root
su -m _dehydrated -c "/usr/local/bin/dehydrated -c"

**** pipe (pkg) -- hbsd packages
Serving pkg.adb-centralen.se over https.

- Packages come from build@flow
  - building
poudriere bulk -f /usr/local/etc/pkglist -j 12amd64
  - signing
pkg repo /zroot/build_poudriere/data/packages/12amd64-default /usr/local/etc/pkgrepo_privkey.pem
  - syncing
Host pkg.adb-centralen.se
        user pkgsync
        port 4722
        identityfile /root/.ssh/pkgsync 
        batchmode yes

<2020-03-16 Mon>
poudriere bulk -f /usr/local/etc/pkglist -j 12_1_amd64
pkg repo /zroot/build_poudriere/data/packages/12_1_amd64-default /usr/local/etc/pkgrepo_privkey.pem
rsync -av --delete /zroot/build_poudriere/data/packages/12_1_amd64-default/ pkg.adb-centralen.se:tmprepo/HardenedBSD/pkg/FreeBSD:12:amd64

**** readahead -- random data gatherer, for noisydiode
**** resolver1 -- dns resolver
pkg install unbound
unbound-control-setup
sysrc unbound_enable=yes
printf "daemon.warning\t\t/var/log/daemon\n" >> /etc/syslog.conf
service syslogd restart
service unbound start

[root@resolver1 /usr/local/etc/unbound]# /usr/local/sbin/unbound-control status
version: 1.7.3
verbosity: 1
threads: 1
modules: 2 [ validator iterator ]
uptime: 544 seconds
options: control
unbound (pid 36682) is running...
 -- dns resolver
**** select -- spam filter
**** tee -- tetrinet server (basild)
**** NOT (YET) IN USE
***** db1 -- postgresql
 pkg install -y postgresql10-server postgresql10-client postgresql10-docs
 sysrc postgresql_enable=yes
 echo local0.info /var/log/postgres.log >> /etc/syslog.conf
 service syslogd reload

 [root@db1 ~]# service postgresql initdb
 The files belonging to this database system will be owned by user "postgres".
 This user must also own the server process.

 The database cluster will be initialized with locale "C".
 The default text search configuration will be set to "english".

 Data page checksums are disabled.

 creating directory /var/db/postgres/data10 ... ok
 creating subdirectories ... ok
 selecting default max_connections ... 100
 selecting default shared_buffers ... 128MB
 selecting dynamic shared memory implementation ... posix
 creating configuration files ... ok
 running bootstrap script ... ok
 performing post-bootstrap initialization ... ok
 syncing data to disk ... ok

 WARNING: enabling "trust" authentication for local connections
 You can change this by editing pg_hba.conf or using the option -A, or
 --auth-local and --auth-host, the next time you run initdb.

 Success. You can now start the database server using:

     /usr/local/bin/pg_ctl -D /var/db/postgres/data10 -l logfile start

 - put the database storage in its own zfs dataset
   zfs create -o mountpoint=/db -o quota=20G -o primarycache=metadata -o atime=off -o recordsize=16K zroot/db
   iocage set jail_zfs=on db1
   zfs set quota=20G primarycache=metadata atime=off recordsize=16K zroot/iocage/jails/db1/data
   iocage start db1
   iocage exec db1 zfs set mountpoint=/db zroot/iocage/jails/db1/data

   - re quota: never let usage exceed 80% of vdev size
   - see
     https://people.freebsd.org/~seanc/postgresql/scale15x-2017-postgresql_zfs_best_practices.pdf
     pages 70 and forward
   - TODO: maybe limit max ARC size to 20% of physical RAM + 50% of shared_buffers

 - enable nightly backups of all db's
 sysrc daily_pgsql_backup_enable=yes
***** nc3 -- nextcloud experiments
 - Need a nextcloud instance on php71 since php56 is going away. From
   UPDATES:
 20180905:
   AFFECTS: users of lang/php56
   AUTHOR: tz@FreeBSD.org

   The default version of PHP has been switched from 5.6 to 7.1.

   If you use binary packages you should make a list of php packages
   before running 'pkg upgrade':

   # pkg info php5\* > ~/installed-php-ports-list

   After the upgrade, check with such list if all your php extensions
   are still installed, and reinstall them if needed.

 - installation and configuration
 pkg install -y git-lite portmaster
 git clone --single-branch --branch master https://github.com/hardenedbsd/hardenedbsd-ports/ /usr/ports/ 
 pkg install mysql56-server lighttpd $(pkg rquery %dn nextcloud-php71)
 portmaster www/nextcloud www/nextcloud-calendar www/nextcloud-contacts www/nextcloud-notes www/nextcloud-tasks mail/nextcloud-mail
 sysrc lighttpd_enable=yes php_fpm_enable=yes mysql_enable=yes
 printf 'daemon.*\t\t\t/var/log/daemon\n' > /etc/syslog.d/daemon.conf
 touch /var/log/daemon
 service syslogd restart
 openssl dhparam -out /usr/local/etc/lighttpd/dhparams.pem 4096
 service mysql-server start
 mysql_secure_installation	# root: kLKY0zoAm3UwE0F8beOvrIT7kYcBcssG
****** php-production.ini
 always_populate_raw_post_data = -1
 <FIXME opcache settings>
****** nextcloud install and config
 occ maintenance:install
 chpass -s /bin/sh www
 HISTFILE= su www
 # admin16 pHBKR3L8xApaxeTro6fMfpi7e07QjNEC
 php /usr/local/www/nextcloud/occ maintenance:install --database mysql --database-name nextcloud --database-user root --database-pass <sikrit> --admin-user admin16 --admin-pass <sikrit>
 exit

 mkdir /usr/local/nextcloud
 mv /usr/local/www/nextcloud/data /usr/local/nextcloud/
 vi /usr/local/www/nextcloud/config/config.php # change datadir path

 su -m www -c "php ./occ config:import < /usr/local/share/nextcloud/fix-apps_paths.json"
****** LDAP
 - Using openldap-server, can we make it query kdc.adbc? No, but we can
   make it authenticate clients using kdc. Not worth it.
 - Can we _easily_ make kdc.adbc use a new ldap server as backend, for
   easier migration (dovecot, smtpd)? I doubt that we want kerberos
   keys in LDAP.
****** HISTORICAL
******* ligghtpd/lighttpd.conf
  - NOTE NOTE NOTE: lighttpd is NOT a good idea 
    - While it seems to work to begin with, subtle things won't
      work,like setting quota and group admin, uploading files from web,
      and probably more.
    - the hint that finally made me test apache24 was the notes about
      fastcgi in
      https://help.nextcloud.com/t/site-fails-to-redirects-to-settings-admin-went-to-https-settings-admin-instead/24013

  var.server_root = "/usr/local/www"
  server.port = 81	# maybe

  $SERVER["socket"] == "127.0.0.1:443" {
    ssl.engine                  = "enable"
    ssl.ca-file = conf_dir + "/certs/le.pem"
    ssl.pemfile = conf_dir + "/certs/clown.adb-centralen.se.pem"
    ssl.use-sslv2               = "disable"
    ssl.use-sslv3               = "disable"
    ssl.dh-file               = conf_dir + "/dhparams.pem"
    ssl.ec-curve              = "secp384r1"
    ssl.honor-cipher-order    = "enable"
    ssl.cipher-list           = "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS"

    setenv.add-response-header = ("Strict-Transport-Security" => "max-age=26280000;includeSubdomains","cache-control" => "public")

    server.name                 = "clown.adb-centralen.se"
    server.document-root        = "/usr/local/www/nextcloud"

    $HTTP["url"] =~ "^/.well-known/" {
      url.redirect = (
	"^/.well-known/carddav" => "/remote.php/dav",
	"^/.well-known/caldav" => "/remote.php/dav",
      )
    }
  }
  $SERVER["socket"] == "[::]:443" {
    ssl.engine                  = "enable"
    ssl.ca-file = conf_dir + "/certs/le.pem"
    ssl.pemfile = conf_dir + "/certs/clown.adb-centralen.se.pem"
    ssl.use-sslv2               = "disable"
    ssl.use-sslv3               = "disable"
    ssl.dh-file               = conf_dir + "/dhparams.pem"
    ssl.ec-curve              = "secp384r1"
    ssl.honor-cipher-order    = "enable"
    ssl.cipher-list           = "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-
  RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES25
  6-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS"

    setenv.add-response-header = ("Strict-Transport-Security" => "max-age=26280000;includeSubdomains","cache-control" => "public")

    server.name                 = "clown.adb-centralen.se"
    server.document-root        = "/usr/local/www/nextcloud"

    $HTTP["url"] =~ "^/.well-known/" {
      url.redirect = (
	"^/.well-known/carddav" => "/remote.php/dav",
	"^/.well-known/caldav" => "/remote.php/dav",
      )
    }
  }
  $SERVER["socket"] == "127.0.0.1:80" { 
    server.name                 = "clown.adb-centralen.se"
    server.document-root        = "/usr/local/www/nextcloud"
    $HTTP["url"] =~ "/.well-known/acme-challenge/(.*)" {
      alias.url += ( "/.well-known/acme-challenge/" => "/usr/local/www/dehydrated/" )
    }
    else $HTTP["host"] =~ "^(.*)" {
      url.redirect = (".*" => "https://%1$0")
    }
  }
  $SERVER["socket"] == "[::]:80" { 
    server.name                 = "clown.adb-centralen.se"
    server.document-root        = "/usr/local/www/nextcloud"
    $HTTP["url"] =~ "/.well-known/acme-challenge/(.*)" {
      alias.url += ( "/.well-known/acme-challenge/" => "/usr/local/www/dehydrated/" )
    }
    else $HTTP["host"] =~ "^(.*)" {
      url.redirect = (".*" => "https://%1$0")
    }
  }
******* lighttpd/modules.conf
  server.modules:
  mod_alias
  mod_redirect
  mod_setenv
  mod_openssl

  include conf.d/fastcgi.conf
******* lighttpd/conf.d/fastcgi.conf
                       "php-tcp" =>
                       (
                         "host" => "127.0.0.1",
                         "port" => 9000,
                         "check-local" => "disable",
                         "broken-scriptfilename" => "enable",
                       ),
******* php-fpm.conf or php-fpm.d/www.conf
  error_log = syslog
  syslog.facility = daemon
  log_level = notice
  syslog.ident = php-fpm
  pm.max_children = 30
  pm.start_servers = 3
  pm.max_spare_servers = 5
  env[HOSTNAME] = $HOSTNAME
  env[PATH] = /usr/local/bin:/usr/bin:/bin
  env[TMP] = /tmp
  env[TMPDIR] = /tmp
  env[TEMP] = /tmp
***** ptrace -- puppetmaster
*** wireguard
**** setup
pkg install wg
sysrc wireguard_enable=yes wireguard_interfaces=wg0

[root@kcmp ~]# cat /usr/local/etc/wireguard/wg0.conf 
[Interface]
Address = 10.128.0.1
Address = fe80::225:90ff:fe71:e325%wg0
Address = fd00:128::1
SaveConfig = true
ListenPort = 51820
PrivateKey = [redacted]

[root@kcmp ~]# pfctl -s n | egrep 10.128
nat on em0 inet from 10.128.0.0/24 to any -> 193.10.5.2

[root@kcmp ~]# wg-quick up wg0
[#] wireguard-go wg0
WARNING WARNING WARNING WARNING WARNING WARNING WARNING
W                                                     G
W   This is alpha software. It will very likely not   G
W   do what it is supposed to do, and things may go   G
W   horribly wrong. You have been warned. Proceed     G
W   at your own risk.                                 G
W                                                     G
WARNING WARNING WARNING WARNING WARNING WARNING WARNING
INFO: (wg0) 2018/11/17 17:43:50 Starting wireguard-go version 0.0.20181018
[#] wg setconf wg0 /tmp/tmp.wJuSzhSj/sh-np.Ut2bk3
[#] ifconfig wg0 inet 10.128.0.1/24 10.128.0.1 alias
[#] ifconfig wg0 mtu 1420
[#] ifconfig wg0 up
[#] route -q -n add -inet 10.128.0.0/24 -interface wg0
[+] Backgrounding route monitor
**** adding a client peer
NOTE: Maybe use this for listing IP addresses in use:
  cat /usr/local/etc/wireguard/wg0.conf | awk '/AllowedIPs/{print $3, $4}' | sort -n
Or better:
  wg show wg0 allowed-ips | sort -t . -k 4 -n

wg set wg0 peer $PUBKEY allowed-ips 10.128.0.${NEXTIP}/32,fd00:128::${NEXTIP}/128
wg-quick save wg0

# Restarting wireguard on kcmp is currently (<2020-03-11 Wed>)
# necessary in order for IPv4 NAT to kick in properly. IPv6 seems to
# work fine without a restart though. Restarting wireguard used to
# crash the kernel (ugh) but that was some time ago (HBSD-11?).
service wireguard restart

*** F&F ip addresses
128 PTR FIXME # was kdc (still used for kdc)
*** NOTES
**** IPv6 between (jails on) kcmp and (jails on) ioctl
There's something borken wrt ipv6, see [[*VM woes][VM woes]]

- <2019-03-30 Sat> removed AAAA records for imap and kdc; smtp.adbc had
  trouble authn users and said

  Mar 30 11:12:05 smtp postfix/submission/smtpd[78194]: warning: kcmp.adb-centralen.se[193.10.5.2]: SASL PLAIN authentication failed: Connection lost to authentication server

  while imap.adbc said

  Mar 30 08:36:33 imap dovecot: auth: Warning: auth client 0 disconnected with 1 pending requests: EOF

  kdc.adbc reported connections from imap.adbc's v6 address, and 10s later from its v4

**** dead unbound <2019-02-27 Wed>
- unbound was not running on resolver1 for an unknown reason
- restarted unbound on resolver1
- limiting access to resolver1 in pf, assuming that unbound was
  hammered to death sometime between 10:03 and 10:34

[root@kcmp ~]# date
Wed Feb 27 10:34:13 CET 2019
[root@kcmp ~]# cat /var/log/messages | egrep 'Limiting icmp unreach'
Feb 27 10:03:10 kcmp kernel: [1357435] Limiting icmp unreach response from 300 to 200 packets/sec
Feb 27 10:03:13 kcmp kernel: [1357437] Limiting icmp unreach response from 206 to 200 packets/sec
Feb 27 10:03:22 kcmp kernel: [1357446] Limiting icmp unreach response from 201 to 200 packets/sec
Feb 27 10:10:03 kcmp kernel: [1357848] Limiting icmp unreach response from 297 to 200 packets/sec
Feb 27 10:10:10 kcmp kernel: [1357854] Limiting icmp unreach response from 201 to 200 packets/sec
Feb 27 10:19:20 kcmp kernel: [1358404] Limiting icmp unreach response from 292 to 200 packets/sec
Feb 27 10:19:29 kcmp kernel: [1358413] Limiting icmp unreach response from 201 to 200 packets/sec
[root@resolver1 ~]# service unbound status
unbound is not running.
[root@resolver1 ~]# tail /var/log/daemon
Jan 26 13:26:49 resolver1 unbound: [56302:0] error: read (in tcp r): Connection reset by peer for 61.219.11.151 port 64749
Jan 29 05:54:27 resolver1 unbound: [56302:0] error: read (in tcp r): Connection reset by peer for 61.219.11.151 port 63784
Jan 30 19:56:10 resolver1 unbound: [56302:0] error: read (in tcp r): Connection reset by peer for 61.219.11.151 port 62467
Feb  3 02:25:03 resolver1 unbound: [94649:0] warning: did not exit gracefully last time (56302)
Feb 12 08:34:05 resolver1 unbound: [81139:0] error: read (in tcp r): Connection reset by peer for 61.219.11.151 port 63557
Feb 12 23:53:38 resolver1 unbound: [81139:0] error: read (in tcp r): Connection reset by peer for 61.219.11.152 port 65200
Feb 16 02:06:16 resolver1 unbound: [81139:0] error: read (in tcp r): Connection reset by peer for 61.219.11.152 port 61263
Feb 19 01:33:32 resolver1 unbound: [81139:0] error: read (in tcp r): Connection reset by peer for 106.75.3.52 port 57854
Feb 19 01:33:42 resolver1 unbound: [81139:0] error: read (in tcp r): Connection reset by peer for 106.75.3.52 port 52408
Feb 26 02:49:06 resolver1 unbound: [11922:0] error: read (in tcp r): Connection reset by peer for 61.219.11.152 port 64644

restarting unbound

[root@resolver1 ~]# tail -1 /var/log/daemon 
Feb 27 10:40:35 resolver1 unbound: [71867:0] warning: did not exit gracefully last time (11922)

**** upgrading 11-2 -> 12 <2019-08-27 Tue>
# once:
vi /etc/hbsd-update.conf # s/11/12/g
adduser -u 123 -D -L daemon # ntpd, 124, nologin, /var/db/ntp (or did we move _ntp to 124 and put ntpd on 123?)
./hbsd-upgrade.sh hupd
reboot
pkg-static install -f pkg
pkg update && pkg upgrade

See https://github.com/HardenedBSD/hardenedBSD/wiki/hbsd-11.2----12-upgrade for details.

# for each iocage jail:
./hbsd-upgrade.sh hupd <jail-number>
i console <jail-name>
pkg-static install -fy pkg
pkg update && pkg upgrade
exit
i restart <jail-name>

- [X]     8  192.168.0.20    select.adb-centralen.se       /var/jail/select
- [X]     7  193.10.5.108    bounce.adb-centralen.se       /iocage/jails/bounce/root
- [X]     4  193.10.5.124    imap                          /iocage/jails/imap/root
- [X]     2  193.10.5.125    resolver1.adb-centralen.se    /iocage/jails/resolver1/root
- [X]     5  193.10.5.83     murmur.adb-centralen.se       /iocage/jails/murmur/root
- [X]     6  193.10.5.87     ns.adb-centralen.se           /iocage/jails/ns/root
- [ ]     3  193.10.5.100    nextcloud                     /iocage/jails/nextcloud/root
[root@nextcloud ~]# pkg info | egrep next
nextcloud-calendar-php73-1.6.4 Calendar app for Nextcloud
nextcloud-contacts-php73-3.1.0 Contacts app for Nextcloud
nextcloud-mail-php73-0.11.0    Mail app for Nextcloud
nextcloud-notes-php73-2.5.1    Notes app for Nextcloud
nextcloud-php73-15.0.7         Personal cloud which runs on your own server
nextcloud-tasks-php73-0.9.8    Tasks app for Nextcloud
[root@nextcloud ~]# pkg search nextcloud-php73
nextcloud-php73-16.0.0         Personal cloud which runs on your own server

**** disabling em1 <2021-01-31 Sun>
We used to jump on kcmp to get to fcntl. This is now done on
rs0-2.dfri.net.

[root@kcmp ~]# sysrc ifconfig_em1
ifconfig_em1: inet 10.12.0.20/24
[root@kcmp ~]# sysrc -d ifconfig_em1
ifconfig_em1: 
[root@kcmp ~]# ifconfig em1 down

** nanosleep.adb-centralen.se (2020-10-12) -- NUC @ home
*** system info
Debian 10.6 (buster) installed <2020-10-12 Mon>.

model name      : Intel(R) Core(TM) i7-7567U CPU @ 3.50GHz
root@nanosleep:~# cat /proc/cpuinfo | egrep ^proc | wc -l
4

[    1.502390] sd 0:0:0:0: [sda] 1953525168 512-byte logical blocks: (1.00 TB/932 GiB)
[    1.502246] sd 2:0:0:0: [sdb] 234455040 512-byte logical blocks: (120 GB/112 GiB)

root@nanosleep:~# lsblk -o +rota
NAME                       MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT ROTA
sda                          8:0    0 931.5G  0 disk                1
sdb                          8:16   0 111.8G  0 disk                0
├─sdb1                       8:17   0   512M  0 part  /boot/efi     0
├─sdb2                       8:18   0   244M  0 part  /boot         0
└─sdb3                       8:19   0 111.1G  0 part                0
  └─sdb3_crypt             254:0    0   111G  0 crypt               0
    ├─nanosleep--vg-root   254:1    0  18.1G  0 lvm   /             0
    ├─nanosleep--vg-var    254:2    0   6.3G  0 lvm   /var          0
    ├─nanosleep--vg-swap_1 254:3    0  15.9G  0 lvm   [SWAP]        0
    ├─nanosleep--vg-tmp    254:4    0   1.1G  0 lvm   /tmp          0
    └─nanosleep--vg-home   254:5    0  69.6G  0 lvm   /home         0

*** installing software
- golang > 1.11 from buster-backports
  https://wiki.debian.org/Backports
  sudo apt edit-sources
  deb http://deb.debian.org/debian buster-backports main contrib non-free
  sudo apt update
  sudo apt -t buster-backports install golang-1.14

- swtpm, only in unstable as of <2020-10-12 Mon>
  sudo apt install build-essential devscripts equivs libfuse-dev libglib2.0-dev libgmp-dev expect libtasn1-6-dev socat python3-cryptography python3-setuptools python3-twisted libgnutls28-dev gnutls-bin net-tools gawk softhsm2 libseccomp-dev

  git clone https://github.com/stefanberger/libtpms && cd libtpms
  ./autogen.sh --with-tpm2 --with-openssl --prefix=/usr
  make && make check && sudo make install
  cd ..

  git clone https://github.com/stefanberger/swtpm && cd swtpm
  ./autogen.sh && ./configure --prefix=/usr
  make && make check
  sudo make install

- all other packages for system-transparency (as of <2020-10-12 Mon>)
  sudo apt install gcc-8 docker.io mercurial gpg qemu-system-x86 make bc mtools dosfstools e2tools parted tree bison flex jq libssl-dev libelf-dev libc6-i386
  sudo apt install libtspi-dev # trousers, for building Debian
  sudo apt install curl gnat libncurses5-dev pkgconf

- system configuration for building ST
  : from ~linus/.profile:
  [ -d "$HOME/go/bin" ] && PATH="$HOME/go/bin:$PATH"
  [ -d "/usr/lib/go-1.14/bin" ] && PATH="/usr/lib/go-1.14/bin:$PATH"
  command -v go > /dev/null && go env -w GO111MODULE=off

  sudo usermod -a -G docker linus

- for building coreboot images
  cd stboot/coreboot-firmware
  git clone https://review.coreboot.org/coreboot && cd coreboot
  make crossgcc-i386 CPUS=$(nproc)
  cp -vi ../x11ssh-tf.defconfig .config
  git submodule update --checkout --init
  make -C util/ifdtool
  : get original_vendor_bios_dump.bin from p/st/roms/original-vendor-bios
  util/ifdtool/ifdtool -x original_vendor_bios_dump.bin
  mkdir -p 3rdparty/blobs/mainboard/supermicro/x11-lga1151-series
  cp -iv flashregion_0_flashdescriptor.bin 3rdparty/blobs/mainboard/supermicro/x11-lga1151-series/descriptor.bin
  cp -iv flashregion_2_intel_me.bin 3rdparty/blobs/mainboard/supermicro/x11-lga1151-series/me.bin
  make menuconfig
    : no changes
  BUILD_TIMELESS=1 make
  build/cbfstool ./build/coreboot.rom add-payload -r COREBOOT -f ../../mixed-firmware/vmlinuz-linuxboot -n fallback/payload -C "console=ttyS0,115200 ro" -I ../../../stboot/initramfs-linuxboot.cpio.gz

  For debugging stboot, add `uroot.uinitargs=\"-debug\"` to the argument for `-C`.

- flashing SPI flash using a CH341 # FIXME: move to st.org

  datan# sudo ~linus/usr/src/flashrom/flashrom -p ch341a_spi
    Found Winbond flash chip "W25Q128.V" (16384 kB, SPI) on ch341a_spi.

  root@datan:~# ~linus/usr/src/flashrom/flashrom -p ch341a_spi --ifd -i bios -w ~linus/p/st/deployments/2020-10-13-vdse/2020-10-14-coreboot-vdse.rom
  flashrom v1.2-25-ge0fac2e on Linux 4.9.0-13-amd64 (x86_64)
  flashrom is free software, get the source code at https://flashrom.org

  Using clock_gettime for delay loops (clk_id: 1, resolution: 1ns).
  Found Winbond flash chip "W25Q128.V" (16384 kB, SPI) on ch341a_spi.
  Reading ich descriptor... done.
  Using region: "bios".
  Reading old flash chip contents... done.
  Erasing and writing flash chip... Erase/write done.
  Verifying flash... VERIFIED.

- making an STDATA partition on an HDD # FIXME: move to st.org
  stboot/coreboot-firmware/make_image.sh
  dd if=stboot/coreboot-firmware/stdata.img of=/dev/sdb bs=1M

- don't require TXT # FIXME: move to st.org
  add to run.config: ST_BOOTBALL_ALLOW_NON_TXT=y
  
- power consumption
  38W booted and idling; 42W halted; 7W powered off

- bring up network and sshd on fresh Debian
  ip link set eno0 up
  ip addr add 192.168.7.82/24 dev eno0
  ip route add default via 192.168.7.1 dev eno0

  ssh-keygen -N '' -t rsa -f /etc/ssh/ssh_host_rsa_key
  ssh-keygen -N '' -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key
  ssh-keygen -N '' -t ed25519 -f /etc/ssh/ssh_host_ed25519_key
  systemctl start sshd
  mkdir /root/.ssh
  chmod 700 /root/.ssh
  cat > /root/.ssh/authorized_keys

- cache debs -- debootstrapping *often* fails without a cache
  - sudo apt install apt-cacher-ng
  - set http_proxy in build-debian.sh
    export http_proxy=http://$(ip route | awk '/default/ {print $3}'):3142

  With a cache on the host system (nanosleep), we can also manually
  fetch files that often fail, ie the large files (like the kernel
  package).

  UPDATE: Caching and HTTPS is not such great. Let's see if a newer
  debos magically works better? UPDATE: Doesn't work, see below for
  details.

  For now, fetch over HTTP instead of HTTPS, which seems to solve the
  download errors. apt-cacher-ng works fine too, see
  /var/cache/apt-cacher-ng on nanosleep.

  UPDATE Using http://HTTPS///snapshot.debian.org/archive/debian/.../
  makes apt-cacher-ng fetch over HTTPS, cf
  https://www.unix-ag.uni-kl.de/~bloch/acng/html/howtos.html#ssluse

- building an OS
  - Q: use more recent debos? see Dockerfile:
    RUN git remote add stdebos https://github.com/system-transparency/debos && \
      git fetch stdebos refs/tags/20191115 && git checkout FETCH_HEAD -b 20191115
    A: github.com/go-debos/debos doesn't have --chroot

- ssh tor onion
  root@nanosleep:/etc/tor# cat /var/lib/tor/hs_ssh/hostname 
  v6m5zwuczulk5lpmigesnybbjq5xzohznyv574yoweaui7m3h7sk2wyd.onion

- rebuilding OS and bootball
  - cd ~/usr/src/st/system-transparency && operating-system/debian/make_debian.sh
    Debian kernel created at: operating-system/debian/docker/out/debian-buster-amd64.vmlinuz
    Debian initramfs created at: operating-system/debian/docker/out/debian-buster-amd64.cpio.gz
  - scripts/create_and_sign_bootball.sh
    [INFO]: bootballs/ball-2020-10-29-22-44-35.stboot created and signed with example keys.

*** nftables and docker
We're using ferm, which is stomping on all the rulse set up by
docker. Here's something which might work:
- add to ferm.conf: interface docker0 ACCEPT;
- reload ferm and restart docker
It seems like there are some initial blocked packets, IN=veth638acea
OUT= PROTO=UDP SPT=5353 DPT=5353, which looks like DNS. The ST build
process seems happy enough though, so let's do this for now.

The longer term solution might be to use nftables directly instead of
ferm.

** kexec.adb-centralen.se (2021-02-01) -- VM @ vm86 for KDC
virt-install --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --autostart \
  --extra-args console=ttyS0,115200 \
  --name kexec.adb-centralen.se --memory 512 --vcpus 1 --disk size=10

KDC database migration:
old-kdc# kadmin -l dump -d cleartext-dumpfile
new-kdc# kadmin -l merge cleartext-dumpfile

Don't forget to move the database encryption key to the new
system. The kdc expects to find it in DATABASE.mkey, see
/etc/heimdal-kdc/kdc.conf for what DATABASE is (default
/var/lib/heimdal-kdc/heimdal).

kpasswdd apparently expects to find it in /var/lib/heimdal-kdc/m-key
so a symlink is a good idea.

*** disk failure <2021-10-01 Fri>
[1404038.716038] ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
[1404038.716128] ata1.00: failed command: FLUSH CACHE
[1404038.716199] ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
                          res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
[1404038.716270] ata1.00: status: { DRDY }
[1404043.756049] ata1: link is slow to respond, please be patient (ready=0)
[1404048.736081] ata1: device not ready (errno=-16), forcing hardreset
[1404048.736102] ata1: soft resetting link
[1404048.897001] ata1.00: configured for MWDMA2
[1404048.897003] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[1404064.032231] ata1.00: qc timeout (cmd 0xe7)
[1404064.032233] ata1.00: FLUSH failed Emask 0x4
[1404069.072260] ata1: link is slow to respond, please be patient (ready=0)
[1404074.052305] ata1: device not ready (errno=-16), forcing hardreset
[1404074.052340] ata1: soft resetting link
[1404074.213096] ata1.00: configured for MWDMA2
[1404074.213098] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[1404078.883202] ata1: EH complete
[1404137.020774] ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
[1404137.020854] ata1.00: failed command: FLUSH CACHE
[1404137.020930] ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
                          res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
[1404137.021011] ata1.00: status: { DRDY }
[1404138.400802] ata1: soft resetting link
[1404138.561144] ata1.01: NODEV after polling detection
[1404138.561847] ata1.00: configured for MWDMA2
[1404138.561848] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[1404138.562026] ata1: EH complete

** btc.adb-centralen.se (2021-04-27) -- VM @ vm86.vdse
*** bitcoind built from source (tag v0.21.0) in april -21
From config.log:

It was created by Bitcoin Core configure 0.21.0, which was
generated by GNU Autoconf 2.69.  Invocation command line was

  $ ./configure BDB_LIBS=-L/home/btc/usr/src/bitcoin/db4/lib -ldb_cxx-4.8 BDB_CFLAGS=-I/home/btc/usr/src/bitcoin/db4/include --prefix=/home/btc/usr --without-qt

From Bash history:
    5  sh contrib/install_db4.sh $(pwd) || echo db4 build fail # Need db4 since we've got old wallets
...
   41  export BDB_PREFIX='/home/btc/usr/src/bitcoin/db4'
   42  ./configure BDB_LIBS="-L${BDB_PREFIX}/lib -ldb_cxx-4.8" BDB_CFLAGS="-I${BDB_PREFIX}/include" --prefix=$HOME/usr --without-qt

*** bitcoind v0.21.0 -> v0.22 <2021-10-01 Fri>

sudo apt install clang libdb-dev libdb++-dev
sudo -iu btc
cd usr/src/bitcoin
git fetch
git checkout v22.0
make distclean
sh autogen.sh
./configure CXX=clang++ CC=clang --prefix=$HOME/usr --without-qt --with-incompatible-bdb
make # ~20m
make install

** tkill.adb-centalen.se (2021-05-11) -- VM @ vm86.vdse for torrenting
VM setup:
virt-install --name tkill.adb-centralen.se --memory 1024 --disk size=6 --virt-type kvm --graphics none --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ --extra-args console=ttyS0,115200
virsh edit tkill.adb-centralen.se   # <interface type='network'>
virsh net-update default add ip-dhcp-host "<host mac='XXX' name='tkill' ip='192.168.122.XXX />" --config --live
virsh vol-create-as default tkill.adb-centralen.se.vol1.qcow2 64GB --format qcow2 --prealloc-metadata
virsh attach-disk tkill.adb-centralen.se /var/lib/libvirt/images/tkill.adb-centralen.se.vol1.qcow2 sdb --config --live

transmission-daemon:
apt install transmission-daemon
cat > /etc/sysctl.d/20-transmission.conf 
net.core.wmem_max = 1048576
net.core.rmem_max = 4194304
$EDIT /etc/transmission-daemon/settings.json
    "rpc-whitelist": "127.0.0.1,10.47.11.*",
    "rpc-whitelist-enabled": true,

IP filter:
                tcp dport 51413 accept
                udp dport 51413 accept
                ip saddr 10.47.11.0/24 tcp dport 9091 accept

Client setup:
export TR_AUTH=transmission:transmission

** smtp-02.adb-centralen.se (2021-08-??) -- VM @ kcmp for SMTP
Debian VM @ kcmp replacing smtp.adbc @ ioctl @ kcmp, to be moved to
"new kcmp" running Debian.

Running Postfix, (milter-)opendkim (http://opendkim.org/), postgrey (http://postgrey.schweikert.ch/)

- opendkim is packaged for debian (2.11.0~beta2-4)
- postgrey is packaged for debian (1.36-5.2)

** dup.adb-centralen.se (2021-10-19) -- VM @ vmsplice for DNS authoritative
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name dup.adb-centralen.se --memory 1024 --vcpus 1 --disk size=20

193.10.5.76/24 2001:6b0:8::76/64

See ansible for knot config.

** keyctl.adb-centralen.se (2022-01-12) -- VM @ vmsplice for building keykeeper systems


*** Keys and zones
[root@ns ~]# service knot stop
Stopping knot.
Waiting for PIDS: 46525.
[root@ns ~]# date
Fri Oct 22 10:13:55 CEST 2021
[root@ns ~]# sysrc knot_enable=no
knot_enable: yes -> no

[root@kcmp ~]# i stop ns
\* Stopping ns
  + Executing prestop OK
  + Stopping services OK
  + Removing devfs_ruleset: 1004 OK
  + Removing jail process OK
  + Executing poststop OK

**** List of all keys on original ns.adbc, as of <2021-10-22 Fri>
[root@ns ~]# date; for zone in /usr/local/etc/knot/zones/*.zone; do printf "# $(basename $zone)\n"; keymgr $(basename $zone .zone) list iso; done
fri Oct 22 10:12:55 CEST 2021
# 0_28.109.141.45.in-addr.arpa.zone
# 1.0.0.0.1.0.0.0.0.c.c.5.7.0.a.2.ip6.arpa.zone
# 192_28.110.141.45.in-addr.arpa.zone
# 224_28.67.227.46.in-addr.arpa.zone
# 4711.se.zone
bfdeca05e7231616e838ecce6d1bd4707b495e55 ksk=no  zsk=yes tag=20928 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T08:14:45Z ready=1970-01-01T00:00:00Z active=2021-10-20T10:14:45Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
fc31ca7ef687433c617b8674f568539195418768 ksk=yes zsk=no  tag=59116 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-11-27T15:49:46Z ready=2018-11-27T15:49:46Z active=2018-12-02T15:24:55Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# adb-centralen.se.zone
0f123384e294ca4c2b6ad7bf0d3d0580eda69c97 ksk=yes zsk=no  tag=20942 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T14:35:52Z ready=2018-12-02T14:35:52Z active=2018-12-02T15:25:23Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
595c7dd5a2a9cd8ea3a589191d1f6941a3854aaa ksk=no  zsk=yes tag=57570 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T09:35:53Z ready=1970-01-01T00:00:00Z active=2021-10-20T11:35:54Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# freeolabini.se.zone
f5f95eb5f66d63d80296b993351c2e33e4f17d67 ksk=yes zsk=no  tag=48064 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2019-04-14T20:56:48Z ready=2019-04-14T20:56:48Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
f7ae541b0834878b977edfb314ba141757d81fc6 ksk=no  zsk=yes tag=61153 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-03T06:56:50Z ready=1970-01-01T00:00:00Z active=2021-10-03T08:56:50Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# hbernstone.se.zone
# klutt.se.zone
# lists.adb-centralen.se.zone
# lists.sigsum.org.zone
# mail.nordberg.se.zone
3c647022f43f6996326437e33a521de0e61e372a ksk=no  zsk=yes tag=58845 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T09:27:29Z ready=1970-01-01T00:00:00Z active=2021-10-20T11:27:29Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
d1117e9558f9c49a633531a9dc94f081a5a81754 ksk=yes zsk=no  tag=37985 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T15:27:29Z ready=2018-12-02T15:27:29Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# mikadako.com.zone
# mobrules.nu.zone
# noisydiode.se.zone
151cba2305d4a79bd70190b4c4abaf7218ca36c4 ksk=no  zsk=yes tag=32869 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-09-24T06:55:36Z ready=1970-01-01T00:00:00Z active=2021-09-24T08:55:36Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
18bbc559b51e48c3cd994ca21ba5a97c20464251 ksk=yes zsk=no  tag=39464 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2019-12-02T12:55:26Z ready=2019-12-02T12:55:26Z active=2019-12-02T12:55:26Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# nordberg.se.zone
41bdce6afa7dd7b8fd384e56bbfcc6d51e376c85 ksk=no  zsk=yes tag=57588 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T09:35:52Z ready=1970-01-01T00:00:00Z active=2021-10-20T11:35:52Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
b5648fd1e224554bf9bbc55863715c71f57b0886 ksk=yes zsk=no  tag=06977 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T14:35:52Z ready=2018-12-02T14:35:52Z active=2018-12-02T15:22:16Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# scoutlokalen.se.zone
5c2e4a3617a3b1cc12bfb6dc13751d686e094c19 ksk=no  zsk=yes tag=60973 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-04T21:50:31Z ready=1970-01-01T00:00:00Z active=2021-10-05T22:50:31Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
9903538805afbd3a939d1944950cde4f8c14562d ksk=yes zsk=no  tag=63577 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2020-11-29T12:50:31Z ready=2020-11-29T12:50:31Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# siglog.se.zone
58b49fb84b9e0fc69639e41cd537fd57245c9489 ksk=yes zsk=no  tag=50189 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-06-15T15:18:53Z ready=2021-06-15T15:18:53Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
8f88b9b245305712be4ced5c5ea990d5c04dc75b ksk=no  zsk=yes tag=11854 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-13T21:18:53Z ready=1970-01-01T00:00:00Z active=2021-10-13T23:18:53Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# sigsum.org.zone
831c65ca316a467661ab33b90ef12d94c6eeaebb ksk=yes zsk=no  tag=41287 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-06-16T14:26:01Z ready=2021-06-16T14:26:01Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
d10be2e2dfe7e23acbb243e3695c1f5169259681 ksk=no  zsk=yes tag=54225 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-14T20:26:01Z ready=1970-01-01T00:00:00Z active=2021-10-14T22:26:01Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# sigsum.se.zone
7e96843982b683da0c45d85a59d274c3e190f0d1 ksk=yes zsk=no  tag=09481 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-06-16T14:29:40Z ready=2021-06-16T14:29:40Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
c863f3d61483bd33a38dd0381cc682d557a0746b ksk=no  zsk=yes tag=20853 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-14T20:29:40Z ready=1970-01-01T00:00:00Z active=2021-10-14T22:29:40Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# verkligendata.se.zone
49b6dad61e74cc84ce2174628a2920134626dbca ksk=yes zsk=no  tag=65500 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T14:35:52Z ready=2018-12-02T14:35:52Z active=2018-12-02T16:27:17Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
97ef93b3e29098459ed91836880e071d3f2d94f1 ksk=no  zsk=yes tag=53959 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-09-29T21:35:52Z ready=1970-01-01T00:00:00Z active=2021-09-30T22:35:52Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z

**** List after migration to dup.adbc
root@dup:~# date; for zone in /var/lib/knot/primary/*.zone; do printf "# $(basename $zone)\n"; keymgr $(basename $zone .zone) list iso; done
Fri Oct 22 11:30:20 CEST 2021
# 0_28.109.141.45.in-addr.arpa.zone
# 1.0.0.0.1.0.0.0.0.c.c.5.7.0.a.2.ip6.arpa.zone
# 192_28.110.141.45.in-addr.arpa.zone
# 224_28.67.227.46.in-addr.arpa.zone
# 4711.se.zone
bfdeca05e7231616e838ecce6d1bd4707b495e55 ksk=no  zsk=yes tag=20928 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T08:14:45Z ready=1970-01-01T00:00:00Z active=2021-10-20T10:14:45Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
fc31ca7ef687433c617b8674f568539195418768 ksk=yes zsk=no  tag=59116 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-11-27T15:49:46Z ready=2018-11-27T15:49:46Z active=2018-12-02T15:24:55Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# adb-centralen.se.zone
0f123384e294ca4c2b6ad7bf0d3d0580eda69c97 ksk=yes zsk=no  tag=20942 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T14:35:52Z ready=2018-12-02T14:35:52Z active=2018-12-02T15:25:23Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
595c7dd5a2a9cd8ea3a589191d1f6941a3854aaa ksk=no  zsk=yes tag=57570 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T09:35:53Z ready=1970-01-01T00:00:00Z active=2021-10-20T11:35:54Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# freeolabini.se.zone
f5f95eb5f66d63d80296b993351c2e33e4f17d67 ksk=yes zsk=no  tag=48064 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2019-04-14T20:56:48Z ready=2019-04-14T20:56:48Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
f7ae541b0834878b977edfb314ba141757d81fc6 ksk=no  zsk=yes tag=61153 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-03T06:56:50Z ready=1970-01-01T00:00:00Z active=2021-10-03T08:56:50Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# hbernstone.se.zone
# klutt.se.zone
# lists.adb-centralen.se.zone
# lists.sigsum.org.zone
# mail.nordberg.se.zone
3c647022f43f6996326437e33a521de0e61e372a ksk=no  zsk=yes tag=58845 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T09:27:29Z ready=1970-01-01T00:00:00Z active=2021-10-20T11:27:29Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
d1117e9558f9c49a633531a9dc94f081a5a81754 ksk=yes zsk=no  tag=37985 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T15:27:29Z ready=2018-12-02T15:27:29Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# mikadako.com.zone
# mobrules.nu.zone
# noisydiode.se.zone
151cba2305d4a79bd70190b4c4abaf7218ca36c4 ksk=no  zsk=yes tag=32869 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-09-24T06:55:36Z ready=1970-01-01T00:00:00Z active=2021-09-24T08:55:36Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
18bbc559b51e48c3cd994ca21ba5a97c20464251 ksk=yes zsk=no  tag=39464 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2019-12-02T12:55:26Z ready=2019-12-02T12:55:26Z active=2019-12-02T12:55:26Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# nordberg.se.zone
41bdce6afa7dd7b8fd384e56bbfcc6d51e376c85 ksk=no  zsk=yes tag=57588 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-20T09:35:52Z ready=1970-01-01T00:00:00Z active=2021-10-20T11:35:52Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
b5648fd1e224554bf9bbc55863715c71f57b0886 ksk=yes zsk=no  tag=06977 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T14:35:52Z ready=2018-12-02T14:35:52Z active=2018-12-02T15:22:16Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# scoutlokalen.se.zone
5c2e4a3617a3b1cc12bfb6dc13751d686e094c19 ksk=no  zsk=yes tag=60973 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-04T21:50:31Z ready=1970-01-01T00:00:00Z active=2021-10-05T22:50:31Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
9903538805afbd3a939d1944950cde4f8c14562d ksk=yes zsk=no  tag=63577 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2020-11-29T12:50:31Z ready=2020-11-29T12:50:31Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# siglog.se.zone
58b49fb84b9e0fc69639e41cd537fd57245c9489 ksk=yes zsk=no  tag=50189 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-06-15T15:18:53Z ready=2021-06-15T15:18:53Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
8f88b9b245305712be4ced5c5ea990d5c04dc75b ksk=no  zsk=yes tag=11854 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-13T21:18:53Z ready=1970-01-01T00:00:00Z active=2021-10-13T23:18:53Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# sigsum.org.zone
831c65ca316a467661ab33b90ef12d94c6eeaebb ksk=yes zsk=no  tag=41287 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-06-16T14:26:01Z ready=2021-06-16T14:26:01Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
d10be2e2dfe7e23acbb243e3695c1f5169259681 ksk=no  zsk=yes tag=54225 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-14T20:26:01Z ready=1970-01-01T00:00:00Z active=2021-10-14T22:26:01Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# sigsum.se.zone
7e96843982b683da0c45d85a59d274c3e190f0d1 ksk=yes zsk=no  tag=09481 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-06-16T14:29:40Z ready=2021-06-16T14:29:40Z active=1970-01-01T00:00:00Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
c863f3d61483bd33a38dd0381cc682d557a0746b ksk=no  zsk=yes tag=20853 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-10-14T20:29:40Z ready=1970-01-01T00:00:00Z active=2021-10-14T22:29:40Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
# verkligendata.se.zone
49b6dad61e74cc84ce2174628a2920134626dbca ksk=yes zsk=no  tag=65500 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2018-12-02T14:35:52Z ready=2018-12-02T14:35:52Z active=2018-12-02T16:27:17Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z
97ef93b3e29098459ed91836880e071d3f2d94f1 ksk=no  zsk=yes tag=53959 algorithm=8  size=2048 public-only=no  pre-active=1970-01-01T00:00:00Z publish=2021-09-29T21:35:52Z ready=1970-01-01T00:00:00Z active=2021-09-30T22:35:52Z retire-active=1970-01-01T00:00:00Z retire=1970-01-01T00:00:00Z post-active=1970-01-01T00:00:00Z revoke=1970-01-01T00:00:00Z remove=1970-01-01T00:00:00Z

*** Trouble resolving
Times when git.adbc didn't resolve on stat.vdse:
2021-11-03 18:15:59,864 p=2437408 u=root n=ansible | stat.verkligendata.se | FAILED! => {
2021-11-19 15:19:50,083 p=4138512 u=root n=ansible | stat.verkligendata.se | FAILED! => {
2021-11-19 16:15:15,332 p=4138619 u=root n=ansible | stat.verkligendata.se | FAILED! => {
2021-11-20 01:17:30,638 p=4172944 u=root n=ansible | stat.verkligendata.se | FAILED! => {
2021-11-21 08:19:21,715 p=110308 u=root n=ansible | stat.verkligendata.se | FAILED! => {
2021-11-21 09:18:12,293 p=110431 u=root n=ansible | stat.verkligendata.se | FAILED! => {
2021-11-21 13:18:48,047 p=123543 u=root n=ansible | stat.verkligendata.se | FAILED! => {
2021-11-22 05:15:14,708 p=188908 u=root n=ansible | stat.verkligendata.se | FAILED! => {

** prctl.adb-centralen.se (2022-02-24) -- VM @ vm86 for private tor bridges
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name prctl.adb-centralen.se --memory 1024 --vcpus 1 --disk size=4

echo knotc zone-begin adb-centralen.se
ssh-keygen -r $(hostname) | egrep 'SSHFP [134] 2' | while read -r name in type n1 n2 fpr; do echo knotc zone-set adb-centralen.se $name 7200 SSHFP $n1 $n2 $fpr; done
echo knotc zone-diff adb-centralen.se

Bridge 91.223.231.122:443 09270580F7C38E11D3D3B518C443CA604D0C13E5
Bridge [2001:67c:8a4:1::122]:443 09270580F7C38E11D3D3B518C443CA604D0C13E5
Bridge obfs4 91.223.231.122:38309 09270580F7C38E11D3D3B518C443CA604D0C13E5 cert=GdJ8wgt5YDiBDGpdI2llyJSQCr3SJAG05Cx8komy5a2qlS8kwQ3mUASY1EMC8Bt1n7uAIA iat-mode=2
Bridge obfs4 [2001:67c:8a4:1::122]:38309 09270580F7C38E11D3D3B518C443CA604D0C13E5 cert=GdJ8wgt5YDiBDGpdI2llyJSQCr3SJAG05Cx8komy5a2qlS8kwQ3mUASY1EMC8Bt1n7uAIA iat-mode=2

https://bridges.torproject.org/status?id=7F083ADEEC636B10F5F663C5FF86BE2418B6E0A7

Running out of disk after a few days. Fix:
root@vm86:~# qemu-img create -f qcow2 /var/lib/libvirt/images/prctl.adb-centralen.se-vol2.qcow2 2G
Formatting '/var/lib/libvirt/images/prctl.adb-centralen.se-vol2.qcow2', fmt=qcow2 size=2147483648 cluster_size=65536 lazy_refcounts=off refcount_bits=16
root@vm86:~# virsh attach-disk --config --subdriver qcow2 prctl.adb-centralen.se /var/lib/libvirt/images/prctl.adb-centralen.se-vol2.qcow2 vdb
Disk attached successfully

*** 2022-10-21 upgrading snowflake/proxy to v2.3.1-15-gac85628
snowflake-proxy@prctl:~/usr/src/snowflake/proxy$ git describe
v2.3.1-15-gac85628

*** 2022-11-16 upgrading obfs4 to obfs4proxy-0.0.14
linus@prctl:~/usr/src/obfs4$ go build -o obfs4proxy/obfs4proxy ./obfs4proxy

root@prctl:~# egrep ^ServerTransportPlugin /etc/tor/instances/b0/torrc 
ServerTransportPlugin obfs4 exec /usr/bin/obfs4proxy -enableLogging -logLevel INFO
root@prctl:~# install -v -o root -g root ~linus/usr/src/obfs4/obfs4proxy/obfs4proxy /usr/bin/
removed '/usr/bin/obfs4proxy'
'/home/linus/usr/src/obfs4/obfs4proxy/obfs4proxy' -> '/usr/bin/obfs4proxy'
root@prctl:~# systemctl restart tor@b0
root@prctl:~# tail -100 /var/lib/tor-instances/b0/pt_state/obfs4proxy.log | egrep 'obfs4proxy-.*launched' 
2022/11/16 09:41:18 [NOTICE]: obfs4proxy-0.0.14 - launched

*** 2022-11-16 vCPU++, RAM++
We'd touched the swap and the CPU situation on vm86 is better now than when we launched.
We now have 2 vCPU, 3G RAM.

** nice.adb-centralen.se (2022-07-25) -- VM @ vm86 for nextcloud (2022 clown)
vm86# ./mkvm.sh nice.adb-centralen.se 2 4096 10
vm86# lvcreate -n nice.adb-centralen.se-ncdata -L 256G ssdm
vm86# virsh attach-disk nice.adb-centralen.se /dev/ssdm/nice.adb-centralen.se-ncdata vdb --live --config --subdriver raw --sourcetype block

NOTE: mkvm.sh was buggy and the VM was adjusted later to have 2
vCPU's, 4G RAM but only 6G disk for /.

https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html

Adding another volume, for /var. Note that trying to attach a third
disk (vdc) using `--live` was not used, because not enough PCI
slots. So `--config` alone and restarting the instance instead. The
new disk showed up as 'sda'.

    virsh vol-create-as default nice.adb-centralen.se.vol1.qcow2 10GB --format qcow2 --prealloc-metadata
    chown libvirt-qemu:libvirt-qemu /var/lib/libvirt/images/nice.adb-centralen.se.vol1.qcow2 
    virsh domblklist nice.adb-centralen.se
    virsh attach-disk nice.adb-centralen.se /var/lib/libvirt/images/nice.adb-centralen.se.vol1.qcow2 sdc --config
    (nice# shutdown -h now)
    virsh start nice.adb-centralen.se

*** mariadb
apt install mariadb-server

*** data directory for NC
pvcreate /dev/vdb
vgcreate nice-nextcloud /dev/vdb
lvcreate -n ncdata -l 100%FREE nice-nextcloud
mkfs.ext4 /dev/nice-nextcloud/ncdata 
echo "UUID=$(lsblk -no UUID /dev/nice-nextcloud/ncdata) /var/nextcloud ext4 defaults 0 2"
mkdir /var/nextcloud
mount -a
mkdir /var/nextcloud/data
chown www-data:www-data /var/nextcloud/data
# NOTE: we will put all the web stuff here too, in /var/nextcloud/www

*** NC dependencies (PHP)
# we got php-fpm from ansible
apt install php-zip php-mysql php-bz2 php-intl php-imagick php-bcmath php-gmp

*** NC installation and configuration
# https://docs.nextcloud.com/server/latest/admin_manual/installation/command_line_installation.html
# https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/occ_command.html#command-line-installation-label

cd /tmp
curl -sL https://nextcloud.com/nextcloud.asc | gpg --import 
gpg --list-key 28806A878AE423A28372792ED75899B9A724937A
curl -LO https://download.nextcloud.com/server/releases/latest-20.tar.bz2
curl -LO https://download.nextcloud.com/server/releases/latest-20.tar.bz2.asc
gpg --verify latest-20.tar.bz2.asc latest-20.tar.bz2
tar x -C /var/nextcloud -f latest-20.tar.bz2
mv /var/nextcloud/nextcloud /var/nextcloud/www
chown -R www-data:www-data /var/nextcloud/www

clown# rsync -az --delete /usr/local/nextcloud/data/ nice.adb-centralen.se:/var/nextcloud/data
clown# rsync -az --delete /var/backups/mariadb/mariadump.sql nice.adb-centralen.se:/var/nextcloud/dbdump/
clown# rsync -az --delete /usr/local/www/nextcloud/config/config.php nice.adb-centralen.se:/var/nextcloud/www/config/config.php.from-clown

mariadb -e "DROP DATABASE nextcloud"
mariadb -e "CREATE DATABASE nextcloud CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci"
mariadb nextcloud < /var/nextcloud/dbdump/mariadump.sql
mariadb
> CREATE USER 'oc_admin12'@localhost IDENTIFIED BY 'SEE_PASSDB';
> GRANT ALL PRIVILEGES ON nextcloud.* TO 'oc_admin12'@localhost;
> FLUSH PRIVILEGES;
> exit

cd /var/nextcloud/www/config
sed -i.bak -e 's!/usr/local/nextcloud/data!/var/nextcloud/data!g' -e 's!/usr/local/www/nextcloud/!/var/nextcloud/www/!g' config.php.from-clown
#sed -i.bak -e 's!clown.adb-centralen.se!nice.adb-centralen.se!g' config.php.from-clown
vi config.php.from-clown # remove array with /usr/local/www/nextcloud/apps-pkg
diff -u config.php.from-clown.bak config.php.from-clown
rm config.php.from-clown.bak
mv config.php config.php.ORIG
mv config.php.from-clown config.php

cd /var/nextcloud/www
sudo -u www-data php occ maintenance:mode --on
sudo -u www-data php occ config:system:set mysql.utf8mb4 --type boolean --value="true"
sudo -u www-data php occ db:add-missing-indice
sudo -u www-data php occ maintenance:mode --off

echo hostmaster@adb-centralen.se > ~www-data/.forward
echo '*/5    *       *       *       *       /usr/bin/php -f /var/nextcloud/www/cron.php' | crontab -u www-data -
mariadb nextcloud -e "update oc_twofactor_providers set enabled='0' where provider_id='u2f' and enabled='1';"

# https://docs.nextcloud.com/server/latest/admin_manual/installation/harden_server.html#setup-fail2ban
apt install fail2ban
cat > /etc/fail2ban/filter.d/nextcloud.conf <<EOF
[Definition]
_groupsre = (?:(?:,?\s*"\w+":(?:"[^"]+"|\w+))*)
failregex = ^\{%(_groupsre)s,?\s*"remoteAddr":"<HOST>"%(_groupsre)s,?\s*"message":"Login failed:
            ^\{%(_groupsre)s,?\s*"remoteAddr":"<HOST>"%(_groupsre)s,?\s*"message":"Trusted domain error.
datepattern = ,?\s*"time"\s*:\s*"%%Y-%%m-%%d[T ]%%H:%%M:%%S(%%z)?"
EOF
cat > /etc/fail2ban/jail.d/nextcloud.local <<EOF
[nextcloud]
backend = auto
enabled = true
port = 80,443
protocol = tcp
filter = nextcloud
maxretry = 3
bantime = 86400
findtime = 43200
logpath = /var/nextcloud/data/nextcloud.log
banaction = nftables
EOF
systemctl reload fail2ban
fail2ban-client status nextcloud

*** installation and ocnfiguration logg
Jul 26 11:07:39 TTL for clown lowered from 3600 to 300

[root@clown /usr/local/www/nextcloud]# su -m www -c "php occ maintenance:mode --on"; date
Maintenance mode enabled
Thu Jul 28 05:12:09 CEST 2022

[root@clown /usr/local/www/nextcloud]# date; time rsync -az --delete /usr/local/nextcloud/data/ nice.adb-centralen.se:/var/nextcloud/data
Thu Jul 28 05:17:57 CEST 2022
real    2m21.418s

root@dup:~# knotc zone-diff $Z 
[adb-centralen.se.] -clown.adb-centralen.se. 300 CNAME clown1.adb-centralen.se.
[adb-centralen.se.] +clown.adb-centralen.se. 300 CNAME nice.adb-centralen.se.
root@dup:~# knotc zone-commit $Z 
OK
root@dup:~# date
Thu Jul 28 05:45:51 CEST 2022

Thu 28 Jul 2022 07:17:16 AM CEST -- DAV stuff now working thanks to
Apache conf added for basic auth headers to be forwarded to PHP, by
proxy_fcgi I presume
  SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
see https://stackoverflow.com/questions/17018586/apache-2-4-php-fpm-and-authorization-headers

This is supposed to work equally well but did not work when tested
  CGIPassAuth On
https://httpd.apache.org/docs/2.4/en/mod/core.html#cgipassauth

Thu 28 Jul 2022 08:28:20 AM CEST -- done, all seems fine, waiting for
initial backup (130G, takes ~1h; update: turned out 118G taking 51m
and subsequent run <1m)

*** Trouble with _some_ files
Initially, I thought it was PDF's.
Then I thought it was large (more than ~120kB) files.
Now I think it's non ASCII characters in file and folder names.

REQUEST_URI (/remote.php/dav/files/linus//Verkligendata/Uppdrag%20%26%20projekt/Sigsum/)
PATH_INFO (             /dav/files/linus/ Verkligendata/Uppdrag%20&  %20projekt/Sigsum/

**** err 1
"{\"Exception\":\"Sabre\\\\DAV\\\\Exception\",\"Message\":\"The
REQUEST_URI
(/remote.php/dav/files/linus//Verkligendata/Uppdrag%20%26%20projekt/Sigsum/)
did not end with the contents of PATH_INFO
(/dav/files/linus/Verkligendata/Uppdrag%20&%20projekt/Sigsum/). This
server might be
misconfigured.\",\"Code\":0,\"Trace\":[{\"file\":\"/var/nextcloud/www/3rdparty/sabre/dav/lib/DAV/Server.php\",\"line\":347,\"function\":\"guessBaseUri\",\"class\":\"Sabre\\\\DAV\\\\Server\",\"type\":\"->\",\"args\":[]},{\"file\":\"/var/nextcloud/www/3rdparty/sabre/dav/lib/DAV/Server.php\",\"line\":252,\"function\":\"getBaseUri\",\"class\":\"Sabre\\\\DAV\\\\Server\",\"type\":\"->\",\"args\":[]},{\"file\":\"/var/nextcloud/www/3rdparty/sabre/dav/lib/DAV/Server.php\",\"line\":321,\"function\":\"start\",\"class\":\"Sabre\\\\DAV\\\\Server\",\"type\":\"->\",\"args\":[]},{\"file\":\"/var/nextcloud/www/remote.php\",\"line\":75,\"function\":\"exec\",\"class\":\"Sabre\\\\DAV\\\\Server\",\"type\":\"->\",\"args\":[]},{\"file\":\"/var/nextcloud/www/remote.php\",\"line\":168,\"function\":\"handleException\",\"args\":[{\"__class__\":\"Exception\"}]}],\"File\":\"/var/nextcloud/www/3rdparty/sabre/dav/lib/DAV/Server.php\",\"Line\":387,\"CustomMessage\":\"--\"}","userAgent":"Mozilla/5.0
(Android) Nextcloud-android/3.20.3","version":"24.0.3.2"}

** mount2.adb-centralen.se (2022-08-01) -- VM @ vmsplice for monitoring
mkvm.sh mount2.adb-centralen.se

* Verkligen Data
** bark -- Dell XPS 13 (2022-12)
DELL XPS 13 9320 CI7-1260P 32/1TB UHD+ 13.4" W11P 1X5GHR3

ST (service tag): 1X5GHR3 
EX (express service code): 4181333727
Type No: P151G991

https://www.dell.com/support/home/en-ie/product-support/product/xps-13-9320-laptop/overview

- There is a physical power button at the top (physical) row, to the right of backspace (<---)
- System setup (BIOS) entered by tapping F2 when booting
- Boot settings (one-time) entered by tapping F12 when booting
  - Requires admin password, when set
  - Prompt seen on <2023-04-14 Fri> is 1X5GHR3-8FC8, ie the service tag plus something

- Fedora doesn't support hibernate (suspend to disk) according to https://www.reddit.com/r/Fedora/comments/r4a4so/interesting_fedora_does_not_support_hibernation/

*** System setup on 2023-04-14, first use
- BIOS version 1.7.1
- Ownership date 2022-12-21
- Manufacture date 2022-09-16
- Signed firmware update enabled
- Processor
  - Type 12th gen intel core, i7-1260p
  - Max clock speed 4.7 GHz
  - Core count 4 + 8
  - Microcode version 420
  - Processor ID 906A3
  - Intel HT capable yes
  - L2 cache 4x1280 kB + 2x2048 kB
  - L3 cache 18432 kB
- Memory
  - RAM 32768 MB
  - Technology LPDDR5 SDRAM
  - Speed 5200 MHz
  - Channel mode dual
- Boot
  - Mode UEFI only
  - Secure boot enabled
- Integrated devices
  - Camera enabled
  - Audio On
  - Microphone enabled
  - Internal speaker enabled
  - USB/Thunderbolt
    - External USB ports enabled
    - USB Boot support enabled
- Storage
  - SATA/NVMe AHCI/NVMe enabled **NOTE** changed from: RAID On (VMD controller)
  - M.2 PCIe SSD on
  - SMART reporting disabled    
  - Drive info
    - M.2 PCIe SSD
    - 1TB PC801 NVMe SK hynix
- Connection
  - Wireless
    - WLAN enabled
    - Bluetooth enabled
  - UEFI Network stack disabled **NOTE** changed from: Enabled
  - Wireless radio control disabled
  - Dynamic wireless transmit power enabled
  - HTTP(s) boot features greyed out
- Power
  - USB wake support on
  - Block sleep (S3) off
- Security
  - Chassis intrusion Enabled **NOTE** changed from: On-Silent
  - Block boot until cleared on **NOTE** changed from: Off
  - SMM security mitigation on
  - Absolute (computrace) disable **NOTE** changed from: enable
  - UEFI boot path security always **NOTE** changed from: Always except internal hdd
  - Firmware device tamper detection enabled **NOTE** changed from silent
- Passwords
  - Admin password set
  - Allow non-admin password changes off **NOTE** changed from: On
  - Admin setup lockout on **NOTE** changed from: Off
- Update, Recovery
  - Enable UEFI capsule firmware updates on
  - BIOS recovery from hard drive on
  - Allow BIOS downgrade on
  - SupportAssist os recovery off **NOTE** changed from: On
  - Dell Auto OS recovery threshold off **NOTE** changed from: 2
- System management
  - Wake on AC off
  - Wake on LAN disabled
  - Auto on time disabled
  - OS agent requests on
  - POST automatic recovery off **NOTE** changed from on
- Virtualization support
  - VT on
  - VT for direct I/O on
  - TXT off
  - Enable pre-boot DMA support on
  - Enable OS kernel DMA support on
 



** getrandom.verkligendata.se (2019-12-06) -- rpi3 red+white case at OBE Kista
- donated to Verkligen Data by Linus
- used for console access to logsrv2.sigsum.org in OBE Kista
- used for BMC access to snowflake-01.torproject.net in OBE Kista
- possibly same as "rpi3 B+ 2017, black case"
- powered how?
- serial console on logsrv-02.sigsum.org (screen /dev/ttyUSB0 115200)
- debian bullseye
- 46.227.66.163/29
- hostname: getrandom
- eth0 MAC b8:27:eb:5f:47:ad
- uuid(1): 80245f24-1a77-11ea-9dc7-fff0ab2a77b4
- ?uid ff:eb:5f:47:ad:00:01:00:01:23:f7:fc:db:b8:27:eb:5f:47:ad;
- blkid
  /dev/mmcblk0p2: LABEL="RASPIROOT" UUID="b8f2865e-b461-4e9b-b09e-c82747a07acf" TYPE="ext4" PARTUUID="7b658673-02"
*** ubiqiti installation
- dl
curl -LO https://dl.ui.com/unifi/5.12.22/unifi_sysvinit_all.deb
- compare sha256 sums
https://community.ui.com/releases/UniFi-Network-Controller-5-12-22/263c8b60-def8-4667-85c3-87a6200a6c9b

- install dependencies, except mongodb
root@rpi3:~# apt install binutils default-jre-headless jsvc

- install package
root@rpi3:~# dpkg --install unifi_sysvinit_all.deb 

Selecting previously unselected package unifi.
(Reading database ... 23727 files and directories currently installed.)
Preparing to unpack unifi_sysvinit_all.deb ...
Unpacking unifi (5.12.22-12966-1) ...
dpkg: dependency problems prevent configuration of unifi:
 unifi depends on mongodb-server (>= 2.4.10) | mongodb-10gen (>= 2.4.14) | mongodb-org-server (>= 2.6.0); however:
  Package mongodb-server is not installed.
  Package mongodb-10gen is not installed.
  Package mongodb-org-server is not installed.
 unifi depends on mongodb-server (<< 1:3.6.0) | mongodb-10gen (<< 3.6.0) | mongodb-org-server (<< 3.6.0); however:
  Package mongodb-server is not installed.
  Package mongodb-10gen is not installed.
  Package mongodb-org-server is not installed.

dpkg: error processing package unifi (--install):
 dependency problems - leaving unconfigured
Processing triggers for systemd (241-7~deb10u1) ...
Errors were encountered while processing:
 unifi


https://andyfelong.com/2019/03/mongodb-4-0-6-64-bit-on-raspberry-pi-3/

*** 2022-09-30 upgrading buster -> bullseye
- https://www.debian.org/releases/bullseye/mips64el/release-notes/ch-upgrading.en.html

- Preparations
```
root@getrandom:~# dpkg --get-selections "*" > /root/dpkg-get-selections.txt
root@getrandom:~# umask 077
root@getrandom:~# cd /
root@getrandom:/# tar cf /tmp/2022-09-30-backup.tar root etc var/lib/dpkg var/lib/apt/extended_states
root@getrandom:/# ls -lh /tmp/2022-09-30-backup.tar 
-rw------- 1 root root 107M Sep 30 07:08 /tmp/2022-09-30-backup.tar
root@getrandom:/# chown linus /tmp/2022-09-30-backup.tar
root@getrandom:/# sha256sum /tmp/2022-09-30-backup.tar 
d795dce8a4f4727c9347201d50849f40a15d20f776627d9fec8bfeb2cde442cb  /tmp/2022-09-30-backup.tar
besk:~% scp getrandom:/tmp/2022-09-30-backup.tar ~/u/bup/
besk:~% sha256sum ~/u/bup/2022-09-30-backup.tar 
d795dce8a4f4727c9347201d50849f40a15d20f776627d9fec8bfeb2cde442cb  /home/linus/u/bup/2022-09-30-backup.tar
besk:~% xz ~/u/bup/2022-09-30-backup.tar
```

- Clean up
We're already up-to-date wrt buster packages.
```
root@getrandom:~# find /etc -name '*.dpkg-*' -o -name '*.ucf-*' -o -name '*.merge-error'
/etc/ca-certificates.conf.dpkg-old
/etc/ssh/sshd_config.ucf-dist
root@getrandom:~# rm /etc/ca-certificates.conf.dpkg-old /etc/ssh/sshd_config.ucf-dist 
```

- Apt
```
root@getrandom:~# cat /etc/apt/sources.list | egrep -v '^$|^#' 
deb https://ftp.acc.umu.se/debian          buster         main contrib non-free
deb https://ftp.acc.umu.se/debian          buster-updates main contrib non-free
deb https://security.debian.org/debian-security buster/updates main contrib non-free
root@getrandom:~# vi /etc/apt/sources.list
root@getrandom:~# cat /etc/apt/sources.list | egrep -v '^$|^#'
deb https://ftp.acc.umu.se/debian               bullseye          main contrib non-free
deb https://ftp.acc.umu.se/debian/              bullseye-updates  main contrib non-free
deb https://security.debian.org/debian-security bullseye-security main contrib non-free
root@getrandom:~# apt update
Get:1 https://ftp.acc.umu.se/debian bullseye InRelease [116 kB]
Get:2 https://security.debian.org/debian-security bullseye-security InRelease [48.4 kB]
Get:3 https://ftp.acc.umu.se/debian bullseye-updates InRelease [44.1 kB]
Get:4 https://security.debian.org/debian-security bullseye-security/main arm64 Packages [184 kB]
Get:5 https://security.debian.org/debian-security bullseye-security/main Translation-en [117 kB]
Get:6 https://security.debian.org/debian-security bullseye-security/non-free Translation-en [344 B]
Get:7 https://ftp.acc.umu.se/debian bullseye/main arm64 Packages [8071 kB]
Get:8 https://ftp.acc.umu.se/debian bullseye/main Translation-en [6239 kB]
Get:9 https://ftp.acc.umu.se/debian bullseye/contrib arm64 Packages [41.0 kB]
Get:10 https://ftp.acc.umu.se/debian bullseye/contrib Translation-en [46.9 kB]
Get:11 https://ftp.acc.umu.se/debian bullseye/non-free arm64 Packages [72.9 kB]
Get:12 https://ftp.acc.umu.se/debian bullseye/non-free Translation-en [92.4 kB]
Get:13 https://ftp.acc.umu.se/debian bullseye-updates/main arm64 Packages [4160 B]
Get:14 https://ftp.acc.umu.se/debian bullseye-updates/main Translation-en [5890 B]
Fetched 15.1 MB in 25s (606 kB/s)                                                                                                                                                                                                             
Reading package lists... Done
Building dependency tree       
Reading state information... Done
270 packages can be upgraded. Run 'apt list --upgradable' to see them.
```

```
apt upgrade --without-new-pkgs
apt full-upgrade
```    

```
-Host readahead.adb-centralen.se
-       RequestTTY no
-       identityfile /root/.ssh/_ndAC01TGFP
-       port 4727
-       user _ndAC01TGFP
-       hostname kcmp.adb-centralen.se
```

*** 2023-03-08 losing contact after upgrade and reboot
Luckily we have console over an USB port on logsrv-02.
Seems like eth0 and eth1 were swapped at reboot.

Removed net.ifnames=0 from /boot/firmware/cmdline.txt (not
/boot/cmdline.txt!) and rebooted. Interfaces are now horribly named
but at least predictably so.

    root@getrandom:~# cat /boot/firmware/cmdline.txt 
    console=tty0 console=ttyS1,115200 root=/dev/mmcblk0p2 rw elevator=deadline fsck.repair=yes cma=64M rootwait
    root@getrandom:~# ip link
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    2: enxb827eb5f47ad: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
        link/ether b8:27:eb:5f:47:ad brd ff:ff:ff:ff:ff:ff
    3: enx00e04c68b34b: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
        link/ether 00:e0:4c:68:b3:4b brd ff:ff:ff:ff:ff:ff
    4: wlan0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
        link/ether b8:27:eb:0a:12:f8 brd ff:ff:ff:ff:ff:ff

TODO: Configure systemd-udevd or something to name them in a better
way, see f.ex. systemd.net-naming-scheme(7).

** sigwaitinfo.verkligendata.se (2020-11-19) -- red apu2 @ VKG
APU2

4G RAM
16G SSD

*** Storage
Device Model:     Hoodisk SSD
Serial Number:    L7DTC7A11208568
Firmware Version: SBFM01.3
User Capacity:    16,013,942,784 bytes [16.0 GB]
Sector Size:      512 bytes logical/physical
Rotation Rate:    Solid State Device
Form Factor:      mSATA

*** install
https://teklager.se/en/knowledge-base/installing-debian-over-serial-console-apu-board/

SeaBIOS (version rel-1.12.1.3-0-g300e8b70)

Press F10 key now for boot menu

Select boot device:

1. USB MSC Drive SanDisk Ultra Fit 1.00
2. AHCI/0: Hoodisk SSD ATA-11 Hard-Disk (15272 MiBytes)
3. Payload [setup]
4. Payload [memtest]

Debian GNU/Linux installer menu (BIOS mode)
- press H and Enter for the help menu
- install console=ttyS0,115200n8
  or, to debug an installation on SSD
- rescue console=ttyS0,115200n8
  - C-a n for next "panel" (installer, shell, shell, log) just like screen

--- or ---

<press TAB for editing the kernel command line, add console=ttyS0,115200n8>
*** boot
At the Debian boot menu (GRUB), press E and edit the 'linux' line to
include console=ttyS0,115200n8.

FIXME: make this permanent by reconfiguring GRUB

*** wireguard
# Install wireguard
echo "deb http://deb.debian.org/debian buster-backports main" > /etc/apt/sources.list.d/buster-backports.list
sudo apt update

# Generate keys, set up server and enable autostart
umask 077
wg genkey | tee /etc/wireguard/wg0.priv | wg pubkey > /etc/wireguard/wg0.pub
chmod 644 /etc/wireguard/wg0.pub
cat > /etc/wireguard/wg0.conf <<EOF
[Interface]
Address = 10.47.11.1
Address = fd00:47:11::1
ListenPort = 51820
PrivateKey = $(</etc/wireguard/wg0.priv)
EOF
umask 022

TODO: set up NAT

systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0

Since we're filtering both INPUT and FORWARD, allow for wg:

NAT is done in an ip postrouting chain:
table ip nat {
        chain postrouting {
                type nat hook postrouting priority 100; policy accept;
                ip saddr 10.47.11.0/24 ip daddr != 10.47.11.0/24 masquerade
        }
}

# Add peer
wg show wg0 allowed-ips | sort -t . -k 4 -n
wg set wg0 peer $PEERPUBKEY allowed-ips 10.47.11.${NEXTV4}/32,fd00:47:11::${NEXTV6}/128
ip route add 10.47.11.${NEXTV4}/32 dev wg0
ip route add fd00:47:11::${NEXTV6}/128 dev wg0
wg-quick save wg0

**** old stuff
Once we were adding 10.47.11.0/24 dev wg0 when for some reason we didn't a route like

    10.47.11.11 dev wg0 scope link

for the .11 peer. This "fixed itself" after a reboot. Not sure if this
will repeat for newly added peers. Please update.

*** DHCP by dnsmasq
Leases in /var/lib/misc/dnsmasq.leases

journalctl -u dnsmasq | awk '/DHCPACK/{print $8, $9}' | sort | uniq -c

** vm86.verkligendata.se (2020-10-15) -- Supermicro 1U with X11SSH-TF
Long term loan from Mullvad.

ST booting, see branch vdse in the system-transparency repository.
Also see [[file:~/p/st/st.org::*vm86.vdse][vm86.vdse]] for a lot of details.

Serial console on screen /dev/ttyUSB0 @ sigwaitinfo.
Coreboot at 115200 baud, the os-pkg kernel at 115200 too.

38400 and sometimes 57600 seems to be right FIXME

    linus@sigwaitinfo:~$ sudo screen /dev/ttyUSB0 57600

*** Hardware
Mullet 1U MRS-362.12, 8xSATA 2.5", 2x10GbaseT, enkel PSU 600W
X11SSH-TF-O Xeon H4-Skt uATX, Intel C236
1 x Intel Xeon E3-1270v6 QuadCore HT
4 x Samsung 16G DDR4 ECC 2666MHz 1.2V UDIMM

*** Disks
All disks are 2.5".

Slots are counted from lower left position, going up and then right and down:
  1 3 5
  0 2 4 6 7

**** 2 x Seagate HDD 2TB 7200
Shipped with the server.

Tray: 0,1
Slot: 0,1

Device Model:     ST2000NX0253
Serial Number:    W462J738
LU WWN Device Id: 5 000c50 0c5104a62
Firmware Version: SN05
User Capacity:    2,000,398,934,016 bytes [2.00 TB]
Sector Sizes:     512 bytes logical, 4096 bytes physical
Rotation Rate:    7200 rpm
Form Factor:      2.5 inches
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-3 (minor revision not indicated)
SATA Version is:  SATA 3.1, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Fri May 13 08:10:01 2022 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

Device Model:     ST2000NX0253
Serial Number:    W462J7RZ
LU WWN Device Id: 5 000c50 0c5103b09
Firmware Version: SN05
User Capacity:    2,000,398,934,016 bytes [2.00 TB]
Sector Sizes:     512 bytes logical, 4096 bytes physical
Rotation Rate:    7200 rpm
Form Factor:      2.5 inches
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-3 (minor revision not indicated)
SATA Version is:  SATA 3.1, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Fri May 13 08:10:20 2022 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

**** Samsung PM897 SSD 1.92TB
2022-05-13 around 09:30, second part of big SSD md mirror
Tray: 3
Slot: 3

=== START OF INFORMATION SECTION ===
Device Model:     SAMSUNG MZ7L31T9HBNA-00A07
Serial Number:    S6ENNE0R900548
LU WWN Device Id: 5 002538 f01902998
Firmware Version: JXTE004Q
User Capacity:    1,920,383,410,176 bytes [1.92 TB]
Sector Sizes:     512 bytes logical, 4096 bytes physical
Rotation Rate:    Solid State Device
Form Factor:      2.5 inches
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-4 T13/BSR INCITS 529 revision 5
SATA Version is:  SATA 3.2, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Fri May 13 08:08:56 2022 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

**** Samsung PM897 SSD 1.92TB
2022-05-13 To be mirrored with another identical one as soon as we've got a free slot.
Tray: 4
Slot: 2

=== START OF INFORMATION SECTION ===
Device Model:     SAMSUNG MZ7L31T9HBNA-00A07
Serial Number:    S6ENNE0R900543
LU WWN Device Id: 5 002538 f01902993
Firmware Version: JXTE004Q
User Capacity:    1,920,383,410,176 bytes [1.92 TB]
Sector Sizes:     512 bytes logical, 4096 bytes physical
Rotation Rate:    Solid State Device
Form Factor:      2.5 inches
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-4 T13/BSR INCITS 529 revision 5
SATA Version is:  SATA 3.2, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Fri May 13 05:30:18 2022 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

**** Kingston SSD 240GB
2021-09-08 SSD for mirror journaling
Tray: 7
Slot: 4

Device Model:     KINGSTON SA400S37240G
Serial Number:    50026B7380F7CA33
LU WWN Device Id: 5 0026b7 380f7ca33
Firmware Version: S3501103
User Capacity:    240,057,409,536 bytes [240 GB]
Sector Size:      512 bytes logical/physical
Rotation Rate:    Solid State Device
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-3 T13/2161-D revision 4
SATA Version is:  SATA 3.2, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Fri May 13 08:11:42 2022 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

**** Samsung 870 EVO SSD 250GB
2022-01-04 For mirroring the Kingston SSD 240GB.
Tray: 6
Slot: 5

Device Model:     Samsung SSD 870 EVO 250GB
Serial Number:    S6PENJ0RB04752D
LU WWN Device Id: 5 002538 f31b01290
Firmware Version: SVT01B6Q
User Capacity:    250,059,350,016 bytes [250 GB]
Sector Size:      512 bytes logical/physical
Rotation Rate:    Solid State Device
Form Factor:      2.5 inches
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-4 T13/BSR INCITS 529 revision 5
SATA Version is:  SATA 3.3, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Fri May 13 08:12:39 2022 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

**** Seagate HDD 1TB 7200
2021-09-11 Another disk, replacing the (thought to be) broken 2T from 2021-08-18
Tray: 5
Slot: 6

Device Model:     ST1000LM049-2GH172
Serial Number:    WN94MXJ1
LU WWN Device Id: 5 000c50 0d67e24cd
Firmware Version: SDM1
User Capacity:    1,000,204,886,016 bytes [1.00 TB]
Sector Sizes:     512 bytes logical, 4096 bytes physical
Rotation Rate:    7200 rpm
Form Factor:      2.5 inches
Device is:        Not in smartctl database [for details use: -P showall]
ATA Version is:   ACS-3 T13/2161-D revision 3b
SATA Version is:  SATA 3.1, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Fri May 13 08:13:50 2022 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

**** ON SHELF: 1 x Seagate HDD 5400
2021-12-02 Replacing one of the "2021-08-18 Two more cheap disks" (the one _not_ matching the serial number listed above)

Model Family:     Seagate Barracuda 2.5 5400
Device Model:     ST2000LM015-2E8174
Serial Number:    ZDZFGKA3
LU WWN Device Id: 5 000c50 0c8bc682b
Firmware Version: 0001
User Capacity:    2,000,398,934,016 bytes [2.00 TB]
Sector Sizes:     512 bytes logical, 4096 bytes physical
Rotation Rate:    5400 rpm
Form Factor:      2.5 inches
Device is:        In smartctl database [for details use: -P show]
ATA Version is:   ACS-3 T13/2161-D revision 3b
SATA Version is:  SATA 3.1, 6.0 Gb/s (current: 6.0 Gb/s)
Local Time is:    Thu Dec  2 14:19:11 2021 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Enabled

date > /tmp/vm86-fdisklist.2.txt; for f in a b c d e f; do printf "\n# sd$f\n" >> /tmp/vm86-fdisklist.2.txt; fdisk -lo 'Device,Start,End,Sectors,Size,Type,Type-UUID,Attrs,Name,UUID' /dev/sd$f >> /tmp/vm86-fdisklist.2.txt; done
See [[file:~/p/st/deployments/verkligen/vm86-fdisklist.2.txt][file:~/p/st/deployments/verkligen/vm86-fdisklist.2.txt]]

**** ON SHELF: 2 x Seagate HDD 2TB 5400
2021-08-18 Two more cheap disks

Shelved 2022-05-03.

Model Family:     Seagate Barracuda 2.5 5400
Device Model:     ST2000LM015-2E8174
Serial Number:    WDZVJ2BT
LU WWN Device Id: 5 000c50 0d63b2a09
Firmware Version: 0001
Rotation Rate:    5400 rpm

*** Storage
**** Setting up two new 2T disks <2021-08-18 Wed>
 fdisk /dev/sdc
 g
 n
 -> Created a new partition 1 of type 'Linux filesystem' and of size 1.8 TiB.
 t
 31
 -> Changed type of partition 'Linux filesystem' to 'Linux LVM'.
 w

 pvcreate /dev/sdc1 
 vgextend st-vg /dev/sdc1

 Then did the same for /dev/sdd.

 root@vm86:~# lvextend -L +1T st-vg/vm-images
   Extending 2 mirror images.
   Size of logical volume st-vg/vm-images changed from 1.00 TiB (262144 extents) to 2.00 TiB (524288 extents).
   Logical volume st-vg/vm-images successfully resized.

 root@vm86:~# resize2fs /dev/mapper/st--vg-vm--images
 resize2fs 1.44.5 (15-Dec-2018)
 Filesystem at /dev/mapper/st--vg-vm--images is mounted on /vm-images; on-line resizing required
 old_desc_blocks = 128, new_desc_blocks = 256

 root@vm86:~# lvs
   LV         VG    Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   scratch300 st-vg Mwi-a-m--- 300.00g                                    16.47           
   st-config  st-vg Mwi-aom---  20.00g                                    100.00          
   vm-images  st-vg Mwi-aom---   2.00t                                    100.00          
 root@vm86:~# df -h /var/lib/libvirt/
 Filesystem      Size  Used Avail Use% Mounted on
 overlay         2.0T  834G  1.1T  44% /var/lib/libvirt

**** SOLVED: Weird sluggishness after reboot (reason: mirror syncing)
 On 2021-09-06 vm86 and especially its VM's behaved strangely for a
 long time, see [[*vm's misbehaving after vm86 boot][vm's misbehaving after vm86 boot]] and the day after a
 hint on why was presented by looking at the output from iostat 10 for
 a while. There's been a lot of mirror syncing going on for the
 vm-images LV the last ~20h or so.

 root@vm86:~# date; lvs
 Tue Sep  7 10:13:56 UTC 2021
   LV         VG    Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   scratch300 st-vg Mwi-a-m--- 300.00g                                    100.00          
   st-config  st-vg Mwi-aom---  20.00g                                    100.00          
   vm-images  st-vg Mwi-aom---   2.00t                                    97.27           

 This is a plausible reason for VM's to behave weirdly, as described.

 One conclusion is that software based mirroring doesn't come for free.
 Faster disks would probably be an improvement.

 Update <2021-09-07 Tue>: Clean reboot, ie stopping all VM's and
 verifying that volumes where indeed synced, still resulted in all
 volumes starting at Cpy%Sync 0. And the reason is that our mirrors
 don't have log files on disk!
**** Converting mirrors from 'mirror' to 'raid1'
***** Rehearsing on volume st-vg/scratch300. 
 : raid1 needs an additional extent on both physical disks so we'll have to resize things.
 : We will
 : 1. Break the mirror: lvconvert --mirrors 0 st-vg/scratch300
 : 2. MAYBE? Shrink existing file system: e2fsck -f /dev/mapper/st--vg-scratch300 && resize2fs /dev/mapper/st--vg-scratch300 280G
 : 3. Shrink the LV: lvresize --resizefs --size 280G st-vg/scratch300
 : 4. Convert to 'raid1': lvconvert --type raid1 --mirrors 1 st-vg/scratch300

 root@vm86:~# lvdisplay st-vg/scratch300
   --- Logical volume ---
   LV Path                /dev/st-vg/scratch300
   LV Name                scratch300
   VG Name                st-vg
   LV UUID                67N7Ep-NFpK-UVjn-VpJR-NpeF-KACx-llhM5X
   LV Write Access        read/write
   LV Creation host, time vm86, 2020-11-01 12:42:35 +0100
   LV Status              available
   # open                 0
   LV Size                300.00 GiB
   Current LE             76800
   Mirrored volumes       2
   Segments               1
   Allocation             inherit
   Read ahead sectors     auto
   - currently set to     256
   Block device           254:8

 root@vm86:~# lvconvert --mirrors 0 st-vg/scratch300
   Logical volume st-vg/scratch300 converted.
 root@vm86:~# lvdisplay st-vg/scratch300
   --- Logical volume ---
   LV Path                /dev/st-vg/scratch300
   LV Name                scratch300
   VG Name                st-vg
   LV UUID                67N7Ep-NFpK-UVjn-VpJR-NpeF-KACx-llhM5X
   LV Write Access        read/write
   LV Creation host, time vm86, 2020-11-01 12:42:35 +0100
   LV Status              available
   # open                 0
   LV Size                300.00 GiB
   Current LE             76800
   Segments               1
   Allocation             inherit
   Read ahead sectors     auto
   - currently set to     256
   Block device           254:8
 root@vm86:~# pvs
   PV         VG    Fmt  Attr PSize  PFree  
   /dev/sda2  st-vg lvm2 a--  <1.82t      0 
   /dev/sdb2  st-vg lvm2 a--  <1.82t 300.00g
   /dev/sdc1  st-vg lvm2 a--  <1.82t  <1.33t
   /dev/sdd1  st-vg lvm2 a--  <1.82t  <1.33t

 : NOTE: probably not necessary thanks to --resizefs below
 root@vm86:~# e2fsck -f /dev/mapper/st--vg-scratch300
 e2fsck 1.44.5 (15-Dec-2018)
 Pass 1: Checking inodes, blocks, and sizes
 Pass 2: Checking directory structure
 Pass 3: Checking directory connectivity
 Pass 4: Checking reference counts
 Pass 5: Checking group summary information
 /dev/mapper/st--vg-scratch300: 13/19660800 files (0.0% non-contiguous), 1512760/78643200 blocks
 root@vm86:~# resize2fs /dev/mapper/st--vg-scratch300 280G
 resize2fs 1.44.5 (15-Dec-2018)
 Resizing the filesystem on /dev/mapper/st--vg-scratch300 to 73400320 (4k) blocks.
 The filesystem on /dev/mapper/st--vg-scratch300 is now 73400320 (4k) blocks long.

 root@vm86:~# lvresize --resizefs --size 280G st-vg/scratch300
 fsck from util-linux 2.33.1
 /dev/mapper/st--vg-scratch300: clean, 13/18350080 files, 1430472/73400320 blocks
 resize2fs 1.44.5 (15-Dec-2018)
 The filesystem is already 73400320 (4k) blocks long.  Nothing to do!

   Size of logical volume st-vg/scratch300 changed from 300.00 GiB (76800 extents) to 280.00 GiB (71680 extents).
   Logical volume st-vg/scratch300 successfully resized.

 root@vm86:~# lvconvert --type raid1 --mirrors 1 st-vg/scratch300 
 Are you sure you want to convert linear LV st-vg/scratch300 to raid1 with 2 images enhancing resilience? [y/n]: y
 WARNING: ext4 signature detected on /dev/st-vg/scratch300_rmeta_1 at offset 1080. Wipe it? [y/n]: y
   Wiping ext4 signature on /dev/st-vg/scratch300_rmeta_1.
   Logical volume st-vg/scratch300 successfully converted.

 root@vm86:~# lvdisplay st-vg/scratch300
   --- Logical volume ---
   LV Path                /dev/st-vg/scratch300
   LV Name                scratch300
   VG Name                st-vg
   LV UUID                67N7Ep-NFpK-UVjn-VpJR-NpeF-KACx-llhM5X
   LV Write Access        read/write
   LV Creation host, time vm86, 2020-11-01 12:42:35 +0100
   LV Status              available
   # open                 0
   LV Size                280.00 GiB
   Current LE             71680
   Mirrored volumes       2
   Segments               1
   Allocation             inherit
   Read ahead sectors     auto
   - currently set to     256
   Block device           254:8

 root@vm86:~# lvs
   LV         VG    Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   scratch300 st-vg rwi-a-r--- 280.00g                                    1.12
   st-config  st-vg Mwi-aom---  20.00g                                    100.00
   vm-images  st-vg Mwi-aom---   2.00t                                    68.78

***** Converting st-vg/vm-images
 root@vm86:~# mount | egrep vm-images
 /dev/mapper/st--vg-vm--images on /vm-images type ext4 (rw,nosuid,nodev,noexec,relatime)
 overlay on /var/lib/libvirt type overlay (rw,relatime,lowerdir=/var/lib/libvirt,upperdir=/vm-images/var/lib/libvirt,workdir=/vm-images/var/lib/libvirt.overlaywork,x-systemd.requires=/vm-images)

 root@vm86:~# df -h /var/lib/libvirt/
 Filesystem      Size  Used Avail Use% Mounted on
 overlay         2.0T  896G  1.1T  47% /var/lib/libvirt

 root@vm86:~# lvdisplay st-vg/vm-images
   --- Logical volume ---
   LV Path                /dev/st-vg/vm-images
   LV Name                vm-images
   VG Name                st-vg
   LV UUID                spCjFT-nVAT-sLWa-Ec7R-x4Qr-ZAV6-uwxkhq
   LV Write Access        read/write
   LV Creation host, time vm86, 2020-10-29 21:34:58 +0100
   LV Status              available
   # open                 1
   LV Size                2.00 TiB
   Current LE             524288
   Mirrored volumes       2
   Segments               1
   Allocation             inherit
   Read ahead sectors     auto
   - currently set to     256
   Block device           254:2

 root@vm86:~# pvs -v
   PV         VG    Fmt  Attr PSize  PFree   DevSize PV UUID                               
   /dev/sda2  st-vg lvm2 a--  <1.82t 300.00g  <1.82t IjikPR-SBc6-GMdk-PbjP-THka-ulSm-3YWkNz
   /dev/sdb2  st-vg lvm2 a--  <1.82t 300.00g  <1.82t j4mtJI-ouhe-wdtu-2ajM-yPkO-txef-BBBprY
   /dev/sdc1  st-vg lvm2 a--  <1.82t  <1.33t  <1.82t zG8En8-lkA2-qR1U-mEJu-OvvC-Lhgr-5NaLWw
   /dev/sdd1  st-vg lvm2 a--  <1.82t  <1.33t  <1.82t I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc

 root@vm86:~# virsh list | egrep '^ *[0-9]+' | while read n _; do virsh shutdown $n; done; while virsh list; do sleep 2; done

 : wait for all VM's to stop

 root@vm86:~# umount /var/lib/libvirt
 root@vm86:~# umount /vm-images
 root@vm86:~# lvconvert --mirrors 0 st-vg/vm-images
   Logical volume st-vg/vm-images converted.
 root@vm86:~# lvs
   LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   st-config st-vg Mwi-aom--- 20.00g                                    100.00          
   vm-images st-vg -wi-a-----  2.00t                                                    
 root@vm86:~# lvconvert --type raid1 --mirrors 1 st-vg/vm-images
 Are you sure you want to convert linear LV st-vg/vm-images to raid1 with 2 images enhancing resilience? [y/n]: y
 WARNING: ext4 signature detected on /dev/st-vg/vm-images_rmeta_0 at offset 1080. Wipe it? [y/n]: y
   Wiping ext4 signature on /dev/st-vg/vm-images_rmeta_0.
   Logical volume st-vg/vm-images successfully converted.
 root@vm86:~# lvs
   LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   st-config st-vg Mwi-aom--- 20.00g                                    100.00          
   vm-images st-vg rwi-a-r---  2.00t                                    0.00            

 : Note the attribute changes: 1: (r)aid, not (M)irrored without initial sync and 7: (r)aid, not (m)irror

 root@vm86:~# mount -a
 root@vm86:~# ls /var/lib/libvirt/images/
 brk-bup.qcow2                      membarrier.verkligendata.se.qcow2   stat-db.qcow2
 brk.verkligendata.se.qcow2         munmap.verkligendata.se.qcow2       stat.verkligendata.se-1.qcow2
 btc.adb-centralen.se.blocks.qcow2  nc.verkligendata.se.qcow2.REMOVE    stat.verkligendata.se.qcow2.REMOVE
 btc.adb-centralen.se.qcow2         nc_st.qcow2                         tkill.adb-centralen.se.qcow2
 getuid.sigsum.org.qcow2            nice.verkligendata.se.qcow2.REMOVE  tkill.adb-centralen.se.vol1.qcow2
 kexec.adb-centralen.se.qcow2       pause.sigsum.org.qcow2              vm-base.img
 root@vm86:~# pvs
   PV         VG    Fmt  Attr PSize  PFree   
   /dev/sda2  st-vg lvm2 a--  <1.82t <300.00g
   /dev/sdb2  st-vg lvm2 a--  <1.82t   <1.62t
   /dev/sdc1  st-vg lvm2 a--  <1.82t   <1.33t
   /dev/sdd1  st-vg lvm2 a--  <1.82t       0 
 root@vm86:~# vgs
   VG    #PV #LV #SN Attr   VSize  VFree 
   st-vg   4   2   0 wz--n- <7.28t <3.24t

**** disk failure on newish HDD, 2021-09-11
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#28 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#28 CDB: Read(10) 28 00 00 00 00 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 0
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#29 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#29 CDB: Read(10) 28 00 00 00 08 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 2048
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#6 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#6 CDB: Read(10) 28 00 00 00 00 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 0
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#7 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#7 CDB: Read(10) 28 00 00 00 08 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 2048
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#8 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#8 CDB: Read(10) 28 00 00 00 00 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 0
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#9 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#9 CDB: Read(10) 28 00 00 00 08 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 2048
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#12 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#12 CDB: Read(10) 28 00 00 00 00 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 0
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#14 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#14 CDB: Read(10) 28 00 00 00 00 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 0
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#16 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
 Sep 11 04:16:51 vm86 kernel: sd 3:0:0:0: [sdd] tag#16 CDB: Read(10) 28 00 00 00 08 00 00 01 00 00
 Sep 11 04:16:51 vm86 kernel: print_req_error: I/O error, dev sdd, sector 2048

 root@vm86:~# lsblk
 NAME                           MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
 sda                              8:0    0   1.8T  0 disk 
 |-sda1                           8:1    0   767M  0 part /stdata
 `-sda2                           8:2    0   1.8T  0 part 
   |-st--vg-vm--images_rmeta_0  254:0    0     4M  0 lvm  
   | `-st--vg-vm--images        254:4    0     2T  0 lvm  /vm-images
   |-st--vg-vm--images_rimage_0 254:1    0     2T  0 lvm  
   | `-st--vg-vm--images        254:4    0     2T  0 lvm  /vm-images
   `-st--vg-st--config_mimage_0 254:5    0    20G  0 lvm  
     `-st--vg-st--config        254:7    0    20G  0 lvm  /st-config
 sdb                              8:16   0   1.8T  0 disk 
 |-sdb1                           8:17   0   767M  0 part 
 `-sdb2                           8:18   0   1.8T  0 part 
   |-st--vg-vm--images_rimage_1 254:3    0     2T  0 lvm  
   | `-st--vg-vm--images        254:4    0     2T  0 lvm  /vm-images
   `-st--vg-st--config_mimage_1 254:6    0    20G  0 lvm  
     `-st--vg-st--config        254:7    0    20G  0 lvm  /st-config
 sdc                              8:32   0   1.8T  0 disk 
 `-sdc1                           8:33   0   1.8T  0 part 
   `-st--vg-vm--images_rimage_0 254:1    0     2T  0 lvm  
     `-st--vg-vm--images        254:4    0     2T  0 lvm  /vm-images
 sdd                              8:48   0   1.8T  0 disk 
 `-sdd1                           8:49   0   1.8T  0 part 
   |-st--vg-vm--images_rmeta_1  254:2    0     4M  0 lvm  
   | `-st--vg-vm--images        254:4    0     2T  0 lvm  /vm-images
   `-st--vg-vm--images_rimage_1 254:3    0     2T  0 lvm  
     `-st--vg-vm--images        254:4    0     2T  0 lvm  /vm-images
 sde                              8:64   0 223.6G  0 disk 
 root@vm86:~# lvs
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
   WARNING: Couldn't find all devices for LV st-vg/vm-images_rmeta_1 while checking used and assumed devices.
   WARNING: Couldn't find all devices for LV st-vg/vm-images_rimage_1 while checking used and assumed devices.
   LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   st-config st-vg Mwi-aom--- 20.00g                                    100.00          
   vm-images st-vg rwi-aor-p-  2.00t                                    100.00          
 root@vm86:~# pvs
   Error reading device /dev/sdd at 0 length 512.
   Error reading device /dev/sdd at 0 length 4096.
   Error reading device /dev/sdd1 at 0 length 4096.
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
   WARNING: Couldn't find all devices for LV st-vg/vm-images_rmeta_1 while checking used and assumed devices.
   WARNING: Couldn't find all devices for LV st-vg/vm-images_rimage_1 while checking used and assumed devices.
   PV         VG    Fmt  Attr PSize  PFree   
   /dev/sda2  st-vg lvm2 a--  <1.82t <300.00g
   /dev/sdb2  st-vg lvm2 a--  <1.82t   <1.62t
   /dev/sdc1  st-vg lvm2 a--  <1.82t   <1.33t
   [unknown]  st-vg lvm2 a-m  <1.82t       0 
 root@vm86:~# vgs
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
   WARNING: Couldn't find all devices for LV st-vg/vm-images_rmeta_1 while checking used and assumed devices.
   WARNING: Couldn't find all devices for LV st-vg/vm-images_rimage_1 while checking used and assumed devices.
   VG    #PV #LV #SN Attr   VSize  VFree 
   st-vg   4   2   0 wz-pn- <7.28t <3.24t

 root@vm86:~# smartctl -i /dev/sdd
 smartctl 6.6 2017-11-05 r4594 [x86_64-linux-4.19.0-17-amd64] (local build)
 Copyright (C) 2002-17, Bruce Allen, Christian Franke, www.smartmontools.org

 Short INQUIRY response, skip product id
 A mandatory SMART command failed: exiting. To continue, add one or more '-T permissive' options.

 root@vm86:~# smartctl -i /dev/sdc
 smartctl 6.6 2017-11-05 r4594 [x86_64-linux-4.19.0-17-amd64] (local build)
 Copyright (C) 2002-17, Bruce Allen, Christian Franke, www.smartmontools.org

 === START OF INFORMATION SECTION ===
 Model Family:     Seagate Barracuda 2.5 5400
 Device Model:     ST2000LM015-2E8174
 Serial Number:    WDZVJ2BT
 LU WWN Device Id: 5 000c50 0d63b2a09
 Firmware Version: 0001
 User Capacity:    2,000,398,934,016 bytes [2.00 TB]
 Sector Sizes:     512 bytes logical, 4096 bytes physical
 Rotation Rate:    5400 rpm
 Form Factor:      2.5 inches
 Device is:        In smartctl database [for details use: -P show]
 ATA Version is:   ACS-3 T13/2161-D revision 3b
 SATA Version is:  SATA 3.1, 6.0 Gb/s (current: 6.0 Gb/s)
 Local Time is:    Sat Sep 11 04:55:43 2021 UTC
 SMART support is: Available - device has SMART capability.
 SMART support is: Enabled

 : After reboot, st-vg/vm-images and st-vg/st-config didn't start properly

 root@7c8567255c48:~# vgreduce --removemissing st-vg
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
   WARNING: Partial LV vm-images needs to be repaired or removed. 
   WARNING: Partial LV vm-images_rmeta_1 needs to be repaired or removed. 
   WARNING: Partial LV vm-images_rimage_1 needs to be repaired or removed. 
   There are still partial LVs in VG st-vg.
   To remove them unconditionally use: vgreduce --removemissing --force.
   WARNING: Proceeding to remove empty missing PVs.

 root@7c8567255c48:~# lvdisplay st-vg/vm-images
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
   --- Logical volume ---
   LV Path                /dev/st-vg/vm-images
   LV Name                vm-images
   VG Name                st-vg
   LV UUID                spCjFT-nVAT-sLWa-Ec7R-x4Qr-ZAV6-uwxkhq
   LV Write Access        read/write
   LV Creation host, time vm86, 2020-10-29 20:34:58 +0000
   LV Status              NOT available
   LV Size                2.00 TiB
   Current LE             524288
   Mirrored volumes       2
   Segments               1
   Allocation             inherit
   Read ahead sectors     auto

 root@7c8567255c48:~# lvchange -ay --activationmode degraded st-vg/vm-images
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
 [ 1262.108494] raid6: sse2x1   gen() 13642 MB/s
 [ 1262.180509] raid6: sse2x1   xor() 10615 MB/s
 [ 1262.252490] raid6: sse2x2   gen() 15961 MB/s
 [ 1262.324490] raid6: sse2x2   xor() 12071 MB/s
 [ 1262.396508] raid6: sse2x4   gen() 19165 MB/s
 [ 1262.468492] raid6: sse2x4   xor() 12924 MB/s
 [ 1262.540494] raid6: avx2x1   gen() 24815 MB/s
 [ 1262.612497] raid6: avx2x1   xor() 20048 MB/s
 [ 1262.684509] raid6: avx2x2   gen() 30423 MB/s
 [ 1262.752496] raid6: avx2x2   xor() 21996 MB/s
 [ 1262.824497] raid6: avx2x4   gen() 37568 MB/s
 [ 1262.896522] raid6: avx2x4   xor() 22344 MB/s
 [ 1262.896522] raid6: using algorithm avx2x4 gen() 37568 MB/s
 [ 1262.896523] raid6: .... xor() 22344 MB/s, rmw enabled
 [ 1262.896523] raid6: using avx2x2 recovery algorithm
 [ 1262.897498] async_tx: api initialized (async)
 [ 1262.898224] xor: automatically using best checksumming function   avx       
 [ 1262.940881] device-mapper: raid: Loading target version 1.14.0
 [ 1262.958535] device-mapper: raid: Failed to read superblock of device at position 1
 [ 1262.969068] md/raid1:mdX: active with 1 out of 2 mirrors

 root@7c8567255c48:~# lvdisplay st-vg/vm-images
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
   --- Logical volume ---
   LV Path                /dev/st-vg/vm-images
   LV Name                vm-images
   VG Name                st-vg
   LV UUID                spCjFT-nVAT-sLWa-Ec7R-x4Qr-ZAV6-uwxkhq
   LV Write Access        read/write
   LV Creation host, time vm86, 2020-10-29 20:34:58 +0000
   LV Status              available
   # open                 0
   LV Size                2.00 TiB
   Current LE             524288
   Mirrored volumes       2
   Segments               1
   Allocation             inherit
   Read ahead sectors     auto
   - currently set to     256
   Block device           254:6

 root@7c8567255c48:~# lvs
   Couldn't find device with uuid I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc.
   LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   st-config st-vg Mwi-aom--- 20.00g                                    6.64            
   vm-images st-vg rwi-aor-p-  2.00t                                    100.00          

 : NOTE: The 'p' is for "partial"

 : 2021-09-11: Bought another disk, inserted and rebooted. 
 : But now the "broken" disk is alive again!

 root@7c8567255c48:~# lsblk
 NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
 sda      8:0    0   1.8T  0 disk 
 ├─sda1   8:1    0   767M  0 part /stdata
 └─sda2   8:2    0   1.8T  0 part 
 sdb      8:16   0   1.8T  0 disk 
 ├─sdb1   8:17   0   767M  0 part 
 └─sdb2   8:18   0   1.8T  0 part 
 sdc      8:32   0   1.8T  0 disk 
 └─sdc1   8:33   0   1.8T  0 part 
 sdd      8:48   0   1.8T  0 disk 
 └─sdd1   8:49   0   1.8T  0 part 
 sde      8:64   0 931.5G  0 disk 
 sdf      8:80   0 223.6G  0 disk 

 root@7c8567255c48:~# pvs -v
     There are 2 physical volumes missing.
   PV         VG    Fmt  Attr PSize  PFree    DevSize PV UUID                               
   /dev/sda2  st-vg lvm2 a--  <1.82t <300.00g  <1.82t IjikPR-SBc6-GMdk-PbjP-THka-ulSm-3YWkNz
   /dev/sdb2  st-vg lvm2 a--  <1.82t   <1.62t  <1.82t j4mtJI-ouhe-wdtu-2ajM-yPkO-txef-BBBprY
   /dev/sdc1  st-vg lvm2 a-m  <1.82t   <1.33t  <1.82t zG8En8-lkA2-qR1U-mEJu-OvvC-Lhgr-5NaLWw
   /dev/sdd1  st-vg lvm2 a-m  <1.82t       0   <1.82t I4vFZu-7ukh-g9jy-3e1I-gflo-9IVc-CCLAPc

 root@7c8567255c48:~# smartctl -H /dev/sdd
 smartctl 6.6 2017-11-05 r4594 [x86_64-linux-4.19.0-17-amd64] (local build)
 Copyright (C) 2002-17, Bruce Allen, Christian Franke, www.smartmontools.org

 === START OF READ SMART DATA SECTION ===
 SMART overall-health self-assessment test result: PASSED

 systemctl rescue
 ...
 umount -a
 ...
 umount: /var/lib/libvirt: target is busy.
 umount -a

 root@vm86:~# vgreduce --removemissing --force st-vg
 [ 1220.072073] md/raid1:mdX: dm-2: rescheduling sector 4294967168
 [ 1220.096079] md/raid1:mdX: Disk failure on dm-2, disabling device.
 [ 1220.096079] md/raid1:mdX: Operation continuing on 1 devices.
 [ 1220.107862] md/raid1:mdX: redirecting sector 4294967168 to other mirror: dm-4
   Wrote out consistent volume group st-vg.

 root@vm86:~# lvs
   Scan of VG st-vg from /dev/sdc1 found metadata seqno 38 vs previous 39.
   Scan of VG st-vg from /dev/sdc1 found metadata seqno 38 vs previous 39.
   WARNING: Volume Group st-vg is not consistent.
   Scan of VG st-vg from /dev/sdc1 found metadata seqno 38 vs previous 39.
   WARNING: Inconsistent metadata found for VG st-vg - updating to use version 39
   WARNING: Removing PV /dev/sdc1 (zG8En8-lkA2-qR1U-mEJu-OvvC-Lhgr-5NaLWw) that no longer belongs to VG st-vg
   LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   st-config st-vg Mwi-a-m--- 20.00g                                    100.00          
   vm-images st-vg rwi-a-r-r-  2.00t                                    100.00          
   temp      temp  -wi-a----- <1.13t                                                    

 root@vm86:~# lvconvert --repair st-vg/vm-images
 Attempt to replace failed RAID images (requires full device resync)? [y/n]: y
 [ 2156.113078] device-mapper: raid: Device 0 specified for rebuild; clearing superblock
 [ 2156.121990] md/raid1:mdX: active with 1 out of 2 mirrors
 [ 2156.661582] md: recovery of RAID array mdX
 [ 2156.809073] md/raid1:mdX: active with 1 out of 2 mirrors
 [ 2156.844438] md: mdX: recovery interrupted.
 [ 2157.119201] md: recovery of RAID array mdX
   Faulty devices in st-vg/vm-images successfully replaced.

 root@vm86:~# lvs
   LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
   st-config st-vg Mwi-a-m--- 20.00g                                    100.00          
   vm-images st-vg rwi-a-r---  2.00t                                    0.08            
   temp      temp  -wi-a----- <1.13t                                                    

**** Creating a libvirt storage pool
 root@vm86:~# virsh pool-define-as cheapo logical --source-name slow --source-format lvm2 --source-dev /dev/sde
 Pool cheapo defined

 root@vm86:~# virsh pool-build cheapo
 Pool cheapo built

 root@vm86:~# virsh pool-start cheapo
 Pool cheapo started

 root@vm86:~# virsh pool-autostart cheapo
 Pool cheapo marked as autostarted

 root@vm86:~# virsh pool-info cheapo
 Name:           cheapo
 UUID:           63667313-2f93-4c0b-aab1-c5c9da0a5172
 State:          running
 Persistent:     yes
 Autostart:      yes
 Capacity:       931.51 GiB
 Allocation:     0.00 B
 Available:      931.51 GiB

 root@vm86:~# vgdisplay slow
   --- Volume group ---
   VG Name               slow
   System ID             
   Format                lvm2
   Metadata Areas        1
   Metadata Sequence No  1
   VG Access             read/write
   VG Status             resizable
   MAX LV                0
   Cur LV                0
   Open LV               0
   Max PV                0
   Cur PV                1
   Act PV                1
   VG Size               931.51 GiB
   PE Size               4.00 MiB
   Total PE              238467
   Alloc PE / Size       0 / 0   
   Free  PE / Size       238467 / 931.51 GiB
   VG UUID               mw2z58-i3Oh-NRKs-Ei5B-hJPk-HrB9-B7dqiX

 root@vm86:~# pvdisplay /dev/sde
   --- Physical volume ---
   PV Name               /dev/sde
   VG Name               slow
   PV Size               931.51 GiB / not usable 1.71 MiB
   Allocatable           yes 
   PE Size               4.00 MiB
   Total PE              238467
   Free PE               238467
   Allocated PE          0
   PV UUID               ghr9il-LQKa-NWsp-iiwI-zsHS-CiNm-xyhbv9
**** Creating a volume on the new storage pool, cheapo
 root@vm86:~# virsh vol-create-as cheapo tkill.adb-centralen.se-vol2 280G --format qcow2 
 Vol tkill.adb-centralen.se-vol2 created

 root@vm86:~# virsh vol-list cheapo --details                                                                

  Name                          Path                                    Type    Capacity     Allocation
 --------------------------------------------------------------------------------------------------------    
  tkill.adb-centralen.se-vol2   /dev/slow/tkill.adb-centralen.se-vol2   block   280.00 GiB   280.00 GiB

 root@vm86:~# virsh domblklist tkill.adb-centralen.se
  Target   Source
 ---------------------------------------------------------------------
  hda      /var/lib/libvirt/images/tkill.adb-centralen.se.qcow2
  sdb      /var/lib/libvirt/images/tkill.adb-centralen.se.vol1.qcow2

 root@vm86:~# virsh attach-disk tkill.adb-centralen.se /dev/slow/tkill.adb-centralen.se-vol2 sdc --live --config
 Disk attached successfully

 : tkill needed a reboot in order for the new disk to show up

 lroot@tkill:~# lsblk
 NAME                 MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
 sda                    8:0    0  120G  0 disk 
 └─tkill--vol1-vol1   254:2    0  120G  0 lvm  /var/lib/transmission-daemon/downloads
 sdb                    8:16   0  280G  0 disk 
 sdc                    8:32   0    6G  0 disk 
 ├─sdc1                 8:33   0  487M  0 part /boot
 ├─sdc2                 8:34   0    1K  0 part 
 └─sdc5                 8:37   0  5.5G  0 part 
   ├─tkill--vg-root   254:0    0  4.6G  0 lvm  /
   └─tkill--vg-swap_1 254:1    0  976M  0 lvm  [SWAP]
 root@tkill:~# 

**** Creating a logical storage pool from a single SSD
NOTE: This pool been rebuilt, see below.
NOTE: No PV or VG created. /dev/sdf is the uninitialized SSD.

root@vm86:/var/lib/libvirt/images# virsh pool-define-as vm-ssd logical --source-name ssd --source-dev /dev/sdf
Pool vm-ssd defined

root@vm86:/var/lib/libvirt/images# virsh pool-build vm-ssd
Pool vm-ssd built

root@vm86:/var/lib/libvirt/images# virsh pool-autostart vm-ssd
Pool vm-ssd marked as autostarted

root@vm86:/var/lib/libvirt/images# virsh pool-info vm-ssd
Name:           vm-ssd
UUID:           ba68bc91-d1b2-49cb-86f1-78ffdef2be94
State:          running
Persistent:     yes
Autostart:      yes
Capacity:       223.57 GiB
Allocation:     0.00 B
Available:      223.57 GiB

**** Moving an existing volume in a qcow2 file to the new pool
Get the size of the new volume from virsh dumpxml <domain>, or just
look at the file size of the qcow2.

    virsh vol-create-as vm-ssd listen.sigsum.org 21478375424
    virsh destroy listen.sigsum.org
    time qemu-img convert /var/lib/libvirt/images/listen.sigsum.org.qcow2 -O raw /dev/ssd/listen.sigsum.org 
    virsh edit listen.sigsum.org

which succeeded (conversion took about 7,5 minutes) with a disk stanza which ended up like this:

    <disk type='block' device='disk'>
      <driver name='qemu' type='raw'/>
      <source dev='/dev/ssd/listen.sigsum.org'/>
      <backingStore/>
      <target dev='sda' bus='scsi'/>
      <alias name='scsi0-0-0'/>
      <address type='drive' controller='0' bus='0' target='0' unit='0'/>
    </disk>

The thing we had to change was:
- disk type: file -> block
- driver type: qcow2 -> raw
- source file= -> dev=
- target dev: hda -> sda; bus: ide -> scsi

Let's try it again for the only volume that stat.vdse is actually using.
Note that stat-db.qcow2 is not being in use (and actually is not a qcow2 file, but raw).

    virsh vol-create-as vm-ssd stat.verkligendata.se $(stat -c %s /var/lib/libvirt/images/stat.verkligendata.se-1.qcow2)
    :shut down VM
    qemu-img convert /var/lib/libvirt/images/stat.verkligendata.se-1.qcow2 -O raw /dev/ssd/stat.verkligendata.se 
    virsh edit stat.verkligendata.se

Changing this:
    <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2'/>
      <source file='/var/lib/libvirt/images/stat.verkligendata.se-1.qcow2'/>
      <target dev='hda' bus='ide'/>
      <address type='drive' controller='0' bus='0' target='0' unit='0'/>
    </disk>
into this:
    <disk type='block' device='disk'>
      <driver name='qemu' type='raw'/>
      <source dev='/dev/ssd/stat.verkligendata.se/>
      <target dev='sda' bus='scsi'/>
      <address type='drive' controller='0' bus='0' target='0' unit='0'/>
    </disk>
and that worked just right away.

**** Adding another SSD
pvcreate /dev/sde
vgextend ssd /dev/sde

***** log
root@vm86:~# vgdisplay ssd
  --- Volume group ---
  VG Name               ssd
  System ID             
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  22
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                4
  Open LV               0
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               <223.57 GiB
  PE Size               4.00 MiB
  Total PE              57233
  Alloc PE / Size       20485 / <80.02 GiB
  Free  PE / Size       36748 / <143.55 GiB
  VG UUID               WRoUFW-uQy5-EXOL-inh1-sAKc-pdks-1eFprd
   
root@vm86:~# vgextend ssd /dev/sde
  Volume group "ssd" successfully extended
root@vm86:~# vgdisplay ssd
  --- Volume group ---
  VG Name               ssd
  System ID             
  Format                lvm2
  Metadata Areas        2
  Metadata Sequence No  23
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                4
  Open LV               0
  Max PV                0
  Cur PV                2
  Act PV                2
  VG Size               <456.45 GiB
  PE Size               4.00 MiB
  Total PE              116851
  Alloc PE / Size       20485 / <80.02 GiB
  Free  PE / Size       96366 / <376.43 GiB
  VG UUID               WRoUFW-uQy5-EXOL-inh1-sAKc-pdks-1eFprd

**** Mirroring the SSD volumes
root@vm86:~# lvdisplay ssd/stat.verkligendata.se
  --- Logical volume ---
  LV Path                /dev/ssd/stat.verkligendata.se
  LV Name                stat.verkligendata.se
  VG Name                ssd
  LV UUID                4BiBJ0-a1i2-rLOr-0Lnv-3Z1V-B1kO-Ei0hCM
  LV Write Access        read/write
  LV Creation host, time vm86, 2022-01-03 15:32:56 +0000
  LV Status              available
  # open                 0
  LV Size                10.00 GiB
  Current LE             2561
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           254:1
   
root@vm86:~# lvconvert --type raid1 --mirrors 1 ssd/stat.verkligendata.se
Are you sure you want to convert linear LV ssd/stat.verkligendata.se to raid1 with 2 images enhancing resilience? [y/n]: y
  Logical volume ssd/stat.verkligendata.se successfully converted.
root@vm86:~# lvdisplay ssd/stat.verkligendata.se
  --- Logical volume ---
  LV Path                /dev/ssd/stat.verkligendata.se
  LV Name                stat.verkligendata.se
  VG Name                ssd
  LV UUID                4BiBJ0-a1i2-rLOr-0Lnv-3Z1V-B1kO-Ei0hCM
  LV Write Access        read/write
  LV Creation host, time vm86, 2022-01-03 15:32:56 +0000
  LV Status              available
  # open                 0
  LV Size                10.00 GiB
  Current LE             2561
  Mirrored volumes       2
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           254:1

**** Creating a mirrored volume for getuid.so
lvcreate --name getuid.sigsum.org --type raid1 --mirrors 1 --size $(stat -c %s /var/lib/libvirt/images/getuid.sigsum.org.qcow2)b ssd
qemu-img convert /var/lib/libvirt/images/getuid.sigsum.org.qcow2 -O raw /dev/ssd/getuid.sigsum.org

***** log
root@vm86:~# lvcreate --name getuid.sigsum.org --type raid1 --mirrors 1 --size $(stat -c %s /var/lib/libvirt/images/getuid.sigsum.org.qcow2)b ssd
  Rounding up size to full physical extent <30.01 GiB
  Logical volume "getuid.sigsum.org" created.
root@vm86:~# time qemu-img convert /var/lib/libvirt/images/getuid.sigsum.org.qcow2 -O raw /dev/ssd/getuid.sigsum.org
                                            
real    5m48.607s                           
user    0m5.768s                            
sys     1m3.615s                            
root@vm86:~# mv /var/lib/libvirt/images/getuid.sigsum.org.qcow2  /var/lib/libvirt/images/getuid.sigsum.org.qcow2.OFF
root@vm86:~# virsh edit getuid.sigsum.org
Domain getuid.sigsum.org XML configuration edited.

root@vm86:~# virsh start getuid.sigsum.org
Domain getuid.sigsum.org started

**** Rebuilding storage pool vm-ssd
virsh pool-undefine vm-ssd
virsh pool-define-as vm-ssd logical --source-name ssd
virsh pool-start vm-ssd
virsh pool-autostart vm-ssd

***** log
root@vm86:~# virsh vol-list vm-ssd
 Name                    Path
---------------------------------------------------------
 getuid.sigsum.org       /dev/ssd/getuid.sigsum.org
 listen.sigsum.org       /dev/ssd/listen.sigsum.org
 meet.sigsum.org         /dev/ssd/meet.sigsum.org
 pause.sigsum.org        /dev/ssd/pause.sigsum.org
 stat.verkligendata.se   /dev/ssd/stat.verkligendata.se

**** Shrinking and moving a volume

e2fsck -f /
resize2fs /dev/mapper/st--vg-scratch300 280G

**** Creating an md mirror out of new SSD's <2022-05-13 Fri>
Adding new SSD (PM897 1.92TB) in slot 7 (0-7), number on tray is 4.

mdadm --create /dev/md0 -l 1 -n 2 /dev/sdh missing
pvcreate /dev/md0
vgcreate ssdm /dev/md0

: shutting down mx-01 and bpf who both had LB's on spinslower

root@vm86:~# lvchange -a n mx-01-slow/postfix
root@vm86:~# lvchange -a n spinslower/mx-01.verkligendata.se-postfix
root@vm86:~# lvchange -a n bpf-vg/bpf-bup
root@vm86:~# lvchange -a n spinslower/bpf.verkligendata.se-bup0
root@vm86:~# vgdisplay spinslower
  --- Volume group ---
  VG Name               spinslower
  System ID             
  Format                lvm2
  Metadata Areas        2
  Metadata Sequence No  73
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               0
  Max PV                0
  Cur PV                2
  Act PV                2
  VG Size               <3.64 TiB
  PE Size               4.00 MiB
  Total PE              953862
  Alloc PE / Size       307204 / 1.17 TiB
  Free  PE / Size       646658 / <2.47 TiB
  VG UUID               G09MB2-vHXu-mdPk-jczj-rIdx-4Gzr-8q537D

root@vm86:~# vgmerge spinslower ssdm
  Volume group "ssdm" successfully merged into "spinslower"
root@vm86:~# pvmove /dev/sdc1 /dev/md0
: took 1-2h
root@vm86:~# vgreduce spinslower /dev/sdc1
  Removed "/dev/sdc1" from volume group "spinslower"
root@vm86:~# pvremove /dev/sdc1
  Labels on physical volume "/dev/sdc1" successfully wiped.

root@vm86:~# lvconvert --type linear spinslower/mx-01.verkligendata.se-postfix
Are you sure you want to convert raid1 LV spinslower/mx-01.verkligendata.se-postfix to type linear losing all resilience? [y/n]: y
  Logical volume spinslower/mx-01.verkligendata.se-postfix successfully converted.
root@vm86:~# lvconvert --type linear spinslower/bpf.verkligendata.se-bup0
Are you sure you want to convert raid1 LV spinslower/bpf.verkligendata.se-bup0 to type linear losing all resilience? [y/n]: y
  Logical volume spinslower/bpf.verkligendata.se-bup0 successfully converted.
root@vm86:~# vgreduce spinslower /dev/sdd1
  Removed "/dev/sdd1" from volume group "spinslower"
root@vm86:~# pvremove /dev/sdd1
  Labels on physical volume "/dev/sdd1" successfully wiped.

: demounting 2 x 5400 rpm slow spinners, mounting another 1.92TB SSD
: /dev/md0 was renamed to /dev/md127 after reboot

root@vm86:~# cat /proc/mdstat 
Personalities : [raid1] [raid6] [raid5] [raid4] 
md127 : active raid1 sdc[0]
      1875242304 blocks super 1.2 [2/1] [U_]
      bitmap: 5/14 pages [20KB], 65536KB chunk

unused devices: <none>
root@vm86:~# mdadm /dev/md127 -a /dev/sdd
mdadm: added /dev/sdd
root@vm86:~# cat /proc/mdstat 
Personalities : [raid1] [raid6] [raid5] [raid4] 
md127 : active raid1 sdd[2] sdc[0]
      1875242304 blocks super 1.2 [2/1] [U_]
      [>....................]  recovery =  0.0% (544128/1875242304) finish=114.8min speed=272064K/sec
      bitmap: 5/14 pages [20KB], 65536KB chunk

unused devices: <none>

root@vm86:~# vgrename spinslower ssdm
  Volume group "spinslower" successfully renamed to "ssdm"

**** /dev/md0 wasn't assembled after reboot <2023-04-03 Mon>
When rebooting into ospkg-vdse-hypervisor-2023-04-02T16:04+02:00 those
VM's using /dev/ssdm (bpf, mx-01 and nice) didn't start up properly
because /dev/ssdm was missing. This because lvm vg ssdm is using
/dev/md0 which is in turn using /dev/sdc and /dev/sdd. We're missing
the mdadm package and maybe that's the reason. I've added it to
debian-config/vdse/base-packages now.

***** Things we did
root@vm86:~# mdadm -Q /dev/sdc
/dev/sdc: is not an md array
/dev/sdc: device 0 in 2 device inactive raid1 array.  Use mdadm --examine for more detail.
root@vm86:~# mdadm --examine /dev/sdc
/dev/sdc:
          Magic : a92b4efc
        Version : 1.2
    Feature Map : 0x1
     Array UUID : 4d2d5f8c:0caa3045:03fd62d6:1e0a9f68
           Name : vm86:0  (local to host vm86)
  Creation Time : Fri May 13 04:57:23 2022
     Raid Level : raid1
   Raid Devices : 2

 Avail Dev Size : 3750484656 sectors (1788.37 GiB 1920.25 GB)
     Array Size : 1875242304 KiB (1788.37 GiB 1920.25 GB)
  Used Dev Size : 3750484608 sectors (1788.37 GiB 1920.25 GB)
    Data Offset : 264192 sectors
   Super Offset : 8 sectors
   Unused Space : before=264112 sectors, after=48 sectors
          State : clean
    Device UUID : 2d01b29e:fb4bd173:5469c221:49ccdbb4

Internal Bitmap : 8 sectors from superblock
    Update Time : Mon Apr  3 06:52:24 2023
  Bad Block Log : 512 entries available at offset 16 sectors
       Checksum : 5ee17776 - correct
         Events : 3793


   Device Role : Active device 0
   Array State : AA ('A' == active, '.' == missing, 'R' == replacing)
root@vm86:~# mdadm --examine /dev/sdd
/dev/sdd:
          Magic : a92b4efc
        Version : 1.2
    Feature Map : 0x1
     Array UUID : 4d2d5f8c:0caa3045:03fd62d6:1e0a9f68
           Name : vm86:0  (local to host vm86)
  Creation Time : Fri May 13 04:57:23 2022
     Raid Level : raid1
   Raid Devices : 2

 Avail Dev Size : 3750484656 sectors (1788.37 GiB 1920.25 GB)
     Array Size : 1875242304 KiB (1788.37 GiB 1920.25 GB)
  Used Dev Size : 3750484608 sectors (1788.37 GiB 1920.25 GB)
    Data Offset : 264192 sectors
   Super Offset : 8 sectors
   Unused Space : before=264112 sectors, after=48 sectors
          State : clean
    Device UUID : d2082027:33ea5cc3:68f919ad:e31df239

Internal Bitmap : 8 sectors from superblock
    Update Time : Mon Apr  3 06:52:24 2023
  Bad Block Log : 512 entries available at offset 16 sectors
       Checksum : 4748ff03 - correct
         Events : 3793


   Device Role : Active device 1
   Array State : AA ('A' == active, '.' == missing, 'R' == replacing)
root@vm86:~# mdadm --assemble --scan
mdadm: Fail to create md0 when using /sys/module/md_mod/parameters/new_array, fallback to creation via node
mdadm: /dev/md/0 has been started with 2 drives.
root@vm86:~# cat /proc/mdstat
Personalities : [raid6] [raid5] [raid4] [raid1]
md0 : active raid1 sdc[0] sdd[2]
      1875242304 blocks super 1.2 [2/2] [UU]
      bitmap: 0/14 pages [0KB], 65536KB chunk

unused devices: <none>
root@vm86:~# vgs
  VG             #PV #LV #SN Attr   VSize    VFree
  bpf-vg           1   1   0 wz--n- <279.44g       0
  cheap            1   1   0 wz--n- <280.00g       0
  mx-01-postfix    1   1   0 wz--n- <300.00g       0
  nice-nextcloud   1   1   0 wz--n- <256.00g       0
  spinfaster       3   4   0 wz--n-   <4.52t   <1.61t
  ssd              2   2   0 wz--n- <456.45g <416.43g
  ssdm             1   3   0 wz--n-   <1.75t <932.37g

*** buildling and deploying ST image
**** old style, based on a fall of 2020 version of repo system-transparency
Branch vdse/hypervisor of system-transparency based on commit 1f89c0c,
merged into vdse/hypervisor on 2020-10-17.

ssh linus@nanosleep.adb-centralen.se
cd usr/src/st/system-transparency
git checkout vdse/hypervisor
vi operating-system/debian/docker/debos.yaml
: update debian, see https://snapshot.debian.org/archive/debian/
git add operating-system/debian/docker/debos.yaml
git commit -m "debian -> $newdebianversion"
operating-system/debian/make_debian.sh
scripts/create_and_sign_bootball.sh
for f in bootballs/ball-2021*.stboot; do sha256sum $f; done

root@vm86:~# cat >> /root/.ssh/authorized_keys << EOF
> ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPyghUNRvRxE/F8azzt6zXeajNRwHbVJYFASuOfyWxkI linus@nanosleep
> EOF
root@vm86:~# ./remount-stdata.sh 

linus@nanosleep:~/usr/src/st/system-transparency$ scp -o 'identityfile ~/.ssh/vm86' bootballs/$FNAME.stboot root@vm86.verkligendata.se:/stdata/stboot/bootballs/new/

root@vm86:~# sha256sum /stdata/stboot/bootballs/new/ball-2021-08-17-10-44-41.stboot 
root@vm86:~# reboot

: console on sigwaitinfo:/dev/ttyUSB1

**** st-os-pkg style, fall -21
cd system-transparency  # b26c18a7bdbcaa2df9388ef40b517a13f03174b6
. .envrc
st-os-pkg/build-os-pkg.sh vdse-hv-buster-$(date -Im) keys/signing_keys/signing-key-1

**** mix style, using st-utils for the os package and st-os-pkg for ST
cd ~/usr/src/st-utils
lib/build-os-pkg-debian -w work -o $PWD/out -r buster
cp work/rootfs/vmlinuz ~/usr/src/system-transparency/out/operating-system/debian-buster-amd64.vmlinuz
cp out/debian-buster.cpio.gz ~/usr/src/system-transparency/out/operating-system/debian-buster-amd64.cpio.gz 

cd ~/usr/src/system-transparency  # b26c18a7bdbcaa2df9388ef40b517a13f03174b6
. .envrc
st-os-pkg/build-os-pkg.sh vdse-hv-buster-$(date -Im) keys/signing_keys/signing-key-1

for f in vdse-hv-buster-2022-03-17T10*.{zip,json} boot_order; do sha256sum $f; scp ./$f vm86.verkligendata.se:/stdata/stboot/os_pkgs/local/; done

*** network setup for VM's
We start out with using an ordinary libvirt "virtual network" (as
described in [1]) and just do "Forward Incomming Connections" for sshd
on port 4722 [2]. The guest (bpf) runs a DHCP client and dnsmasqd on
the host (vm86) provides an address from 192.168.122.0/24. This is
fine until we need to use the same port in more than one VM.

The next step is to use the "shared physical device" method [3]
together with [4] and [5] to set up the bridge.

They can be mixed and matched too, so that "simple VM's" with zero or
a few and simple services can be NAT:ed with a port or two being
forwarded to the VM while others can have their own address through
the bridge interface.

A note on what can happen when fiddling with restarting VM's and
poking around in the qemu hooks file (/etc/libvirt/hooks/qemu):
Something is adding REJECT rules for virbr0, which if they appear
_before_ rules added by the hook earlier might make those rules become
null and void. 
Here's an example of a bad situation for 45.141.110.194:4722 -> 192.168.122.45:22:

root@vm86:~# iptables -vv -n -t nat -L PREROUTING; iptables -vv -n -L FORWARD
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
 1676  100K DNAT       tcp  --  *      *       0.0.0.0/0            45.141.110.194       tcp dpt:4722 to:192.168.122.45:22
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
  12M   40G ACCEPT     all  --  *      virbr0  0.0.0.0/0            192.168.122.0/24     ctstate RELATED,ESTABLISHED
5310K 1874M ACCEPT     all  --  virbr0 *       192.168.122.0/24     0.0.0.0/0
    0     0 ACCEPT     all  --  virbr0 virbr0  0.0.0.0/0            0.0.0.0/0
 1045 62596 REJECT     all  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
    0     0 REJECT     all  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
16398 3227K ACCEPT     tcp  --  *      virbr0  0.0.0.0/0            192.168.122.45       tcp dpt:22
    0     0 REJECT     all  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable

[1] https://wiki.libvirt.org/page/Networking
[2] https://wiki.libvirt.org/page/Networking#Forwarding_Incoming_Connections
[3] https://wiki.libvirt.org/page/Networking#Bridged_networking_.28aka_.22shared_physical_device.22.29
[4] https://wiki.debian.org/BridgeNetworkConnections
[5] https://jamielinux.com/docs/libvirt-networking-handbook/bridged-network.html

**** virtual network setup
cat /etc/libvirt/hooks/qemu

#! /bin/sh
set -eu

setup() {
    local state="$1"; shift
    local proto="$1"; shift

    local HOST_IP="$1"
    local GUEST_IP="$2"
    local HOST_PORT="$3"
    local GUEST_PORT="${4:-$3}"

    if [ "$state" = "stopped" ] || [ "$state" = "reconnect" ]; then
        /sbin/iptables -D FORWARD -o virbr0 -p $proto -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /sbin/iptables -t nat -D PREROUTING -p $proto -d $HOST_IP  --dport $HOST_PORT  -j DNAT --to $GUEST_IP:$GUEST_PORT
    fi
    if [ "$state" = "start" ] || [ "$state" = "reconnect" ]; then
        /sbin/iptables -I FORWARD -o virbr0 -p $proto -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /sbin/iptables -t nat -I PREROUTING -p $proto -d $HOST_IP  --dport $HOST_PORT  -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
}

**** shared physical ethernet device
On the host system (vm86) we create a bridge by adding a bridge stanza
to /etc/network/interfaces. Then we configure the guests.

: once: enslave eno0 into br0
apt install bridge-utils # for brctl

: for systemd-networkd
See [[*KVM][KVM]]

: for ifup/ifdown
root@vm86:~# cat /stdata/etc/network/interfaces.d/br0 
auto br0

iface br0 inet static
    address 45.141.109.3/28
    gateway 45.141.109.1
    bridge_ports eno0
    bridge_stp off
    bridge_waitport 0
    bridge_fd 0
    
iface br0 inet6 static
    address 2a07:5cc0:1:1::3/64
    gateway 2a07:5cc0:1:1::1
    autoconf 0

: TODO: maybe this? or is this a Fedora thing?
: once: disable netfilter for bridges
cat > /etc/sysctl.d/bridge.conf <<EOF
net.bridge.bridge-nf-call-ip6tables=0
net.bridge.bridge-nf-call-iptables=0
net.bridge.bridge-nf-call-arptables=0
EOF
cat > /etc/udev/rules.d/99-bridge.rules <<EOF
ACTION=="add", SUBSYSTEM=="module", KERNEL=="br_netfilter", RUN+="/sbin/sysctl -p /etc/sysctl.d/bridge.conf"
EOF

: when creating a VM, set 
- Add vnetN to the bridge_ports list for br0

brctl show should now show that br0 bridging eno0 with a number of
vnetN interfaces.

*** creating a VM, manual style
<see st.org>

*** system boot
**** no vm's running, virsh list hanging
Tried first with
systemctl restart dm-event

The following commands are still hanging:
- virsh list
- systemctl restart libvirt-guests
- systemctl restart libvirtd

Found this:
 1220 ?        Ss     0:00 /bin/sh /usr/lib/libvirt/libvirt-guests.sh stop

Killed it:
root@vm86:~# kill 1220
root@vm86:~# [  487.334280] libvirt-guests.sh[1288]: libvirt-guests is configured not to start any guests on boot
[  488.838709] virbr0: port 2(vnet1) entered blocking state
[  488.844034] virbr0: port 2(vnet1) entered disabled state
[  488.849399] device vnet1 entered promiscuous mode
[  488.854208] virbr0: port 2(vnet1) entered blocking state
[  488.859524] virbr0: port 2(vnet1) entered listening state
[  490.874626] virbr0: port 2(vnet1) entered learning state
[  492.890843] virbr0: port 2(vnet1) entered forwarding state
[  492.896343] virbr0: topology change detected, propagating

We can now restart libvirtd:
systemctl restart libvirtd

But this is still hanging:
virsh list

Restarting virtlogd made no difference.

Restarting libvirtd again resolved the issue with hanging 'virsh list', grr!

All vm's came up in state paused though, and after a short wihle,
everyone except munmap had transitioned to shut off.

**** no network
/etc/network/... not populated
do:
cp fixme
ifup eno0 
ifup br0

**** only some vm's running
for f in /etc/libvirt/qemu/autostart/*.xml; do vm=$(basename $f .xml); virsh start $vm; done

*** VM's running on vm86
*** machine id
What about setting machine id at boot, from kernel command line?
systemd.machine_id=
Yes, this would require a unique bootball per host.

*** vm's misbehaving after vm86 boot 
Two vm's didn't shut down properly witin the 120s time limit at reboot.
Then at least two vm's didn't start properly at boot.

- getuid.sigsum.org replied to ping but not ssh, and but after virsh destroy and start
  it _kinda_ worked, but super super slowly, and eventually stuff started working as normal.
  no response from console.
- bpf.verkligendata.se did respond to ping (it's vm86 responding) but no sshd and no console, until
  virsh destroy + start.

libvirtd reports two errors at startup:  

Sep 06 11:54:58 vm86 libvirtd[724]: libvirt version: 5.0.0, package: 4+deb10u1 (Guido Günther <agx@sigxcpu.org> Thu, 05 Dec 2019 00:22:14 +0100)
Sep 06 11:54:58 vm86 libvirtd[724]: hostname: vm86
Sep 06 11:54:58 vm86 libvirtd[724]: End of file while reading data: Input/output error
Sep 06 12:13:10 vm86 dnsmasq-dhcp[847]: DHCPREQUEST(virbr0) 192.168.122.45 52:54:00:cf:a3:7f
Sep 06 12:13:10 vm86 dnsmasq-dhcp[847]: DHCPACK(virbr0) 192.168.122.45 52:54:00:cf:a3:7f bpf
Sep 06 12:16:44 vm86 dnsmasq-dhcp[847]: DHCPREQUEST(virbr0) 192.168.122.234 52:54:00:36:ba:f8
Sep 06 12:16:44 vm86 dnsmasq-dhcp[847]: DHCPACK(virbr0) 192.168.122.234 52:54:00:36:ba:f8 btc
Sep 06 12:23:21 vm86 libvirtd[724]: internal error: End of file from qemu monitor

*** IP filtering
Try this:

nft create table inet tempblock
nft add chain inet tempblock tempinput "{ type filter hook input priority 0; policy accept; }"
nft add rule inet tempblock tempinput "iifname eno0 tcp dport {5355, 67} log prefix "tempinput DROP: " level info drop"

*** l1tf and IOMMU
<2021-09-07 Tue> Adding l1tf=full,force and intel_iommu=on
ST_BOOTBALL_OS_CMDLINE="console=tty0 console=ttyS0,115200n8 rw rdinit=/lib/systemd/systemd l1tf=full,force intel_iommu=on"

The l1tf setting removed 4 out of 8 vCPU's.
L1 Terminal Fault https://access.redhat.com/security/vulnerabilities/L1TF-perf

The IOMMU made this warning go away:
# virt-host-validate
...
  QEMU: Checking if IOMMU is enabled by kernel                               : WARN (IOMMU appears to be disa

*** Manually blocking some crucial network ports

for rs in ip ip6; do
nft add rule $rs filter INPUT "iifname br0 tcp dport 25 counter reject";
nft add rule $rs filter INPUT "iifname br0 tcp dport 53 counter reject";
nft add rule $rs filter INPUT "iifname br0 udp dport 53 counter reject";
nft add rule $rs filter INPUT "iifname br0 tcp dport 5355 counter reject";
nft add rule $rs filter INPUT "iifname br0 udp dport 5355 counter reject";
done

** bpf.verkligendata.se (2020-10-31) -- VM @ vm86.vdse from <2020-10-31 Sat>
For backups, replacing jail bpf @ brk <2020-10-31 Sat>.

*** log
- <2022-04-26 Tue> block device emulation scsi -> virtio
- <2022-04-26 Tue> 10:13 vcpu's 4 -> 2
- <2022-04-26 Tue> measured borg check on clown.adbc, over 30m;
  disabled borg check in adbc/ansible => backups barely noticed on
  server
*** network setup
virsh shutdown bpf.verkligendata.se
cat >> /etc/libvirt/hooks/qemu <<EOF

if [ "\${1}" = "bpf.verkligendata.se" ]; then
  setup "$2" tcp 45.141.109.3 192.168.122.45 4722 22
fi
EOF
systemctl restart libvirtd

*** initial setup of storage and borgbackup
adduser bup

pvcreate /dev/sdb
vgcreate bpf-vg /dev/sdb
lvcreate --name bpf-bup --extents 100%VG bpf-vg
mkfs.ext4 /dev/bpf-vg/bpf-bup
mkdir /var/lib/my_bup; chmod 700 /var/lib/my_bup; chown bup:bup /var/lib/my_bup
echo /dev/bpf-vg/bpf-bup /var/lib/my_bup ext4 rw,noexec,nosuid,nodev >> /etc/fstab
mount -a

su - bup
ssh-keygen -t ed25519 -f ~/.ssh/tmpbup
cat > ~.ssh/config <<EOF
Host curbpf
        port 4722
        user _bup
        identityfile ~/.ssh/tmpbup
        hostname 185.97.32.65 
EOF
time rsync -av curbpf:/var/db/my_bup/* /var/lib/my_bup/ # started at 23:25 (sat oct 31 2020)

apt install borgbackup
cat > ~bup/.ssh/authorized_keys <<EOF
command="borg serve --restrict-to-path /var/lib/my_bup",no-pty,no-agent-forwarding,no-port-forwarding,no-X11-forwarding,no-user-rc ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ9mlCdnc/Dk+32kvrqytS9jeVrqr3O0JiXnDjILIVDC bup
command="borg serve --restrict-to-path /var/lib/my_bup",no-pty,no-agent-forwarding,no-port-forwarding,no-X11-forwarding,no-user-rc ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDKEByWU73uSCF154W4ui0b3JdWc8DfaP32zBbYsC8gw flow.ndn
EOF

**** more info on storage
root@bpf:~# lvdisplay 
  --- Logical volume ---
  LV Path                /dev/bpf-vg/bpf-bup
  LV Name                bpf-bup
  VG Name                bpf-vg
  LV UUID                Oa4PHX-eJxw-xeGz-voQC-ocWZ-42u3-VeE1ve
  LV Write Access        read/write
  LV Creation host, time bpf, 2020-10-31 23:07:35 +0100
  LV Status              available
  # open                 0
  LV Size                <279.44 GiB
  Current LE             71536
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           254:0

root@bpf:~# df -h /var/lib/my_bup/
Filesystem                    Size  Used Avail Use% Mounted on
/dev/mapper/bpf--vg-bpf--bup  275G   65M  261G   1% /var/lib/my_bup

bup@bpf:~$ time rsync -av curbpf:/var/db/my_bup/* /var/lib/my_bup/
sent 442,374 bytes  received 60,714,910,931 bytes  6,112,796.71 bytes/sec
total size is 60,698,681,223  speedup is 1.00

real    165m32.206s
user    4m35.407s
sys     6m39.046s
bup@bpf:~$ df -h /var/lib/my_bup/
Filesystem                    Size  Used Avail Use% Mounted on
/dev/mapper/bpf--vg-bpf--bup  275G   57G  204G  22% /var/lib/my_bup

root@7c8567255c48:~# vgdisplay st-vg
  --- Volume group ---
  VG Name               st-vg
  System ID             
  Format                lvm2
  Metadata Areas        4
  Metadata Sequence No  33
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               0
  Max PV                0
  Cur PV                4
  Act PV                2
  VG Size               <7.28 TiB
  PE Size               4.00 MiB
  Total PE              1907340
  Alloc PE / Size       1058818 / <4.04 TiB
  Free  PE / Size       848522 / <3.24 TiB
  VG UUID               G09MB2-vHXu-mdPk-jczj-rIdx-4Gzr-8q537D

root@7c8567255c48:~# vgchange -aay st-vg
  Refusing activation of partial LV st-vg/vm-images.  Use '--activationmode partial' to override.
  1 logical volume(s) in volume group "st-vg" now active

root@7c8567255c48:~# vgextend --restoremissing st-vg /dev/sdd1
  Volume group "st-vg" successfully extended

root@7c8567255c48:~# vgchange -aay st-vg
[ 1457.691085] raid6: sse2x1   gen() 15306 MB/s
[ 1457.763072] raid6: sse2x1   xor() 10730 MB/s
[ 1457.831103] raid6: sse2x2   gen() 18267 MB/s
[ 1457.903102] raid6: sse2x2   xor() 12490 MB/s
[ 1457.975102] raid6: sse2x4   gen() 20761 MB/s
[ 1458.047084] raid6: sse2x4   xor() 13123 MB/s
[ 1458.119090] raid6: avx2x1   gen() 29773 MB/s
[ 1458.191090] raid6: avx2x1   xor() 20634 MB/s
[ 1458.263089] raid6: avx2x2   gen() 36205 MB/s
[ 1458.335083] raid6: avx2x2   xor() 23038 MB/s
[ 1458.407090] raid6: avx2x4   gen() 39225 MB/s
[ 1458.479090] raid6: avx2x4   xor() 23671 MB/s
[ 1458.483735] raid6: using algorithm avx2x4 gen() 39225 MB/s
[ 1458.489599] raid6: .... xor() 23671 MB/s, rmw enabled
[ 1458.495020] raid6: using avx2x2 recovery algorithm
[ 1458.500707] async_tx: api initialized (async)
[ 1458.506083] xor: automatically using best checksumming function   avx       
[ 1458.525086] device-mapper: raid: Loading target version 1.14.0
[ 1458.537160] md/raid1:mdX: active with 1 out of 2 mirrors
[ 1458.907083] md: recovery of RAID array mdX
  2 logical volume(s) in volume group "st-vg" now active

root@7c8567255c48:~# lvs
  LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  st-config st-vg Mwi-a-m--- 20.00g                                    100.00          
  vm-images st-vg rwi-a-r-p-  2.00t                                    6.45            

: After reboot, we're back though:

root@7c8567255c48:~# lvs
[  105.838013] device-mapper: uevent: version 1.0.3
[  105.843274] device-mapper: ioctl: 4.39.0-ioctl (2018-04-03) initialised: dm-devel@redhat.com
  LV        VG    Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  st-config st-vg Mwi---m--- 20.00g                                                    
  vm-images st-vg rwi---r-p-  2.00t                                                    
root@7c8567255c48:~# vgs
  VG    #PV #LV #SN Attr   VSize  VFree 
  st-vg   4   2   0 wz-pn- <7.28t <3.24t
root@7c8567255c48:~# pvs
  PV         VG    Fmt  Attr PSize  PFree   
  /dev/sda2  st-vg lvm2 a--  <1.82t <300.00g
  /dev/sdb2  st-vg lvm2 a--  <1.82t   <1.62t
  /dev/sdc1  st-vg lvm2 a-m  <1.82t   <1.33t
  /dev/sdd1  st-vg lvm2 a--  <1.82t       0 

*** The lost LV <2022-03-16 Wed>

unavailable since approx 2022-03-10
First complaint from clown: Date: Thu, 10 Mar 2022 06:35:36 +0100 (CET) (6 days, 3 hours ago)
Logs on vm86 don't have much to say about the first 8h of Mar 10.

root@bpf:~# ls -lrt /etc/lvm/backup/bpf-vg 
-rw------- 1 root root 889 Jan 10 12:17 /etc/lvm/backup/bpf-vg

I think that this indicates a reboot on Jan 10. It contains no logical_volumes.

root@bpf:~# ls -lrt /etc/lvm/archive/
total 32
-rw------- 1 root root  857 Oct 31  2020 brk-vg_00000-753216741.vg
-rw------- 1 root root  880 Oct 31  2020 brk-vg_00001-1468739619.vg
-rw------- 1 root root 1278 Oct 31  2020 brk-vg_00002-1209625945.vg
-rw------- 1 root root  848 Oct 31  2020 brk-vg_00003-1190618936.vg
-rw------- 1 root root  857 Oct 31  2020 bpf-vg_00000-1841759841.vg
-rw------- 1 root root  880 Oct 31  2020 bpf-vg_00001-444666137.vg
-rw------- 1 root root  890 Jan 10 12:17 bpf-vg_00003-874819051.vg
-rw------- 1 root root 1312 Jan 10 12:17 bpf-vg_00002-1898327120.vg

root@bpf:~# cat /etc/lvm/archive/bpf-vg_00002-1898327120.vg
# Generated by LVM2 version 2.03.02(2) (2018-12-18): Mon Jan 10 12:17:06 2022

contents = "Text Format Volume Group"
version = 1

description = "Created *before* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'"

creation_host = "bpf"   # Linux bpf 4.19.0-16-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64
creation_time = 1641813426      # Mon Jan 10 12:17:06 2022

bpf-vg {
        id = "Dr2gmS-yQLz-DlBn-DBR7-u8le-Rm3A-eC0tQO"
        seqno = 2
        format = "lvm2"                 # informational
        status = ["RESIZEABLE", "READ", "WRITE"]
        flags = []
        extent_size = 8192              # 4 Megabytes
        max_lv = 0
        max_pv = 0
        metadata_copies = 0

        physical_volumes {

                pv0 {
                        id = "5yllbe-sW0w-DYdB-d2W0-YqG8-vifu-fL67rq"
                        device = "/dev/sdb"     # Hint only

                        status = ["ALLOCATABLE"]
                        flags = []
                        dev_size = 586027392    # 279.44 Gigabytes
                        pe_start = 2048
                        pe_count = 71536        # 279.438 Gigabytes
                }
        }

        logical_volumes {

                bpf-bup {
                        id = "Oa4PHX-eJxw-xeGz-voQC-ocWZ-42u3-VeE1ve"
                        status = ["READ", "WRITE", "VISIBLE"]
                        flags = []
                        creation_time = 1604182055      # 2020-10-31 23:07:35 +0100
                        creation_host = "bpf"
                        segment_count = 1

                        segment1 {
                                start_extent = 0
                                extent_count = 71536    # 279.438 Gigabytes

                                type = "striped"
                                stripe_count = 1        # linear

                                stripes = [
                                        "pv0", 0
                                ]
                        }
                }
        }

}

root@bpf:~# diff -u /etc/lvm/archive/bpf-vg_00003-874819051.vg /etc/lvm/archive/bpf-vg_00002-1898327120.vg 
--- /etc/lvm/archive/bpf-vg_00003-874819051.vg  2022-01-10 12:17:06.180932854 +0100
+++ /etc/lvm/archive/bpf-vg_00002-1898327120.vg 2022-01-10 12:17:06.180932854 +0100
@@ -10,7 +10,7 @@
 
 bpf-vg {
        id = "Dr2gmS-yQLz-DlBn-DBR7-u8le-Rm3A-eC0tQO"
-       seqno = 3
+       seqno = 2
        format = "lvm2"                 # informational
        status = ["RESIZEABLE", "READ", "WRITE"]
        flags = []
@@ -33,5 +33,28 @@
                }
        }
 
+       logical_volumes {
+
+               bpf-bup {
+                       id = "Oa4PHX-eJxw-xeGz-voQC-ocWZ-42u3-VeE1ve"
+                       status = ["READ", "WRITE", "VISIBLE"]
+                       flags = []
+                       creation_time = 1604182055      # 2020-10-31 23:07:35 +0100
+                       creation_host = "bpf"
+                       segment_count = 1
+
+                       segment1 {
+                               start_extent = 0
+                               extent_count = 71536    # 279.438 Gigabytes
+
+                               type = "striped"
+                               stripe_count = 1        # linear
+
+                               stripes = [
+                                       "pv0", 0
+                               ]
+                       }
+               }
+       }
 
 }

root@bpf:/etc/lvm# diff -u archive/bpf-vg_00002-1898327120.vg backup/bpf-vg 
--- archive/bpf-vg_00002-1898327120.vg  2022-01-10 12:17:06.180932854 +0100
+++ backup/bpf-vg       2022-01-10 12:17:06.300931634 +0100
@@ -3,14 +3,14 @@
 contents = "Text Format Volume Group"
 version = 1
 
-description = "Created *before* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'"
+description = "Created *after* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'"
 
 creation_host = "bpf"  # Linux bpf 4.19.0-16-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64
 creation_time = 1641813426     # Mon Jan 10 12:17:06 2022
 
 bpf-vg {
        id = "Dr2gmS-yQLz-DlBn-DBR7-u8le-Rm3A-eC0tQO"
-       seqno = 2
+       seqno = 3
        format = "lvm2"                 # informational
        status = ["RESIZEABLE", "READ", "WRITE"]
        flags = []
@@ -33,28 +33,5 @@
                }
        }
 
-       logical_volumes {
-
-               bpf-bup {
-                       id = "Oa4PHX-eJxw-xeGz-voQC-ocWZ-42u3-VeE1ve"
-                       status = ["READ", "WRITE", "VISIBLE"]
-                       flags = []
-                       creation_time = 1604182055      # 2020-10-31 23:07:35 +0100
-                       creation_host = "bpf"
-                       segment_count = 1
-
-                       segment1 {
-                               start_extent = 0
-                               extent_count = 71536    # 279.438 Gigabytes
-
-                               type = "striped"
-                               stripe_count = 1        # linear
-
-                               stripes = [
-                                       "pv0", 0
-                               ]
-                       }
-               }
-       }
 
 }

root@bpf:/etc/lvm# diff -u archive/bpf-vg_00003-874819051.vg backup/bpf-vg 
--- archive/bpf-vg_00003-874819051.vg   2022-01-10 12:17:06.180932854 +0100
+++ backup/bpf-vg       2022-01-10 12:17:06.300931634 +0100
@@ -3,7 +3,7 @@
 contents = "Text Format Volume Group"
 version = 1
 
-description = "Created *before* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'"
+description = "Created *after* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'"
 
 creation_host = "bpf"  # Linux bpf 4.19.0-16-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64
 creation_time = 1641813426     # Mon Jan 10 12:17:06 2022

root@bpf:/etc/lvm# vgcfgrestore --list bpf-vg
   
  File:         /etc/lvm/archive/bpf-vg_00000-1841759841.vg
  Couldn't find device with uuid 5yllbe-sW0w-DYdB-d2W0-YqG8-vifu-fL67rq.
  VG name:      bpf-vg
  Description:  Created *before* executing 'vgcreate bpf-vg /dev/sdb'
  Backup Time:  Sat Oct 31 23:07:32 2020

   
  File:         /etc/lvm/archive/bpf-vg_00001-444666137.vg
  VG name:      bpf-vg
  Description:  Created *before* executing 'lvcreate --name bpf-bup --extents 100%VG bpf-vg'
  Backup Time:  Sat Oct 31 23:07:35 2020

   
  File:         /etc/lvm/archive/bpf-vg_00002-1898327120.vg
  VG name:      bpf-vg
  Description:  Created *before* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'
  Backup Time:  Mon Jan 10 12:17:06 2022

   
  File:         /etc/lvm/archive/bpf-vg_00003-874819051.vg
  VG name:      bpf-vg
  Description:  Created *before* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'
  Backup Time:  Mon Jan 10 12:17:06 2022

   
  File:         /etc/lvm/backup/bpf-vg
  VG name:      bpf-vg
  Description:  Created *after* executing '/sbin/vgs --noheadings --nosuffix --units g --separator ,'
  Backup Time:  Mon Jan 10 12:17:06 2022


root@bpf:/etc/lvm# vgcfgrestore --file /etc/lvm/archive/bpf-vg_00002-1898327120.vg bpf-vg
[ 2709.139852] device-mapper: uevent: version 1.0.3
[ 2709.141845] device-mapper: ioctl: 4.39.0-ioctl (2018-04-03) initialised: dm-devel@redhat.com
  Restored volume group bpf-vg.

root@bpf:/etc/lvm# lvs
  LV      VG     Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  bpf-bup bpf-vg -wi------- <279.44g 
root@bpf:/etc/lvm# vgchange -ay
  1 logical volume(s) in volume group "bpf-vg" now active
root@bpf:/etc/lvm# mount -a
[ 2755.446733] EXT4-fs (dm-0): mounted filesystem with ordered data mode. Opts: (null)
root@bpf:/etc/lvm# ls /var/db/my_bup
bdflush.adb-centralen.se  kcmp.adb-centralen.se     murmur.adb-centralen.se
bounce.adb-centralen.se   llseek.adb-centralen.se   ns.adb-centralen.se
clown.adb-centralen.se    lost+found                pipe.adb-centralen.se
dup.adb-centralen.se      mincore.adb-centralen.se  resolver1.adb-centralen.se
getgid.adb-centralen.se   mount2.adb-centralen.se   tee.adb-centralen.se
root@bpf:/etc/lvm# du -sh /var/db/my_bup/
138G    /var/db/my_bup/

** membarrier.verkligendata.se (2020-11-15) -- VM @ vm86 running Jitsi
- https://jitsi.github.io/handbook/docs/devops-guide/devops-guide-quickstart

*** disk error <2021-10-01 Fri>
[1576010.860427] ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
[1576010.860522] ata1.00: failed command: FLUSH CACHE
[1576010.860600] ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
                          res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
[1576010.860694] ata1.00: status: { DRDY }
[1576015.904441] ata1: link is slow to respond, please be patient (ready=0)
[1576020.888504] ata1: device not ready (errno=-16), forcing hardreset
[1576020.888524] ata1: soft resetting link
[1576021.049469] ata1.00: configured for MWDMA2
[1576021.049471] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[1576036.176657] ata1.00: qc timeout (cmd 0xe7)
[1576036.176659] ata1.00: FLUSH failed Emask 0x4
[1576041.216662] ata1: link is slow to respond, please be patient (ready=0)
[1576046.196683] ata1: device not ready (errno=-16), forcing hardreset
[1576046.196704] ata1: soft resetting link
[1576046.357640] ata1.00: configured for MWDMA2
[1576046.357641] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[1576061.108734] ata1: EH complete

** munmap.verkligendata.se (2020-11-29) -- MUD for scoutlokalen.se
vm86# virt-install --name munmap.verkligendata.se --memory 1024 --vcpus 2 --disk size=30 --graphics none --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ --extra-args console=ttyS0,115200 --virt-type kvm --autostart

munmap# cat > /etc/network/interfaces.d/ens2 <<EOF
allow-hotplug ens2
iface ens2 inet static
        address 45.141.110.197/28
        gateway 45.141.110.193

iface ens2 inet6 static
        address 2a07:5cc0:1:1::197/64
        gateway 2a07:5cc0:1:1::1
EOF
munmap# systemctl restart ifup@ens2

datan$ ./addhost -l munmap.verkligendata.se

*** install evennia
apt install -y python3-venv python3-setuptools python3-dev gettext
adduser --disabled-password evennia
su - evennia
mkdir skogsmannen
cd skogsmannen
git clone -b v0.9.5 https://github.com/evennia/evennia.git
python3.7 -m venv smenv
. smenv/bin/activate
pip install -e evennia
evennia --init skogsmannen
(cd evennia/evennia && django-admin compilemessages)
cd skogsmannen
vi server/conf/settings.py
evennia migrate
evennia start

# FIXME: can't get this to work; use crontab @reboot?
cat | systemctl --user --fixme <<EOF
[Unit]
Description=Skogsmannen MUD
After=network.target

[Service]
Type=simple
ExecStart= $HOME/skogsmannen/smenv/bin/evennia --gamedir $HOME/skogsmannen/skogsmannen start

** stat.verkligendata.se (2021-03-17) -- VM @ vm86 for stlog-poc
*** VM setup
virt-install --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --name stat.verkligendata.se --memory 2048 --vcpus 4 --disk size=10

virsh vol-create-as default stat-db.qcow2 30GB --format qcow2 --prealloc-metadata
virsh attach-disk stat.verkligendata.se /var/lib/libvirt/images/stat-db.qcow2 sdb --live --config

# NOTE: we should maybe have created a new storage pool, virsh pool-create, but doesn't that need its own lvm volume group?
#   lvcreate --name stat-db --size 30G --type mirror --mirrors 1 --mirrorlog core --nosync st-vg
#   virsh pool-create-as stat-db-pool logical --source-name /dev/st-vg/stat-db
#   -> error: unsupported configuration: cannot find logical volume group name '/dev/st-vg/stat-db'

*** storage setup in VM
pvcreate /dev/sdb
vgcreate stat-db-vg /dev/sdb
lvcreate --name db -l 100%FREE stat-db-vg
mkfs.ext4 /dev/mapper/stat--db--vg-db
mkdir /var/db
printf "UUID=%s\t/var/db\text4\tdefaults\t0\t2\n" $(lsblk -no UUID /dev/mapper/stat--db--vg-db) >> /etc/fstab
mount /var/db

root@stat:~# df -h /var/db
Filesystem                   Size  Used Avail Use% Mounted on
/dev/mapper/stat--db--vg-db   28G   45M   26G   1% /var/db

*** trillian + stfe
NOTE: Add buster-backports, for golang-1.14
apt install -t buster-backports golang
apt install mariadb-server

*** disk error <2021-10-01 Fri>
[1576031.264394] ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
[1576031.264487] ata1.00: failed command: FLUSH CACHE
[1576031.264563] ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
                          res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
[1576031.264638] ata1.00: status: { DRDY }
[1576036.304362] ata1: link is slow to respond, please be patient (ready=0)
[1576041.284517] ata1: device not ready (errno=-16), forcing hardreset
[1576041.284537] ata1: soft resetting link
[1576041.445385] ata1.00: configured for MWDMA2
[1576041.445387] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[1576056.580611] ata1.00: qc timeout (cmd 0xe7)
[1576056.580613] ata1.00: FLUSH failed Emask 0x4
[1576061.020637] ata1: soft resetting link
[1576061.180977] ata1.01: NODEV after polling detection
[1576061.181661] ata1.00: configured for MWDMA2
[1576061.181662] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[1576061.181866] ata1: EH complete

*** mariadb replication <2022-05-12 Thu>
We make stat a primary, for testing.

$EDITOR /etc/mysql/mariadb.conf.d/50-server.cnf
- bind_adress
  - * seems to result in IPv6 only, such irritating 
  - 0.0.0.0 works for IPv4 only

cat > /etc/mysql/mariadb.conf.d/60-replication.cnf <<EOF
[mariadb]
server-id = 1
log_bin = /var/lib/mysql/mariadb-bin
binlog_format = mixed
expire_logs_days = 0
EOF

root@stat:/etc/mysql# cat /var/lib/mysql/mariadb-bin.index 
/var/lib/mysql/mariadb-bin.000001
root@stat:/etc/mysql# file /var/lib/mysql/mariadb-bin.000001 
/var/lib/mysql/mariadb-bin.000001: MySQL replication log, server id 1 MySQL V5+, server version 10.5.12-MariaDB-0+deb11u1-log

> create user 'replication_user'@'%' identified by '**REDACTED**';
> grant replication slave on *.* to 'replication_user'@'%';

**** Setting up a replica, on besk
set server_id = 4711 and restart mariadb

on primary (stat.vdse): 

    export MY_MARIADB_BACKUP_FILE=/var/backups/mariadb/test.$(date +%s)
    mkdir -pm 700 $(dirname $MY_MARIADB_BACKUP_FILE)
    time mariadb-dump --databases test --add-drop-database --master-data > $MY_MARIADB_BACKUP_FILE

  real    0m0.682s
  root@stat:/etc/mysql# ls -lh $MY_MARIADB_BACKUP_FILE 
  -rw-r--r-- 1 root root 55M May 12 14:57 /var/backups/mariadb/test.1652360220

  # This is a manual version of the sequence of commands above
  FLUSH TABLES WITH READ LOCK;
  SHOW MASTER STATUS;
  \! mariadb-dump --databases test > fixme
  UNLOCK TABLES

  # This requires the mariabackup program, available from MariaDB repos.
  \! time mariabackup --backup --target-dir=/var/backups/mariadb/$(date +%s)

time mariadb test < $MY_MARIADB_BACKUP_FILE
real    0m5.585s

CHANGE MASTER TO
  MASTER_HOST='stat.verkligendata.se',
  MASTER_USER='replication_user',
  MASTER_PASSWORD='**REDACTED**',
  MASTER_PORT=3306,
  MASTER_CONNECT_RETRY=10;
START SLAVE;

** getuid.sigsum.org @ vm86 for cgit
*** VM setup
virt-install --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --name getuid.sigsum.org --memory 1024 --vcpus 1 --disk size=30

** pause.sigsum.org (2021-08-23) -- VM @ vm86 for etherpads
virt-install --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --name pause.sigsum.org --memory 1024 --vcpus 1 --disk size=30

*** log
- <2022-04-26 Tue> block device emulation scsi -> virtio

*** disk crash <2021-10-01 Fri>
Message from syslogd@pause at Oct  1 12:16:21 ...
 kernel:[592334.869759] EXT4-fs (dm-0): failed to convert unwritten extents to written extents -- potential data loss!  (inode 1185188, error -30)
mount|egrep ^C
root@pause:~# ls -l /dev/dm-0
brw-rw---- 1 root disk 254, 0 Sep 24 15:44 /dev/dm-0
root@pause:~# mount|egrep dm-0
root@pause:~# pvs
  Error reading device /dev/sda1 at 0 length 4096.
  Error reading device /dev/sda5 at 0 length 4096.
root@pause:~# vgs
root@pause:~# lvs
root@pause:~# dmesg | less
-bash: /usr/bin/dmesg: Input/output error

**** journal
Oct 01 12:14:39 pause kernel: ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
Oct 01 12:16:21 pause kernel: ata1.00: failed command: FLUSH CACHE
Oct 01 12:16:21 pause kernel: ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
				       res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
Oct 01 12:16:21 pause kernel: ata1.00: status: { DRDY }
Oct 01 12:16:21 pause kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:16:21 pause kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:16:21 pause kernel: ata1: soft resetting link
Oct 01 12:16:21 pause kernel: ata1.00: configured for MWDMA2
Oct 01 12:16:21 pause kernel: ata1.00: retrying FLUSH 0xe7 Emask 0x4
Oct 01 12:16:21 pause kernel: ata1.00: qc timeout (cmd 0xe7)
Oct 01 12:16:21 pause kernel: ata1.00: FLUSH failed Emask 0x4
Oct 01 12:16:21 pause kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:16:21 pause kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:16:21 pause kernel: ata1: soft resetting link
Oct 01 12:16:21 pause kernel: ata1.00: configured for MWDMA2
Oct 01 12:16:21 pause kernel: ata1.00: retrying FLUSH 0xe7 Emask 0x4
Oct 01 12:16:21 pause kernel: ata1.00: qc timeout (cmd 0xe7)
Oct 01 12:16:21 pause kernel: ata1.00: FLUSH failed Emask 0x4
Oct 01 12:16:21 pause kernel: ata1.00: limiting speed to MWDMA2:PIO3
Oct 01 12:16:21 pause kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:16:21 pause kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:16:21 pause kernel: ata1: soft resetting link
Oct 01 12:16:21 pause kernel: ata1.00: configured for MWDMA2
Oct 01 12:16:21 pause kernel: ata1.00: retrying FLUSH 0xe7 Emask 0x4
Oct 01 12:16:21 pause kernel: ata1.00: qc timeout (cmd 0xe7)
Oct 01 12:16:21 pause kernel: ata1.00: FLUSH failed Emask 0x4
Oct 01 12:16:21 pause kernel: ata1.00: disabled
Oct 01 12:16:21 pause kernel: INFO: task jbd2/dm-0-8:165 blocked for more than 120 seconds.
Oct 01 12:16:21 pause kernel:       Not tainted 5.10.0-8-amd64 #1 Debian 5.10.46-4
Oct 01 12:16:21 pause kernel: "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
Oct 01 12:16:21 pause kernel: task:jbd2/dm-0-8     state:D stack:    0 pid:  165 ppid:     2 flags:0x00004000
Oct 01 12:16:21 pause kernel: Call Trace:
Oct 01 12:16:21 pause kernel:  __schedule+0x282/0x870
Oct 01 12:16:21 pause kernel:  ? out_of_line_wait_on_bit_lock+0xb0/0xb0
Oct 01 12:16:21 pause kernel:  schedule+0x46/0xb0
Oct 01 12:16:21 pause kernel:  io_schedule+0x42/0x70
Oct 01 12:16:21 pause kernel:  bit_wait_io+0xd/0x50
Oct 01 12:16:21 pause kernel:  __wait_on_bit+0x2a/0x90
Oct 01 12:16:21 pause kernel:  out_of_line_wait_on_bit+0x92/0xb0
Oct 01 12:16:21 pause kernel:  ? var_wake_function+0x20/0x20
Oct 01 12:16:21 pause kernel:  jbd2_journal_commit_transaction+0x16b3/0x1ad0 [jbd2]
Oct 01 12:16:21 pause kernel:  ? sched_clock+0x5/0x10
Oct 01 12:16:21 pause kernel:  kjournald2+0xab/0x270 [jbd2]
Oct 01 12:16:21 pause kernel:  ? add_wait_queue_exclusive+0x70/0x70
Oct 01 12:16:21 pause kernel:  ? load_superblock.part.0+0xb0/0xb0 [jbd2]
Oct 01 12:16:21 pause kernel:  kthread+0x11b/0x140
Oct 01 12:16:21 pause kernel:  ? __kthread_bind_mask+0x60/0x60
Oct 01 12:16:21 pause kernel:  ret_from_fork+0x22/0x30
Oct 01 12:16:21 pause kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:16:21 pause kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:16:21 pause kernel: ata1: EH complete
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Write(10) 2a 00 00 c6 36 60 00 00 38 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 12990048 op 0x1:(WRITE) flags 0x0 phys_seg 7 prio class 0
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1185092 starting block 1498316)
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1498316
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1185092 starting block 1498317)
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1185092 starting block 1498319)
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1185092 starting block 1498320)
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=162s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Synchronize Cache(10) 35 00 00 00 00 00 00 00 00 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 0 op 0x1:(WRITE) flags 0x800 phys_seg 0 prio class 0
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Read(10) 28 00 02 54 f2 78 00 00 08 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 39121528 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1498317
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Read(10) 28 00 02 54 f2 78 00 00 08 00
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1498318
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1498319
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 39121528 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1498320
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1498321
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1498322
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Read(10) 28 00 02 54 f2 78 00 00 08 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 39121528 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Write(10) 2a 00 00 54 85 80 00 00 08 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 5539200 op 0x1:(WRITE) flags 0x800 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1181990 starting block 566960)
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 566960
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Read(10) 28 00 02 54 f2 78 00 00 08 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 39121528 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Write(10) 2a 00 00 b8 50 70 00 00 08 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 12079216 op 0x1:(WRITE) flags 0x0 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1183326 starting block 1384462)
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 1384462
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Read(10) 28 00 02 54 f2 78 00 00 08 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 39121528 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 FAILED Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK cmd_age=0s
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 CDB: Read(10) 28 00 02 54 f2 78 00 00 08 00
Oct 01 12:16:21 pause kernel: blk_update_request: I/O error, dev sda, sector 39121528 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 0
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1185197 starting block 4754136)
Oct 01 12:16:21 pause kernel: Buffer I/O error on device dm-0, logical block 4754136
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] Read Capacity(16) failed: Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] Sense not available.
Oct 01 12:16:21 pause kernel: Aborting journal on device dm-0-8.
Oct 01 12:16:21 pause kernel: Buffer I/O error on dev dm-0, logical block 3702784, lost sync page write
Oct 01 12:16:21 pause kernel: JBD2: Error -5 detected when updating journal superblock for dm-0-8.
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] Read Capacity(10) failed: Result: hostbyte=DID_BAD_TARGET driverbyte=DRIVER_OK
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] Sense not available.
Oct 01 12:16:21 pause kernel: Buffer I/O error on dev dm-0, logical block 0, lost sync page write
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] 0 512-byte logical blocks: (0 B/0 B)
Oct 01 12:16:21 pause kernel: EXT4-fs (dm-0): I/O error while writing superblock
Oct 01 12:16:21 pause kernel: sda: detected capacity change from 32212254720 to 0
Oct 01 12:16:21 pause kernel: EXT4-fs error (device dm-0): ext4_journal_check_start:83: Detected aborted journal
Oct 01 12:16:21 pause kernel: EXT4-fs (dm-0): Remounting filesystem read-only
Oct 01 12:16:21 pause kernel: sd 0:0:0:0: [sda] tag#0 access beyond end of device
Oct 01 12:16:21 pause kernel: EXT4-fs warning (device dm-0): ext4_end_bio:345: I/O error 10 writing to inode 1185188 starting block 4751877)
Oct 01 12:16:21 pause kernel: EXT4-fs (dm-0): failed to convert unwritten extents to written extents -- potential data loss!  (inode 1185188, error -30)
Oct 01 12:15:01 pause CRON[652070]: pam_unix(cron:session): session opened for user root(uid=0) by (uid=0)
Oct 01 12:15:01 pause CRON[652071]: pam_unix(cron:session): session opened for user root(uid=0) by (uid=0)
Oct 01 12:15:01 pause CRON[652072]: (root) CMD (command -v debian-sa1 > /dev/null && debian-sa1 1 1)
Oct 01 12:15:01 pause CRON[652073]: (root) CMD (env CRONWAIT=1 /usr/local/bin/ansible-my-wrapper >/dev/null 2>&1)
Oct 01 12:15:01 pause CRON[652070]: pam_unix(cron:session): session closed for user root
Oct 01 12:16:00 pause ansible-git[652100]: Invoked with name= dest=/var/cache/ansible version=master verify_commit=True repo= remote=origin force=False clone=True update=True gpg_whitelist=[] accept_hostkey=F>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Input/output error [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Input/output error [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Input/output error [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Input/output error [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Input/output error [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Input/output error [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rs>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-3-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rs>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-3-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rs>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-3-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rs>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-3-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rs>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-3-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/kern.log'[15] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rs>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-3-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>
Oct 01 12:16:21 pause rsyslogd[385]: action 'action-1-builtin:omfile' (module 'builtin:omfile') message lost, could not be processed. Check for additional error messages before this one. [v8.2102.0 try https:>
Oct 01 12:16:21 pause rsyslogd[385]: file '/var/log/syslog'[8] write error - see https://www.rsyslog.com/solving-rsyslog-write-errors/ for help OS error: Read-only file system [v8.2102.0 try https://www.rsysl>

*** trying recover of qcow2 file
  664  virsh shutdown pause.sigsum.org
  666  virsh destroy pause.sigsum.org
  675  modprobe nbd
  676  qemu-nbd -c /dev/nbd0 --read-only /var/lib/libvirt/images/pause.sigsum.org.qcow2 
  691  vgs
  692  mount -o ro /dev/pause-vg/root /mnt

root@vm86:~# qemu-nbd -d /dev/nbd0
root@vm86:~# qemu-nbd -c /dev/nbd0 /var/lib/libvirt/images/pause.sigsum.org.qcow2 
Failed to set NBD socket
Disconnect client, due to: Unexpected end-of-file before all bytes were read
root@vm86:~# fsck /dev/pause-vg/root 
fsck from util-linux 2.33.1
e2fsck 1.44.5 (15-Dec-2018)
fsck.ext2: Input/output error while trying to open /dev/mapper/pause--vg-root

The superblock could not be read or does not describe a valid ext2/ext3/ext4
filesystem.  If the device is valid and it really contains an ext2/ext3/ext4
filesystem (and not swap or ufs or something else), then the superblock
is corrupt, and you might try running e2fsck with an alternate superblock:
    e2fsck -b 8193 <device>
 or
    e2fsck -b 32768 <device>

root@vm86:~# qemu-nbd -c /dev/nbd2 /var/lib/libvirt/images/pause.sigsum.org.qcow2
root@vm86:~# vgs
  WARNING: Device mismatch detected for pause-vg/root which is accessing /dev/nbd0p5 instead of /dev/nbd2p5.
  WARNING: Device mismatch detected for pause-vg/swap_1 which is accessing /dev/nbd0p5 instead of /dev/nbd2p5.
  VG         #PV #LV #SN Attr   VSize    VFree 
  pause-vg     1   2   0 wz--n-  <29.52g     0 
  spinfaster   1   2   0 wz--n-  931.51g 51.51g
  ssd          1   1   0 wz--n- <223.57g     0 
  st-vg        4   2   0 wz--n-   <7.28t <3.24t
root@vm86:~# fsck /dev/pause-vg/root 
fsck from util-linux 2.33.1
e2fsck 1.44.5 (15-Dec-2018)
fsck.ext2: Input/output error while trying to open /dev/mapper/pause--vg-root

The superblock could not be read or does not describe a valid ext2/ext3/ext4
filesystem.  If the device is valid and it really contains an ext2/ext3/ext4
filesystem (and not swap or ufs or something else), then the superblock
is corrupt, and you might try running e2fsck with an alternate superblock:
    e2fsck -b 8193 <device>
 or
    e2fsck -b 32768 <device>

*** etherpad
**** error <2021-11-02 Tue>
Please press and hold Ctrl and press F5 to reload this page

If the problem persists, please send this error message to your webmaster:
Error: Failed assertion: Invalid changeset (checkRep failed)
at https://pad.sigsum.org/static/js/require-kernel.js?v=57e650dc line 10 > Function at line 19
ErrorId: dV8jOklawjTtTKluhnRF
Unhandled Promise rejection
URL: https://pad.sigsum.org/p/sigsum-20211109
UserAgent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0

** listen.sigsum.org (2021-09-22) -- VM @ vm86 for list archives (and web page)
virt-install --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --name listen.sigsum.org --memory 1024 --vcpus 1 --disk size=20

*** disk failure <2021-10-01 Fri>
[768452.245151] ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
[768452.245266] ata1.00: failed command: FLUSH CACHE
[768452.245343] ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
                         res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
[768452.245441] ata1.00: status: { DRDY }
[768457.285129] ata1: link is slow to respond, please be patient (ready=0)
[768457.885210] ata1: soft resetting link
[768458.045584] ata1.01: NODEV after polling detection
[768458.046332] ata1.00: configured for MWDMA2
[768458.046333] ata1.00: retrying FLUSH 0xe7 Emask 0x4
[768458.046581] ata1: EH complete

** mincore.adb-centralen.se (2021-09-26) -- VM @ vm86 for Minecraft
virt-install --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --name mincore.adb-centralen.se --memory 4096 --vcpus 2 --disk size=20

Gave it another vCPU to try to get the load down on vm86. Didn't help.

htop on vm86 reports one core pegged and lists two libvirt-qemu w/
guest=mincore as constantly utulising 95%-98% while htop on mincore
reports a load avg of 0.12-0.15 while idling and only two java
processes, chugging along on 8%-9%.

*** crash <2021-10-01 Fri>
[12:14:49 ERROR]: --- DO NOT REPORT THIS TO PAPER - THIS IS NOT A BUG OR A CRASH  - git-Paper-279 (MC: 1.17.1) ---
[12:14:49 ERROR]: The server has not responded for 10 seconds! Creating thread dump
[12:14:49 ERROR]: ------------------------------
[12:14:49 ERROR]: Server thread dump (Look for plugins here before reporting to Paper!):
[12:15:12 ERROR]: ------------------------------
[12:15:12 ERROR]: Current Thread: Server thread
[12:15:12 ERROR]:       PID: 21 | Suspended: false | Native: true | State: RUNNABLE
[12:15:12 ERROR]:       Stack:
[12:15:27 WARN]: Can't keep up! Is the server overloaded? Running 47653ms or 953 ticks behind
[12:17:35 ERROR]:               java.base@17-ea/java.io.FileDescriptor.close0(Native Method)
[12:17:35 ERROR]:               java.base@17-ea/java.io.FileDescriptor.close(FileDescriptor.java:297)
[12:17:35 ERROR]:               java.base@17-ea/java.io.FileOutputStream$1.close(FileOutputStream.java:390)
[12:17:35 ERROR]:               java.base@17-ea/java.io.FileDescriptor.closeAll(FileDescriptor.java:355)
[12:17:35 ERROR]:               java.base@17-ea/java.io.FileOutputStream.close(FileOutputStream.java:388)
[12:17:35 ERROR]:               java.base@17-ea/java.util.zip.DeflaterOutputStream.close(DeflaterOutputStream.java:240)
[12:17:35 ERROR]:               java.base@17-ea/java.io.FilterOutputStream.close(FilterOutputStream.java:188)
[12:17:35 ERROR]:               java.base@17-ea/java.io.FilterOutputStream.close(FilterOutputStream.java:188)
[12:17:35 ERROR]:               app//net.minecraft.nbt.NbtIo.writeCompressed(NbtIo.java:103)
[12:17:35 ERROR]:               app//net.minecraft.nbt.NbtIo.writeCompressed(NbtIo.java:74)
[12:17:35 ERROR]:               app//net.minecraft.world.level.saveddata.SavedData.save(SavedData.java:40)
[12:17:35 ERROR]:               app//net.minecraft.world.level.storage.DimensionDataStorage.lambda$save$0(DimensionDataStorage.java:158)
[12:17:35 ERROR]:               app//net.minecraft.world.level.storage.WorldPersistentData$$Lambda$4654/0x0000000801c67058.accept(Unknown Source)
[12:17:35 ERROR]:               java.base@17-ea/java.util.HashMap.forEach(HashMap.java:1425)
[12:17:35 ERROR]:               app//net.minecraft.world.level.storage.DimensionDataStorage.save(DimensionDataStorage.java:156)
[12:17:35 ERROR]:               app//net.minecraft.server.level.ServerLevel.saveLevelData(ServerLevel.java:1256)
[12:17:35 ERROR]:               app//net.minecraft.server.level.ServerLevel.saveIncrementally(ServerLevel.java:1194)
[12:17:35 ERROR]:               app//net.minecraft.server.MinecraftServer.tickServer(MinecraftServer.java:1506)
[12:17:35 ERROR]:               app//net.minecraft.server.MinecraftServer.runServer(MinecraftServer.java:1274)
[12:17:35 ERROR]:               app//net.minecraft.server.MinecraftServer.lambda$spin$0(MinecraftServer.java:319)
[12:17:35 ERROR]:               app//net.minecraft.server.MinecraftServer$$Lambda$3663/0x00000008017c3358.run(Unknown Source)
[12:17:35 ERROR]:               java.base@17-ea/java.lang.Thread.run(Thread.java:831)
[12:17:35 ERROR]: ------------------------------
[12:17:35 ERROR]: --- DO NOT REPORT THIS TO PAPER - THIS IS NOT A BUG OR A CRASH ---
[12:17:35 ERROR]: ------------------------------

Oct 01 12:14:39 mincore kernel: ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
Oct 01 12:15:26 mincore kernel: ata1.00: failed command: FLUSH CACHE
Oct 01 12:15:26 mincore kernel: ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
                                         res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
Oct 01 12:15:26 mincore kernel: ata1.00: status: { DRDY }
Oct 01 12:15:26 mincore kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:15:26 mincore kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:15:26 mincore kernel: ata1: soft resetting link
Oct 01 12:15:26 mincore kernel: ata1.00: configured for MWDMA2
Oct 01 12:15:26 mincore kernel: ata1.00: retrying FLUSH 0xe7 Emask 0x4
Oct 01 12:15:26 mincore kernel: ata1: EH complete
Oct 01 12:15:01 mincore CRON[200556]: pam_unix(cron:session): session opened for user root(uid=0) by (uid=0)
Oct 01 12:15:01 mincore CRON[200555]: pam_unix(cron:session): session opened for user root(uid=0) by (uid=0)
Oct 01 12:15:01 mincore CRON[200557]: (root) CMD (command -v debian-sa1 > /dev/null && debian-sa1 1 1)
Oct 01 12:15:01 mincore CRON[200558]: (root) CMD (env CRONWAIT=1 /usr/local/bin/ansible-my-wrapper >/dev/null 2>&1)
Oct 01 12:15:01 mincore CRON[200555]: pam_unix(cron:session): session closed for user root
Oct 01 12:16:29 mincore kernel: ata1.00: exception Emask 0x0 SAct 0x0 SErr 0x0 action 0x6 frozen
Oct 01 12:16:29 mincore kernel: ata1.00: failed command: FLUSH CACHE
Oct 01 12:16:29 mincore kernel: ata1.00: cmd e7/00:00:00:00:00/00:00:00:00:00/a0 tag 0
                                         res 40/00:01:00:00:00/00:00:00:00:00/a0 Emask 0x4 (timeout)
Oct 01 12:16:29 mincore kernel: ata1.00: status: { DRDY }
Oct 01 12:16:34 mincore kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:16:39 mincore kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:16:39 mincore kernel: ata1: soft resetting link
Oct 01 12:16:39 mincore kernel: ata1.00: configured for MWDMA2
Oct 01 12:16:39 mincore kernel: ata1.00: retrying FLUSH 0xe7 Emask 0x4
Oct 01 12:16:55 mincore kernel: ata1.00: qc timeout (cmd 0xe7)
Oct 01 12:16:55 mincore kernel: ata1.00: FLUSH failed Emask 0x4
Oct 01 12:17:00 mincore kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:17:05 mincore kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:17:05 mincore kernel: ata1: soft resetting link
Oct 01 12:17:05 mincore kernel: ata1.00: configured for MWDMA2
Oct 01 12:17:05 mincore kernel: ata1.00: retrying FLUSH 0xe7 Emask 0x4
Oct 01 12:17:20 mincore kernel: ata1.00: qc timeout (cmd 0xe7)
Oct 01 12:17:20 mincore kernel: ata1.00: FLUSH failed Emask 0x4
Oct 01 12:17:20 mincore kernel: ata1.00: limiting speed to MWDMA2:PIO3
Oct 01 12:17:25 mincore kernel: ata1: link is slow to respond, please be patient (ready=0)
Oct 01 12:17:30 mincore kernel: ata1: device not ready (errno=-16), forcing hardreset
Oct 01 12:17:30 mincore kernel: ata1: soft resetting link
Oct 01 12:17:30 mincore kernel: ata1.00: configured for MWDMA2
Oct 01 12:17:30 mincore kernel: ata1.00: retrying FLUSH 0xe7 Emask 0x4
Oct 01 12:17:35 mincore kernel: ata1: EH complete

560 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x7a593a7c

root@vm86:/dev/shm/tmp# qemu-img convert -p -O raw /var/lib/libvirt/images/pause.sigsum.org.qcow2 pause.raw
root@vm86:/dev/shm/tmp# losetup -f pause.raw 

Device       Boot   Start      End  Sectors  Size Id Type
/dev/loop0p1 *       2048   999423   997376  487M 83 Linux
/dev/loop0p2      1001470 62912511 61911042 29.5G  5 Extended
/dev/loop0p5      1001472 62912511 61911040 29.5G 8e Linux LVM

root@vm86:/dev/shm/tmp# losetup -d /dev/loop0

1001470 2/p
500735.000

root@vm86:/dev/shm/tmp# losetup -f -o 500735K pause.raw 
root@vm86:/dev/shm/tmp# vgs
  /dev/loop0: Label for sector 1 found at sector 3 - ignoring.
  VG         #PV #LV #SN Attr   VSize    VFree 
  spinfaster   1   2   0 wz--n-  931.51g 51.51g
  ssd          1   1   0 wz--n- <223.57g     0 
  st-vg        4   2   0 wz--n-   <7.28t <3.24t
root@vm86:/dev/shm/tmp# losetup -d /dev/loop0
root@vm86:/dev/shm/tmp# losetup -f -o 500736K pause.raw 
root@vm86:/dev/shm/tmp# vgs
  WARNING: Device mismatch detected for pause-vg/root which is accessing /dev/nbd0p5 instead of /dev/loop0.
  WARNING: Device mismatch detected for pause-vg/swap_1 which is accessing /dev/nbd0p5 instead of /dev/loop0.
  VG         #PV #LV #SN Attr   VSize    VFree 
  pause-vg     1   2   0 wz--n-  <29.52g     0 
  spinfaster   1   2   0 wz--n-  931.51g 51.51g
  ssd          1   1   0 wz--n- <223.57g     0 
  st-vg        4   2   0 wz--n-   <7.28t <3.24t
root@vm86:/dev/shm/tmp# fsck /dev/pause-vg/root 
fsck from util-linux 2.33.1
e2fsck 1.44.5 (15-Dec-2018)
fsck.ext2: Input/output error while trying to open /dev/mapper/pause--vg-root

The superblock could not be read or does not describe a valid ext2/ext3/ext4
filesystem.  If the device is valid and it really contains an ext2/ext3/ext4
filesystem (and not swap or ufs or something else), then the superblock
is corrupt, and you might try running e2fsck with an alternate superblock:
    e2fsck -b 8193 <device>
 or
    e2fsck -b 32768 <device>

(none of the -b options give any better result)

** meet.sigsum.org (2021-09-27) -- VM @ vm86 for Jitsi
virt-install --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --name meet.sigsum.org --memory 2048 --vcpus 2 --disk size=20

NOTE: Using Jitsi's quick install and not run Ansible

*** ip filtering
apt install nftables
cat > /etc/nftables.conf <<EOF
#!/usr/sbin/nft -f
flush ruleset
table inet filter {
	chain input {
		type filter hook input priority 0; policy drop;
		ct state invalid drop; ct state related,established accept;
		iifname lo accept
		ip protocol icmp limit rate 4/second accept
	        ip6 nexthdr icmpv6 icmpv6 type { nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert } limit rate 4/second accept

		tcp dport 4722 accept
		tcp dport {80, 443} accept

		# jitsi: "general network video/audio communications"
		udp dport 10000 accept
		# jitsi: "for quering the stun server"
		udp dport 3478 accept
		# jitsi: "for fallback network video/audio communications over TCP"
		tcp dport 5349 accept
	}
	chain forward {
		type filter hook forward priority 0; policy accept;
	}
	chain output {
		type filter hook output priority 0; policy accept;
	}
}
EOF
systemctl restart nftables

*** installing jitsi stuff
- instructions from https://jitsi.github.io/handbook/docs/devops-guide/devops-guide-quickstart

apt install gnupg2 nginx-full sudo apt-transport-https curl
curl https://download.jitsi.org/jitsi-key.gpg.key | sh -c 'gpg --dearmor > /usr/share/keyrings/jitsi-keyring.gpg'
echo 'deb [signed-by=/usr/share/keyrings/jitsi-keyring.gpg] https://download.jitsi.org stable/' | tee /etc/apt/sources.list.d/jitsi-stable.list > /dev/null
apt update
apt install jitsi-meet
/usr/share/jitsi-meet/scripts/install-letsencrypt-cert.sh

- cert and key end up in /etc/letsencrypt/live/meet.sigsum.org/{fullchain,privkey}.pem

so the first invokation of install-letsencrypt-cert.sh might fail

and you will need to edit
/etc/nginx/sites-available/meet.sigsum.org.conf to point at the right
cert and key path

*** misc other stuff
- atop for logging 

apt install atop
cat > /etc/default/atop <<EOF
LOGOPTS="-R"
LOGINTERVAL=60
LOGGENERATIONS=90
EOF
systemctl restart atop

- unattended upgrades

apt install unattended-upgrades

- some more privacy in nginx logs

vi /etc/nginx/nginx.conf
http {
...
        map $remote_addr $remote_addr_anon {
            ~(?P<ip>\d+\.\d+)\.    $ip.0.0;
            ~(?P<ip>[^:]+:[^:]+):  $ip::;
            default                0.0.0.0;
        }
        log_format srcaddrprivacy '$remote_addr_anon  - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';

        access_log /var/log/nginx/access.log srcaddrprivacy;
...
}

** ns.verkligendata.se (2021-10-22) -- VM @ vm86 for DNS authoritative
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name ns.verkligendata.se --memory 1024 --vcpus 1 --disk size=20

91.223.231.3/24
2001:67c:8a4::

** madvise.sigsum.org (2021-10-29) -- VM @ vm86 for email
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name madvise.sigsum.org --memory 1024 --vcpus 1 --disk size=20

** tee.sigsum.org (2021-12-14) -- VM @ vm86 for testing
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name tee.sigsum.org --memory 1024 --vcpus 1 --disk size=20

: on tee
ssh-keygen -r $(hostname) | egrep 'SSHFP [134] 2' | while read -r name in type n1 n2 fpr; do echo $name 7200 SSHFP $n1 $n2 $fpr; done
: on ns
export Z=sigsum.org; knotc zone-begin $Z && while read -r line; do knotc zone-set $Z $line; done && knotc zone-diff $Z
** link.verkligendata.se (2021-12-27) -- VM @ vm86 for lab
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name link.verkligendata.se --memory 1024 --vcpus 1 --disk size=20

ssh-keygen -r $(hostname) | egrep 'SSHFP [134] 2' | while read -r name in type n1 n2 fpr; do echo $name 7200 SSHFP $n1 $n2 $fpr; done

** sauterad.verkligendata.se (2022-01-06) -- VM @ vm86 for satalite.org
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name sauterad.verkligendata.se --memory 1024 --vcpus 1 --disk size=5

ssh-keygen -r $(hostname) | egrep 'SSHFP [134] 2' | while read -r name in type n1 n2 fpr; do echo $name 7200 SSHFP $n1 $n2 $fpr; done

*** soapi
```
root@sauterad:~# systemctl cat soapi
# /etc/systemd/system/soapi.service
[Unit]
Description=Sauteed onions API service

[Service]
Type=simple
User=sauterad
StandardError=journal
WorkingDirectory=/home/sauterad/usr/var/lib/soapi
ExecStart=/home/sauterad/usr/bin/soapi

[Install]
WantedBy=multi-user.target

```
besk:soapi% pwd
~/p/sauteed-onions/src/sauteed-onions/monitor/soapi
besk:soapi% go build
besk:soapi% scp soapi sauterad.verkligendata.se:~sauterad/usr/bin/
soapi
```

```
sauterad@sauterad:~$ ls -lR
.:
total 4
drwxr-xr-x 4 sauterad sauterad 4096 Jul 11 16:45 usr

./usr:
total 8
drwxr-xr-x 2 sauterad sauterad 4096 Jul 11 16:53 bin
drwxr-xr-x 3 sauterad sauterad 4096 Jul 11 16:45 var

./usr/bin:
total 6188
-rwxrwxr-x 1 sauterad sauterad 6334201 Jul 11 17:28 soapi

./usr/var:
total 4
drwxr-xr-x 3 sauterad sauterad 4096 Jul 11 16:45 lib

./usr/var/lib:
total 4
drwxr-xr-x 2 sauterad sauterad 4096 Jul 11 16:45 soapi

./usr/var/lib/soapi:
total 0
lrwxrwxrwx 1 sauterad sauterad 17 Jul 11 16:45 index -> /var/www/db/index
```

** mx-01.verkligendata.se (2022-04-21) -- VM @ vm86 for MX
virt-install \
  --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ \
  --virt-type kvm \
  --graphics none \
  --extra-args console=ttyS0,115200 \
  --autostart \
  --os-variant debian9 \
  --network bridge=br0 \
  --name sauterad.verkligendata.se --memory 2048 --vcpus 1 --disk size=6

ssh-keygen -r $(hostname) | egrep 'SSHFP [134] 2' | while read -r name in type n1 n2 fpr; do echo $name 7200 SSHFP $n1 $n2 $fpr; done

*** 2022-08-05 opendkim not working
We've had some trouble since some eleven days or so:
Jul 26 13:15:01 mx-01 postfix/shutup/cleanup[481031]: warning: connect to Milter service unix:/opendkim/opendkim.sock: No such file or directory

Might be this:
commit 7de9ce57d76bbec44f6e766361c5f0b8832da7dc
Author: Linus Nordberg <linus@nordberg.se>
Date:   Tue Jul 26 12:06:16 2022 +0200

    enable shutup; increase max msg size 10M->35M
    
    Also be explicit about rate limiting time unit (1 minute).

*** 2022-10-20 watchdog: BUG: soft lockup - CPU#0 stuck for 24s! [kworker/0:1:117116]
Message from syslogd@mx-01 at Oct 20 12:55:05 ...
 kernel:[110327.209575] watchdog: BUG: soft lockup - CPU#0 stuck for 24s! [kworker/0:1:117116]

Nothing else than this at vm86, at that time:
Oct 20 12:55:01 vm86 audit[16669]: USER_ACCT pid=16669 uid=0 auid=4294967295 ses=4294967295 subj==unconfined msg='op=PAM:accounting grantors=pam_permit acct="root" exe="/usr/sbin/cron" hostname=? addr=? terminal=cron res=success'
Oct 20 12:55:01 vm86 audit[16669]: CRED_ACQ pid=16669 uid=0 auid=4294967295 ses=4294967295 subj==unconfined msg='op=PAM:setcred grantors=pam_permit acct="root" exe="/usr/sbin/cron" hostname=? addr=? terminal=cron res=success'
Oct 20 12:55:01 vm86 audit[16669]: USER_START pid=16669 uid=0 auid=0 ses=35207 subj==unconfined msg='op=PAM:session_open grantors=pam_loginuid,pam_env,pam_env,pam_permit,pam_unix,pam_limits acct="root" exe="/usr/sbin/cron" hostname=? addr=
Oct 20 12:55:01 vm86 CRON[16669]: pam_unix(cron:session): session opened for user root by (uid=0)
Oct 20 12:55:01 vm86 CRON[16670]: (root) CMD (command -v debian-sa1 > /dev/null && debian-sa1 1 1)
Oct 20 12:55:01 vm86 audit[16669]: CRED_DISP pid=16669 uid=0 auid=0 ses=35207 subj==unconfined msg='op=PAM:setcred grantors=pam_permit acct="root" exe="/usr/sbin/cron" hostname=? addr=? terminal=cron res=success'
Oct 20 12:55:01 vm86 CRON[16669]: pam_unix(cron:session): session closed for user root
Oct 20 12:55:01 vm86 audit[16669]: USER_END pid=16669 uid=0 auid=0 ses=35207 subj==unconfined msg='op=PAM:session_close grantors=pam_loginuid,pam_env,pam_env,pam_permit,pam_unix,pam_limits acct="root" exe="/usr/sbin/cron" hostname=? addr=?

**** more logs
Oct 20 12:54:14 mx-01 kernel: rcu: INFO: rcu_sched self-detected stall on CPU
Oct 20 12:54:14 mx-01 kernel: rcu:         0-...!: (1 ticks this GP) idle=a52/0/0x1 softirq=14621393/14621393 fqs=0 
Oct 20 12:54:14 mx-01 kernel:         (t=6344 jiffies g=14007709 q=3)
Oct 20 12:54:14 mx-01 kernel: rcu: rcu_sched kthread starved for 6344 jiffies! g14007709 f0x0 RCU_GP_WAIT_FQS(5) ->state=0x402 ->cpu=0
Oct 20 12:54:14 mx-01 kernel: rcu:         Unless rcu_sched kthread gets sufficient CPU time, OOM is now expected behavior.
Oct 20 12:54:14 mx-01 kernel: rcu: RCU grace-period kthread stack dump:
Oct 20 12:54:14 mx-01 kernel: task:rcu_sched       state:I stack:    0 pid:   12 ppid:     2 flags:0x00004000
Oct 20 12:54:14 mx-01 kernel: Call Trace:
Oct 20 12:54:14 mx-01 kernel:  __schedule+0x282/0x880
Oct 20 12:54:14 mx-01 kernel:  ? __switch_to_asm+0x3a/0x60
Oct 20 12:54:14 mx-01 kernel:  schedule+0x46/0xb0
Oct 20 12:54:14 mx-01 kernel:  schedule_timeout+0x8b/0x150
Oct 20 12:54:14 mx-01 kernel:  ? __next_timer_interrupt+0x110/0x110
Oct 20 12:54:14 mx-01 kernel:  rcu_gp_kthread+0x51b/0xbb0
Oct 20 12:54:14 mx-01 kernel:  ? rcu_cpu_kthread+0x190/0x190
Oct 20 12:54:14 mx-01 kernel:  kthread+0x118/0x140
Oct 20 12:54:14 mx-01 kernel:  ? __kthread_bind_mask+0x60/0x60
Oct 20 12:54:14 mx-01 kernel:  ret_from_fork+0x1f/0x30
Oct 20 12:54:14 mx-01 kernel: NMI backtrace for cpu 0
Oct 20 12:54:14 mx-01 kernel: CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.10.0-19-amd64 #1 Debian 5.10.149-1
Oct 20 12:54:14 mx-01 kernel: Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.12.0-1 04/01/2014
Oct 20 12:54:14 mx-01 kernel: Call Trace:
Oct 20 12:54:14 mx-01 kernel:  <IRQ>
Oct 20 12:54:14 mx-01 kernel:  dump_stack+0x6b/0x83
Oct 20 12:54:14 mx-01 kernel:  nmi_cpu_backtrace.cold+0x32/0x69
Oct 20 12:54:14 mx-01 kernel:  ? lapic_can_unplug_cpu+0x80/0x80
Oct 20 12:54:14 mx-01 kernel:  nmi_trigger_cpumask_backtrace+0xdf/0xf0
Oct 20 12:54:14 mx-01 kernel:  rcu_dump_cpu_stacks+0xa2/0xd4
Oct 20 12:54:14 mx-01 kernel:  rcu_sched_clock_irq.cold+0x1ff/0x3d6
Oct 20 12:54:14 mx-01 kernel:  update_process_times+0x8c/0xc0
Oct 20 12:54:14 mx-01 kernel:  tick_sched_handle+0x22/0x60
Oct 20 12:54:14 mx-01 kernel:  tick_sched_timer+0x80/0xc0
Oct 20 12:54:14 mx-01 kernel:  ? tick_do_update_jiffies64.part.0+0xc0/0xc0
Oct 20 12:54:14 mx-01 kernel:  __hrtimer_run_queues+0x127/0x280
Oct 20 12:54:14 mx-01 kernel:  hrtimer_interrupt+0x110/0x2c0
Oct 20 12:54:14 mx-01 kernel:  __sysvec_apic_timer_interrupt+0x5c/0xe0
Oct 20 12:54:14 mx-01 kernel:  asm_call_irq_on_stack+0xf/0x20
Oct 20 12:54:14 mx-01 kernel:  </IRQ>
Oct 20 12:54:14 mx-01 kernel:  sysvec_apic_timer_interrupt+0x72/0x80
Oct 20 12:54:14 mx-01 kernel:  asm_sysvec_apic_timer_interrupt+0x12/0x20
Oct 20 12:54:14 mx-01 kernel: RIP: 0010:native_safe_halt+0xe/0x20
Oct 20 12:54:14 mx-01 kernel: Code: 00 3e 80 48 02 20 48 8b 00 a8 08 75 c0 e9 77 ff ff ff cc cc cc cc cc cc cc cc cc cc 0f 1f 44 00 00 0f 00 2d a6 39 51 00 fb f4 <c3> cc cc cc cc 66 66 2e 0f 1f 84 00 00 00 00 00 66 90 0f 1f 44 00
Oct 20 12:54:14 mx-01 kernel: RSP: 0018:ffffffffbda03eb8 EFLAGS: 00000256
Oct 20 12:54:14 mx-01 kernel: RAX: ffffffffbccf6410 RBX: 0000000000000000 RCX: ffff920dbdc30a40
Oct 20 12:54:14 mx-01 kernel: RDX: 000000000828fa4e RSI: ffffffffbda03e50 RDI: 00006445a3b433f8
Oct 20 12:54:14 mx-01 kernel: RBP: ffffffffbda13940 R08: 0000000000000001 R09: 0000000000000001
Oct 20 12:54:14 mx-01 kernel: R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
Oct 20 12:54:14 mx-01 kernel: R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
Oct 20 12:54:14 mx-01 kernel:  ? __sched_text_end+0x6/0x6
Oct 20 12:54:14 mx-01 kernel:  default_idle+0xa/0x20
Oct 20 12:54:14 mx-01 kernel:  default_idle_call+0x3c/0xd0
Oct 20 12:54:14 mx-01 kernel:  do_idle+0x20c/0x2b0
Oct 20 12:54:14 mx-01 kernel:  cpu_startup_entry+0x19/0x20
Oct 20 12:54:14 mx-01 kernel:  start_kernel+0x574/0x599
Oct 20 12:54:14 mx-01 kernel:  secondary_startup_64_no_verify+0xb0/0xbb
Oct 20 12:55:05 mx-01 kernel: watchdog: BUG: soft lockup - CPU#0 stuck for 24s! [kworker/0:1:117116]
Oct 20 12:55:05 mx-01 kernel: Modules linked in: intel_rapl_msr intel_rapl_common intel_pmc_core_pltdrv intel_pmc_core ghash_clmulni_intel wireguard curve25519_x86_64 libchacha20poly1305 chacha_x86_64 poly1305_x86_64 ip6_udp_tunnel udp_tunnel libcurve25519_generic libchacha virtio_console iTCO_wdt intel_pmc_bxt iTCO_vendor_support watchdog virtio_balloon aesni_intel libaes crypto_simd cryptd glue_helper joydev button evdev serio_raw qemu_fw_cfg pcspkr nft_limit nft_ct nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 nf_tables libcrc32c nfnetlink drm fuse configfs virtio_rng rng_core ip_tables x_tables autofs4 ext4 crc16 mbcache jbd2 crc32c_generic dm_mod ahci libahci libata virtio_net virtio_blk net_failover failover xhci_pci xhci_hcd crct10dif_pclmul crct10dif_common crc32_pclmul crc32c_intel scsi_mod psmouse i2c_i801 i2c_smbus lpc_ich usbcore usb_common virtio_pci virtio_ring virtio
Oct 20 12:55:05 mx-01 kernel: CPU: 0 PID: 117116 Comm: kworker/0:1 Not tainted 5.10.0-19-amd64 #1 Debian 5.10.149-1
Oct 20 12:55:05 mx-01 kernel: Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.12.0-1 04/01/2014
Oct 20 12:55:05 mx-01 kernel: Workqueue: events_power_efficient wg_ratelimiter_gc_entries [wireguard]
Oct 20 12:55:05 mx-01 kernel: RIP: 0010:__do_softirq+0x6f/0x279
Oct 20 12:55:05 mx-01 kernel: Code: ff ff 89 74 24 14 65 81 05 2a bb 01 43 00 01 00 00 c7 44 24 10 0a 00 00 00 65 66 c7 05 d8 f4 02 43 00 00 fb 66 0f 1f 44 00 00 <b8> ff ff ff ff 49 c7 c3 c0 60 a0 bd 41 0f bc c7 41 89 c4 41 83 c4
Oct 20 12:55:05 mx-01 kernel: RSP: 0018:ffffac3a40003fa8 EFLAGS: 00000286
Oct 20 12:55:05 mx-01 kernel: RAX: ffff920d75fc3080 RBX: 0000000000000036 RCX: 0000000001800000
Oct 20 12:55:05 mx-01 kernel: RDX: 0000000000000000 RSI: 0000000004208060 RDI: 0000000000000000
Oct 20 12:55:05 mx-01 kernel: RBP: ffffac3a40aa7d50 R08: 08ec15057180be49 R09: b7ec6d31cb5141e7
Oct 20 12:55:05 mx-01 kernel: R10: 0000000000000008 R11: 0000000000000000 R12: 0000000000000000
Oct 20 12:55:05 mx-01 kernel: R13: ffff920dbaf17e00 R14: 0000000000000000 R15: 0000000000000008
Oct 20 12:55:05 mx-01 kernel: FS:  0000000000000000(0000) GS:ffff920dbdc00000(0000) knlGS:0000000000000000
Oct 20 12:55:05 mx-01 kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Oct 20 12:55:05 mx-01 kernel: CR2: 0000000001fb99f0 CR3: 0000000002634006 CR4: 0000000000370ef0
Oct 20 12:55:05 mx-01 kernel: DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
Oct 20 12:55:05 mx-01 kernel: DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Oct 20 12:55:05 mx-01 kernel: Call Trace:
Oct 20 12:55:05 mx-01 kernel:  <IRQ>
Oct 20 12:55:05 mx-01 kernel:  asm_call_irq_on_stack+0xf/0x20
Oct 20 12:55:05 mx-01 kernel:  </IRQ>
Oct 20 12:55:05 mx-01 kernel:  do_softirq_own_stack+0x37/0x50
Oct 20 12:55:05 mx-01 kernel:  irq_exit_rcu+0x92/0xc0
Oct 20 12:55:05 mx-01 kernel:  common_interrupt+0x74/0x130
Oct 20 12:55:05 mx-01 kernel:  asm_common_interrupt+0x1e/0x40
Oct 20 12:55:05 mx-01 kernel: RIP: 0010:_raw_spin_lock+0x10/0x30
Oct 20 12:55:05 mx-01 kernel: Code: 0f c1 07 a9 ff 01 00 00 75 05 c3 cc cc cc cc e9 66 99 7f ff 66 0f 1f 44 00 00 0f 1f 44 00 00 31 c0 ba 01 00 00 00 3e 0f b1 17 <75> 05 c3 cc cc cc cc 89 c6 e8 02 81 7f ff 66 90 c3 cc cc cc cc 66
Oct 20 12:55:05 mx-01 kernel: RSP: 0018:ffffac3a40aa7e58 EFLAGS: 00000246
Oct 20 12:55:05 mx-01 kernel: RAX: 0000000000000000 RBX: ffffffffc080e140 RCX: 0000000000000017
Oct 20 12:55:05 mx-01 kernel: RDX: 0000000000000001 RSI: 00000000137ed8c9 RDI: ffffffffc080ee78
Oct 20 12:55:05 mx-01 kernel: RBP: 0000645180259982 R08: 0000000000000000 R09: ffffffffbe36d660
Oct 20 12:55:05 mx-01 kernel: R10: 0000000000000018 R11: 0000000000000018 R12: dead000000000122
Oct 20 12:55:05 mx-01 kernel: R13: 0000000000001a1f R14: ffff920dbdc33b00 R15: 0000000000001a1f
Oct 20 12:55:05 mx-01 kernel:  wg_ratelimiter_gc_entries+0x49/0x170 [wireguard]
Oct 20 12:55:05 mx-01 kernel:  process_one_work+0x1b3/0x350
Oct 20 12:55:05 mx-01 kernel:  worker_thread+0x53/0x3e0
Oct 20 12:55:05 mx-01 kernel:  ? process_one_work+0x350/0x350
Oct 20 12:55:05 mx-01 kernel:  kthread+0x118/0x140
Oct 20 12:55:05 mx-01 kernel:  ? __kthread_bind_mask+0x60/0x60
Oct 20 12:55:05 mx-01 kernel:  ret_from_fork+0x1f/0x30

*** 2022-10-20 sshd "'Unable to negotiate with"
root@mx-01:/etc/postfix# journalctl | egrep 'Unable to negotiate with 124.116.129.15' | head -1
Oct 20 11:28:59 mx-01 sshd[155187]: Unable to negotiate with 124.116.129.15 port 53229: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]
root@mx-01:/etc/postfix# journalctl | egrep 'Unable to negotiate with' | egrep -v  '124.116.129.15' | wc -l
3935
root@mx-01:/etc/postfix# journalctl | awk '/Unable to negotiate with/{print $10}' | sort | uniq -c
   2214 124.116.129.15
   1870 61.142.103.100
   1351 61.164.64.10
    714 94.180.244.121

*** rate limiting
**** IP layer
Two sets:
        set denylist4 {
                type ipv4_addr
                flags dynamic,timeout
                timeout 5m
        }
        set denylist6 {
                type ipv6_addr
                flags dynamic,timeout
                timeout 5m
        }

Then in chain input:
                ip protocol tcp ct state new,untracked limit rate over 30/minute add @denylist4 { ip saddr }
                meta l4proto tcp ct state new,untracked limit rate over 30/minute add @denylist6 { ip6 saddr }
and:
                ip saddr @denylist4 counter drop
                ip6 saddr @denylist6 counter drop

On <2023-03-08 Wed> we changed 30/minute to 60/minute to lower the
risk of overblocking, after the VKG router (and wg endpoint) got
blocked.

Later on <2023-03-08 Wed> we changed to 5/second when realising this
is packets per time unit. Each SMTP interaction requires multiple
packets.

**** Application layer, postfix
root@mx-01:~# postconf | egrep smtpd_client_.\*_rate
smtpd_client_auth_rate_limit = 6
smtpd_client_connection_rate_limit = 10
smtpd_client_message_rate_limit = 10
smtpd_client_new_tls_session_rate_limit = 0
smtpd_client_recipient_rate_limit = 100

**** Application layer, dovecot
Not sure really, figure it out.

**** Application layer, kdc
Not sure really, figure it out.

**** Application layer, fail2ban
root@mx-01:~# fail2ban-client status
Status
|- Number of jail:      1
`- Jail list:   sshd

** besk -- Lenovo X270 from 2018-07
- purchase date: 2018-07-??
- [[https://psref.lenovo.com/syspool/Sys/PDF/datasheet/ThinkPad_X270_datasheet_EN.pdf][datasheet]], [[https://www.thinkwiki.org/wiki/X270_Detailed_Hardware_Information][thinkwiki]]
- 256GB SSD (nvme0)
- 8GB RAM (DDR4-2666 SODIMM?), max 16GB
- ? i5-6300U
- Intel® WiGig 18265 Combo
*** OS: debian 10.3.0 installed <2020-02-28 Fri>
    - UEFI boot
    - FDE
    - /etc/network/interfaces
    allow enp0s31f6
    allow-hotplug enp0s31f6
    iface enp0s31f6 inet dhcp
    iface enp0s31f6 inet6 auto
    - apt install apt-transport-tor
    - vi /etc/apt/sources.list # s/http:/tor+http:/g; see https://onion.debian.org/
    - apt update
    - apt install git pass curl

*** Installing and restoring from 'datan'
- [X] verifying resolver set up
  apt install unbound knot-dnsutils
  cat > /etc/unbound/unbound.conf.d/dontleak.conf <<EOF
server:
        local-zone: lan refuse
        local-zone: datan refuse
EOF
  systemctl restart unbound

- [X] wireguard
  echo 'deb tor+http://vwakviie2ienjx6t.onion/debian/ unstable main' > /etc/apt/sources.list.d/debian-unstable.list
  printf 'Package: *\nPin: release a=unstable\nPin-Priority: 90\n' > /etc/apt/preferences.d/limit-unstable
  apt update
  apt install wireguard
  (cd /etc/wireguard; umask 077; wg genkey | tee private.key | wg pubkey > public.key; printf "[Interface]\nPrivateKey = $(cat private.key)\nAddress = 10.128.0.YOURS/32\nAddress = fd00:128::YOURS/128\n" > /etc/wireguard/wg0.conf;)
  wg-quick up wg0
  wg set wg0 peer $SERVER_PUBKEY endpoint 193.10.5.2:51820 allowed-ips 0.0.0.0/0,::/0
  wg-quick save wg0
  wg-quick down wg0
  wg-quick up wg0

- Transfer using encrypted USB stick:
  - [X] ~/.priv/tstick.img
  - [ ] ~/.priv/ostick.img
- [X] sudo cat > /root/mount-stick.sh
- [X] mkdir ~/tstick
- [X] sudo /root/mount-stick.sh tstick
- .ssh/config
  - [ ] mkdir ~/.ssh; ln -s ~/tstick/.ssh/config .ssh/

- git clone
  - [ ] git-linus.adb-centralen.se:linus/linus
  - [ ] git-linus.adb-centralen.se:linus/src

- [ ] sudo cat > /root/setup-stuff.sh <<EOF
#! /bin/sh
/root/mount-stick.sh $@
journalctl -f &
 
#tail -F /var/log/kern.log | egrep -v 'IN=.*(DST=(255\.255\.255\.255|224\.0\.0\.|192\.36\.125\.255)|DPT=(137|17500))' &
#tail -F /var/log/daemon.log &
 
tail -F /var/log/tor/log &
tail -F /var/log/htpdate.log &
EOF

- [ ] htpdate

- [ ] tor browser
  - curl -A '' -x socks4a://127.0.0.1:9050/ -LO https://www.torproject.org/dist/torbrowser/9.0.5/tor-browser-linux64-9.0.5_en-US.tar.xz
  - curl -A '' -x socks4a://127.0.0.1:9050/ -LO https://www.torproject.org/dist/torbrowser/9.0.5/tor-browser-linux64-9.0.5_en-US.tar.xz.asc
  - gpg --verify tor-browser-linux64-9.0.5_en-US.tar.xz.asc

*** Signal through flatpak
    $ sudo apt install flatpak
...
    $ flatpak remote-add --user flathub https://flathub.org/repo/flathub.flatpakrepo
...    
    $ flatpak remote-add --user flathub https://flathub.org/repo/flathub.flatpakrepo
...
Required runtime for org.signal.Signal/x86_64/stable (runtime/org.freedesktop.Platform/x86_64/21.08) found in remote flathub
Do you want to install it? [Y/n]: 

org.signal.Signal permissions:
    ipc     network     pulseaudio     x11     devices     file access [1]     dbus access [2]     bus ownership [3]

    [1] xdg-desktop, xdg-documents, xdg-download, xdg-music, xdg-pictures, xdg-public-share, xdg-videos
    [2] org.freedesktop.Notifications, org.freedesktop.portal.Background, org.kde.StatusNotifierWatcher
    [3] org.kde.*


        id                                              Branch            Op           Remote            Download
 1.     org.freedesktop.Platform.GL.default             21.08             i            flathub           < 128.6 MB
 2.     org.freedesktop.Platform.Locale                 21.08             i            flathub           < 324.9 MB (partial)
 3.     org.freedesktop.Platform.VAAPI.Intel            21.08             i            flathub            < 11.6 MB
 4.     org.freedesktop.Platform.openh264               2.0               i            flathub             < 1.5 MB
 5.     org.freedesktop.Platform                        21.08             i            flathub           < 198.6 MB
 6.     org.signal.Signal                               stable            i            flathub           < 152.5 MB

    $ flatpak run org.signal.Signal
...
config/get: Did not find ephemeral config file, cache is now empty object
libva error: vaGetDriverNameByIndex() failed with unknown libva error, driver_name = (null)
(node:80) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
(Use `exe --trace-deprecation ...` to show where the warning was created)
**** upgrading 5.22.0 -> 5.29.1 <2022-01-26 Wed>
flatpak update org.signal.Signal
...

besk:~% flatpak info org.signal.Signal 

Signal Desktop - Private messenger

          ID: org.signal.Signal
         Ref: app/org.signal.Signal/x86_64/stable
        Arch: x86_64
      Branch: stable
     Version: 5.29.1
     License: GPL-3.0
      Origin: flathub
  Collection: org.flathub.Stable
Installation: user
   Installed: 361.9 MB
     Runtime: org.freedesktop.Platform/x86_64/21.08
         Sdk: org.freedesktop.Sdk/x86_64/21.08

      Commit: 995a677e3cd85e33d643fee0360770d6a8dc71d51128ff9314f0b5a3ed85f93b
      Parent: d893803877b517bf74fdd75cc29da56bcb5fdf100c6d3ae8ea29d20fdd47b50a
     Subject: Update signal-desktop_5.29.0_amd64.deb to 5.29.1 (#262) (50babf4f)
        Date: 2022-01-26 06:39:06 +0000
besk:~% flatpak run org.signal.Signal 
[2 preload-host-spawn-strategy] Running: /app/bin/zypak-helper child - /app/Signal/signal-desktop --type=zygote --enable-crashpad
Set Windows Application User Model ID (AUMID) { appUserModelId: 'org.whispersystems.signal-desktop' }
NODE_ENV production
NODE_CONFIG_DIR /app/Signal/resources/app.asar/config
NODE_CONFIG {}
ALLOW_CONFIG_MUTATIONS undefined
HOSTNAME undefined
NODE_APP_INSTANCE undefined
SUPPRESS_NO_CONFIG_WARNING undefined
SIGNAL_ENABLE_HTTP undefined
userData: /home/linus/.var/app/org.signal.Signal/config/Signal
config/get: Successfully read user config file
config/get: Successfully read ephemeral config file
LaunchProcess: failed to execvp:
xdg-settings
LaunchProcess: failed to execvp:
xdg-settings
[2:0126/090355.172596:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket /run/dbus/system_bus_socket: No such file or directory
[2:0126/090355.312749:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket /run/dbus/system_bus_socket: No such file or directory
[2:0126/090355.312832:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket /run/dbus/system_bus_socket: No such file or directory
[2:0126/090355.312875:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket /run/dbus/system_bus_socket: No such file or directory
libva error: vaGetDriverNameByIndex() failed with unknown libva error, driver_name = (null)
[47:0126/090355.526488:ERROR:sandbox_linux.cc(376)] InitializeSandbox() called with multiple threads in process gpu-process.
(node:68) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
(Use `exe --trace-deprecation ...` to show where the warning was created)


*** OLD stuff (2018)
**** os: debian 9 (stretch)
- BIOS settings: booting from USB stick: legacy only (and only _left_ USB slot working?)
- apt install apt-transport-tor
- vi /etc/apt/sources.list # s/http:/tor+http:/g' and see https://onion.debian.org/
- in sources.list, add 'contrib non-free' after 'main'

** Windows -- Lenovo Y520 "LAPTOP-CKH417UJ"
CPU: Intel Core i5-7300HQ @ 2.50Ghz
RAM: 8 GB
Device ID: 2D54D9E9-821C-4716-A4EA-30E61A1C0F97
Windows Product ID: 00325-96300-65112-AAOEM

** vkg-sw0 -- tp-link TL-SG105E 3.0
Location: VKG
IP addr: 192.168.33.1/24
See [[file:~/verkligen/sysadm/vkg-net/vkg-sw0/vkg-sw0.md][file:~/verkligen/sysadm/vkg-net/vkg-sw0/vkg-sw0.md]]

** vkg-sw1 -- netgear prosafe gigabit 8 port VPN firewall FVS318G
Where
    - 2022-04-25: on shelf

MAC Address: 	e0:46:9a:b7:b0:03
System Name: 	FVS318G
Firmware Version: 	
    - 2022-02-17: 3.1.1-18
    - 2021: 3.0.7-34

IP addresses
- 192.168.1.1
- exposing no open TCP ports on port 8 AFAICT <2021-09-09 Thu>
- lots of open ports on physical port 2 though: 23, 80, 443, 49152
ssh vm86.verkligendata.se ip ad add 192.168.1.10/24 dev eno1
ssh -NfL 4904:192.168.1.1:443 vm86.verkligendata.se
ssh vm86.verkligendata.se ip ad del 192.168.1.10/24 dev eno1

how to upgrade fw
- https://kb.netgear.com/25701/FVS318G-Firmware-Version-3-1-1-18
  Last Updated:11/28/2016 | Article ID: 25701 
- Firmware Version: 	3.1.1-18

** vkg-sw2 -- D-Link DGS-1210-10
IP address: 192.168.0.2:80

Where:
  - 2022: VKG top-of-rack

General info: https://files.dlink.com.au/products/DGS-1210-10P/

Model: D-Link DGS-1210-10
S/N: TM0B117000364
MAC Address 	08-5A-11-A2-A6-50
Purchase date: 2022-02
Installation date: 2022-03-10

Boot Version 	1.01.001
Firmware Version 	6.20.007
Hardware Version 	F1

We jump on sigwaitinfo.
NOTE: This address (.100) is the only "trusted host" configured in the switch.

    root@sigwaitinfo:~# ip ad add 192.168.0.100/24 dev enp3s0

Make sure that we're using the correct source address. Set up routing
manually if needed.

    root@sigwaitinfo:~# ip r get 192.168.0.2
    192.168.0.2 dev enp3s0 src 192.168.0.100 uid 0 

Web access (no TLS).

    ssh -NfL 9090:192.168.0.2:80 sigwaitinfo.verkligendata.se
    firefox http://localhost:9090/

SSH access, expecting key `cardno:000604156811`.
    ssh -NfL 9022:192.168.0.2:22 sigwaitinfo.verkligendata.se
    ssh -p 9022 -l admin localhost

*** Upgrading to "REV F"
http://files.dlink.com.au/products/DGS-1210-10P/REV_F/Firmware/Firmware_6.30.016/DGS-1210-Fx-Series_Firmware_6.30.016.zip
Runtime: v6.30.016, Boot: 1.02.001, https://files.dlink.com.au/products/DGS-1210-10P/REV_F/Firmware/Firmware_6.30.016/DGS-1210_Series_Firmware_Release_Notes_v6.30.016.pdf
besk:Downloads% sha512sum DGS-1210-Fx-Series_Firmware_6.30.016.zip 
42ba4135822867abadd3b4a5f7a7afa672e59ea8ee032b1739a11e57fa99ea3653a767be130d3adbde27eac30f68d718808c4667bf71c556bd5c56a23c867d54  DGS-1210-Fx-Series_Firmware_6.30.016.zip
besk:unpack% unzip ../DGS-1210-Fx-Series_Firmware_6.30.016.zip 
Archive:  ../DGS-1210-Fx-Series_Firmware_6.30.016.zip
  inflating: !READ_ME!.txt           
  inflating: DGS-1210-FX-SERIES-FX-6-30-016-FIRST.hex  
  inflating: DGS-1210-FX-SERIES-FX-6-30-016-SECOND.con  
Tried upgrading to -FIRST twice with the same result: "Firmware Upgrade Fail"
Tried upgrading to -SECOND once with the same result: "Firmware Upgrade Fail"

Trying http://files.dlink.com.au/products/DGS-1210-10P/REV_F/Firmware/Firmware_6.12.001/DGS-1210-F1-SERIES-F1-6-12-B001.zip
besk:fw% sha512sum DGS-1210-F1-SERIES-F1-6-12-B001.zip 
6a4696d4bd6db32edd9ef1a951adb0d44d387f5ab51ed9a811b6bc3d1b3056ed604b9fdc6c17877a6f71ddce619f976a920e942b873a7285053e08bb50ebcf96  DGS-1210-F1-SERIES-F1-6-12-B001.zip
Tried upgrading using the DGS-1210-F1-SERIES-F1-6-12-B001.hex file: Firmware Upgrade Fail

Trying http://files.dlink.com.au/products/DGS-1210-10P/REV_F/Firmware/Firmware_6.10.007/DGS-1210-F1-SERIES-F1-6-10-007.hex
besk:fw% sha512sum DGS-1210-F1-SERIES-F1-6-10-007.hex
4ab8561160ec49936ee22a4cc966c2272d12c43f67254545272f11839826b4ab819f37a9fd0f7b94a2ee7711d70323bc4cfdd831e68fb6d7b2ed7886ed54d8b1  DGS-1210-F1-SERIES-F1-6-10-007.hex
Failed. But wait, if this is 6.10 and we're running 6.20, maybe not so bad after all.

** vkg-sw3 -- Huawei S5320-52X-EI-AC
IP address: 192.168.0.3
Serial: logsrv-01# screen /dev/ttyS0 9600

Installed on: 2022-11-14
Location: 2022-11-14 VKG On top of network rack

*** bonding
https://support.huawei.com/enterprise/en/doc/EDOC1000141933/56fa680f/example-for-configuring-link-aggregation-in-lacp-mode

[vkg-sw3]lacp priority 100
[vkg-sw3]interface Eth-Trunk 1
[vkg-sw3-Eth-Trunk1]port link-type trunk 
[vkg-sw3-Eth-Trunk1]mode lacp 
[vkg-sw3-Eth-Trunk1]quit
[vkg-sw3]interface GigabitEthernet 0/0/2
[vkg-sw3-GigabitEthernet0/0/2]eth-trunk 1 mode active
[vkg-sw3-GigabitEthernet0/0/2]lacp priority 100
[vkg-sw3-GigabitEthernet0/0/4]quit
[vkg-sw3]interface GigabitEthernet 0/0/4
[vkg-sw3-GigabitEthernet0/0/4]eth-trunk 1 mode active
[vkg-sw3-GigabitEthernet0/0/4]lacp priority 100
[vkg-sw3-GigabitEthernet0/0/4]quit

[vkg-sw3]vlan batch 48
[vkg-sw3]interface Eth-Trunk 1
[vkg-sw3-Eth-Trunk1]port trunk allow-pass vlan 48

** snowflake-01.torproject.net
- A SuperMicro X11: https://www.supermicro.com/en/products/motherboard/X11DDW-NT
  - BIOS revision 3.5
- From Mullet: [[file:~/clown/Verkligendata/Uppdrag & projekt/Snowflake bridge/7647.Order-18397.pdf][file:~/clown/Verkligendata/Uppdrag & projekt/Snowflake bridge/7647.Order-18397.pdf]]
- See also [[file:~/clown/Snowflake bridge/snowflake-01.md][file:~/clown/Snowflake bridge/snowflake-01.md]] 

- IP
193.187.88.40/29
GW: .41
2a0c:dd40:1:b::/64
GW: 2a0c:dd40:1:b::1

** next router
https://mullet.se/product.html?product_id=347351
** DECOMMISSIONED
*** nc.verkligendata.se -- VM @ Tranquillity
 - VM @ tranquillity; 1 VCPU; 1G RAM; 30G SSD
 - Started 2020-04-06
**** Installing Nextcloud
 pkg install secadm-kmod secadm nextcloud-php74 apache24 mod_php74 mariadb104-server dehydrated
 service mysql-server onestart
 mysql_secure_installation # unix socket; set root pw; remove anon; no remote root; remove test

 # secadm
 cp sic/www/nextcloud/config/secadm.rules /usr/local/etc/
 sysrc secadm_enable=yes
 service secadm restart

 # Apache
 vi /usr/local/etc/apache24/httpd.conf
 scp sic/www/nextcloud/config/nextcloud.conf sic/www/nextcloud/config/all-http.conf /usr/local/etc/apache24/Includes/
 ## NOTE: Edit both files -- they're not generic!

 FIXME: memcached

 # PHP
 cd /usr/local/etc
 ln -s php.ini-production php.ini
 cat <<EOF >> php.ini
 opcache.enable=1
 opcache.enable_cli=1
 opcache.interned_strings_buffer=8
 opcache.max_accelerated_files=10000
 opcache.memory_consumption=128
 opcache.save_comments=1
 opcache.revalidate_freq=1
 EOF

 vi php.ini # memory_limit = 512M

 ## Data cache is probably fixed by default, but do check.
 # pkg install php74-pecl-APCu
 # config/
 #  'memcache.local' => '\OC\Memcache\APCu',
 vi php.ini # apc.enable_cli = 1

 service apach24 restart

 # Letsencrypt
 cat <<EOF > /usr/local/etc/dehydrated/domains.txt
 nc.verkligendata.se
 EOF
 sysrc -f /etc/periodic.conf weekly_dehydrated_enable=yes weekly_dehydrated_user="_letsencrypt"

 # Nextcloud
 config/config.php
 # NOTE: should have added `--data-dir /var/db/nextcloud` to the following command:
 cd /usr/local/www/nextcloud && su -m www -c "php ./occ maintenance:install --database mysql --database-name nextcloud --database-user root --admin-user admin38"
 config/config.php

 FIXME: email

 # Autostart
 sysrc apache24_enable=yes mysql_enable=yes
 service mysql-server start
 service apache24 start

 # Configure NextCloud
 - secure the admin account
   - install app "Two-Factor U2F"
   - save backup codes and add U2F device
 - fix up the db
   - su -m www -c "php /usr/local/www/nextcloud/occ db:add-missing-indices"
   - su -m www -c "php /usr/local/www/nextcloud/occ db:convert-filecache-bigint"

*** brk.verkligendata.se -- VM @ Tranquillity until <2020-10-31 Sat>
 - VM at tranquillity.se
    v4: 185.97.32.63/24
    v6: 2a00:66c0:1:1::63/64
    interface: vtnet0
    dns: 185.97.32.6
    def v4 gw: 185.97.32.1
    def v6 gw: 2a00:66c0:1:1::1
**** extra available blocks
***** 185.97.32.64/28
      64
      65 bpf
      66 recv
      67 pread
      68 wait
      79
***** 2a00:66c0:1:1::64/124
      64
      65 bpf
      66 recv
      67 pread
      68 wait
      79

* DFRI
NOTE: See ~/p/dfri/dfriadm/sysadmin/hosts for an updated list.
** tex.dfri.se -- 1U Fujitsu PRIMERGY RX100 S3
http://www.fujitsu.com/global/services/computing/server/ia/rackserver/rx100_s3.html
CPU: Intel(R) Pentium(R) 4 CPU 3.00GHz (2992.51-MHz K8-class CPU)

https://proj.adb-centralen.se/~fti/fti/infrastruktur/

Donated by Johan N. Installed in FF at the time of the second meeting
with DFRI, 2011-05-31.

*** On board Ethernet
BCM5721

*** New eth card
Fredrik Reutersvärd offers us a [[http://www.bootsector.com/intel-lan-card-pro1000mt-e-g021-03-1161][Intel LAN card PRO/1000MT
E-G021-03-1161]].  It's based on Intel's 82545 chipset according to [[http://www.ebay.com/itm/Dell-W1392-Intel-PRO-1000MT-Gigabit-PCI-LAN-Card-/220791545415%3Fpt%3DCOMP_EN_Servers&hash%3Ditem3368339e47][this
link]] so it should work with the FreeBSD [[http://www.freebsd.org/releases/8.2R/hardware.html#ETHERNET][em(4) driver]].

* NORDUnet
** tor.nordu.net -- PowerEdge R410/01V648
Ubuntu 14.04.1 LTS
Netblocks: 109.105.109.144/28, 109.105.109.160/29
*** bridges
See [[file:~/p/tor/tor.org::*ndn%20@%20tor.nordu.net%20(Ubuntu)][ndn  @ tor.nordu.net (Ubuntu)]].
**** obfs4
GOPATH=$HOME/usr/go; export GOPATH

# 2022-08
git clone https://gitlab.com/yawning/obfs4
cd obfs4/
go build -o obfs4proxy/obfs4proxy ./obfs4proxy
sudo cp obfs4proxy/obfs4proxy /usr/local/bin/

# historical
go get git.torproject.org/pluggable-transports/obfs4.git/obfs4proxy
sudo cp ~linus/usr/go/bin/obfs4proxy /usr/local/bin/

* Sigsum / Glasklar
** stime.verkligendata.se (2021-06-18) -- Supermicro X11SCL-F, Mullvad property
Delivered 2021-03-18
Racked VKG 2021-03-21
RAM 16GB
BIOS Version 1.5, "10/05/2020"

*** ethernet interfaces
**** BMC
BMC on "Dedicated LAN", VLAN 66, 192.168.66.10/24, no gw
  Adding VLAN 66 on vm86: ip link add link eno0 name eno0.66 type vlan id 66 && ip link set up eno0.66
  Setting an IP: ip addr add 192.168.66.1/24 dev eno0.66
  Listing VLAN interfaces: ip -d link show type vlan

Example: Adding eno0.66 on vm86 to a new virtual network interface in (old!) tee.sigsum.org
  brctl addbr br1
  brctl addif br1 eno0.66
  ip link set up br1
  virsh attach-interface tee.sigsum.org bridge br1 --live --config

NOTE: tee was reinstalled on logsrv-01 on 2022-10-24, new bridge interface is br-ipmi

Reach the BMC web interface by jumping on tee. See
passdb:hosts/stime:IPIM:ADMIN for more access info.

    ssh -NfL 4711:192.168.66.10:443 tee.sigsum.org
    firefox https://localhost:4711/

**** on-board 1
**** on-board 2
**** dual-i/f card
- port 1
- port 2

*** flashing coreboot
FIXME: what? coreboot has support for this board?

apt install git gcc make pciutils-dev
git clone https://review.coreboot.org/flashrom && cd flashrom
make CONFIG_ENABLE_LIBUSB1_PROGRAMMERS=no

Reboot system with `iomem=relaxed`.
./flashrom -p internal -r current.rom

*** building a new ST ball
**** Pre upgrading coreboot to Feb/Mar 2021 changes in the build tooling
ssh linus@nanosleep.adb-centralen.se
cd ~/usr/src/st/system-transparency
git checkout vdse/hypervisor
operating-system/debian/make_debian.sh
scripts/create_and_sign_bootball.sh
#scp -o 'identityfile ~/.ssh/vm86' bootballs/ball-2021-04-22-14-07-59.stboot root@vm86.verkligendata.se:/stdata/stboot/bootballs/new/

** logsrv-02.sigsum.org (2022-04) -- Supermicro X11SCH-F-O
Placement: OBE Kista
IPv4 address: 46.227.66.162/29
IPv6 address: 2a0c:dd40:1:2::162/64

- https://www.supermicro.com/en/products/motherboard/X11SCH-F ([[file:~/clown/Verkligendata/Datorhall/Supermicro-X11SCH-F-MNL-2105.pdf][copy]])
- https://www.supermicro.com/support/resources/results.aspx
- https://www.supermicro.com/support/resources/getfile.php?SoftwareItemID=14075&type=releasenote ([[file:~/clown/Verkligendata/Datorhall/X11SCH-(LN4)F_BIOS_1.6_release_notes.pdf][copy]])

Console: `screen /dev/ttyUSB0 9600` on getrandom (46.227.66.163)

*** Boot
No UEFI boot.

Might want to investigate:
- https://forums.debian.net/viewtopic.php?t=145105 which says use legacy, not UEFI
- https://outflux.net/blog/archives/2018/04/19/uefi-booting-and-raid1/
- https://www.koendiels.be/mdadm-and-a-single-lvm-to-boot-from-on-a-debian-based-system

*** Storage
**** Installation, 2022-05-06
mdadm --create /dev/md0 -N sys -l 1 -n 2 /dev/nvme[0,1]n1

Later mysteriously renamed to /dev/md127.

grub-install /dev/md127
grub-install: error: diskfilter writes are not supported
https://bugs.launchpad.net/ubuntu/+source/grub2/+bug/1756517

Physically removing the NVMe disks after a lot (!) of mishaps where
the Debian installer failed at installing GRUB properly. Mounted them
again after installation was finished.

This is what we finally ended up with, not because it's the optimal
configuration but because we were out of time:

- Set up /dev/md0 on /dev/sd[ab]1
- Set up LVM on /dev/md0p5, with separate LV's for /, /home, /tmp/ and /var.
- Installed GRUB to /dev/sda

After more configuration, we tried the following for the mirror on the
NVMe's (UUID from mdadm --detail /dev/md127):

```
root@logsrv-02:~# echo "ARRAY /dev/md/1 metadata=1.2 UUID=3ca0977c:13e1d147:b439c1bd:b4be9f67 name=nonameyet" >> /etc/mdadm/mdadm.conf 
root@logsrv-02:~# update-initramfs -u
update-initramfs: Generating /boot/initrd.img-5.10.0-14-amd64
```

But that didn't seem to change anything -- after a reboot, the device
was still named /dev/md127. Rolled back the change by commenting out
the ARRAY line in /etc/mdadm/mdadm.conf but didn't re-run
update-initramfs.

**** Resizing /home
- temporarily enable root login over ssh 
- log out ordinary users using /home
- ssh -l root
- umount /home
- resize2fs /dev/mapper/logsrv--02--ssd-home 10G
- lvreduce -L 10G logsrv-02-ssd/home
- mount /home

**** Status 2022-06-16
Nothing done since installation.

Here's what it looks like currently, with the peculiar partition
layout by the Debian installer.


```
root@logsrv-02:~# date; lvs; vgs; pvs
Thu 16 Jun 2022 02:26:50 PM CEST
  LV     VG            Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  home   logsrv-02-ssd -wi-ao----  10.00g                                                    
  root   logsrv-02-ssd -wi-ao----  23.28g                                                    
  swap_1 logsrv-02-ssd -wi-ao---- 976.00m                                                    
  tmp    logsrv-02-ssd -wi-ao----  <1.86g                                                    
  var    logsrv-02-ssd -wi-ao----   9.31g                                                    
  VG             #PV #LV #SN Attr   VSize   VFree   
  logsrv-02-nvme   1   0   0 wz--n- 894.12g  894.12g
  logsrv-02-ssd    1   5   0 wz--n- 893.64g <848.24g
  PV         VG             Fmt  Attr PSize   PFree   
  /dev/md0p5 logsrv-02-ssd  lvm2 a--  893.64g <848.24g
  /dev/md127 logsrv-02-nvme lvm2 a--  894.12g  894.12g
root@logsrv-02:~# parted /dev/md0 p
Model: Linux Software RAID Array (md)
Disk /dev/md0: 960GB
Sector size (logical/physical): 512B/4096B
Partition Table: msdos
Disk Flags: 

Number  Start  End    Size   Type      File system  Flags
 1      1024B  512MB  512MB  primary   ext2
 2      512MB  960GB  960GB  extended
 5      512MB  960GB  960GB  logical                lvm
```
```
root@logsrv-02:~# lsblk
NAME                           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda                              8:0    0 894.3G  0 disk  
└─sda1                           8:1    0 894.3G  0 part  
  └─md0                          9:0    0 894.1G  0 raid1 
    ├─md0p1                    259:2    0 488.3M  0 part  /boot
    ├─md0p2                    259:3    0     1K  0 part  
    └─md0p5                    259:4    0 893.6G  0 part  
      ├─logsrv--02--ssd-root   253:0    0  23.3G  0 lvm   /
      ├─logsrv--02--ssd-var    253:1    0   9.3G  0 lvm   /var
      ├─logsrv--02--ssd-swap_1 253:2    0   976M  0 lvm   [SWAP]
      ├─logsrv--02--ssd-tmp    253:3    0   1.9G  0 lvm   /tmp
      └─logsrv--02--ssd-home   253:4    0    10G  0 lvm   /home
sdb                              8:16   0 894.3G  0 disk  
└─sdb1                           8:17   0 894.3G  0 part  
  └─md0                          9:0    0 894.1G  0 raid1 
    ├─md0p1                    259:2    0 488.3M  0 part  /boot
    ├─md0p2                    259:3    0     1K  0 part  
    └─md0p5                    259:4    0 893.6G  0 part  
      ├─logsrv--02--ssd-root   253:0    0  23.3G  0 lvm   /
      ├─logsrv--02--ssd-var    253:1    0   9.3G  0 lvm   /var
      ├─logsrv--02--ssd-swap_1 253:2    0   976M  0 lvm   [SWAP]
      ├─logsrv--02--ssd-tmp    253:3    0   1.9G  0 lvm   /tmp
      └─logsrv--02--ssd-home   253:4    0    10G  0 lvm   /home
nvme0n1                        259:0    0 894.3G  0 disk  
└─md127                          9:127  0 894.1G  0 raid1 
nvme1n1                        259:1    0 894.3G  0 disk  
└─md127                          9:127  0 894.1G  0 raid1 
root@logsrv-02:~# parted /dev/sda p
Model: ATA SAMSUNG MZ7L3960 (scsi)
Disk /dev/sda: 960GB
Sector size (logical/physical): 512B/4096B
Partition Table: msdos
Disk Flags: 

Number  Start   End    Size   Type     File system  Flags
 1      1049kB  960GB  960GB  primary  ext2         boot, raid

root@logsrv-02:~# parted /dev/sdb p
Model: ATA SAMSUNG MZ7L3960 (scsi)
Disk /dev/sdb: 960GB
Sector size (logical/physical): 512B/4096B
Partition Table: msdos
Disk Flags: 

Number  Start   End    Size   Type     File system  Flags
 1      1049kB  960GB  960GB  primary               boot, raid
```

*** Network
46.227.66.160/29, gw: 161
2a0c:dd40:1:2::/64, gw: ::1

** logsrv-01.sigsum.org
Placement: VKG

*** Installation
**** Installation 2022-06-16
It would have been nice to run coreboot but alas, we don't have time
to do that right now.

Given the trouble back in may with installing GRUB on a NVMe-backed
mirror, we will not even try it this time around. Instead we create a
mirror on the SSD disks and install to that.

Trying this:
UEFI booting from the md mirror on the SSD's (/dev/md127) but with two
important steps done manually from a "rescue shell" with root mounted
from the mirror:

- grub-install /dev/md127
- parted /dev/md127 toggle pmbr_boot

Need to `apt update && apt install parted` first.

UPDATE: this doesn't seem to work -- unable to boot from SSD's :(

**** Installation 2022-06-21, trying UEFI again
Mounted the NVMe disks again.
Partitioned them like this:
TODO

Ran, from a rescue shell, grub-install /dev/nvme0n1 (and 1n1), which
made dd report something looking like EFI on sector 2 (0x200).
**** Installation 2022-06-21, trying LEGACY/MBR instead
Didn't even bother to try booting from an md device this time and
instead made two primary partitions on each NVMe and installed GRUB
only to the first one. And configured BIOS for LEAGCY boot.

That didn't work, so I started the installer again and picked "install
boot loader", this time picking the other NVMe. Nope.

Tried again, without RAID1. Nope.

Removing the NVMe, no raid. Ok, booting UEFI.

**** Moving / and some
From nc task:
/dev/md126 has a broken mirror, with only /dev/sdb1 taking part.
We'd like to move the five VG's from /dev/sda3 (to /dev/md127 which is
a mirror backed by nvme's) and partition /dev/sda like /dev/sdb and
add /dev/sda1 to /dev/md126.
But / lives in one of them so there's the question of booting
here. This is delicate.
See https://pad.sigsum.org/p/cNreIZFpRikrdGF_3KKx for the disk and fs
layout as of 2022-09-02.

root@logsrv-01:~# date
Thu 15 Sep 2022 06:42:13 AM CEST

root@logsrv-01:~# efibootmgr -v
BootCurrent: 0000
Timeout: 1 seconds
BootOrder: 0000,0009,0003,0004,0005,0006,0007,0001
Boot0000* debian        HD(1,GPT,8766dc0a-d8d8-460b-82f6-a3b68ae72962,0x800,0x100000)/File(\EFI\DEBIAN\SHIMX64.EFI)
Boot0001  Hard Drive    BBS(HD,,0x0)/VenHw(5ce8128b-2cec-40f0-8372-80640e3dc858,0200)..GO..NO..........S.A.M.S.U.N.G. .M.Z.7.L.3.9.6.0.H.C.J.R.-.0.0.A.0.7...................\.,.@.r.d.=.X..........A...........................>..Gd-.;.A..MQ.
.L.6.S.2.6.E.N.R.0.0.C.1.7.0.9. . . . . . ........BO..NO..........S.A.M.S.U.N.G. .M.Z.7.L.3.9.6.0.H.C.J.R.-.0.0.A.0.7...................\.,.@.r.d.=.X..........A...........................>..Gd-.;.A..MQ..L.6.S.2.6.E.N.R.0.0.C.1.7.6.9. . . .
 . . ........BO
Boot0003  UEFI: Built-in EFI Shell      VenMedia(5023b95c-db26-429b-a648-bd47664c8012)..BO
Boot0004  (B2/D0/F0) UEFI PXE: IPv4 Intel(R) I210 Gigabit  Network Connection(MAC:3cecef8a6486) PciRoot(0x0)/Pci(0x1b,0x4)/Pci(0x0,0x0)/MAC(3cecef8a6486,1)/IPv4(0.0.0.00.0.0.0,0,0)..BO
Boot0005  (B3/D0/F0) UEFI PXE: IPv4 Intel(R) I210 Gigabit  Network Connection(MAC:3cecef8a6487) PciRoot(0x0)/Pci(0x1b,0x5)/Pci(0x0,0x0)/MAC(3cecef8a6487,1)/IPv4(0.0.0.00.0.0.0,0,0)..BO
Boot0006  (B2/D0/F0) UEFI PXE: IPv6 Intel(R) I210 Gigabit  Network Connection(MAC:3cecef8a6486) PciRoot(0x0)/Pci(0x1b,0x4)/Pci(0x0,0x0)/MAC(3cecef8a6486,1)/IPv6([::]:<->[::]:,0,0)..BO
Boot0007  (B3/D0/F0) UEFI PXE: IPv6 Intel(R) I210 Gigabit  Network Connection(MAC:3cecef8a6487) PciRoot(0x0)/Pci(0x1b,0x5)/Pci(0x0,0x0)/MAC(3cecef8a6487,1)/IPv6([::]:<->[::]:,0,0)..BO
Boot0009* debian        HD(1,GPT,8766dc0a-d8d8-460b-82f6-a3b68ae72962,0x800,0x100000)/File(\EFI\DEBIAN\GRUBX64.EFI)..BO

root@logsrv-01:~# blkid | egrep 8766dc0a-d8d8-460b-82f6-a3b68ae72962
/dev/sda1: UUID="C026-7934" BLOCK_SIZE="512" TYPE="vfat" PARTUUID="8766dc0a-d8d8-460b-82f6-a3b68ae72962"

https://wiki.debian.org/UEFI

So UEFI cares about /dev/sda1 and maybe let's just not touch the
partition table on /dev/sda and instead of adding /dev/sda1 to the
mirror we move the five volumes from /dev/sda3 and use that for the
mirror.

Let's hope that since sda3 is slightly larger than md126 -- md126 is
893.14g (936534016 blocks) while sda3 is 893.27g -- this will work as
expected, with only a small amount of storage wasted.

md126 : active raid1 sdb1[0]
      936534016 blocks super 1.2 [2/1] [U_]
      bitmap: 7/7 pages [28KB], 65536KB chunk

*** Network
Port 4 in switch.
91.223.231.10/25
2001:67c:8a4:1::10/64

*** Storage
It seems like we didn't set up _any_ md mirrors at installation.

So, for the NVMe's:

    mdadm --create /dev/md0 --name db --level 1 --raid-devices 2 /dev/nvme[0,1]n1
    pvcreate /dev/md0
    
Hmm, the NVMe's are only 100G, not 1T. They should really be used for
system disks rather than database. So the name 'db' is misleading and
we should fix it.

And for the SSD we're not booting from, which will be the new PV for
database data:

    mdadm --create /dev/md1 --name db1 --level 1 --raid-devices 2 /dev/sdb1 missing

Later, move VG logsrv-01-vg to /dev/md127.

*** KVM
Create a bridge for VM's, enslaving eno1

    apt install bridge-utils # for brctl

    cat > /etc/systemd/network/20-vm-bridge.netdev <<EOF
    [NetDev]
    Name = br0
    Kind = bridge

    [Bridge]
    STP = false
    EOF

    cat > /etc/systemd/network/20-vm-bridge.network <<EOF
    [Match]
    Name = br0

    [Network]
    Address = 91.223.231.10/25
    Gateway = 91.223.231.1
    Address = 2001:67c:8a4:1::10/64
    Gateway = 2001:67c:8a4:1::1
    EOF

    cp /etc/systemd/network/10-static-vkg.network  /etc/systemd/network/10-static-vkg.network.BAK
    cat > /etc/systemd/network/10-static-vkg.network <<EOF
    [Match]
    Name = eno1

    [Network]
    Description = Serving br0
    Bridge = br0
    EOF

    systemctl restart systemd-networkd; sleep 2
    networkctl

*** Mariadb
As of 2023-03-10, the MariaDB server requires a password for root@localhost.
New Ansible role is setting it. I'm not convinced it's the right thing but don't
have the energy to have that changed right now.

We solve it with 

    touch /root/.my.cnf
    chmod 600 /root/.my.cnf
    printf "[client]\npassword='$MYPASSWORD'\n" > /root/.my.cnf

where MYPASSWORD is whatever we have set Ansible variable
mysql_root_password to.

** nextcloud-01.sigsum.org (2022-08-23) -- VM @ logsrv-01
root@logsrv-01:~# ./mkvm.sh nextcloud-01.sigsum.org 2 4096 40
...
root@logsrv-01:~# lvcreate -n nextcloud -L 30G logsrv-01-nvme
  Logical volume "nextcloud" created.
root@logsrv-01:~# virsh attach-disk nextcloud-01.sigsum.org /dev/logsrv-01-nvme/nextcloud vdb --live --config --subdriver raw --sourcetype block
Disk attached successfully

pvcreate /dev/vdb
vgcreate nextcloud-vg /dev/vdb
lvcreate -n ncdata -l 100%FREE nextcloud-vg
mkfs.ext4 /dev/nextcloud-vg/ncdata 
echo "UUID=$(lsblk -no UUID /dev/nextcloud-vg/ncdata) /var/nextcloud ext4 defaults 0 2" >> /etc/fstab
mkdir /var/nextcloud
mount -a

apt install php-fpm php-zip php-pgsql php-bz2 php-intl php-imagick php-bcmath php-gmp

cd /tmp
curl -sL https://nextcloud.com/nextcloud.asc | gpg --import 
gpg --list-key 28806A878AE423A28372792ED75899B9A724937A
curl -LO https://download.nextcloud.com/server/releases/nextcloud-24.0.4.tar.bz2
curl -LO https://download.nextcloud.com/server/releases/nextcloud-24.0.4.tar.bz2.asc
gpg --verify nextcloud-24.0.4.tar.bz2.asc nextcloud-24.0.4.tar.bz2
tar x -C /var/nextcloud -f nextcloud-24.0.4.tar.bz2
mv /var/nextcloud/nextcloud /var/nextcloud/www
chown -R www-data:www-data /var/nextcloud/www

echo "deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
curl -s https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
apt update
apt install postgresql
sudo -u postgres psql
> CREATE USER nc_admin WITH PASSWORD 'some-secret';
> CREATE DATABASE nextcloud TEMPLATE template0 ENCODING 'UNICODE';
> ALTER DATABASE nextcloud OWNER TO nc_admin;
> GRANT ALL PRIVILEGES ON DATABASE nextcloud TO nc_admin;
> \q

# https://docs.nextcloud.com/server/latest/admin_manual/installation/command_line_installation.html
# https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/occ_command.html#command-line-installation-label
cd /var/nextcloud/www
sudo -u www-data php occ maintenance:install --database pgsql --database-name nextcloud --database-user nc_admin --admin-user admin29

: root@nextcloud-01:/var/nextcloud/www# sudo -u www-data php occ maintenance:install --database pgsql --database-name nextcloud --database-user nc_admin --admin-user admin29
: What is the password to access the database with user <nc_admin>?
: What is the password you like to use for the admin account <admin29>?
: Nextcloud was successfully installed

sudo -u www-data php occ config:system:set trusted_domains 0 --value=nc.sigsum.org
sudo -u www-data php occ config:system:set trusted_domains 1 --value=nextcloud.sigsum.org

: root@nextcloud-01:/var/nextcloud/www# sudo -u www-data php occ config:system:get trusted_domains
: nc.sigsum.org
: nextcloud.sigsum.org

while read -r var val; do sudo -u www-data php occ config:system:set "$var" "$val"; done <<EOF
mail_smtpmode --value=sendmail
mail_sendmailmode --value=smtp
mail_from_address --value=nextcloud-admin
mail_domain --value=sigsum.org
default_phone_region --value=SE
overwrite.cli.url --value=https://nc.sigsum.org/
default_locale --value=sv_SE
token_auth_enforced --value=true
logtimezone --value=Europe/Stockholm
EOF

Set the following by editing config/config.php -- the quoting became
just a bit too crazy for me right now.

: 'memcache.local' => '\\OC\\Memcache\\APCu',
: 'remember_login_cookie_lifetime' => 60 * 60 * 24 * 1
: 'session_lifetime' => 60 * 60 * 12
: 'trashbin_retention' => 'auto, 7'

echo '*/5    *       *       *       *       /usr/bin/php -f /var/nextcloud/www/cron.php' | crontab -u www-data -

# https://docs.nextcloud.com/server/latest/admin_manual/installation/harden_server.html#setup-fail2ban
apt install fail2ban
cat > /etc/fail2ban/filter.d/nextcloud.conf <<EOF
[Definition]
_groupsre = (?:(?:,?\s*"\w+":(?:"[^"]+"|\w+))*)
failregex = ^\{%(_groupsre)s,?\s*"remoteAddr":"<HOST>"%(_groupsre)s,?\s*"message":"Login failed:
            ^\{%(_groupsre)s,?\s*"remoteAddr":"<HOST>"%(_groupsre)s,?\s*"message":"Trusted domain error.
datepattern = ,?\s*"time"\s*:\s*"%%Y-%%m-%%d[T ]%%H:%%M:%%S(%%z)?"
EOF
cat > /etc/fail2ban/jail.d/nextcloud.local <<EOF
[nextcloud]
backend = auto
enabled = true
port = 80,443
protocol = tcp
filter = nextcloud
maxretry = 5
bantime = 3600
findtime = 3600
logpath = /var/nextcloud/www/data/nextcloud.log
banaction = nftables
EOF
systemctl reload fail2ban
fail2ban-client status nextcloud

# For SVG support in imagick, do
apt install libmagickcore-6.q16-6-extra

** build-03
sh -x ./mkvm.sh build-03.glasklarteknik.se 2 4096 10 br1 /var/lib/libvirt/boot/Fedora-Server-dvd-x86_64-36-1.5.iso fedora33

dnf remove cockpit
Fri Nov 18 01:50:06 PM CET 2022

** tee.sigsum.org (reinstalled on 2022-10-24) -- VM @ logsrv-01
** getuid.sigsum.org
*** Moving from vm86 to logsrv-01
root@vm86:~# lvdisplay --nosuffix --units s ssd/getuid.sigsum.org 

root@logsrv-01:~# lvcreate -L 62930944s -n getuid.sigsum.org logsrv-01-vg
root@logsrv-01:~# lvdisplay logsrv-01-vg/getuid.sigsum.org 
root@logsrv-01:~# chgrp vmtmp /dev/dm-14

root@getuid:~# env BUP_RATE_LIMIT=- my_bup.sh
root@getuid:~# shutdown -p now

root@vm86:~# export DOMAIN=getuid.sigsum.org
root@vm86:~# virsh autostart --disable $DOMAIN
root@vm86:~# while true; do virsh list | egrep -q $DOMAIN || break; sleep 1; done
root@vm86:~# virsh dumpxml $DOMAIN | ssh -p 4722 -l vmtmp -i /root/.ssh/vmtemp logsrv-01.sigsum.org dd of=$DOMAIN.xml
root@vm86:~# time dd bs=1M if=/dev/ssd/getuid.sigsum.org | ssh -p 4722 -l vmtmp -i /root/.ssh/vmtemp logsrv-01.sigsum.org dd bs=1M of=/dev/logsrv-01-vg/getuid.sigsum.org                                                                     

30728+0 records in
30728+0 records out
32220643328 bytes (32 GB, 30 GiB) copied, 287.092 s, 112 MB/s
0+1910696 records in
0+1910696 records out
32220643328 bytes (32 GB, 30 GiB) copied, 289.477 s, 111 MB/s

real    4m49.931s
user    2m0.111s
sys     0m52.259s

vmtmp@logsrv-01:~$ vi getuid.sigsum.org.xml	# fix disk path to LV and interface bridge=
root@logsrv-01:~# virsh define ~vmtmp/getuid.sigsum.org.xml --validate
root@logsrv-01:~# virsh start getuid.sigsum.org
root@logsrv-01:~# ping -c 1 -4 getuid.sigsum.org
root@logsrv-01:~# ping -c 1 -6 getuid.sigsum.org
root@logsrv-01:~# chgrp disk /dev/dm-14

root@vm86:~# lvchange -an ssd/getuid.sigsum.org
root@vm86:~# lvremove ssd/getuid.sigsum.org
root@vm86:~# virsh undefine getuid.sigsum.org

* Sunet
** datan -- lenovo x260
Delivered 2017-05-02 to TUG.
*** hw and fw
[   19.533530] thinkpad_acpi: Lenovo ThinkPad X260, model 20F600A4MS

Intel Core i7-6500, 2.5GHz, 16GB RAM
MAC addr C85B76C11FD1
Preinstalled OS License SDK0J40697 WIN

UEFI BIOS Version R02ET52W (1.24 (or 1.25?)) 2016-12-05
Embedded Controller Version R02HT30W (1.12)
ME Firmware Version 11.0.12.1008

System-unit serial number PC0JMPPB
System board serial number L1HF6CN007S

New firmware flashed on 2017-05-03 by
$ curl -O https://download.lenovo.com/pccbbs/mobiles/r02uj53d.iso
$ geteltorito -o r02uj53d.image r02uj53d.iso
$ sudo dd if=/u/ISO/Lenovo/r02uj53d.image of=/dev/sdb bs=10M
Booting off the USB stick.
Result: UEFI BIOS Version R02ET53W (1.26) 2017-02-20

**** wifi
- dmesg
  [   19.572807] iwlwifi 0000:04:00.0: Detected Intel(R) Dual Band Wireless AC 8260, REV=0x208
- [hw doc]
- [iwlwifi] says that the microcode to use for 8260 is iwlwifi-8000
- sudo apt install firmware-iwlwifi # from non-free
- [iwlfiwi] says that having Bluetooth enabled can be problematic and
  suggests passing bt_coex_active=0 to the module
  (iwlwifi.bt_coex_active=0 to the kernel), see GRUB_CMDLINE_LINUX in
  /etc/default/grub

[hw doc] https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/dual-band-wireless-ac-8260-brief.pdf
[iwlwifi] https://wireless.wiki.kernel.org/en/users/drivers/iwlwifi

*** os
**** hbsd <2017-07-28 Fri>
- http://installer.hardenedbsd.org/hardened_11_stable_master-LAST/HardenedBSD-11-STABLE-v1100048-amd64-mini-memstick.img
***** suspend/resume
- suspend seems to work, resume not so much -- at least the screen
  does not wake up
- seems like lots of things are being resumed -- typing reboot <ENTER>
  makes the computer reboot
- https://wiki.freebsd.org/SuspendResume
  - debug.acpi.resume_beep=1 indicates that the resume code is run
**** debian stretch <2017-08-03 Thu>
- configure legacy boot only in BIOS, or debian installer will try UEFI which
  does not work
- https://ftp.acc.umu.se/cdimage/release/current/amd64/iso-cd/debian-9.1.0-amd64-netinst.iso
- https://ftp.acc.umu.se/cdimage/unofficial/non-free/firmware/stretch/current/firmware.tar.gz
- select automatic LVM with full encryption
- no window manager and no "standard system utilities" (which
  according to [[https://unix.stackexchange.com/questions/307600/whats-the-consequences-if-i-dont-install-the-standard-system-utilities-of-de][{link}]] translates to |aptitude search ~pstandard
  ~prequired ~pimportant -F%p|), resulting in about 260 packages
  being installed
- apt install apt-transport-tor
- vi /etc/apt/sources # replace http with tor+http, see https://onion.debian.org/
- apt install xinit ratpoison # brings in another 100 packages or so
- NOTE: startx does not work as non-root (this is not Xorg but wayland/winston)
- apt install less pm-utils
- timedatectl set-ntp false # disable systemd-timesyncd -- run ~linus/src/timesync.sh periodically
*** function keys
**** speaker muted
- UPDATE3: no, it was just muted -- unmute with alsamixer, duh
- UPDATE2: problem came back with linux 4.9.65-3+deb9u2
- UPDATE: solved: apt install acpi-support
- speaker mute button led is on (and no sound)
- wifi button works (rfkill), none of the others
- https://wiki.gentoo.org/wiki/ACPI/ThinkPad-special-buttons
  - Q: what is 'evdev' in /lib/udev/hwdb.d/60-keyboard.hwdb matched against?
- http://www.thinkwiki.org/wiki/Thinkpad-acpi
-  cat /proc/acpi/ibm/volume
level:          unsupported
mute:           on
- linux-doc-4.9: /usr/share/doc/linux-doc-4.9/Documentation/laptops/thinkpad-acpi.txt.gz
- apt install acpi-support gives the following, making mute go away and volume buttons work
  acpi-fakekey acpi-support acpi-support-base acpid rfkill

[later, reapering problem after kernel upgrade (SPECTRE)]
- acpi_listen shows, when pressing the mute (F1) key:
  - button/mute MUTE 00000080 00000000 K
  which is exactly what invoking /etc/acpi/always-mute.sh also does
- seems like /etc/acpi/events/thinkpad-mute is mapping from an
  ibm/hotkey event to button/mute event; this seems to be confirmed by
  /usr/share/doc/acpi-support/README.thinkpad
- the volume up and down buttons generate button/volumeup and
  button/volumedown events:
  - button/volumeup VOLUP 00000080 00000000 K
  - button/volumedown VOLDN 00000080 00000000 K
  but the led on the mute button, and the lack of sound, don't change

[later, 2018-02-21]
- joe: "did you take a look in alsamixer? navigate to each bar and try
  'm'" and the LED on F1 disappears when i do that on Master or
  Speaker, can't remember which
**** backlight brightness
echo 200 > /sys/class/backlight/intel_backlight/brightness

question is who should adjust brightness when keys are being pressed
**** keyboard backlight
# cat /root/kbdlight
#! /bin/sh
I=$1
[ -z "$I" ] && I=2
echo $I > /proc/acpi/ibm/kbdlight
*** TODO [0/2]
- [ ] macchanger fixed
Disabled it due to ifup fail:
Oct 01 22:49:43 datan ifup[889]: run-parts: /etc/network/if-pre-up.d/macchanger exited with return code 1
root@datan:/etc/network/if-pre-up.d# ls -l macchanger
lrwxrwxrwx 1 root root 28 Feb  7  2015 macchanger -> ../../macchanger/ifupdown.sh
root@datan:/etc/network/if-pre-up.d# rm macchanger
- [ ] waiting for network interfaces to come up at boot
*** sysadmin
systemctl start wpa_supplicant@wlp4s0
ifup wlp4s0

systemctl status openvpn-client@mullvad_se-sto
systemctl restart tor@default
*** weird failed authn <2018-04-27 Fri>
Update: This was almost certainly M typing on a connected keyboard,
lol. :D

Apr 27 00:12:43 datan systemd-logind[661]: Suspending...
Apr 27 08:00:59 datan systemd-logind[661]: Operation 'sleep' finished.
Apr 27 08:01:15 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): conversation failed
Apr 27 08:01:15 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): auth could not identify password for [linus]
Apr 27 08:01:16 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): conversation failed
Apr 27 08:01:16 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): auth could not identify password for [linus]
Apr 27 08:01:16 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): conversation failed
Apr 27 08:01:16 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): auth could not identify password for [linus]
Apr 27 08:01:16 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): conversation failed
Apr 27 08:01:16 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): auth could not identify password for [linus]
Apr 27 08:01:17 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): conversation failed
Apr 27 08:01:17 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): auth could not identify password for [linus]
Apr 27 08:01:17 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): conversation failed
Apr 27 08:01:17 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): auth could not identify password for [linus]
Apr 27 08:01:23 datan unix_chkpwd[12255]: password check failed for user (linus)
Apr 27 08:01:23 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): authentication failure; logname= uid=1000 euid=1000 tty=:0.0 ruser= rhost=  user=linus
Apr 27 08:01:25 datan xscreensaver[2178]: FAILED LOGIN 1 ON DISPLAY ":0.0", FOR "linus"
Apr 27 08:01:26 datan systemd-logind[661]: Suspending...
Apr 27 08:01:32 datan systemd-logind[661]: Operation 'sleep' finished.
Apr 27 08:01:54 datan unix_chkpwd[12677]: password check failed for user (linus)
Apr 27 08:01:54 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): authentication failure; logname= uid=1000 euid=1000 tty=:0.0 ruser= rhost=  user=linus
Apr 27 08:01:57 datan xscreensaver[2178]: FAILED LOGIN 2 ON DISPLAY ":0.0", FOR "linus"
Apr 27 08:01:59 datan systemd-logind[661]: Suspending...
Apr 27 08:02:06 datan systemd-logind[661]: Operation 'sleep' finished.
Apr 27 08:02:33 datan systemd-logind[661]: Suspending...
Apr 27 08:02:44 datan systemd-logind[661]: Operation 'sleep' finished.
Apr 27 08:02:44 datan unix_chkpwd[13244]: password check failed for user (linus)
Apr 27 08:02:44 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): authentication failure; logname= uid=1000 euid=1000 tty=:0.0 ruser= rhost=  user=linus
Apr 27 08:02:47 datan xscreensaver[2178]: FAILED LOGIN 3 ON DISPLAY ":0.0", FOR "linus"
Apr 27 08:03:06 datan unix_chkpwd[13605]: password check failed for user (linus)
Apr 27 08:03:06 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): authentication failure; logname= uid=1000 euid=1000 tty=:0.0 ruser= rhost=  user=linus
Apr 27 08:03:08 datan xscreensaver[2178]: FAILED LOGIN 4 ON DISPLAY ":0.0", FOR "linus"
Apr 27 08:03:12 datan systemd-logind[661]: Suspending...
Apr 27 08:03:19 datan systemd-logind[661]: Operation 'sleep' finished.
Apr 27 08:03:24 datan unix_chkpwd[14020]: password check failed for user (linus)
Apr 27 08:03:24 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): authentication failure; logname= uid=1000 euid=1000 tty=:0.0 ruser= rhost=  user=linus
Apr 27 08:03:27 datan xscreensaver[2178]: FAILED LOGIN 5 ON DISPLAY ":0.0", FOR "linus"
Apr 27 08:03:46 datan systemd-logind[661]: Suspending...
Apr 27 08:03:52 datan systemd-logind[661]: Operation 'sleep' finished.
Apr 27 08:04:03 datan unix_chkpwd[14603]: password check failed for user (linus)
Apr 27 08:04:03 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): authentication failure; logname= uid=1000 euid=1000 tty=:0.0 ruser= rhost=  user=linus
Apr 27 08:04:04 datan xscreensaver[2178]: FAILED LOGIN 6 ON DISPLAY ":0.0", FOR "linus"
Apr 27 08:04:19 datan systemd-logind[661]: Suspending...
Apr 27 09:10:38 datan systemd-logind[661]: Lid opened.
Apr 27 09:10:38 datan systemd-logind[661]: Operation 'sleep' finished.
Apr 27 09:10:56 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): conversation failed
Apr 27 09:10:56 datan xscreensaver[2178]: pam_unix(xscreensaver:auth): auth could not identify password for [linus]
*** vm's
**** debian-unstable
**** puppet
<2018-12-27 Thu>
virt-install --virt-type kvm --name puppet --ram 512 --disk size=20 --graphics none --location https://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ --extra-args console=ttyS0,115200

virsh start --console puppet
Loading Linux 4.9.0-8-amd64 ...
Loading initial ramdisk ...

Hmm. Add 'console=ttyS0,115200' to boot command line?

**** dta -- debian throw-away
virt-install --virt-type kvm --name dta --ram 512 --disk size=20 --graphics none --location http://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ --extra-args console=ttyS0,115200 --os-variant debiantesting
root: Em4LIjZdhVYj
linus: Em4LIjZdhVYj
console doesn't seem to work, ssh linus@192.168.122.90 is fine though
apt install -y tor apt-transport-tor
vi /etc/apt/sources.list
deb tor+http://sgvtcaew4bxjd7ln.onion/debian-security stretch/updates main
deb-src tor+http://sgvtcaew4bxjd7ln.onion/debian-security stretch/updates main
deb tor+http://vwakviie2ienjx6t.onion/debian/ stretch main contrib non-free
deb-src tor+http://vwakviie2ienjx6t.onion/debian/ stretch main contrib non-free
deb tor+http://vwakviie2ienjx6t.onion/debian/ stretch-updates main contrib non-free
deb-src tor+http://vwakviie2ienjx6t.onion/debian/ stretch-updates main contrib non-free
apt update
**** fdroid <2020-09-16 Wed 17:28>
virt-install --virt-type kvm --name fdroid --memory 4096 --disk size=60 --graphics none --location http://ftp.acc.umu.se/debian/dists/stable/main/installer-amd64/ --extra-args console=ttyS0,115200 --os-variant debiantesting

Host fdroid
     hostname 192.168.122.197
     user builder

"Install the Android SDK and make sure the ANDROID_HOME environment variable is properly set." https://f-droid.org/docs/Installing_the_Server_and_Repo_Tools/

***** Android command line tools
https://developer.android.com/studio
Linux 	82 MB 	89f308315e041c93a37a79e0627c47f21d5c5edbe5e80ea8dc0aac8a649e0e92
(Doesn't work in Tor Browser.)
datan:~% sha256sum commandlinetools-linux-6609375_latest.zip
89f308315e041c93a37a79e0627c47f21d5c5edbe5e80ea8dc0aac8a649e0e92  commandlinetools-linux-6609375_latest.zip

root@fdroid:#
   38  mkdir -p /usr/android/cmdline-tools  # NAME IS CRUCIAL, see https://stackoverflow.com/questions/60440509/android-command-line-tools-sdkmanager-always-shows-warning-could-not-create-se
   39  cd /usr/android/cmdline-tools
   40  unzip ~builder/commandlinetools-linux-6609375_latest.zip

https://developer.android.com/studio/command-line/

builder@fdroid:~$ export USE_SDK_WRAPPER=yes
builder@fdroid:~$ export ANDROID_SDK_ROOT=/usr/android
builder@fdroid:~$ export ANDROID_HOME=$ANDROID_SDK_ROOT
builder@fdroid:~$ export PATH=$PATH:/usr/android/cmdline-tools/tools/bin

builder@fdroid:~$ sudo $ANDROID_SDK_ROOT/cmdline-tools/tools/bin/sdkmanager --install platform-tools
builder@fdroid:~$ sudo $ANDROID_SDK_ROOT/cmdline-tools/tools/bin/sdkmanager --install tools 
builder@fdroid:~$ sudo $ANDROID_SDK_ROOT/cmdline-tools/tools/bin/sdkmanager --install 'build-tools;30.0.2'

# NOTE: can't find 'android'

sudo apt install -y git python3-setuptools python3-git
cd /usr/src
git clone https://gitlab.com/fdroid/fdroidserver
cd fdroidserver

builder@fdroid:/usr/src/fdroidserver$ ./fdroid init
2020-09-16 21:17:28,946 INFO: Generating a new key in "keystore.jks"...
2020-09-16 21:17:32,270 INFO: Alias name: fdroid
Creation date: Sep 16, 2020
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: CN=fdroid, OU=F-Droid
Issuer: CN=fdroid, OU=F-Droid
Serial number: 63ca931c
Valid from: Wed Sep 16 21:17:30 CEST 2020 until: Sun Feb 02 20:17:30 CET 2048
Certificate fingerprints:
         SHA1: BA:21:44:3A:C7:95:39:80:CE:A6:4F:B1:76:40:0C:A1:41:E7:C1:00
         SHA256: D2:A4:9A:73:76:AC:C3:E7:B6:8A:5E:3D:0E:25:FF:C1:AF:0C:F2:72:5D:57:CC:09:50:A5:CD:2E:26:2F:B1:17
Signature algorithm name: SHA256withRSA
Subject Public Key Algorithm: 4096-bit RSA key
Version: 3

Extensions: 

#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 41 B4 D0 76 31 1E 93 37   B4 A6 AA 16 60 E4 A5 01  A..v1..7....`...
0010: B1 28 C5 B7                                        .(..
]
]


2020-09-16 21:17:33,083 INFO: 
Built repo based in "/usr/src/fdroidserver" with this config:

  Android SDK:                  /usr/android
  Android SDK Build Tools:      /usr/android/build-tools/30.0.2
  Android NDK r12b (optional):  $ANDROID_NDK
  Keystore for signing key:     keystore.jks

To complete the setup, add your APKs to "/usr/src/fdroidserver/repo"
then run "fdroid update -c; fdroid update".  You might also want to edit
"config.py" to set the URL, repo name, and more.  You should also set up
a signing key (a temporary one might have been automatically generated).

For more info: https://f-droid.org/docs/Setup_an_F-Droid_App_Repo
and https://f-droid.org/docs/Signing_Process


./fdroid update               # creates metadata/ and more

datan:fdroid% tar cf - fdroiddata/metadata/de.schildbach.oeffi* | ssh fdroid tar xf - -C /usr/src
builder@fdroid:/usr/src/fdroidserver$ rmdir metadata; ln -s /usr/src/fdroiddata/metadata

builder@fdroid:/usr/src/fdroidserver$ ./fdroid build de.schildbach.oeffi
2020-09-16 21:30:39,463 INFO: Creating log directory
2020-09-16 21:30:39,464 INFO: Creating output directory
2020-09-16 21:30:39,558 INFO: Creating build directory
2020-09-16 21:30:41,863 INFO: Using git version 2.20.1
2020-09-16 21:30:41,865 INFO: Building version 10.0-aosp (610) of de.schildbach.oeffi
2020-09-16 21:30:41,867 INFO: Getting source for revision v10.0
2020-09-16 21:30:44,458 INFO: Initialising submodules
2020-09-16 21:30:48,306 INFO: Creating local.properties file at build/de.schildbach.oeffi/local.properties
2020-09-16 21:30:48,308 INFO: Creating local.properties file at build/de.schildbach.oeffi/oeffi/local.properties
2020-09-16 21:30:48,315 INFO: Running 'prebuild' commands in build/de.schildbach.oeffi/oeffi
2020-09-16 21:30:48,521 INFO: Cleaning Gradle project...
2020-09-16 21:30:56,370 ERROR: Could not build app de.schildbach.oeffi: Error cleaning de.schildbach.oeffi:10.0-aosp
==== detail begin ====
Found 3.4.1 via gradleVersion
Downloading missing gradle version 3.4.1
/home/builder/.cache/fdroidserver/gradle-3.4.1-bin.zip: OK
Running /home/builder/.cache/fdroidserver/gradle/3.4.1/bin/gradle clean

FAILURE: Build failed with an exception.
...
2020-09-16 21:31:52,475 INFO: 23 builds failed

sudo apt install -y disorderfs gradle
export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
./fdroid build -v -ls de.schildbach.oeffi

$ tail logs/de.schildbach.oeffi.log
== Installed Android Tools ==

\* build-tools/30.0.2 (30.0.2)
\* cmdline-tools/tools (2.1)
\* emulator (30.0.26)
\* patcher/v4 (1)
\* platform-tools (30.0.4)
\* tools (26.1.1)

Error running init command for de.schildbach.oeffi:11.2.4-aosp
==== detail begin ====
+ cd ../..
+ mv de.schildbach.oeffi de.schildbach.oeffi_underlying
mv: cannot move 'de.schildbach.oeffi' to 'de.schildbach.oeffi_underlying/de.schildbach.oeffi': Device or resource busy
==== detail end ====

builder@fdroid:/usr/src/fdroidserver$ ps x
  PID TTY      STAT   TIME COMMAND
  949 ?        Ss     0:00 /lib/systemd/systemd --user
  950 ?        S      0:00 (sd-pam)
  959 ?        S      0:03 sshd: builder@pts/0
  960 pts/0    Ss     0:02 -bash
26251 ?        Ssl    0:00 disorderfs --sort-dirents=yes --reverse-dirents=no de.schildbach.oeffi_underlying de.schildbach.oeffi
27802 pts/0    R+     0:00 ps x

killing disorderfs, trying again
...
NDK is missing a "platforms" directory.
If you are using NDK, verify the ndk.dir is set to a valid NDK directory.  It is currently set to /home/builder/.gradle/daemon/4.4.1/$ANDROID_NDK.
If you are not using NDK, unset the NDK variable from ANDROID_NDK_HOME or local.properties to remove this warning.

File /home/builder/.android/repositories.cfg could not be loaded.
Checking the license for package Android SDK Build-Tools 29.0.3 in /usr/android/licenses
License for package Android SDK Build-Tools 29.0.3 accepted.
Preparing "Install Android SDK Build-Tools 29.0.3 (revision: 29.0.3)".
Warning: Failed to read or create install properties file.
Checking the license for package Android SDK Platform 29 in /usr/android/licenses
License for package Android SDK Platform 29 accepted.
Preparing "Install Android SDK Platform 29 (revision: 5)".
Warning: Failed to read or create install properties file.

FAILURE: Build failed with an exception.

\* What went wrong:
A problem occurred configuring project ':oeffi'.
> Failed to install the following SDK components:
      build-tools;29.0.3 Android SDK Build-Tools 29.0.3
      platforms;android-29 Android SDK Platform 29
  The SDK directory is not writable (/usr/android)

builder@fdroid:/usr/src/fdroidserver$ sudo $ANDROID_SDK_ROOT/cmdline-tools/tools/bin/sdkmanager --install 'build-tools;29.0.3'
builder@fdroid:/usr/src/fdroidserver$ sudo $ANDROID_SDK_ROOT/cmdline-tools/tools/bin/sdkmanager --install 'platforms;android-29'
again

mv: cannot move 'de.schildbach.oeffi' to 'de.schildbach.oeffi_underlying/de.schildbach.oeffi': Device or resource busy

builder@fdroid:/usr/src/fdroidserver$ ps x
  PID TTY      STAT   TIME COMMAND
  949 ?        Ss     0:00 /lib/systemd/systemd --user
  950 ?        S      0:00 (sd-pam)
  959 ?        S      0:04 sshd: builder@pts/0
  960 pts/0    Ss     0:02 -bash
28036 ?        Ssl    0:00 disorderfs --sort-dirents=yes --reverse-dirents=no de.schildbach.oeffi_underlying de.schildbach.oeffi
28069 ?        Ssl    0:28 /usr/lib/jvm/java-11-openjdk-amd64/bin/java -Xmx2048M -Dfile.encoding=UTF-8 -Duser.country=US -Duser.language=en -Duser.variant -cp /usr/share/gradle/lib/gradle-launcher-4.4.1.jar or
28568 pts/0    R+     0:00 ps x

killing both disorderfs and java; rm -rf build/*
(the java process is probably a gradle daemon)
complaints about NDK

builder@fdroid:/usr/src/fdroidserver$ sudo $ANDROID_SDK_ROOT/cmdline-tools/tools/bin/sdkmanager --install ndk-bundle
builder@fdroid:/usr/src/fdroidserver$ export ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk-bundle




\* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

\* Get more help at https://help.gradle.org

BUILD FAILED in 57s
==== detail end ====
2020-09-16 21:53:27,727 DEBUG: Error encoutered, stopping by user request.

Make sure you invoke fdroid with -l for build latest only.

builder@fdroid:/usr/src/fdroidserver$ export ANDROID_NDK=$ANDROID_SDK_ROOT/ndk-bundle

Keep getting java.lang.NullPointerException.
Adding `-s' to gradle by editing metadata/de.schildbach.oeffi.yml shows

org.gradle.api.ProjectConfigurationException: A problem occurred configuring project ':oeffi'.
        at org.gradle.configuration.project.LifecycleProjectEvaluator.addConfigurationFailure(LifecycleProjectEvaluator.java:94)
        at org.gradle.configuration.project.LifecycleProjectEvaluator.notifyAfterEvaluate(LifecycleProjectEvaluator.java:89)
        at org.gradle.configuration.project.LifecycleProjectEvaluator.doConfigure(LifecycleProjectEvaluator.java:70)
...
        at org.gradle.internal.concurrent.ThreadFactoryImpl$ManagedThreadRunnable.run(ThreadFactoryImpl.java:55)
Caused by: java.lang.NullPointerException
        at com.google.common.base.Preconditions.checkNotNull(Preconditions.java:782)
...
        at org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:93)
        at com.sun.proxy.$Proxy29.afterEvaluate(Unknown Source)
        at org.gradle.configuration.project.LifecycleProjectEvaluator.notifyAfterEvaluate(LifecycleProjectEvaluator.java:76)
        ... 81 more

Unsetting ANDROID_NDK doesn't change anything.
Removing the init cruft, ie disorderfs, adding --scan to gradle.
Sam old NullPointerException.
Trying gradle -S.


***** Full Android SDK
root@fdroid:/u# curl -LO https://redirector.gvt1.com/edgedl/android/studio/ide-zips/4.0.1.0/android-studio-ide-193.6626763-linux.tar.gz

apt-get install apksigner curl lib32gcc1 lib32ncurses6 lib32stdc++6 lib32z1 default-jdk-headless python3-pil python3-pyasn1 python3-pyasn1-modules python3-ruamel.yaml python3-yaml

  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   476  100   476    0     0    911      0 --:--:-- --:--:-- --:--:--   910
100  865M  100  865M    0     0  14.8M      0  0:00:58  0:00:58 --:--:-- 15.0M
root@fdroid:/u# sha256sum android-studio-ide-193.6626763-linux.tar.gz
f2f82744e735eae43fa018a77254c398a3bab5371f09973a37483014b73b7597  android-studio-ide-193.6626763-linux.tar.gz

TBC

*** backups
- blackwd/datan/: root etc var boot using ~linus/bin/bup.sh

- root@datan:~# date
Sat Jan 19 14:26:27 CET 2019
- root@datan:~# lvs
  LV     VG       Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root   datan-vg -wi-ao---- 461.25g
  swap_1 datan-vg -wi-ao----  15.44g
- root@datan:~# vgs
  VG       #PV #LV #SN Attr   VSize   VFree
  datan-vg   1   2   0 wz--n- 476.70g    0
- root@datan:~# pvs
  PV                     VG       Fmt  Attr PSize   PFree
  /dev/mapper/sda5_crypt datan-vg lvm2 a--  476.70g    0
- root@datan:~# dmsetup info
Name:              datan--vg-root
State:             ACTIVE
Read Ahead:        256
Tables present:    LIVE
Open count:        1
Event number:      0
Major, minor:      253, 1
Number of targets: 1
UUID: LVM-H4Vekpi0xtZO2fUhAeJpYxDTzaNMnBwh6xo3a4Nm8caUCsvpsr61zfaJ10o3dQoa

Name:              sda5_crypt
State:             ACTIVE
Read Ahead:        256
Tables present:    LIVE
Open count:        2
Event number:      0
Major, minor:      253, 0
Number of targets: 1
UUID: CRYPT-LUKS1-089e6f0325df42ea820afb6b7b7e593d-sda5_crypt

Name:              datan--vg-swap_1
State:             ACTIVE
Read Ahead:        256
Tables present:    LIVE
Open count:        2
Event number:      0
Major, minor:      253, 2
Number of targets: 1
UUID: LVM-H4Vekpi0xtZO2fUhAeJpYxDTzaNMnBwhbVCleFlP1odHlHohV8bZsYJ3Wegu2eAy

- root@datan:~# cryptsetup status sda5_crypt
/dev/mapper/sda5_crypt is active and is in use.
  type:    LUKS1
  cipher:  aes-xts-plain64
  keysize: 512 bits
  device:  /dev/sda5
  offset:  4096 sectors
  size:    999708672 sectors
  mode:    read/write
- root@datan:~# ls -l /mnt/*.header*
-r-------- 1 root root 2068480 Mar  7  2018 /mnt/datan.sda5.header-backup
-r-------- 1 root root 1052672 Mar  7  2018 /mnt/ostick.header-backup
-r-------- 1 root root 1052672 Oct 25 10:35 /mnt/tstick.header-backup

** flow.sunet.se -- PowerEdge R620/0KCKR5 (hbsd-11)
- former flow.nordu.net
- purchased 2012-11 (or possibly 2013-01)
- one (of two?) disks replaced 2018-03-22
- reinstalled w/ hbsd-11 <2018-03-23 Fri>
- 130.242.94.16/28
  - .20 flow
  - .21 p11p
  - .22 carmeli
- 2001:6b0:8:8::/64
  - ::4 p11p
  - ::5 carmeli
  - ::10 flow
*** vm's and jails
- NAT for FIXME
- naming: https://en.wikipedia.org/wiki/Category:Allium
**** PCI pass through
- securelevel > 0 makes it impossible to start bhyve guests with pci
  device passthrough (bhyve -S -s)
- cannot direct _one_ of bge2 and bge3 to a vm, have to pass both:
  - /boot/loader.conf
    -  pptdevs="1/0/0 1/0/1"
  - /var/vm/basalticum/basalticum.conf
    - passthru1="1/0/1"
    - passthru0="1/0/0"
- pass through broke in early March 2020 when upgrading hbsd
  12.0->12.a and bhyve 1.3.0 -> 1.4.2
- pass through started working again <2020-09-08 Tue>
**** aaseae -- test and development of bw scanners
- access: pastly, juga
**** basalticum
- tor browser signing infra jump host
- i/f passthrough: bge3 in host shows as bge1 in VM
- using a virtual switch instead of passthrough <2020-03-05 Thu> to <2020-09-08 Tue>
  - vm switch create -i bge3 -p basaltic # shows as vm-basaltic on flow
  - vm add -d network -s basaltic basalticum
  - ifconfig vm-basaltic on flow should list two members: bge3 and tapN (vmnet-basalticum-1-basaltic)
- access: gk, boklm, sysrqb
**** build (jail, running poudriere)
***** intallation, HBSD-12.0
https://github.com/freebsd/poudriere/wiki/poudriere_in_jail
kldload tmpfs nullfs fdescfs
MY_DOMAINNAME="nordu.net sunet.se" MY_NS_1_V4=109.105.96.141 MY_NS_1_V6=NONE /root/mkjail.sh install build rfc1918
zfs create -o jailed=on zroot/build_poudriere
zfs jail build zroot/build_poudriere
vi /etc/jail.conf # add a lot of cruft:
        ip4=inherit;
        ip6=inherit;
        persist;
        children.max=32;
        allow.mount;
        allow.mount.devfs;
        allow.mount.procfs;
        allow.mount.zfs;
        allow.mount.nullfs;
        allow.raw_sockets;
        allow.socket_af;
        allow.sysvipc;
        allow.chflags;
        enforce_statfs=1;
        path=/jails/poudriere;
        exec.start="mount -t devfs devfs /dev";
        exec.stop="umount /dev; zfs umount -a";
service jail restart build

# In the jail:
[root@build ~]# diff -u1 /usr/local/etc/poudriere.conf.sample /usr/local/etc/poudriere.conf
--- /usr/local/etc/poudriere.conf.sample        2019-07-19 10:22:01.000000000 +0200
+++ /usr/local/etc/poudriere.conf       2019-09-21 18:41:36.981133000 +0200
@@ -11,3 +11,3 @@
 #
-#ZPOOL=zroot
+ZPOOL=zroot
 
@@ -18,3 +18,3 @@
 # root of the poudriere zfs filesystem, by default /poudriere
-# ZROOTFS=/poudriere
+ZROOTFS=/build_poudriere
 
@@ -38,3 +38,3 @@
 # The directory where poudriere will store jails and ports
-BASEFS=/usr/local/poudriere
+BASEFS=/zroot/build_poudriere
 
@@ -85,3 +85,3 @@
 # the required distfiles.
-DISTFILES_CACHE=/usr/ports/distfiles
+DISTFILES_CACHE=/zroot/build_poudriere/ports/distifiles
 
@@ -173,3 +173,3 @@
 # Disable Linux support
-# NOLINUX=yes
+NOLINUX=yes
 
@@ -264,3 +264,3 @@
 # to that user.  Then set CCACHE_DIR_NON_ROOT_SAFE to yes.
-#BUILD_AS_NON_ROOT=no
+BUILD_AS_NON_ROOT=no


# Creating the jail took about 1.5 minute
poudriere jail -c -m url=http://dk-01.installer.hardenedbsd.org/HardenedBSD/releases/amd64/amd64/hardenedbsd-12-stable-LAST -v master -j 12amd64
# cloning the ports tree took about 4 minutes.
pkg install -y git
git clone --single-branch --branch master https://github.com/hardenedbsd/hardenedbsd-ports/ /zroot/build_poudriere/ports
poudriere ports -c -M /zroot/build_poudriere/ports -m null
mkdir /zroot/build_poudriere/ports/distifiles

***** FIXME: upgrading to HBSD-12.1 <2020-03-04 Wed>
NOTE: dk-01.installer is outdated!
[root@build ~]# poudriere jail -c -m url=https://ci-01.nyi.hardenedbsd.org/pub/hardenedbsd/12-stable/amd64/amd64/BUILD-LATEST -v 12.1 -j 12_1_amd64
NOTE2: `-v 12.1' is for presentation only iiuc
***** setting default PHP version
echo 'DEFAULT_VERSIONS+=php=74' >> /usr/local/etc/poudriere.d/make.conf
***** security/pinentry build failure 
security/gnupg fails bc it cannot find the pinentry binary.

Building pinentry and pinentry-tty works just fine:
  poudriere bulk -C -j 12_1_amd64 security/pinentry-tty security/pinentry

That doesn't make gnupg any happier though:
=======================<phase: run-depends    >============================
===>   gnupg-2.2.21 depends on executable: pinentry - not found
===>   Installing existing package /packages/All/pinentry-1.1.0_6.txz
[12_1_amd64-default-job-01] Installing pinentry-1.1.0_6...
[12_1_amd64-default-job-01] `-- Installing pinentry-tty-1.1.0...
[12_1_amd64-default-job-01] `-- Extracting pinentry-tty-1.1.0: .... done
[12_1_amd64-default-job-01] Extracting pinentry-1.1.0_6: ..... done
===>   gnupg-2.2.21 depends on executable: pinentry - not found
\*** Error code 1

What if all three packages are built at the same time?
The symlink pinentry -> pinentry-tty is missing in /usr/local/bin.
root@12_1_amd64-default:~ # tar tvf /packages/All/pinentry-1.1.0_6.txz
-rw-r--r--  0 root   wheel     856 Jan  1  1970 +COMPACT_MANIFEST
-rw-r--r--  0 root   wheel    1918 Jan  1  1970 +MANIFEST
-rw-r--r--  0 root   wheel     217 Aug 31 23:34 /usr/local/share/licenses/pinentry-1.1.0_6/catalog.mk
-rw-r--r--  0 root   wheel      93 Aug 31 23:34 /usr/local/share/licenses/pinentry-1.1.0_6/LICENSE
-rw-r--r--  0 root   wheel   15131 Aug 31 23:34 /usr/local/share/licenses/pinentry-1.1.0_6/GPLv2+
-rw-r--r--  0 root   wheel   44705 Aug 31 23:34 /usr/local/share/info/pinentry.info

Can the problem be that pkg refuses to include a broken symlink in the
pinentry package?

A quick and dirty solution is to change pinentry/Makefile to symlink
/usr/local/bin/pinentry-tty.

***** upgrading poudriere jails to HBSD-12.2 <2020-08-31 Mon>
[root@build ~]# uname -a
FreeBSD build 12.2-PRERELEASE-HBSD FreeBSD 12.2-PRERELEASE-HBSD #0 : Sun Aug 30 01:49:47 UTC 2020     root@updater-01.md.hardenedbsd.lan:/usr/obj/usr/src/amd64.amd64/sys/HARDENEDBSD  amd64

[root@build ~]# poudriere jail -c -m url=https://ci-01.nyi.hardenedbsd.org/pub/hardenedbsd/12-stable/amd64/amd64/BUILD-LATEST -v 12.2 -j 12_2_amd64
[00:00:00] Creating 12_2_amd64 fs at /zroot/build_poudriere/jails/12_2_amd64... done
[00:00:00] Fetching MANIFEST for FreeBSD 12.2 amd64
/zroot/build_poudriere/jails/12_2_amd64/fromft         677  B 3147 kBps    00s
[00:00:01] Fetching base for FreeBSD 12.2 amd64
/zroot/build_poudriere/jails/12_2_amd64/fromft         294 MB   10 MBps    27s
[00:00:31] Extracting base... done
[00:01:05] Fetching src for FreeBSD 12.2 amd64
/zroot/build_poudriere/jails/12_2_amd64/fromft         165 MB 9430 kBps    18s
[00:01:26] Extracting src... done
[00:02:01] Cleaning up... done
awk: can't open file /sys/param.h
 source line number 1
[00:02:02] Recording filesystem state for clean... done
[00:02:02] Jail 12_2_amd64 12.2--HBSD amd64 is ready to be used

[root@build ~]# poudriere jail -l
JAILNAME   VERSION    ARCH  METHOD                                                                                   TIMESTAMP           PATH
12_1_amd64 12.1--HBSD amd64 url=https://ci-01.nyi.hardenedbsd.org/pub/hardenedbsd/12-stable/amd64/amd64/BUILD-LATEST 2020-03-04 14:34:46 /zroot/build_poudriere/jails/12_1_amd64
12_2_amd64 12.2--HBSD amd64 url=https://ci-01.nyi.hardenedbsd.org/pub/hardenedbsd/12-stable/amd64/amd64/BUILD-LATEST 2020-08-31 14:17:13 /zroot/build_poudriere/jails/12_2_amd64

**** carmeli -- tjr's bwauth
**** p11p -- pkcs11 testing
**** lnbup (jail) -- backups
**** rb-fbsd12 -- reprodbuilds jail

** gamma.sunet.se / scanner.ct.nordu.net -- Xeon E5-2420, 16GB RAM
[root@gamma ~]# ifconfig
bge0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> metric 0 mtu 1500
        options=c019b<RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,TSO4,VLAN_HWTSO,LINKSTATE>
        ether f0:1f:af:d7:6d:4e
        hwaddr f0:1f:af:d7:6d:4e
        inet 130.229.192.11 netmask 0xffffff00 broadcast 130.229.192.255 
        inet 10.220.0.1 netmask 0xffffffff broadcast 10.220.0.1 
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
        media: Ethernet autoselect (1000baseT <full-duplex>)
        status: active
bge1: flags=8802<BROADCAST,SIMPLEX,MULTICAST> metric 0 mtu 1500
        options=c019b<RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,TSO4,VLAN_HWTSO,LINKSTATE>
        ether f0:1f:af:d7:6d:4f
        hwaddr f0:1f:af:d7:6d:4f
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
        media: Ethernet autoselect
lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> metric 0 mtu 16384
        options=680003<RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6>
        inet6 ::1 prefixlen 128 
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x3 
        inet 127.0.0.1 netmask 0xff000000 
        nd6 options=21<PERFORMNUD,AUTO_LINKLOCAL>
        groups: lo 
mlxen0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> metric 0 mtu 1500
        options=ed07bb<RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,JUMBO_MTU,VLAN_HWCSUM,TSO4,TSO6,LRO,VLAN_HWFILTER,VLAN_HWTSO,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6>
        ether 00:02:c9:52:11:20
        hwaddr 00:02:c9:52:11:20
        inet 94.176.225.1 netmask 0xfffffffe broadcast 255.255.255.255 
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
        media: Ethernet autoselect (10Gbase-SR <full-duplex,rxpause,txpause>)
        status: active
pflog0: flags=141<UP,RUNNING,PROMISC> metric 0 mtu 33160
        groups: pflog 
[root@gamma ~]# date
Tue Feb  2 22:09:06 CET 2021
[root@gamma ~]# uptime
10:09PM  up 855 days, 11:13, 1 user, load averages: 0.42, 0.23, 0.18
[root@gamma ~]# freebsd-version -ku
11.2-STABLE-HBSD
11.2--HBSD
[root@gamma ~]# uname -a
FreeBSD gamma.sunet.se 11.2-STABLE-HBSD FreeBSD 11.2-STABLE-HBSD #0 : Thu Sep 27 21:58:43 UTC 2018     root@updater-01:/usr/obj/usr/src/sys/HARDENEDBSD  amd64
[root@gamma ~]# sockstat -46l
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS      
root     syslogd    58580 5  udp4   10.220.0.1:514        *:*
root     sshd       89164 4  tcp6   *:22                  *:*
root     sshd       89164 5  tcp4   *:22                  *:*
unbound  unbound    30097 4  udp6   ::1:53                *:*
unbound  unbound    30097 5  tcp6   ::1:53                *:*
unbound  unbound    30097 6  udp4   127.0.0.1:53          *:*
unbound  unbound    30097 7  tcp4   127.0.0.1:53          *:*
[root@gamma ~]# sysctl hw | head -5
hw.machine: amd64
hw.model: Intel(R) Xeon(R) CPU E5-2420 0 @ 1.90GHz
hw.ncpu: 6
hw.byteorder: 1234
hw.physmem: 17092280320

** vmsplice.adb-centralen.se
root@4c255a9c6946:~# fdisk -lo 'device,Start,End,Sectors,Size,Type,Type-UUID,Attrs,Name,UUID' /dev/sda
Disk /dev/sda: 931.5 GiB, 1000204886016 bytes, 1953525168 sectors
Disk model: HGST HUS722T1TAL
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: 7D1789D4-A01F-11EA-8C85-00259071E325

Device       Start        End    Sectors   Size Type Type-UUID                            Attrs Name UUID
/dev/sda1     2048    2099199    2097152     1G Linu 0FC63DAF-8483-4772-8E79-3D69D8477DE4       STDATA
                                                                                                     E228E3AB-4850-CA44-A019-0E34CCE96A24
/dev/sda2  2099200 1953525127 1951425928 930.5G Linu E6D6D379-F507-44C2-A23C-238F2A3DF928            774377B5-697C-C34A-90E0-AADBDCBCB9B1
root@4c255a9c6946:~# date
Wed Oct 13 10:54:55 UTC 2021

besk:verkligen% sha256sum 2020-10-15-coreboot-vdse.rom 
9f3cb5e8271914c012a3e484d8ec658a4823c36eb6a1129a61ed7ff18ac26dea  2020-10-15-coreboot-vdse.rom
root@besk:~# flashrom -p ch341a_spi --ifd -i bios -w ~linus/p/st/deployments/verkligen/2020-10-15-coreboot-vdse.rom

*** kvm setup
cat > /stdata/etc/network/interfaces.d/br0 <<EOF
auto br0

iface br0 inet static
    address 193.10.5.101/24
    gateway 193.10.5.1
    dns-nameserver 193.10.5.125
    dns-search adb-centralen.se
    bridge_ports eno0
    bridge_stp off
    bridge_waitport 0
    bridge_fd 0
    
iface br0 inet6 static
    address 2001:6b0:8::101/64
    gateway 2001:6b0:8::1
    autoconf 0
EOF
cp /stdata/etc/network/interfaces.d/br0 /etc/network/interfaces.d/

cat > /stdata/etc/network/interfaces.d/eno0 <<EOF
allow-auto eno0
allow-hotplug eno0

iface eno0 inet static
    address 0.0.0.0/32
EOF
cp /stdata/etc/network/interfaces.d/eno0 /etc/network/interfaces.d/

systemctl restart networking
*** kcmp in a VM

curl -LO https://ci-01.nyi.hardenedbsd.org/pub/hardenedbsd/12-stable/amd64/amd64/BUILD-LATEST/bootonly.iso.xz
curl -LO https://ci-01.nyi.hardenedbsd.org/pub/hardenedbsd/12-stable/amd64/amd64/BUILD-LATEST/bootonly.iso.xz.asc
xz -d bootonly.iso.xz

virt-install \
  --virt-type kvm \
  --graphics none \
  --os-variant freebsd11.2 \
  --cdrom bootonly.iso \
  --name kcmp.adb-centralen.se --memory 4096 --vcpus 2 --disk size=40

*** 2021-10-13 first boot
linus@nanosleep:~/usr/src/st/system-transparency.HISTORICAL$ openssl x509 -noout -fingerprint -sha256 -in keys/signing_keys/root.cert  
SHA256 Fingerprint=5F:BB:A8:F4:7F:18:6F:15:FA:99:2A:60:A9:62:7B:B6:38:F2:64:95:82:23:41:08:51:FE:8E:36:CE:31:B5:51
linus@nanosleep:~/usr/src/st/system-transparency.HISTORICAL$ openssl x509 -noout -text -in keys/signing_keys/root.cert  | egrep Before\|After
            Not Before: Oct 13 20:18:31 2020 GMT
            Not After : Aug  3 20:18:31 2023 GMT

$ date -d @1602777665
Thu 15 Oct 2020 06:01:05 PM CEST

**** 2021/10/13 11:44:52 Welcome to u-root!
                              _
   _   _      _ __ ___   ___ | |_
  | | | |____| '__/ _ \ / _ \| __|
  | |_| |____| | | (_) | (_) | |_
   \__,_|    |_|  \___/ \___/ \__|

stboot: 2021/10/13 11:44:52
  _____ _______   _____   ____   ____________
 / ____|__   __|  |  _ \ / __ \ / __ \__   __|
| (___    | |     | |_) | |  | | |  | | | |
 \___ \   | |     |  _ <| |  | | |  | | | |
 ____) |  | |     | |_) | |__| | |__| | | |
|_____/   |_|     |____/ \____/ \____/  |_|

stboot: 2021/10/13 11:44:52 Host variables: {
  "minimal_signatures_match": 1,
  "fingerprints": [
    "5fbba8f47f186f15fa992a60a9627bb638f264958223410851fe8e36ce31b551"
  ],
  "build_timestamp": 1602777665,
  "boot_mode": "LocalStorage"
}
stboot: 2021/10/13 11:44:52 Search data partition with label STDATA ...
stboot: 2021/10/13 11:44:52 Skip /dev/sda: Bad GPT signature
stboot: 2021/10/13 11:44:52 Found data partition on /dev/sdb , partition 1
stboot: 2021/10/13 11:44:52 data partition /dev/sdb1 mounted at data
stboot: 2021/10/13 11:44:52 Systemtime: 2021-10-13 11:44:53 +0000 UTC
stboot: 2021/10/13 11:44:52 TXT self tests are not implementet yet.
stboot: 2021/10/13 11:44:52 WARNING: No TXT Support!
stboot: 2021/10/13 11:44:52 TXT is supported on this platform
stboot: 2021/10/13 11:44:52 Bootballs to be processed:
stboot: 2021/10/13 11:44:52 data/stboot/bootballs/new/ball-2021-09-13-06-23-19.stboot
stboot: 2021/10/13 11:44:52 Opening bootball data/stboot/bootballs/new/ball-2021-09-13-06-23-19.stboot
stboot: 2021/10/13 11:44:54 Fingerprint of boot ball's root certificate:
stboot: 2021/10/13 11:44:54 5fbba8f47f186f15fa992a60a9627bb638f264958223410851fe8e36ce31b551
stboot: 2021/10/13 11:44:54 OK!
stboot: 2021/10/13 11:44:54 Bootball config: {
  "label": "System Transparency with Debian Buster",
  "kernel": "boot/debian-buster-amd64.vmlinuz",
  "initramfs": "boot/debian-buster-amd64.cpio.gz",
  "cmdline": "console=tty0 console=ttyS0,115200n8 rw rdinit=/lib/systemd/systemd l1tf=full,force intel_iommu=on",
  "tboot": "boot/tboot.gz",
  "tboot_args": "",
  "acms": [
    "boot/acms/2nd_gen_i5_i7_SINIT_51.BIN",
    "boot/acms/3rd_gen_i5_i7_RACM-SINIT_67.bin",
    "boot/acms/3rd_gen_i5_i7_SINIT_67.BIN",
    "boot/acms/4th_gen_i5_i7_SINIT_75.BIN",
    "boot/acms/5th_gen_i5_i7_SINIT_79.BIN",
    "boot/acms/6th_7th_gen_i5_i7-SINIT_79.bin",
    "boot/acms/6th_gen_i5_i7_SINIT_71.BIN",
    "boot/acms/7th_8th_gen_i5_i7-SINIT_81.bin",
    "boot/acms/GM45_GS45_PM45_SINIT_51.BIN",
    "boot/acms/Q35_SINIT_51.BIN",
    "boot/acms/Q45_Q43_SINIT_51.BIN",
    "boot/acms/Xeon-5600-3500-SINIT-v1.1.bin",
    "boot/acms/Xeon-E7-8800-4800-2800-SINIT-v1.1.bin",
    "boot/acms/i5_i7_DUAL_SINIT_51.BIN",
    "boot/acms/i7_QUAD_SINIT_51.BIN"
  ],
  "allow_non_txt": true
}
stboot: 2021/10/13 11:44:55 Signatures: 1 found, 1 valid, 1 required
stboot: 2021/10/13 11:44:55 Bootball passed verification

* future
** <next tor machine>
CPU:    AMD Phenom II X6 1090T               1500:-
Planka: ASUS M4A89GTD PRO/USB3, Socket-AM3   1250:-
Minne:  2 x KVR1333D3E9S/4G                   750:-

Eller, enligt [[gnus:nnimap%2Badb-centralen:INBOX#861uuyqrz9.fsf@shell.gmplib.org][Email from Torbjorn Granlund: Re: Snabb maskin]]

AMD Phenom II X6 1100T Black Edition

alt., för färre kärnor, mer sprutt:

AMD Phenom II X4 980 Black Edition
Socket-AM3, Quad Core, 3,7Ghz, 6MB, 125W, Boxed
